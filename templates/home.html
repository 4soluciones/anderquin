{% load static %}

<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <!-- <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"> -->
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <title>{% block title %}ANDEQUIN {% endblock title %}</title>

    <link rel="icon" href="{% static 'assets/icons/images_mYC_1.ico' %}" type="image/ico"/>

    <!-- Normalize V8.0.1 -->
    <!-- <link rel="stylesheet" href="{% static 'css/normalize.css' %}"> -->

    <!-- Bootstrap V4.3 -->
    <link rel="stylesheet" href="{% static 'css/bootstrap.min.css' %}">
    {#<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css">#}
    <link rel="stylesheet" href="https://unpkg.com/bootstrap-table@1.18.3/dist/bootstrap-table.min.css">


    <!-- Simple javascript toast notifications -->
    <link href="//cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/css/toastr.min.css" rel="stylesheet">
    <!-- Bootstrap Material Design V4.0 -->
    <!-- <link rel="stylesheet" href="{% static 'css/bootstrap-material-design.min.css' %}"> -->

    <!-- Font Awesome V5.9.0 -->
    <link rel="stylesheet" href="{% static 'css/all.css' %}">

    <!-- Sweet Alerts V8.13.0 CSS file -->
    <link rel="stylesheet" href="{% static 'css/sweetalert2.min.css' %}">

    <!-- Sweet Alert V8.13.0 JS file-->
    <script src="{% static 'js/sweetalert2.min.js' %}"></script>

    <!-- jQuery Custom Content Scroller V3.1.5 -->
    <link rel="stylesheet" href="{% static 'css/jquery.mCustomScrollbar.css' %}">

    <!-- jQuery UI CSS -->
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

    <!-- DataTables CSS -->
    <link rel="stylesheet" href="{% static 'assets/datatables/datatables.min.css' %}">
    <link href="//cdn.datatables.net/buttons/1.6.5/css/buttons.dataTables.min.css" rel="stylesheet">
    <!-- General Styles -->
    <link rel="stylesheet" href="{% static 'css/style.css' %}">

    <!-- ERP Sidebar Styles -->
    <link rel="stylesheet" href="{% static 'css/sidebar.css' %}">
    <link rel="stylesheet" href="{% static 'css/loader.css' %}">

    <!-- Select2 - customizable select box -->
    <link rel="stylesheet" href="{% static 'css/select2.min.css' %}">
    <!-- select2-bootstrap4-theme -->
    <link rel="stylesheet" href="{% static 'css/select2-bootstrap4.css' %}">
    <!-- DataTables Select CSS <link href="css/addons/datatables-select2.min.css" rel="stylesheet">-->

    <link rel="stylesheet" href="{% static 'css/sweetalert.css' %}">
    <link rel="stylesheet" href="{% static 'css/bootstrap-duallistbox.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/select2-bootstrap4.min.css' %}">
    <link rel="stylesheet" href="{% static 'css/autocomplete.css' %}">

    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Aldrich">
    <link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Open+Sans">
    <link href='https://fonts.googleapis.com/css?family=Montserrat' rel='stylesheet'>
    <link href="https://fonts.googleapis.com/css2?family=Archivo&display=swap" rel="stylesheet">

</head>
<body>

<!-- ERP Layout con Sidebar -->
<div class="erp-layout">
    {% include "megamenu.html" %}

    <div class="erp-main-wrapper">
        <!-- Top Bar -->
        <header class="erp-topbar">
            <div class="erp-topbar-left">
                <button class="erp-topbar-sidebar-toggle" id="sidebar-toggle" aria-label="Mostrar/ocultar menú">
                    <i class="fas fa-bars"></i>
                </button>
                <button class="erp-topbar-icon-btn" id="sidebar-search" aria-label="Buscar" title="Buscar">
                    <i class="fas fa-search"></i>
                </button>
            </div>
            <div class="erp-topbar-actions">
                <div class="erp-topbar-subsidiary-dropdown dropdown">
                    <a class="erp-topbar-icon-btn dropdown-toggle" href="#" data-toggle="dropdown" id="subsidiaryMenuDropdown" aria-haspopup="true" aria-expanded="false" title="Sucursal actual">
                        <span class="erp-topbar-subsidiary-label">
                            {% if current_subsidiary %}{{ current_subsidiary.name }}{% else %}Sin sucursal{% endif %}
                        </span>
                    </a>
                    <div class="dropdown-menu dropdown-menu-right erp-subsidiary-dropdown" aria-labelledby="subsidiaryMenuDropdown">
                        <div class="erp-subsidiary-dropdown-header px-3 py-2">
                            <small class="text-muted text-uppercase">Sucursal actual</small>
                            <div class="font-weight-bold">{% if current_subsidiary %}{{ current_subsidiary.name }}{% else %}-{% endif %}</div>
                        </div>
                        <div class="dropdown-divider"></div>
                        {% if current_worker and subsidiary_set %}
                            <div class="px-3 py-2">
                                <small class="text-muted text-uppercase">Cambiar sucursal</small>
                            </div>
                            {% for sub in subsidiary_set %}
                                <a class="dropdown-item {% if current_subsidiary and sub.id == current_subsidiary.id %}active{% endif %} js-switch-subsidiary" href="#" data-worker-id="{{ current_worker.id }}" data-subsidiary-id="{{ sub.id }}" data-subsidiary-name="{{ sub.name }}">
                                    <i class="fas fa-map-marker-alt mr-2 text-muted"></i>{{ sub.name }}
                                </a>
                            {% endfor %}
                        {% else %}
                            <div class="dropdown-item text-muted disabled">No hay sucursales disponibles</div>
                        {% endif %}
                    </div>
                </div>
                <div class="erp-topbar-user-dropdown dropdown">
                    <a class="erp-topbar-icon-btn dropdown-toggle" href="#" data-toggle="dropdown" id="userMenuDropdown" aria-haspopup="true" aria-expanded="false" title="Cuenta de usuario">
                        <i class="fas fa-user-circle"></i>
                    </a>
                    <div class="dropdown-menu dropdown-menu-right erp-user-dropdown" aria-labelledby="userMenuDropdown">
                        <div class="erp-user-dropdown-header">
                            {% if user.worker_set.all %}
                                {% with w=user.worker_set.last %}
                                    <span class="erp-user-dropdown-name">{{ w.employee.names|default:user.username|upper|truncatewords:2 }}</span>
                                    {% for e in w.establishment_set.all %}
                                        {% if forloop.last %}
                                            <span class="erp-user-dropdown-subsidiary">{{ e.subsidiary.name|default:"-"|truncatechars:25 }}</span>
                                        {% endif %}
                                    {% empty %}
                                        <span class="erp-user-dropdown-subsidiary">-</span>
                                    {% endfor %}
                                {% endwith %}
                            {% else %}
                                <span class="erp-user-dropdown-name">{{ user.get_full_name|default:user.username|upper|truncatewords:2 }}</span>
                                <span class="erp-user-dropdown-subsidiary">Usuario</span>
                            {% endif %}
                        </div>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item" href="{% url 'dashboard' %}"><i class="fas fa-home"></i> Inicio</a>
                        <a class="dropdown-item" href="{% url 'hrm:profile' %}"><i class="fas fa-user"></i> Perfil</a>
                        <a class="dropdown-item" href="{% url 'hrm:settings_password' %}"><i class="fas fa-cog"></i> Configuración</a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item" href="#" data-toggle="modal" data-target="#modalSupportCenter"><i class="fas fa-life-ring"></i> Support Center</a>
                        <div class="dropdown-divider"></div>
                        <a class="dropdown-item text-danger" href="{% url 'logout' %}"><i class="fas fa-power-off"></i> Cerrar sesión</a>
                    </div>
                </div>
                <a href="{% url 'logout' %}" class="erp-topbar-icon-btn" title="Cerrar sesión">
                    <i class="fas fa-sign-out-alt"></i>
                </a>
            </div>
        </header>

        <!-- Contenido principal -->
        <main class="erp-main-content">
            {% block body %}
                <div class="container-fluid">
                    <div class="row justify-content-center align-items-center" style="min-height: 60vh;">
                        <div class="col text-center">
                            <img src="{% static 'assets/avatar/logo_anderquin_new.png' %}" class="img-fluid" alt="Logo Anderquin" style="max-width: 450px; opacity: 0.95;"/>
                            <p class="mt-4 text-muted" style="font-size: 1.1rem;">Bienvenido al Sistema ERP</p>
                        </div>
                    </div>
                </div>
            {% endblock body %}
        </main>
    </div>
</div>

<!-- Modal Support Center -->
<div class="modal fade" id="modalSupportCenter" tabindex="-1" role="dialog" aria-labelledby="modalSupportCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-sm" role="document">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 16px;">
            <div class="modal-header border-0 py-3" style="background: linear-gradient(135deg, #1565c0 0%, #0d47a1 100%); border-radius: 16px 16px 0 0;">
                <h6 class="modal-title text-white font-weight-bold" id="modalSupportCenterTitle">
                    <i class="fas fa-life-ring mr-2"></i>Support Center
                </h6>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Cerrar">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body py-4 px-4">
                <p class="mb-2"><strong>Ing. Jhon Olanda Salas</strong></p>
                <p class="mb-2 text-muted small">Sistema de Tecnología 4 Soluciones SAC</p>
                <p class="mb-0"><i class="fas fa-phone-alt text-primary mr-2"></i><a href="tel:958097875">958 097 875</a></p>
            </div>
        </div>
    </div>
</div>

<!--=============================================
=            Include JavaScript files           =
==============================================-->
<!-- jQuery V3.4.1 -->
<script src="{% static 'js/jquery-3.4.1.min.js' %}"></script>

<!-- jQuery UI -->
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.min.js"></script>

<!-- popper -->
<script src="{% static 'js/popper.min.js' %}"></script>

<!-- Bootstrap V4.3 -->
<script src="{% static 'js/bootstrap.min.js' %}"></script>

{#<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.min.js"></script>#}

<script src="https://cdn.jsdelivr.net/npm/tableexport.jquery.plugin@1.10.21/tableExport.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tableexport.jquery.plugin@1.10.21/libs/jsPDF/jspdf.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tableexport.jquery.plugin@1.10.21/libs/jsPDF-AutoTable/jspdf.plugin.autotable.js"></script>

<script src="https://unpkg.com/bootstrap-table@1.18.3/dist/bootstrap-table.min.js"></script>
<script src="https://unpkg.com/bootstrap-table@1.18.3/dist/extensions/print/bootstrap-table-print.min.js"></script>
<script src="https://unpkg.com/bootstrap-table@1.18.3/dist/extensions/export/bootstrap-table-export.min.js"></script>

<!-- jQuery Custom Content Scroller V3.1.5 -->
<script src="{% static 'js/jquery.mCustomScrollbar.concat.min.js' %}"></script>

<!-- Bootstrap Material Design V4.0 -->
<!-- <script src="{% static 'js/bootstrap-material-design.min.js' %}" ></script> -->
<!-- <script>$(document).ready(function() { $('body').bootstrapMaterialDesign(); });</script> -->

<!-- Simple javascript toast notifications -->
<script src="//cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/js/toastr.min.js"></script>

<script src="{% static 'js/main.js' %}"></script>
<script src="{% static 'js/sidebar.js' %}"></script>

<!-- DataTables JS -->
<script src="{% static 'assets/datatables/datatables.min.js' %}"></script>
<script src="{% static 'assets/datatables/datatables.language.js' %}"></script>
<!-- DataTables Select JS <script src="js/addons/datatables-select2.min.js" type="text/javascript"></script>-->
<script src="//cdn.datatables.net/buttons/1.6.5/js/dataTables.buttons.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
<script src="//cdn.datatables.net/buttons/1.6.5/js/buttons.html5.min.js"></script>
<script src="//cdn.datatables.net/buttons/1.6.5/js/buttons.print.min.js"></script>

<!-- Select2 - customizable select box -->
<script src="{% static 'js/select2.min.js' %}"></script>
<script src="{% static 'js/select2.full.min.js' %}"></script>

<!-- Chained - select depend -->
<script src="{% static 'js/jquery.chained.min.js' %}"></script>

<!-- ISOTOPE CDN -->
{#<script src="https://unpkg.com/isotope-layout@3/dist/isotope.pkgd.min.js"></script>#}

<script src="{% static 'js/isotope.pkgd.min.js' %}"></script>
<!-- TABLE2EXCEL CDN -->

<script src="{% static 'js/jquery.table2excel.min.js' %}"></script>

<!-- GRIDVIEW SCROLL - Freeze column and fixed header in Table or GridView -->
<script src="{% static 'js/gridviewscroll.js' %}"></script>

<script src="{% static 'js/sweetalert-dev.js' %}"></script>
<!-- Graphs -->
<script src="{% static 'js/canvasjs.min.js' %}"></script>
<script src="{% static 'js/jquery.bootstrap-duallistbox.min.js' %}"></script>

<script src="{% static 'js/autocomplete.js' %}"></script>

<script src="https://cdnjs.com/libraries/Chart.js"></script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.8.335/pdf.min.js"></script>

<script>
$(document).ready(function() {
    $('.js-switch-subsidiary').on('click', function(e) {
        e.preventDefault();
        var $btn = $(this);
        var workerId = $btn.data('worker-id');
        var subsidiaryId = $btn.data('subsidiary-id');
        var subsidiaryName = $btn.data('subsidiary-name');
        if (!workerId || !subsidiaryId) return;
        if ($btn.hasClass('active')) return;
        var $form = $('<form>').attr({ method: 'POST', action: '{% url "hrm:update_worker_establishment" %}' });
        $form.append($('<input>').attr({ type: 'hidden', name: 'csrfmiddlewaretoken', value: '{{ csrf_token }}' }));
        $form.append($('<input>').attr({ type: 'hidden', name: 'worker', value: workerId }));
        $form.append($('<input>').attr({ type: 'hidden', name: 'subsidiary', value: subsidiaryId }));
        $('body').append($form);
        $.ajax({
            url: '{% url "hrm:update_worker_establishment" %}',
            type: 'POST',
            data: { csrfmiddlewaretoken: '{{ csrf_token }}', worker: workerId, subsidiary: subsidiaryId },
            success: function() {
                toastr.success('Sucursal cambiada a: ' + subsidiaryName, '¡Listo!');
                setTimeout(function() { location.reload(); }, 500);
            },
            error: function(xhr) {
                toastr.error(xhr.responseJSON && xhr.responseJSON.error ? xhr.responseJSON.error : 'Error al cambiar sucursal', '¡Error!');
            }
        });
        $form.remove();
    });
});
</script>

{% block extrajs %}
{% endblock extrajs %}

</body>
</html>
