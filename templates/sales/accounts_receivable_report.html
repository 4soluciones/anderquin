{% extends 'home.html' %}

{% block title %}
   Cuentas por Cobrar
{% endblock title %}

{% block extra_css %}
    <link rel="stylesheet" href="/static/css/accounts_receivable.css">
{% endblock extra_css %}

{% block body %}
    <div class="container-fluid roboto-condensed-regular">
        <!-- Header del Reporte -->
        <div class="card-header text-left mt-2 mb-2 p-2 bg-gradient-primary text-white">
            <h3 class="mb-0 roboto-condensed-regular">
                <i class="fas fa-chart-line mr-2"></i>
                Reporte de Cuentas por Cobrar
            </h3>
        </div>

        <!-- Panel de Filtros -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0 roboto-condensed-regular">
                    <i class="fas fa-filter mr-2"></i>
                    Filtros de Búsqueda
                </h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <label class="form-label font-weight-bold">Cliente:</label>
                        <select class="form-control" id="id-client" name="client">
                            <option value="">Todos los clientes</option>
                            {% for client in clients %}
                                <option value="{{ client.id }}">{{ client.names }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label font-weight-bold">Fecha Inicial:</label>
                        <input type="date" class="form-control" id="id_date_initial" value="{{ formatdate }}" required>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label font-weight-bold">Fecha Final:</label>
                        <input type="date" class="form-control" id="id_date_final" value="{{ formatdate }}" required>
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button type="button" id="id_btn_show" class="btn btn-primary btn-block">
                            <i class="fas fa-search mr-2"></i>
                            Generar Reporte
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Loader -->
        <div class="loader-container col-auto" id="loader-report" style="display: none; opacity: 1.5; width: 100%; padding-top: 3em;">
            <div class="loader"></div>
        </div>

        <!-- Contenedor del Reporte -->
        <div id="table-list-accounts-receivable"></div>
    </div>

    <!-- Modal para Agregar Pago -->
    <div class="modal fade" id="modal-client-payment" tabindex="-1" role="dialog" aria-labelledby="clientPaymentModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" id="client-payment-content"></div>
    </div>

    <!-- Modal para Ver Archivo -->
    <div class="modal fade" id="fileModal" tabindex="-1" role="dialog" aria-labelledby="fileModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content bg-light">
                <div class="modal-header">
                    <input type="hidden" id="loan_payment" value="">
                    <h5 class="modal-title col-sm-6" id="fileModalLabel">Comprobante de Pago</h5>
                    <div class="col-sm-5">
                        <button type="button" id="btn_edit_container" class="btn-sm btn btn-outline-info">
                            <i class="fas fa-edit mr-1"></i>
                            Editar Archivo
                        </button>
                    </div>
                    <button type="button" id="closeModal" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body text-left">
                    <div class="card m-2 d-none" id="editContainer">
                        <table class="table table-sm bg-light mb-0">
                            <thead>
                            <tr class="text-uppercase font-weight-lighter">
                                <th class="border-bottom-0 align-middle">SUBIR NUEVO COMPROBANTE:</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr>
                                <td class="border-top-0 border-bottom align-middle">
                                    <div class="form-group m-0 w-100">
                                        <div class="input-group w-100">
                                            <div class="custom-file w-100">
                                                <input type="file" name="file" id="file_edit" style="font-size: 12px"/>
                                            </div>
                                        </div>
                                    </div>
                                </td>
                                <td class="border-top-0 align-middle text-center">
                                    <button type="button" id="btn-edit-file" class="btn btn-block btn-sm btn-warning">
                                        <i class="fas fa-save mr-1"></i>
                                        Guardar
                                    </button>
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="card m-2" id="fileContainer"></div>
                </div>
            </div>
        </div>
    </div>
{% endblock body %}

{% block extrajs %}
    <script type="text/javascript">
        // Loader personalizado
        loader = '<div class="container">' +
            '<div class="row">' +
            '<div class="col-md-12">' +
            '<div class="loader">' +
            '<p><strong>Generando reporte...</strong></p>' +
            '<div class="loader-inner"></div>' +
            '<div class="loader-inner"></div>' +
            '<div class="loader-inner"></div>' +
            '</div>' +
            '</div>' +
            '</div>' +
            '</div>';

        // Generar reporte
        $("#id_btn_show").click(function () {
            let _start_date = $('#id_date_initial').val();
            let _end_date = $('#id_date_final').val();
            let _client_id = $('#id-client').val();
            console.log(_start_date)
            console.log(_end_date)
            console.log(_start_date)

            if (_start_date && _end_date) {
                $('#table-list-accounts-receivable').empty();
                $('#loader-report').html(loader).show();
                
                console.log('Enviando datos AJAX:', {
                    'start-date': _start_date, 
                    'end-date': _end_date, 
                    'client_id': _client_id
                });
                
                $.ajax({
                    url: '/sales/accounts_receivable_report/',
                    async: true,
                    dataType: 'json',
                    type: 'POST',
                    data: {
                        'start-date': _start_date, 
                        'end-date': _end_date, 
                        'client_id': _client_id
                    },
                    headers: {"X-CSRFToken": '{{ csrf_token }}'},
                    success: function (response, textStatus, xhr) {
                        console.log('Respuesta exitosa:', response);
                        if (xhr.status === 200) {
                            $('#table-list-accounts-receivable').html(response.grid);
                            $('#loader-report').hide();
                        }
                    },
                    error: function (jqXhr, textStatus, xhr) {
                        console.log('Error en AJAX:', jqXhr, textStatus, xhr);
                        toastr.error('Error al generar el reporte', '¡Error!');
                        $('#loader-report').hide();
                    }
                });
            } else {
                toastr.warning('Seleccione las fechas de inicio y fin', 'Mensaje');
            }
        });

        // Abrir modal de pago
        $(document).on('click', '.btn-add-payment', function () {
            let _order_id = $(this).attr('data-order-id');
            let _client_id = $(this).attr('data-client-id');
            
            $.ajax({
                url: '/sales/get_client_payment_modal/',
                async: true,
                dataType: 'json',
                type: 'GET',
                data: {
                    'order_id': _order_id,
                    'client_id': _client_id
                },
                success: function (response) {
                    $('#client-payment-content').html(response.modal);
                    $('#modal-client-payment').modal('show');
                },
                error: function (response) {
                    toastr.error('Error al cargar el modal', '¡Error!');
                }
            });
        });

        // Guardar pago
        $(document).on('submit', '#form-client-payment', function (e) {
            e.preventDefault();
            
            let formData = new FormData(this);
            
            $.ajax({
                url: '/sales/save_client_payment/',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function (response) {
                    if (response.success) {
                        toastr.success(response.message, '¡Éxito!');
                        $('#modal-client-payment').modal('hide');
                        $("#id_btn_show").trigger('click'); // Recargar reporte
                    } else {
                        toastr.error(response.message, '¡Error!');
                    }
                },
                error: function (xhr, status, error) {
                    toastr.error('Error al guardar el pago', '¡Error!');
                }
            });
        });

        // Ver archivo de pago
        function loadFile(fileUrl, loanPayment) {
            var fileContainer = document.getElementById("fileContainer");
            fileContainer.innerHTML = '';
            document.getElementById("loan_payment").value = loanPayment;
            
            if (fileUrl === '/mediafiles/img/image_placeholder.jpg') {
                fileContainer.innerHTML = '<p class="text-muted">No se subió ningún archivo.</p>';
                return;
            }
            
            if (fileUrl.endsWith('.pdf')) {
                showPDF(fileUrl, 400, 500);
            } else {
                var img = document.createElement('img');
                img.src = fileUrl;
                img.style.maxWidth = '100%';
                img.style.height = 'auto';
                img.className = 'img-fluid';
                fileContainer.appendChild(img);
            }
        }

        function showPDF(pdfUrl, width, height) {
            var fileContainer = document.getElementById("fileContainer");
            fileContainer.innerHTML = '<canvas id="pdfViewer"></canvas>';
            var canvas = document.getElementById('pdfViewer');
            var ctx = canvas.getContext('2d');

            pdfjsLib.getDocument(pdfUrl).promise.then(function (pdf) {
                pdf.getPage(1).then(function (page) {
                    var viewport = page.getViewport({scale: 1});
                    var scale = Math.min(width / viewport.width, height / viewport.height);
                    var scaledViewport = page.getViewport({scale: scale});

                    canvas.width = scaledViewport.width;
                    canvas.height = scaledViewport.height;

                    page.render({
                        canvasContext: ctx,
                        viewport: scaledViewport
                    });
                });
            });
        }

        // Editar archivo
        $(document).on('click', '#btn_edit_container', function () {
            $('#editContainer').removeClass('d-none');
        });
        
        $(document).on('click', '#closeModal', function () {
            $('#editContainer').addClass('d-none');
        });

        // Guardar archivo editado
        document.addEventListener('DOMContentLoaded', function () {
            document.getElementById('btn-edit-file').addEventListener('click', function () {
                var fileInput = document.getElementById('file_edit');
                var file = fileInput.files[0];
                var loanPayment = document.getElementById('loan_payment').value;
                
                if (!file) {
                    alert('Por favor selecciona un archivo.');
                    return;
                }
                
                var formData = new FormData();
                formData.append('file', file);
                formData.append('loan_payment', loanPayment);
                
                var xhr = new XMLHttpRequest();
                xhr.open('POST', '/accounting/edit_file/', true);

                xhr.onload = function () {
                    if (xhr.status >= 200 && xhr.status < 400) {
                        var response = JSON.parse(xhr.responseText);
                        if (response.success) {
                            $('#fileModal').modal('hide');
                            toastr.success(response['message'], '¡Bien hecho!');
                            $("#id_btn_show").trigger('click');
                        } else {
                            alert(response.message);
                        }
                    } else {
                        alert('Error: ' + xhr.statusText);
                    }
                };
                xhr.onerror = function () {
                    alert('Error de red al intentar enviar el archivo');
                };

                xhr.send(formData);
            });
        });

        // Inicializar tooltips
        $(document).ready(function() {
            $('[data-toggle="tooltip"]').tooltip();
        });
    </script>
{% endblock extrajs %} 