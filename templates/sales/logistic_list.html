{% extends 'home.html' %}

{% block title %}
    Logística
{% endblock title %}

{% block body %}

    <div class="container-fluid py-4 roboto-condensed-regular" style="background-color: #e8f4f8; min-height: 100vh;">
        <!-- Encabezado y Contenido -->
        <div class="card border-0 shadow-lg mb-4 overflow-hidden" style="border-radius: 15px;">
            <div class="card-header py-3 position-relative" style="background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h3 class="text-white mb-0 font-weight-bold roboto-condensed-regular">
                            <i class="fas fa-truck-loading mr-2"></i> LOGÍSTICA - LISTADO DE FACTURAS POR INGRESAR
                        </h3>
                    </div>
                </div>
            </div>

            <div class="card-body border-bottom" style="background-color: #f0f8fc;">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <label class="small font-weight-bold text-uppercase text-muted mb-1">Buscar factura</label>
                        <div class="input-group shadow-sm border-0">
                            <div class="input-group-prepend">
                                <span class="input-group-text bg-white border-right-0"><i class="fas fa-search text-primary"></i></span>
                            </div>
                            <input id="myInput" type="text" placeholder="Ingrese factura a buscar..." aria-label="..."
                                   class="form-control form-control-lg text-uppercase border-left-0"
                                   style="border-radius: 0 5px 5px 0;">
                        </div>
                    </div>
                </div>
            </div>

            <div class="card-body p-0" style="background-color: #e3f2fd;">
                <div id="purchase-grid-list">{% include "sales/logistic_list_grid.html" %}</div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="assignment" data-backdrop="static" data-keyboard="false"
         tabindex="-1" role="dialog" aria-labelledby="ModalAssignmentTitle"
         aria-hidden="true"></div>

    <div class="modal fade" id="modal-credit-note" tabindex="-1" role="dialog"
         aria-labelledby="ModalHelpTitle"
         aria-hidden="true"></div>

    <style>
        .form-control:focus {
            box-shadow: 0 0 0 0.2rem rgba(30, 58, 95, 0.25);
            border-color: #1e3a5f;
        }
        #purchase-grid-list .card {
            background-color: transparent !important;
            box-shadow: none !important;
        }
        #purchase-list-with-bill td,
        #purchase-list-with-bill th {
            border-color: #bbdefb !important;
        }
        .input-icon {
            position: relative;
        }
        .input-icon > i {
            position: absolute;
            display: block;
            transform: translate(0, -50%);
            top: 50%;
            pointer-events: none;
            width: 25px;
            text-align: center;
            font-style: normal;
        }
        .input-icon > input {
            padding-left: 25px;
            padding-right: 8px;
        }
        .input-icon-right > i {
            right: 0;
        }
        .input-icon-right > input {
            padding-left: 0;
            padding-right: 25px;
            text-align: right;
        }
    </style>

{% endblock body %}

{% block extrajs %}

    <script type="text/javascript">

        $(document).on('click', '.assignment-store', function () {
            let search = $(this).attr('pk');
            $.ajax({
                url: '/sales/assign_to_warehouse/',
                dataType: 'json',
                type: 'GET',
                data: {'pk': search},
                contentType: 'application/json;charset=UTF-8',
                headers: {"X-CSRFToken": '{{ csrf_token }}'},
                success: function (response, textStatus, xhr) {
                    if (xhr.status === 200) {
                        $('#assignment').html(response.form);
                        $('#assignment').modal('show');
                    }
                },
                error: function (jqXhr, textStatus, xhr) {
                    toastr.error(jqXhr.responseJSON.detalle, '¡MENSAJE!');
                }

            });
        });

        $(document).on('click', '.btn-show-detail', function () {
            let bill_id = $(this).attr('pk');
            let _table = $(this).closest('td').parent('tr').next('tr').children('td.table-details-bill');
            let _icon = $(this).find('i.see-icon')

            if (_icon.hasClass("fas fa-sort-down fa-lg")) {
                _icon.removeClass('fas fa-sort-down fa-lg');
                _icon.addClass('fas fa-sort-up fa-lg')

                openDetail(bill_id, _table)
            } else {
                _icon.removeClass('fas fa-sort-up fa-lg');
                _icon.addClass('fas fa-sort-down fa-lg');

                closeDetail(_table)
            }
        });

        function openDetail(bill_id, _table) {
            $.ajax({
                url: '/sales/get_details_by_bill/',
                async: true,
                dataType: 'json',
                type: 'GET',
                data: {'bill_id': bill_id},
                success: function (response) {
                    _table.html(response.grid);
                    _table.parent('tr').slideDown("fast");
                },
            });
        }

        function closeDetail($td) {
            $td.parent('tr').slideUp("fast");
        }

        $(document).ready(function () {

            $("#myInput").on("keyup", function () {
                $("#purchase-list-with-bill tbody tr td").closest("tr").hide()
                var value = $(this).val().toUpperCase();
                if (value) {
                    $("#purchase-list-with-bill tbody tr td:contains('" + value + "')").each(function (index) {
                        const parent = $(this).closest("tr")
                        const rowspan = $(this).attr("rowspan")
                        if (rowspan !== undefined) {
                            var current = parent
                            for (var i = 0; i < rowspan; i++) {
                                current.show()
                                current = current.next()
                            }
                        } else {
                            parent.show()
                        }
                    })
                } else {
                    $("#purchase-list-with-bill tbody tr").next("tr.details").show()
                }
            });
        });

        $(document).on('keyup', '.item-quantity-batch', function () {
            let quantity_batch = $(this);
            let tr = $(this).closest('td').parent('tr.entered-quantity');
            let _quantity_principal;
            if (tr.find('input.quantity_entered_principal').val() !== undefined) {
                _quantity_principal = tr.find('input.quantity_entered_principal');
            } else {
                _quantity_principal = tr.find('input.quantity_entered_units');
            }
            if (_quantity_principal.val() <= 0) {
                toastr.warning("PRIMERO DIGITE LA CANTIDAD INGRESADA", '¡Error de datos!');
                quantity_batch.val('');
                return false;
            }
            let quantity_batch_in_units = $(this).closest('div.row.add-batch').find('input.item-quantity-units-batch')
            let _quantity_minimum = tr.find('input.quantity-minimum').val();
            quantity_batch_in_units.val(Number(quantity_batch.val()) * Number(_quantity_minimum))
        });

        $(document).on('keyup', '.item-quantity-units-batch', function () {
            let quantity_batch_units = $(this);
            let tr = $(this).closest('td').parent('tr.entered-quantity');
            let quantity_batch_principal = $(this).closest('div.row.add-batch').find('input.item-quantity-batch');
            let _quantity_minimum = tr.find('input.quantity-minimum').val();
            let multiply = Number(quantity_batch_units.val()) / Number(_quantity_minimum)
            quantity_batch_principal.val(multiply.toFixed(2))
        });


        /********* QUANTITY ENTERED  ***********/

        $(document).on('keyup', '.entered-quantity-principal', function () {
            let product_id = $(this).attr('p');
            let tbodyId = $(`#details-batch-${product_id}`);
            let quantity_minimum = tbodyId.parent('table').closest('tr').attr('qm');
            let result = sumQuantitiesBatch(tbodyId, quantity_minimum, product_id);
            if (result === false) {
                $(this).val('');
            }
        });
        $(document).on('keyup', '.entered-quantity-units', function () {
            let product_id = $(this).attr('p');
            let tbodyId = $(`#details-batch-${product_id}`);
            let quantity_minimum = tbodyId.parent('table').closest('tr').attr('qm');
            let result = sumQuantitiesBatch(tbodyId, quantity_minimum, product_id);
            if (result === false) {
                $(this).val('');
            }
        });

        /********* QUANTITY RETURNED  ***********/

        $(document).on('keyup', '.returned-quantity-principal', function () {
            let product_id = $(this).attr('p');
            let tbodyId = $(`#details-batch-${product_id}`);
            let quantity_minimum = tbodyId.parent('table').closest('tr').attr('qm');
            let result = sumQuantitiesBatch(tbodyId, quantity_minimum, product_id);
            if (result === false) {
                $(this).val('');
            }
        });
        $(document).on('keyup', '.returned-quantity-units', function () {
            let product_id = $(this).attr('p');
            let tbodyId = $(`#details-batch-${product_id}`);
            let quantity_minimum = tbodyId.parent('table').closest('tr').attr('qm');
            let result = sumQuantitiesBatch(tbodyId, quantity_minimum, product_id);
            if (result === false) {
                $(this).val('');
            }
        });

        /********* QUANTITY SOLD  ***********/

        $(document).on('keyup', '.sold-quantity-principal', function () {
            let product_id = $(this).attr('p');
            let tbodyId = $(`#details-batch-${product_id}`);
            let quantity_minimum = tbodyId.parent('table').closest('tr').attr('qm');
            let result = sumQuantitiesBatch(tbodyId, quantity_minimum, product_id);
            if (result === false) {
                $(this).val('');
            }
        });
        $(document).on('keyup', '.sold-quantity-units', function () {
            let product_id = $(this).attr('p');
            let tbodyId = $(`#details-batch-${product_id}`);
            let quantity_minimum = tbodyId.parent('table').closest('tr').attr('qm');
            let result = sumQuantitiesBatch(tbodyId, quantity_minimum, product_id);
            if (result === false) {
                $(this).val('');
            }
        });

        $(document).on('click', '.btn-generate-sold', function () {
            let store = $('#store');
            if (store.val() === '0' || store.val() === null) {
                toastr.warning('¡Seleccione el Almacén de Destino!', 'Error de Datos');
                return false;
            }

            let tr = $(this).closest('tr');
            let batch_number = tr.find('input.item-number-batch').val();
            let entered_principal = tr.find('input.entered-quantity-principal').val() || '',
                entered_units = tr.find('input.entered-quantity-units').val() || '';
            let sold_principal = tr.find('input.sold-quantity-principal').val() || '',
                sold_units = tr.find('input.sold-quantity-units').val() || '';

            // Validar: lote, cantidad ingresada y cantidad vendida antes de generar código
            if (!batch_number || batch_number.trim() === '') {
                toastr.warning('Debe ingresar el Nº de Lote antes de generar el código de venta', 'Error de Datos');
                return false;
            }
            if ((!entered_principal || parseFloat(entered_principal) <= 0) && (!entered_units || parseFloat(entered_units) <= 0)) {
                toastr.warning('Debe ingresar la cantidad INGRESADA antes de generar el código de venta', 'Error de Datos');
                return false;
            }
            if ((!sold_principal || parseFloat(sold_principal) <= 0) && (!sold_units || parseFloat(sold_units) <= 0)) {
                toastr.warning('Debe ingresar la cantidad VENDIDA antes de generar el código de venta', 'Error de Datos');
                return false;
            }

            let r = confirm("¿Está seguro de Generar la Venta?")
            if (r === true) {
                let _tr_detail = $(this).closest('table').parent('td').parent('tr');
                let check_sold = $(this).closest('table').find('thead tr td.title-sold input.check-sold');
                let _product_id = _tr_detail.attr('product');
                let input_principal;
                let input_principal_val = null;
                let unit_principal = null;
                let unit_id = tr.find('input.sold-quantity-units').attr('unit');
                let input_units = tr.find('input.sold-quantity-units');
                if (tr.find('input.sold-quantity-principal').val()) {
                    input_principal = tr.find('input.sold-quantity-principal');
                    input_principal_val = tr.find('input.sold-quantity-principal').val();
                    unit_principal = _tr_detail.attr("unit");
                }
                let _td_item_sold = $(this).closest('td.item-sold');
                if (_td_item_sold.length === 0) {
                    console.error('No se encontró td.item-sold');
                    toastr.error('Error al encontrar elementos del formulario', '¡ERROR!');
                    return false;
                }
                let _input_correlative = _td_item_sold.find('input.sale-cod');
                let _input_order = _td_item_sold.find('input.sale-id');
                let _btn_generate = _td_item_sold.find('button.btn-generate-sold');
                let _btn_cancel = _td_item_sold.find('button.btn-cancel-sold');
                
                // Verificar que se encontraron los elementos
                if (_input_correlative.length === 0 || _input_order.length === 0 || _btn_generate.length === 0 || _btn_cancel.length === 0) {
                    console.error('No se encontraron todos los elementos necesarios');
                    console.log('_input_correlative:', _input_correlative.length);
                    console.log('_input_order:', _input_order.length);
                    console.log('_btn_generate:', _btn_generate.length);
                    console.log('_btn_cancel:', _btn_cancel.length);
                }

                $.ajax({
                    url: '/sales/create_warehouse_sale/',
                    dataType: 'json',
                    type: 'GET',
                    data: {
                        'product_id': _product_id,
                        'unit_principal': unit_principal ? unit_principal : null,
                        'input_principal_val': input_principal_val,
                        'unit_id': unit_id,
                        'store': store.val(),
                        'input_units': input_units.val(),

                    },
                    contentType: 'application/json;charset=UTF-8',
                    headers: {"X-CSRFToken": '{{ csrf_token }}'},
                    success: function (response, textStatus, xhr) {
                        if (xhr.status === 200) {
                            let order_id = response.order_id;
                            if (order_id) {
                                _input_correlative.val(order_id).prop('readonly', true);
                                _input_order.val(order_id);
                                _btn_generate.addClass('d-none');
                                _btn_cancel.removeClass('d-none');
                                toastr.success('ID de orden ' + order_id + ' generado. Use este ID en el módulo de ventas.', '¡ID de Orden Generado!');
                            } else {
                                console.error('No se recibió order_id en la respuesta:', response);
                                toastr.error('No se recibió el ID de orden en la respuesta del servidor', '¡ERROR!');
                            }
                        }
                    },
                    error: function (jqXhr, textStatus, xhr) {
                        let errorMsg = 'Error al generar el ID de orden';
                        if (jqXhr.responseJSON && jqXhr.responseJSON.detalle) {
                            errorMsg = jqXhr.responseJSON.detalle;
                        } else if (jqXhr.responseJSON && jqXhr.responseJSON.error) {
                            errorMsg = jqXhr.responseJSON.error;
                        } else if (jqXhr.responseText) {
                            errorMsg = jqXhr.responseText;
                        }
                        console.error('Error en AJAX:', jqXhr);
                        toastr.error(errorMsg, '¡ERROR!');
                    }

                });

                if (input_principal) {
                    input_principal.prop('disabled', true);
                }
                check_sold.prop('disabled', true);
                input_units.prop('disabled', true);
            }
        });

        $(document).on('click', '.btn-cancel-sold', function () {
            let tr = $(this).closest('tr')
            let _td_item_sold = $(this).closest('td.item-sold');
            let _correlative = _td_item_sold.find('input.sale-cod');
            let _order_id = _td_item_sold.find('input.sale-id');
            let _btn_generate = _td_item_sold.find('button.btn-generate-sold');
            let _btn_cancel = _td_item_sold.find('button.btn-cancel-sold');
            let check_sold = $(this).closest('table').find('thead tr td.title-sold input.check-sold');
            let input_principal
            let input_units = tr.find('input.sold-quantity-units');
            if (tr.find('input.sold-quantity-principal').val()) {
                input_principal = tr.find('input.sold-quantity-principal');
            }

            let r = confirm("¿Está seguro de Eliminar la Venta?")
            if (r === true) {
                $.ajax({
                    url: '/sales/delete_warehouse_sale/',
                    dataType: 'json',
                    type: 'GET',
                    data: {'order_id': _order_id.val()},
                    contentType: 'application/json;charset=UTF-8',
                    headers: {"X-CSRFToken": '{{ csrf_token }}'},
                    success: function (response, textStatus, xhr) {
                        if (xhr.status === 200) {
                            _correlative.val("").prop('readonly', true);
                            _order_id.val("0");
                            _btn_generate.removeClass('d-none');
                            _btn_cancel.addClass('d-none');
                            check_sold.prop('disabled', false);
                            if (input_principal) {
                                input_principal.prop('disabled', false);
                            }
                            input_units.prop('disabled', false);
                            toastr.warning(response.message, '¡Operación Correcta!');
                        }
                    },
                    error: function (jqXhr, textStatus, xhr) {
                        toastr.error(jqXhr.responseJSON, '¡ERROR!');
                    }

                });
            }
        });

        function sumQuantitiesBatch(tbody, quantity_minimum, product_id) {
            let quantity_entered_principal = 0;
            let quantity_entered_units = 0;
            let tbody_product = $(`#details-product-${product_id}`);
            let current_quantity = tbody_product.find('tr.detail td.item-current-quantity input.current-quantity-missing');
            let quantity_missing = tbody_product.find('tr.detail td.item-current-quantity input.quantity-missing');

            tbody.find('tr').each(function () {
                let value = parseFloat($(this).find('input.entered-quantity-principal').val()) || 0;
                quantity_entered_principal += value;
            });
            let in_units_entered = Number(quantity_entered_principal) * Number(quantity_minimum)

            tbody.find('tr').each(function () {
                let value = parseFloat($(this).find('input.entered-quantity-units').val()) || 0;
                quantity_entered_units += value;
            });
            let sum_entered = in_units_entered + Number(quantity_entered_units)

            let quantity_returned_principal = 0;
            let quantity_returned_units = 0;
            tbody.find('tr').each(function () {
                let value = parseFloat($(this).find('input.returned-quantity-principal').val()) || 0;
                quantity_returned_principal += value;
            });
            let in_units_returned = Number(quantity_returned_principal) * Number(quantity_minimum)

            tbody.find('tr').each(function () {
                let value = parseFloat($(this).find('input.returned-quantity-units').val()) || 0;
                quantity_returned_units += value;
            });
            let sum_returned = in_units_returned + Number(quantity_returned_units)

            let quantity_sold_principal = 0;
            let quantity_sold_units = 0;
            tbody.find('tr').each(function () {
                let value = parseFloat($(this).find('input.sold-quantity-principal').val()) || 0;
                quantity_sold_principal += value;
            });
            let in_units_sold = Number(quantity_sold_principal) * Number(quantity_minimum)

            tbody.find('tr').each(function () {
                let value = parseFloat($(this).find('input.sold-quantity-units').val()) || 0;
                quantity_sold_units += value;
            });
            let sum_sold = in_units_sold + Number(quantity_sold_units)

            let sum_total_quantities = sum_entered + sum_returned + sum_sold;

            if (sum_total_quantities > Number(current_quantity.val())) {
                toastr.warning("La cantidad DIGITADA no puede superar a la cantidad COMPRADA", '¡MENSAJE!', {
                    positionClass: "toast-center",
                });
                return false;
            } else {
                let new_q_missing = Number(current_quantity.val()) - Number(sum_total_quantities)
                quantity_missing.val(new_q_missing.toFixed(2))
            }
        }

        function checkSaleCodAndCloseModal() {
            let allowClose = true;

            $(".sale-cod").each(function () {
                if ($(this).val() !== "") {
                    allowClose = false;
                }
            });
            return allowClose
        }
    </script>

{% endblock extrajs %}
