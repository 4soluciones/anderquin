{% load operations %}
<div class="modal-dialog modal-xl" role="document">

    <div class="modal-content border-0 shadow-lg" style="border-radius: 12px; overflow: hidden;">
        <div class="modal-header py-4" style="background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);">
            <div class="d-flex flex-column">
                <h5 class="modal-title text-white font-weight-bold roboto-condensed-regular mb-1">
                    <i class="fas fa-warehouse mr-2"></i>INGRESO A ALMACÉN
                </h5>
                <span class="text-white-50 small">Factura: {{ bill_obj }}</span>
                <span class="text-white font-weight-bold">{{ bill_obj.supplier.name }}</span>
            </div>
            <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close" style="opacity: 1;">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
        <div class="modal-body roboto-condensed-regular bg-light">
            <input type="hidden" id="bill_id" value="{{ bill_obj.id }}">

            <!-- Panel informativo del proceso -->
            <div class="alert alert-light border mb-3 shadow-sm" style="border-radius: 8px; border-left: 4px solid #1e3a5f !important;">
                <div class="d-flex align-items-start">
                    <div class="mr-3 mt-1">
                        <i class="fas fa-info-circle text-primary" style="font-size: 1.5rem;"></i>
                    </div>
                    <div>
                        <h6 class="font-weight-bold text-dark mb-2">Proceso de ingreso</h6>
                        <ol class="mb-0 pl-3 small text-muted">
                            <li><strong>Cantidad ingresada:</strong> Registre la cantidad que ingresa al almacén por cada lote.</li>
                            <li><strong>Devuelta:</strong> Marque si parte de la cantidad ingresada será devuelta al proveedor.</li>
                            <li><strong>Vendida:</strong> Marque si parte de la cantidad ingresada será vendida. Generará un <strong>código (ID Orden)</strong> para usar en el módulo de ventas.</li>
                        </ol>
                    </div>
                </div>
            </div>

            <div class="card border-0 shadow-sm mb-3" style="border-radius: 10px;">

                <div class="card-body">
                    <div class="row">
                        <div class="col-sm-4 col-md-4 col-lg-4">
                            <label for="store" class="small font-weight-bold text-uppercase text-muted mb-1">Almacén de destino</label>
                            <div class="input-group shadow-sm">
                                <div class="input-group-prepend">
                                    <span class="input-group-text bg-white"><i class="fas fa-warehouse text-primary"></i></span>
                                </div>
                                <select id="store" name="store" class="form-control" style="border-left: 0;">
                                    <option disabled selected value="0">Seleccione almacén</option>
                                    {% for s in subsidiary_stores %}
                                        <option value="{{ s.id }}">{{ s.subsidiary.name }} - ALMACÉN {{ s.name|upper }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="col-sm-4 col-md-4 col-lg-4">
                            <label for="assign_date" class="small font-weight-bold text-uppercase text-muted mb-1">Fecha de ingreso</label>
                            <div class="input-group shadow-sm">
                                <div class="input-group-prepend">
                                    <span class="input-group-text bg-white"><i class="far fa-calendar-alt text-primary"></i></span>
                                </div>
                                <input type="date" class="form-control" id="assign_date" name="assign_date"
                                       value="{{ bill_obj.register_date|date:'Y-m-d' }}" required style="border-left: 0;">
                            </div>
                        </div>

                        <div class="col-sm-4 col-md-4 col-lg-4">
                            <label for="guide_number" class="small font-weight-bold text-uppercase text-muted mb-1">Nº de guía</label>
                            <div class="input-group shadow-sm">
                                <div class="input-group-prepend">
                                    <span class="input-group-text bg-white"><i class="fas fa-file-alt text-primary"></i></span>
                                </div>
                                <input type="text" class="form-control text-uppercase" id="guide_number" name="guide_number"
                                       value="" placeholder="Opcional" style="border-left: 0;">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card border-0 shadow-sm m-0" style="border-radius: 10px;">
                    {% for d in detail_bill %}
                        <table class="table table-bordered align-content-center table-sm m-0 mb-2" id="table-detail-product-{{ d.product_id }}" style="background: #fff;">
                            <input type="hidden" class="unit-purchase" value="{{ d.unit_id }}">
                            <input type="hidden" class="price-unit-purchase" value="{{ d.price_unit }}">
                            <thead>
                            <tr style="background: #f8f9fa;">
                                <td colspan="2" class="border-0 py-2">
                                    <div class="d-flex align-items-center justify-content-center position-relative">
                                        <span class="font-weight-bold text-dark position-absolute" style="left: 0;">{{ d.product_name }}</span>
                                        <div class="d-flex align-items-center gap-2">
                                            <span class="badge badge-secondary px-3 py-2" style="font-size: 1rem;">
                                                <span class="text-white">CANTIDAD COMPRADA: </span>
                                                <span class="font-weight-bold text-white" style="font-size: 1.1rem;">
                                                    <input type="text" class="quantity-purchased-in-units bg-transparent border-0 text-center font-weight-bold text-white d-inline" style="width: 50px; font-size: 1.1rem;" value="{{ d.quantity }}" readonly>
                                                    {{ d.unit_description }}
                                                </span>
                                                {% if d.unit_name != 'UND' %}
                                                    <span class="text-white small" style="font-size: 0.65rem;">({{ d.quantity_in_units }} UND)</span>
                                                {% endif %}
                                            </span>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            <tr style="background: #e9ecef;">
                                <th class="align-middle text-center py-2" style="width: 90%">Despacho de cantidades</th>
                                <th class="align-middle text-center py-2" style="width: 10%; font-size: 0.8rem;">Cant. falt. (UND)</th>
                            </tr>
                            </thead>
                            <tbody id="details-product-{{ d.product_id }}">
                            <tr class="detail" product="{{ d.product_id }}" purchase_detail="{{ d.id }}"
                                qm="{{ d.quantity_minimum }}" unit="{{ d.unit_id }}" unit_name="{{ d.unit_name }}">
                                <td class="align-middle item-quantity text-center p-0">
                                    <table class="table table-sm table-bordered mb-0" id="table-product-{{ d.product_id }}" style="background: #fefefe;">
                                        <thead>
                                        <tr class="text-uppercase title" style="background: #f8f9fa; font-size: 0.75rem;">
                                            <td colspan="2"></td>
                                            <td {% if d.unit_name != 'UND' %}colspan="2"{% endif %} class="py-2" style="background: #d4edda;">Ingresada</td>
                                            <td class="title-return py-2" {% if d.unit_name != 'UND' %}colspan="2"{% endif %} style="background: #fff3cd;">
                                                <label class="mb-0 d-inline-flex align-items-center cursor-pointer" style="cursor: pointer;">
                                                    <input type="checkbox" class="form-check-input check-returned mr-1" p="{{ d.product_id }}" id="check-returned-{{ d.product_id }}">
                                                    <span>Devuelta</span>
                                                </label>
                                            </td>
                                            <td class="title-sold py-2" {% if d.unit_name != 'UND' %}colspan="2"{% endif %} style="background: #cce5ff;">
                                                <label class="mb-0 d-inline-flex align-items-center" style="cursor: pointer;">
                                                    <input type="checkbox" class="form-check-input check-sold mr-1" p="{{ d.product_id }}" id="check-sold-{{ d.product_id }}">
                                                    <span>Vendida</span>
                                                </label>
                                            </td>
                                            <!-- COMENTADO: Columna de código ya no es necesaria, se genera automáticamente
                                            <td class="item-sold d-none py-2" style="background: #d1ecf1;">ID Orden</td>
                                            -->
                                            <td colspan="2"></td>
                                        </tr>
                                        <tr class="sub-title" style="font-size: 0.7rem;">
                                            {% if d.unit_name == 'UND' %}
                                                <th class="py-1" style="width: 3%">#</th>
                                                <th class="py-1" style="width: 10%; background: #e8f5e9;">Nº Lote</th>
                                                <th class="py-1" style="width: 10%; background: #d4edda;">UNIDAD(ES)</th>
                                                <th class="py-1" style="width: 10%; background: #fff3cd;">UNIDAD(ES)</th>
                                                <th class="py-1" style="width: 10%; background: #cce5ff;">UNIDAD(ES)</th>
                                                <!-- COMENTADO: Columna de código ya no es necesaria
                                                <th class="py-1 item-sold d-none" style="width: 14%; background: #d1ecf1;">Código</th>
                                                -->
                                                <th class="py-1" style="width: 10%">Venc. Lote</th>
                                                <th class="py-1" style="width: 5%"></th>
                                            {% else %}
                                                <th class="py-1" style="width: 3%">#</th>
                                                <th class="py-1" style="width: 9%; background: #e8f5e9;">Nº Lote</th>
                                                <th class="py-1" style="width: 8%; background: #d4edda;">{{ d.unit_description }}</th>
                                                <th class="py-1" style="width: 8%; background: #d4edda;">UNIDAD(ES)</th>
                                                <th class="py-1" style="width: 8%; background: #fff3cd;">{{ d.unit_description }}</th>
                                                <th class="py-1" style="width: 8%; background: #fff3cd;">UNIDAD(ES)</th>
                                                <th class="py-1" style="width: 8%; background: #cce5ff;">{{ d.unit_description }}</th>
                                                <th class="py-1" style="width: 8%; background: #cce5ff;">UNIDAD(ES)</th>
                                                <!-- COMENTADO: Columna de código ya no es necesaria
                                                <th class="py-1 item-sold d-none" style="width: 12%; background: #d1ecf1;">Código</th>
                                                -->
                                                <th class="py-1" style="width: 9%">Fecha Venc. Lote</th>
                                                <th class="py-1" style="width: 5%"></th>
                                            {% endif %}
                                        </tr>
                                        </thead>
                                        <tbody id="details-batch-{{ d.product_id }}">
                                        <tr unit="{{ d.unit_id }}">
                                            <td class="text-center align-middle item-correlative">1</td>
                                            <td>
                                                <input type="text" aria-label=""
                                                       class="form-control text-center form-control-sm item-number-batch"
                                                       p="{{ d.product_id }}"
                                                       autocomplete="off">
                                            </td>
                                            {% if d.unit_name != 'UND' %}
                                                <td>
                                                    <input type="text" aria-label=""
                                                           class="form-control form-control-sm text-center entered-quantity-principal"
                                                           p="{{ d.product_id }}"
                                                           autocomplete="off">
                                                </td>
                                            {% endif %}
                                            <td>
                                                <input type="text" aria-label=""
                                                       class="form-control form-control-sm text-center entered-quantity-units"
                                                       p="{{ d.product_id }}"
                                                       autocomplete="off">
                                            </td>
                                            {% if d.unit_name != 'UND' %}
                                                <td>
                                                    <input type="text" aria-label=""
                                                           class="form-control form-control-sm text-center returned-quantity-principal"
                                                           p="{{ d.product_id }}"
                                                           disabled
                                                           autocomplete="off">
                                                </td>
                                            {% endif %}
                                            <td>
                                                <input type="text" aria-label=""
                                                       class="form-control form-control-sm text-center returned-quantity-units"
                                                       p="{{ d.product_id }}"
                                                       disabled
                                                       autocomplete="off">
                                            </td>
                                            {% if d.unit_name != 'UND' %}
                                                <td>
                                                    <input type="text" aria-label=""
                                                           class="form-control form-control-sm text-center sold-quantity-principal"
                                                           p="{{ d.product_id }}"
                                                           disabled
                                                           autocomplete="off">
                                                </td>
                                            {% endif %}
                                            <td>
                                                <input type="text" aria-label=""
                                                       class="form-control form-control-sm text-center sold-quantity-units"
                                                       unit="1" p="{{ d.product_id }}"
                                                       disabled
                                                       autocomplete="off">
                                            </td>
                                            <!-- COMENTADO: Columna de código ya no es necesaria, se genera automáticamente
                                            <td class="item-sold d-none">
                                                <div class="d-flex flex-column align-items-center">
                                                    <button type="button" class="btn btn-success btn-sm btn-generate-sold mb-1" title="Genera el ID de orden para usar en el módulo de ventas" style="white-space: nowrap;">
                                                        <i class="fas fa-barcode mr-1"></i>Obtener ID
                                                    </button>
                                                    <button type="button" class="btn btn-outline-danger btn-sm btn-cancel-sold d-none mb-1" style="white-space: nowrap;">
                                                        <i class="fas fa-times"></i> Anular
                                                    </button>
                                                    <input type="text" readonly class="form-control form-control-sm text-center font-weight-bold sale-cod bg-light mt-1" placeholder="ID Orden" p="{{ d.product_id }}" name="sale-cod" style="min-width: 100px;">
                                                    <input type="hidden" class="sale-id" value="0" name="sale-id">
                                                </div>
                                            </td>
                                            -->
                                            <td>
                                                <input type="date" aria-label=""
                                                       class="form-control form-control-sm item-expiration-batch"
                                                       p="{{ d.product_id }}"
                                                       id="batch_expiration_date"
                                                       value="{{ formatdate }}" required>
                                            </td>
                                            <td>
                                                <button id="id_add_new_batch" type="button" product="{{ d.product_id }}"
                                                        class="btn btn-primary btn-sm btn-block btn-add-batch"><i
                                                        class="fas fa-plus"></i></button>
                                            </td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </td>
                                <td class="align-middle text-center item-current-quantity bg-light">
                                    <input type="text" id="quantity-missing" class="form-control form-control-sm font-weight-bold text-center quantity-missing border-0 bg-transparent" readonly value="{{ d.quantity_in_units }}">
                                    <input type="hidden" id="current-quantity-missing" class="current-quantity-missing" value="{{ d.quantity_in_units }}">
                                </td>
                            </tr>
                            </tbody>
                        </table>
                    {% endfor %}
                </div>

            </div><!-- modal-body -->
            <div class="modal-footer bg-white border-top py-3">
                <button type="button" class="btn btn-outline-secondary font-weight-bold" id="close-modal" data-dismiss="modal">
                    <i class="fas fa-times mr-1"></i>Cerrar
                </button>
                <button id="assignment-changes" type="button" class="btn btn-primary font-weight-bold px-4 shadow-sm">
                    <i class="fas fa-save mr-1"></i>Guardar ingreso
                </button>
            </div>

        </div>
    </div>
</div>

<style>
    .toast-center { top: 5%; left: 50%; transform: translate(-50%, -50%); }
    .modal-content .form-control:focus {
        box-shadow: 0 0 0 0.2rem rgba(30, 58, 95, 0.25);
        border-color: #1e3a5f;
    }
    .modal-content .table td, .modal-content .table th { vertical-align: middle !important; }
    .modal-content .btn-add-batch { border-radius: 6px; }
    .modal-content .btn-delete-row { border-radius: 6px; }
    .cursor-pointer { cursor: pointer; }
</style>

<script type="text/javascript">

    function checkSold() {
        let check = false;
        $('table[id^="table-product-"] thead tr.title td.title-sold input[type="checkbox"]').each(function () {
            if ($(this).prop('checked')) {
                check = true;
            }
        });
        return check;
    }
    function checkBatch() {
        let hasError = false;
        $('tbody[id^="details-batch-"] tr').each(function () {
            let batchInput = $(this).find('input.item-number-batch');
            let enteredPrincipal = parseFloat($(this).find('input.entered-quantity-principal').val()) || 0;
            let enteredUnits = parseFloat($(this).find('input.entered-quantity-units').val()) || 0;
            let returnedPrincipal = parseFloat($(this).find('input.returned-quantity-principal').val()) || 0;
            let returnedUnits = parseFloat($(this).find('input.returned-quantity-units').val()) || 0;
            let soldPrincipal = parseFloat($(this).find('input.sold-quantity-principal').val()) || 0;
            let soldUnits = parseFloat($(this).find('input.sold-quantity-units').val()) || 0;
            let hasQuantity = (enteredPrincipal + enteredUnits + returnedPrincipal + returnedUnits + soldPrincipal + soldUnits) > 0;
            if (hasQuantity && (!batchInput.val() || batchInput.val().trim() === '')) {
                hasError = true;
                return false;
            }
        });
        return hasError;
    }

    $('#assignment-changes').click(async function () {

        let store = $('#store');
        let guide_number = $('#guide_number');
        if (store.val() === '0' || store.val() === null) {
            toastr.warning('¡Seleccione el Almacén de Destino!', 'Error de Datos');
            return false;
        }
        if (checkBatch() === true) {
            toastr.warning('Debe ingresar el Nº de Lote en todas las filas que tengan cantidades registradas.', 'Error de Datos');
            return false;
        }
        if (checkDuplicateBatchInForm()) {
            toastr.warning('No pueden haber dos lotes con el mismo número. Corrija los números de lote duplicados en el formulario.', 'Error de Datos');
            return false;
        }
        // Verificar que los números de lote no existan ya en la BD (mismo producto + mismo almacén)
        let batchChecks = []; // [{batchNumber, productId}, ...]
        $('tbody[id^="details-batch-"]').each(function () {
            let productId = $(this).attr('id').replace('details-batch-', '');
            let seenInProduct = {};
            $(this).find('tr').each(function () {
                let batchInput = $(this).find('input.item-number-batch');
                let batchNumber = (batchInput.val() || '').toString().trim();
                let enteredPrincipal = parseFloat($(this).find('input.entered-quantity-principal').val()) || 0;
                let enteredUnits = parseFloat($(this).find('input.entered-quantity-units').val()) || 0;
                let returnedPrincipal = parseFloat($(this).find('input.returned-quantity-principal').val()) || 0;
                let returnedUnits = parseFloat($(this).find('input.returned-quantity-units').val()) || 0;
                let soldPrincipal = parseFloat($(this).find('input.sold-quantity-principal').val()) || 0;
                let soldUnits = parseFloat($(this).find('input.sold-quantity-units').val()) || 0;
                let hasQuantity = (enteredPrincipal + enteredUnits + returnedPrincipal + returnedUnits + soldPrincipal + soldUnits) > 0;
                let key = batchNumber + '|' + productId;
                if (hasQuantity && batchNumber && !seenInProduct[key]) {
                    seenInProduct[key] = true;
                    batchChecks.push({batchNumber: batchNumber, productId: productId});
                }
            });
        });
        for (let i = 0; i < batchChecks.length; i++) {
            let existsInDb = await checkNumberBatch(batchChecks[i].batchNumber, store.val(), batchChecks[i].productId);
            if (existsInDb) {
                toastr.warning('El número de lote "' + batchChecks[i].batchNumber + '" ya existe en el almacén para este producto. No pueden haber dos lotes con el mismo número.', 'Error de Datos');
                return false;
            }
        }
        // COMENTADO: Validación de código de venta ya no es necesaria, se genera automáticamente
        /*
        // Validar: si hay cantidad vendida, debe tener código de venta generado
        let hasSoldWithoutOrder = false;
        $('tbody[id^="details-batch-"] tr').each(function () {
            let soldPrincipal = parseFloat($(this).find('input.sold-quantity-principal').val()) || 0;
            let soldUnits = parseFloat($(this).find('input.sold-quantity-units').val()) || 0;
            let orderId = $(this).find('input.sale-id').val() || '0';
            if ((soldPrincipal > 0 || soldUnits > 0) && (!orderId || orderId === '0')) {
                hasSoldWithoutOrder = true;
                return false; // break
            }
        });
        if (hasSoldWithoutOrder) {
            toastr.warning('Las cantidades VENDIDAS deben tener el ID de orden generado. Ingrese Nº Lote, cantidad ingresada, cantidad vendida y haga clic en "Obtener ID" antes de guardar.', 'Error de Datos');
            return false;
        }
        */
        let details_bill = {
            "Details": [],
            "Bill": $('#bill_id').val(),
            "AssignDate": $('#assign_date').val(),
            "GuideNumber": guide_number.val(),
            "Store": store.val(),
        };
        //let shouldStop = false;
        //let promises = [];
        $('table[id^="table-detail-product-"]').each(async function () {
            let tr = $(this).find('tbody tr.detail');

            let detailObj = {
                "PurchaseDetail": tr.attr('purchase_detail'),
                "Product": tr.attr('product'),
                "UnitPurchase": $(this).find("input.unit-purchase").val(),
                "PricePurchase": $(this).find("input.price-unit-purchase").val(),
                "QuantityPurchased": $(this).find("input.quantity-purchased-in-units").val(),
                "SumQuantityEnteredPrincipal": 0,
                "SumQuantityEnteredUnits": 0,
                "SumQuantityEnteredTotalInUnits": 0,
                "SumQuantityReturnedPrincipal": 0,
                "SumQuantityReturnedUnits": 0,
                "SumQuantityReturnedTotalInUnits": 0,
                "SumQuantitySoldPrincipal": 0,
                "SumQuantitySoldUnits": 0,
                "SumQuantitySoldTotalInUnits": 0,
                "Batch": [],
            };
            details_bill.Details.push(detailObj);
            let SumQuantityEnteredPrincipal = 0
            let SumQuantityEnteredUnits = 0
            let SumQuantityReturnedPrincipal = 0
            let SumQuantityReturnedUnits = 0
            let SumQuantitySoldPrincipal = 0
            let SumQuantitySoldUnits = 0
            tr.find('tbody[id^="details-batch-"] tr').each(function () {
                let _entered_quantity_principal = $(this).find('input.entered-quantity-principal').val() !== undefined ? $(this).find('input.entered-quantity-principal').val() : 0;
                let _entered_quantity_units = $(this).find('input.entered-quantity-units').val();
                let _returned_quantity_principal = $(this).find('input.returned-quantity-principal').val() !== undefined ? $(this).find('input.returned-quantity-principal').val() : 0;
                let _returned_quantity_units = $(this).find('input.returned-quantity-units').val();
                let _sold_quantity_principal = $(this).find('input.sold-quantity-principal').val() !== undefined ? $(this).find('input.sold-quantity-principal').val() : 0;
                let _sold_quantity_units = $(this).find('input.sold-quantity-units').val();
                // COMENTADO: Ya no se necesita obtener el order_id, se genera automáticamente
                // let _order = $(this).find('td.item-sold input.sale-id').val();
                let _order = '0'; // Se generará automáticamente en el backend

                SumQuantityEnteredPrincipal += Number(_entered_quantity_principal);
                SumQuantityEnteredUnits += Number(_entered_quantity_units);
                SumQuantityReturnedPrincipal += Number(_returned_quantity_principal);
                SumQuantityReturnedUnits += Number(_returned_quantity_units);
                SumQuantitySoldPrincipal += Number(_sold_quantity_principal);
                SumQuantitySoldUnits += Number(_sold_quantity_units);

                let batchObj = {
                    "batchNumber": $(this).find('input.item-number-batch').val(),
                    "EnteredQuantityPrincipal": Number(_entered_quantity_principal),
                    "EnteredQuantityUnits": Number(_entered_quantity_units),
                    "batchExpiration": $(this).find('input.item-expiration-batch').val(),
                    "ReturnedQuantityPrincipal": Number(_returned_quantity_principal),
                    "ReturnedQuantityUnits": Number(_returned_quantity_units),
                    "SoldQuantityPrincipal": Number(_sold_quantity_principal),
                    "SoldQuantityUnit": Number(_sold_quantity_units),
                    "SoldOrderId": '0', // COMENTADO: Se generará automáticamente en el backend
                };
                detailObj.Batch.push(batchObj);
            });
            detailObj.SumQuantityEnteredPrincipal = SumQuantityEnteredPrincipal;
            detailObj.SumQuantityEnteredUnits = SumQuantityEnteredUnits;
            detailObj.SumQuantityEnteredTotalInUnits = SumQuantityEnteredUnits + SumQuantityEnteredPrincipal;

            detailObj.SumQuantityReturnedPrincipal = SumQuantityReturnedPrincipal;
            detailObj.SumQuantityReturnedUnits = SumQuantityReturnedUnits;
            detailObj.SumQuantityReturnedTotalInUnits = SumQuantityReturnedUnits + SumQuantityReturnedPrincipal;

            detailObj.SumQuantitySoldPrincipal = SumQuantitySoldPrincipal;
            detailObj.SumQuantitySoldUnits = SumQuantitySoldUnits;
            detailObj.SumQuantitySoldTotalInUnits = SumQuantitySoldUnits + SumQuantitySoldPrincipal;
        });


        console.log(details_bill);
        $.ajax({
            url: '/sales/save_detail_to_warehouse/',
            async: true,
            dataType: 'json', // for response
            type: 'GET',
            data: {'details': JSON.stringify(details_bill)},
            contentType: 'application/json;charset=UTF-8',
            headers: {"X-CSRFToken": '{{ csrf_token }}'},
            success: function (response, textStatus, xhr) {
                if (xhr.status === 200 && response.success && response.summary_html) {
                    toastr.success(response.message, '¡Operación Exitosa!');
                    // Ocultar tabla de despacho de cantidades y datos generales
                    $('.card:has(.card-body:has(#products-table))').hide();
                    $('.card:has(.card-body:has(#store))').hide();
                    $('.alert.alert-light').hide();
                    // Mostrar resumen
                    $('.modal-body').prepend(response.summary_html);
                    // Deshabilitar botón de guardar
                    $('#assignment-changes').prop('disabled', true).html('<i class="fas fa-check mr-1"></i>Guardado');
                    // Cambiar botón cerrar
                    $('#close-modal').html('<i class="fas fa-times mr-1"></i>Cerrar');
                } else if (xhr.status === 200) {
                    toastr.success(response.message, '¡Operación Exitosa!');
                    setTimeout(() => {
                        location.reload();
                    }, 500);
                }
            },
            error: function (jqXhr, textStatus, xhr) {
                let msg = 'Error al guardar. Verifique los datos.';
                if (jqXhr.responseJSON) {
                    msg = jqXhr.responseJSON.error || jqXhr.responseJSON.detalle || msg;
                }
                toastr.error(msg, '¡ERROR!');
            }
        });
    })

    /**
     * Verifica si el número de lote ya existe en la BD para ese producto en ese almacén.
     * Consulta la view check_batch_number que valida contra la base de datos.
     * @param {string} number_batch - Número del lote
     * @param {string|number} subsidiary_store - ID del almacén
     * @param {string|number} product_id - ID del producto
     * @returns {Promise<boolean>} true = el lote ya existe (duplicado), false = no existe (válido)
     */
    async function checkNumberBatch(number_batch, subsidiary_store, product_id) {
        try {
            const response = await $.ajax({
                url: '/sales/check_batch_number/',
                dataType: 'json',
                type: 'GET',
                data: {
                    'number_batch': String(number_batch || '').trim(),
                    'subsidiary_store': subsidiary_store,
                    'product_id': product_id,
                },
                headers: {"X-CSRFToken": '{{ csrf_token }}'},
            });
            return response.flag === true;
        } catch (e) {
            toastr.error('Error al verificar el número de lote.', '¡ERROR!');
            return true; // En caso de error, bloquear para evitar guardar datos inválidos
        }
    }

    /**
     * Verifica que no haya números de lote duplicados dentro del mismo producto en el formulario.
     * @returns {boolean} true = hay duplicados (error), false = no hay duplicados (OK)
     */
    function checkDuplicateBatchInForm() {
        let hasDuplicate = false;
        $('tbody[id^="details-batch-"]').each(function () {
            let productId = $(this).attr('id').replace('details-batch-', '');
            let batchNumbersSeen = {};
            $(this).find('tr').each(function () {
                let batchInput = $(this).find('input.item-number-batch');
                let batchNumber = (batchInput.val() || '').toString().trim();
                let enteredPrincipal = parseFloat($(this).find('input.entered-quantity-principal').val()) || 0;
                let enteredUnits = parseFloat($(this).find('input.entered-quantity-units').val()) || 0;
                let returnedPrincipal = parseFloat($(this).find('input.returned-quantity-principal').val()) || 0;
                let returnedUnits = parseFloat($(this).find('input.returned-quantity-units').val()) || 0;
                let soldPrincipal = parseFloat($(this).find('input.sold-quantity-principal').val()) || 0;
                let soldUnits = parseFloat($(this).find('input.sold-quantity-units').val()) || 0;
                let hasQuantity = (enteredPrincipal + enteredUnits + returnedPrincipal + returnedUnits + soldPrincipal + soldUnits) > 0;

                if (hasQuantity && batchNumber) {
                    if (batchNumbersSeen[batchNumber]) {
                        hasDuplicate = true;
                        return false;
                    }
                    batchNumbersSeen[batchNumber] = true;
                }
            });
            if (hasDuplicate) return false;
        });
        return hasDuplicate;
    }


    $('.returned-quantity-check').change(function () {
        let _input_entered_unit = $(this).closest('tr').parent('tbody#details').find('tr.entered-quantity td.quantity-entered input.quantity_entered_units').val()
        let _input_entered_principal = $(this).closest('tr').parent('tbody#details').find('tr.entered-quantity td.quantity-entered input.quantity_entered_principal').val()

        let _table = $(this).closest('tr').find('td.quantity-returned table.table-quantity-returned');
        let _input_und = _table.find('tr.returned-quantity-und input.returned_quantity_entered_units');
        let _input_principal = _table.find('tr.returned-quantity-principal input.returned_quantity_entered_principal');

        if (!(Number(_input_entered_unit) > 0 || Number(_input_entered_principal) > 0)) {
            if (!(Number(_input_und.val()) > 0 || Number(_input_principal.val()) > 0)) {
                toastr.warning('Antes de DEVOLVER, Favor de registrar la cantidad ingresada', '¡MENSAJE!');
                $(this).prop('checked', false);
                return;
            }
        }

        if ($(this).is(':checked')) {
            _input_und.prop('disabled', false);
            _input_principal.prop('disabled', false);
        } else {
            _input_und.prop('disabled', true);
            _input_principal.prop('disabled', true);
            _input_und.val('0');
            _input_principal.val('0');
            $('.quantity_entered_principal').trigger('keyup');
            $('.quantity_entered_units').trigger('keyup');
        }
    });

    $('.check-quantity-sold').change(function () {
        let _tr = $(this).closest('tr.sold-quantity-units');
        // let _tbody = _tr.parent('tbody#details');
        let _input_entered_principal = _tr.prevUntil('tr.entered-quantity').prev('tr.entered-quantity').find('td.quantity-entered input.quantity_entered_principal').val()
        let _input_entered_unit = _tr.prevUntil('tr.entered-quantity').prev('tr.entered-quantity').find('td.quantity-entered input.quantity_entered_units').val()
        let _tr_sold = _tr.next('tr.sold');

        let _table = _tr.find('td.quantity-sold table.table-sold');
        let _input_und = _table.find('tr.sold-quantity-und input.quantity_sold_units');
        let _input_principal = _table.find('tr.sold-quantity-principal input.quantity_sold_principal');

        if (!(Number(_input_entered_unit) > 0 || Number(_input_entered_principal) > 0)) {
            if (!(Number(_input_und.val()) > 0 || Number(_input_principal.val()) > 0)) {
                toastr.warning('Antes de VENDER, Favor de registrar la cantidad ingresada', '¡MENSAJE!');
                $(this).prop('checked', false);
                return;
            }
        }
        if ($(this).is(':checked')) {
            _input_und.prop('disabled', false);
            _input_principal.prop('disabled', false);
            _tr_sold.removeClass('d-none')
        } else {
            _tr_sold.addClass('d-none')
            _input_und.prop('disabled', true);
            _input_principal.prop('disabled', true);
            _input_und.val('0');
            _input_principal.val('0');
            //$(this).closest('tbody#details').find('tr.sold-quantity table.table-sold td.item-quantity-sold input.quantity-purchased-sold').val('0');
            //$(this).closest('tbody#details').find('tr.sold-quantity table.table-sold td.item-total-sold input.total-sold').val('0.00');
            $('.returned_quantity_entered_principal').trigger('keyup')
            $('.returned_quantity_entered_units').trigger('keyup')
        }

    });

    /********* QUANTITY ENTERED  ***********/

    $('.quantity_entered_principal').keyup(function () {

        let _tr = $(this).closest('tr.entered-quantity');
        let _tr_returned = _tr.next('tr.returned-quantity');
        let _tr_sold = _tr.nextUntil('tr.sold-quantity-units').next('tr.sold-quantity-units');
        sumQuantitiesMissing(_tr, _tr_returned, _tr_sold, 'pri', 'in')
    });

    $('.quantity_entered_units').keyup(function () {

        let _tr = $(this).closest('tr.entered-quantity');
        let _tr_returned = _tr.next('tr.returned-quantity');
        let _tr_sold = _tr.nextUntil('tr.sold-quantity-units').next('tr.sold-quantity-units');
        sumQuantitiesMissing(_tr, _tr_returned, _tr_sold, 'und', 'in')
    });

    /********* END QUANTITY ENTERED  ***********/

    /********* QUANTITY RETURNED  ***********/

    $('.returned_quantity_entered_principal').keyup(function () {

        let _tr = $(this).closest('tr.returned-quantity');
        let _tr_entered = _tr.prev('tr.entered-quantity');
        let _tr_sold = _tr.next('tr.sold-quantity-units');
        sumQuantitiesMissing(_tr_entered, _tr, _tr_sold, 'pri', 'return')
    });

    $('.returned_quantity_entered_units').keyup(function () {

        let _tr = $(this).closest('tr.returned-quantity');
        let _tr_entered = _tr.prev('tr.entered-quantity');
        let _tr_sold = _tr.next('tr.sold-quantity-units');
        sumQuantitiesMissing(_tr_entered, _tr, _tr_sold, 'und', 'return')
    });

    /********* END QUANTITY RETURNED  ***********/

    /********* QUANTITY SOLD  ***********/

    $('.quantity_sold_principal').keyup(function () {

        let _tr = $(this).closest('tr.sold-quantity-units');
        let _tr_entered = _tr.prevUntil('tr.entered-quantity').prev('tr.entered-quantity');
        let _tr_return = _tr.prev('tr.returned-quantity');
        sumQuantitiesMissing(_tr_entered, _tr_return, _tr, 'pri', 'sold')
    });

    $('.quantity_sold_units').keyup(function () {

        let _tr = $(this).closest('tr.sold-quantity-units');
        let _tr_entered = _tr.prevUntil('tr.entered-quantity').prev('tr.entered-quantity');
        let _tr_return = _tr.prev('tr.returned-quantity');
        sumQuantitiesMissing(_tr_entered, _tr_return, _tr, 'und', 'sold')
    });

    // COMENTADO: Función ya no es necesaria, el código se genera automáticamente
    /*
    function checkSaleCodAndCloseModal() {
        let allowClose = true;

        $(".sale-cod").each(function () {
            if ($(this).val() !== "") {
                allowClose = false;
            }
        });
        return allowClose
    }
    */
    function checkSaleCodAndCloseModal() {
        // Siempre permite cerrar, ya que el código se genera automáticamente
        return true;
    }

    $('#close-modal, .close').click(function () {
        // COMENTADO: Ya no se necesita validar, el código se genera automáticamente al guardar
        let allowClose = checkSaleCodAndCloseModal();
        if (allowClose) {
            // Si el ingreso fue guardado y se muestra el resumen, recargar la página principal al cerrar
            if ($('#assignment-changes').prop('disabled')) {
                location.reload();
            } else {
                $('#assignment').modal('hide');
            }
        } else {
            // COMENTADO: Este mensaje ya no es necesario
            // toastr.error('No puedes cerrar la ventana si ya se genero la venta, completa el guardado o Anula la venta');
            return false;
        }
    });

    /*$('.btn-cancel-sold').click(function () {
        let _correlative = $(this).parent('div').parent('div.row').find('div.item-sale input.sale-cod');
        let _order_id = $(this).parent('div').parent('div.row').find('div.item-sale input.sale-id');
        let _div_sale = $(this).parent('div').parent('div.row').find('div.sale');
        let _div_cancel = $(this).parent('div').parent('div.row').find('div.delete-sale');
        let check_sold = $(this).closest('tr').parent('tbody#details').find('tr.sold-quantity-units td.item-check-sold input.check-quantity-sold')
        let input_principal
        let input_units = $(this).closest('tr').parent('tbody#details').find('tr.sold-quantity-units td.quantity-sold input.quantity_sold_units');
        if ($(this).closest('tr').parent('tbody#details').find('tr.sold-quantity-units td.quantity-sold input.quantity_sold_principal').val()) {
            input_principal = $(this).closest('tr').parent('tbody#details').find('tr.sold-quantity-units td.quantity-sold input.quantity_sold_principal');
        }
        let r = confirm("¿Esta seguro de Eliminar la Venta")
        if (r === true) {
            /*$.ajax({
                url: '/sales/delete_warehouse_sale/',
                dataType: 'json',
                type: 'GET',
                data: {'order_id': _order_id.val()},
                contentType: 'application/json;charset=UTF-8',
                headers: {"X-CSRFToken": '{{ csrf_token }}'},
                success: function (response, textStatus, xhr) {
                    if (xhr.status === 200) {
                        _correlative.val("");
                        _order_id.val("");
                        _div_sale.removeClass('d-none');
                        _div_cancel.addClass('d-none');
                        check_sold.prop('disabled', false);
                        if (input_principal) {
                            input_principal.prop('disabled', false);
                        }
                        input_units.prop('disabled', false);
                        toastr.warning(response.message, '¡Operación Correcta!');
                    }
                },
                error: function (jqXhr, textStatus, xhr) {
                    toastr.error(jqXhr.responseJSON, '¡ERROR!');
                }

            });
        }
    });*/

    /********* END QUANTITY SOLD  ***********/

    function sumQuantitiesMissing(_tr_in, tr_return, tr_sold, type_unit, type_op) {

        let _quantity_missing = _tr_in.find('td.item-quantity-missing input.quantity-missing');
        let _quantity_missing_val = _quantity_missing.val();
        let _current_quantity_missing = _tr_in.find('td.item-quantity-missing input.current-quantity-missing');
        let _quantity_minimum = _tr_in.find('input.quantity-minimum').val();

        let _quantity_principal;
        let _quantity_principal_val = 0;
        let _q_unit = _tr_in.find('tr.quantity-und input.quantity_entered_units');

        let _quantity_returned_principal;
        let _quantity_returned_principal_val = 0
        let _q_returned_unit = tr_return.find('tr.returned-quantity-und input.returned_quantity_entered_units');

        let _quantity_sold_principal;
        let _quantity_sold_principal_val = 0
        let _q_sold_unit = tr_sold.find('tr.sold-quantity-und input.quantity_sold_units');

        if (_tr_in.find('input.quantity_entered_principal').val() !== undefined) {
            _quantity_principal = _tr_in.find('input.quantity_entered_principal');
            _quantity_principal_val = _tr_in.find('input.quantity_entered_principal').val();
        }
        if (tr_return.find('input.returned_quantity_entered_principal').val() !== undefined) {
            _quantity_returned_principal = tr_return.find('input.returned_quantity_entered_principal');
            _quantity_returned_principal_val = tr_return.find('input.returned_quantity_entered_principal').val();
        }
        if (tr_sold.find('input.quantity_sold_principal').val() !== undefined) {
            _quantity_sold_principal = tr_sold.find('input.quantity_sold_principal');
            _quantity_sold_principal_val = tr_sold.find('input.quantity_sold_principal').val();
        }

        let q_in_units_principal_entered = Number(_quantity_principal_val) * Number(_quantity_minimum)
        let q_in_units_principal_returned = Number(_quantity_returned_principal_val) * Number(_quantity_minimum)
        let q_in_units_principal_sold = Number(_quantity_sold_principal_val) * Number(_quantity_minimum)
        let sum_quantities_entered = q_in_units_principal_entered + Number(_q_unit.val())
        let sum_quantities_returned = q_in_units_principal_returned + Number(_q_returned_unit.val())
        let sum_quantities_sold = q_in_units_principal_sold + Number(_q_sold_unit.val())

        let sum_total_quantities = sum_quantities_entered + sum_quantities_returned + sum_quantities_sold

        if (type_op === 'in') {
            if (sum_total_quantities > Number(_current_quantity_missing.val())) {
                toastr.warning("La cantidad INGRESADA no puede superar a la cantidad COMPRADA", '¡MENSAJE!', {
                    positionClass: "toast-center",
                });
                if (type_unit === 'und') {
                    _q_unit.val('')
                    let sum_new = Number(q_in_units_principal_entered) + Number(sum_quantities_returned) + Number(sum_quantities_sold)
                    let new_q_missing = Number(sum_new) - Number(_current_quantity_missing.val())
                    _quantity_missing_val = Math.abs(new_q_missing).toFixed(2)
                    _quantity_missing.val(_quantity_missing_val)
                } else {
                    _quantity_principal.val('')
                    let new_q_missing = (Number(_q_unit.val()) + Number(sum_quantities_returned) + Number(sum_quantities_sold)) - Number(_current_quantity_missing.val())
                    _quantity_missing_val = Math.abs(new_q_missing).toFixed(2)
                    _quantity_missing.val(_quantity_missing_val)
                }
                return false;
            } else {
                let new_q_missing = Number(_current_quantity_missing.val()) - Number(sum_total_quantities)
                _quantity_missing.val(new_q_missing.toFixed(2))
            }
        } else if (type_op === 'return') {
            if (sum_total_quantities > Number(_current_quantity_missing.val())) {
                toastr.warning("La cantidad DEVUELTA no puede superar a la cantidad FALTANTE", '¡MENSAJE!', {
                    positionClass: "toast-center",
                });
                if (type_unit === 'und') {
                    _q_returned_unit.val('')
                    let sum_new = Number(sum_quantities_entered) + Number(q_in_units_principal_returned) + Number(sum_quantities_sold)
                    let new_q_missing = Number(sum_new) - Number(_current_quantity_missing.val())
                    _quantity_missing.val(Math.abs(new_q_missing).toFixed(2))
                } else {
                    _quantity_returned_principal.val('')
                    let new_q_missing = (Number(sum_quantities_entered) + Number(_q_returned_unit.val()) + Number(sum_quantities_sold)) - Number(_current_quantity_missing.val())
                    _quantity_missing_val = Math.abs(new_q_missing).toFixed(2)
                    _quantity_missing.val(_quantity_missing_val)
                }
                return false;
            } else {
                let new_q_missing = Number(_current_quantity_missing.val()) - Number(sum_total_quantities)
                _quantity_missing.val(new_q_missing.toFixed(2))
            }
        } else if (type_op === 'sold') {
            if (sum_total_quantities > Number(_current_quantity_missing.val())) {
                toastr.warning("La cantidad VENDIDA no puede superar a la cantidad FALTANTE", '¡MENSAJE!', {
                    positionClass: "toast-center",
                });
                if (type_unit === 'und') {
                    _q_sold_unit.val('')
                    let sum_new = Number(sum_quantities_entered) + Number(sum_quantities_returned) + Number(q_in_units_principal_sold)
                    let new_q_missing = Number(sum_new) - Number(_current_quantity_missing.val())
                    _quantity_missing.val(Math.abs(new_q_missing).toFixed(2))
                } else {
                    _quantity_sold_principal.val('');
                    let new_q_missing = (Number(sum_quantities_entered) + Number(sum_quantities_returned) + Number(_q_sold_unit.val())) - Number(_current_quantity_missing.val())
                    _quantity_missing_val = Math.abs(new_q_missing).toFixed(2)
                    _quantity_missing.val(_quantity_missing_val)
                }
                return false;
            } else {
                let new_q_missing = Number(_current_quantity_missing.val()) - Number(sum_total_quantities)
                _quantity_missing.val(new_q_missing.toFixed(2))
            }
        }
    }

    $('.btn-add-batch').click(function () {
        let product_id = $(this).attr("product");
        let formattedDate = "{{ formatdate|escapejs }}";
        let check_sold = $(this).closest('tr').parent('tbody').parent('table').find('thead tr td.title-sold input.check-sold');
        let check_return = $(this).closest('tr').parent('tbody').parent('table').find('thead tr td.title-return input.check-returned');
        let unit_name = $(this).closest('table').parent('td').parent('tr').attr('unit_name');
        let itemSoldClass = 'd-none';
        let attrDisabled = 'disabled';
        let attrDisabledReturn = 'disabled';
        let enteredQuantityPrincipalCell = '';
        let returnedQuantityPrincipalCell = '';
        let soldQuantityPrincipalCell = '';
        if (check_sold.is(':checked')) {
            itemSoldClass = '';
            attrDisabled = '';
        }
        if (check_return.is(':checked')) {
            attrDisabledReturn = '';
        }
        if (unit_name !== 'UND') {
            enteredQuantityPrincipalCell = `<td><input type="text" class="form-control form-control-sm text-center entered-quantity-principal" p="${product_id}"></td>`;
            returnedQuantityPrincipalCell = `<td><input type="text" class="form-control form-control-sm text-center returned-quantity-principal" p="${product_id}" ${attrDisabledReturn}></td>`;
            soldQuantityPrincipalCell = `<td><input type="text" class="form-control form-control-sm text-center sold-quantity-principal" p="${product_id}" ${attrDisabled}></td>`;
        }
        // COMENTADO: Columna de código ya no es necesaria
        let soldCodeCell = ''; // Ya no se incluye la columna de código
        /*
        let soldCodeCell = `<td class="item-sold ${itemSoldClass}">
            <div class="d-flex flex-column align-items-center">
                <button type="button" class="btn btn-success btn-sm btn-generate-sold mb-1" style="white-space: nowrap;"><i class="fas fa-barcode mr-1"></i>Obtener ID</button>
                <button type="button" class="btn btn-outline-danger btn-sm btn-cancel-sold d-none mb-1" style="white-space: nowrap;"><i class="fas fa-times"></i> Anular</button>
                <input type="text" readonly class="form-control form-control-sm text-center font-weight-bold sale-cod bg-light mt-1" placeholder="ID Orden" p="${product_id}" name="sale-cod" style="min-width: 100px;">
                <input type="hidden" class="sale-id" name="sale-id" value="0">
            </div>
        </td>`;
        */
        $(`tbody#details-batch-${product_id}`).append(`
            <tr class="">
                <td class="text-center align-middle item-correlative"></td>
                <td><input type="text" class="form-control text-center form-control-sm item-number-batch" p="${product_id}"></td>
                ${enteredQuantityPrincipalCell}
                <td><input type="text" class="form-control form-control-sm text-center entered-quantity-units" p="${product_id}"></td>
                ${returnedQuantityPrincipalCell}
                <td><input type="text" class="form-control form-control-sm text-center returned-quantity-units" p="${product_id}" ${attrDisabledReturn}></td>
                ${soldQuantityPrincipalCell}
                <td><input type="text" class="form-control form-control-sm text-center sold-quantity-units" unit="1" p="${product_id}" ${attrDisabled}></td>
                ${soldCodeCell}
                <td><input type="date" class="form-control form-control-sm item-expiration-batch" value="${formattedDate}"></td>
                <td>
                    <button type="button" product="${product_id}"
                            class="btn btn-outline-danger btn-sm btn-block btn-delete-row">
                        <i class="fas fa-minus"></i>
                    </button>
                </td>
            </tr>
        `);
        counterBatch(product_id);
    });

    function counterBatch(product_id) {
        let l = 1;
        $(`#details-batch-${product_id} tr`).each(function () {
            $(this).attr('i', l);
            $(this).children('td:nth-child(1)').text(l);
            l++;
        });
    }
    $(document).on('click', '.btn-delete-row', function () {
        let product_id = $(this).attr('product');
        let deletedRow = $(this).closest('tr');
        deletedRow.remove();
        counterBatch(product_id);
    });


    $('.check-returned').change(function () {
        let product_id = $(this).attr('p');
        let tbody = $(`#details-batch-${product_id}`);
        if ($(this).is(':checked')) {
            tbody.find('tr').each(function () {
                $(this).find('input.returned-quantity-principal').prop('disabled', false);
                $(this).find('input.returned-quantity-units').prop('disabled', false);
            });
        }
        else {
            tbody.find('tr').each(function () {
                $(this).find('input.returned-quantity-principal').prop('disabled', true);
                $(this).find('input.returned-quantity-units').prop('disabled', true);
            });
        }
    });
    $('.check-sold').change(function () {
        let product_id = $(this).attr('p');
        // COMENTADO: Ya no se necesita manejar la columna de código
        // let unit_name = $(this).closest('table').parent('td').parent('tr').attr('unit_name');
        // let col_span_checked = unit_name === 'UND' ? 2 : 3;
        // let col_span_unchecked = 2; // Siempre 2 cuando está desmarcado
        let tbody = $(`#details-batch-${product_id}`);
        if ($(this).is(':checked')) {
            tbody.find('tr').each(function () {
                $(this).find('input.sold-quantity-principal').prop('disabled', false);
                $(this).find('input.sold-quantity-units').prop('disabled', false);
                // COMENTADO: Ya no se necesita manejar sale-cod
                // $(this).find('input.sale-cod').prop('readonly', false);
            });
            // COMENTADO: Ya no se muestra/oculta la columna de código
            // tbody.find('td.item-sold').removeClass('d-none');
            // tbody.parent('table').find('thead tr.sub-title th.item-sold').removeClass('d-none');
            // tbody.parent('table').find('thead tr.title td.title-sold').attr('colspan', col_span_checked);
        }
        else {
            tbody.find('tr').each(function () {
                $(this).find('input.sold-quantity-principal').prop('disabled', true).val('');
                $(this).find('input.sold-quantity-units').prop('disabled', true).val('');
                // COMENTADO: Ya no se necesita manejar sale-cod
                // $(this).find('input.sale-cod').prop('readonly', true).val('');
                // $(this).find('input.sale-id').val('0');
                // Resetear botones
                // $(this).find('button.btn-generate-sold').removeClass('d-none');
                // $(this).find('button.btn-cancel-sold').addClass('d-none');
            });
            // COMENTADO: Ya no se muestra/oculta la columna de código
            // tbody.find('td.item-sold').addClass('d-none');
            // tbody.parent('table').find('thead tr.sub-title th.item-sold').addClass('d-none');
            // tbody.parent('table').find('thead tr.title td.title-sold').attr('colspan', col_span_unchecked);
        }
    });



</script>




