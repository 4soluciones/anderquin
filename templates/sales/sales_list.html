{% extends 'home.html' %}
{% load static %}
{% load operations %}
{% block title %}
    Ventas
{% endblock title %}

{% block body %}

    {% if error != "" %}
        <div class="alert alert-danger" role="alert">
            <h4 class="alert-heading">Inconcebible!</h4>
            <p>{{ error }}</p>
            <hr>
        </div>
    {% else %}
        <div class="container-fluid py-4 roboto-condensed-regular" style="background-color: #e8f4f8; min-height: 100vh;">
            <div class="card border-0 shadow-lg mb-4 overflow-hidden" style="border-radius: 15px;">
                <div class="card-body border-bottom py-2 py-md-3" style="background-color: #f0f8fc;">
                    <div class="row align-items-center no-gutters">
                        <div class="col-12 col-lg-8 mb-2 mb-lg-0 pr-lg-2">
                            <div id="autocomplete-product" class="autocomplete autocomplete-product-sales d-flex align-items-center flex-wrap">
                                <label for="product-names" class="mb-0 mr-2 text-nowrap small font-weight-bold text-uppercase text-muted" style="font-size: 0.8rem;">Ingrese para buscar producto</label>
                                <div class="input-group input-group-sm shadow-sm border rounded-pill overflow-hidden flex-grow-1" style="min-width: 200px; border-color: #bbdefb !important;">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text bg-white border-0 py-2"><i class="fas fa-search text-primary" style="font-size: 0.9rem;"></i></span>
                                    </div>
                                    <input class="form-control form-control-sm autocomplete-input autocomplete-input-product border-0 py-2"
                                           type="text" aria-label="Buscar producto"
                                           id="product-names"
                                           name="product-names"
                                           maxlength="200"
                                           autocomplete="off"
                                           placeholder="Mín. 3 letras..."
                                           style="font-size: 0.875rem;">
                                </div>
                                <ul class="autocomplete-result-list autocomplete-product-dropdown"></ul>
                            </div>
                        </div>
                        <div class="col-12 col-lg-3 col-xl-2 pl-lg-0">
                            <button type="button" id="clean_product"
                                    class="btn btn-outline-danger btn-sm border-2 btn-sales-rounded w-100 py-2">
                                <i class="fas fa-sync-alt"></i> Limpiar
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card-body p-0 p-md-3" style="background-color: #e3f2fd;">
                    <div class="row no-gutters">
                        <div class="col-12 col-xl-6 pr-xl-2 mb-3 mb-xl-0" id="tab-two">
                            {% include "sales/sales_grid_tab1.html" %}
                        </div>
                        <div class="col-12 col-xl-6 pl-xl-0">
                            <div id="product_list_sales">
                                <div class="card text-center roboto-condensed-regular p-4 border-0 shadow-sm" style="background-color: #fff; border-radius: 12px;">
                                    <div class="card-header font-weight-bold border-0 py-2" style="background: linear-gradient(180deg, #bbe0f5 0%, #90caf9 100%); border-radius: 12px 12px 0 0;">
                                        <span style="color: #0d47a1;">Atención</span>
                                    </div>
                                    <div class="card-body py-4">
                                        <h5 class="card-title roboto-condensed-regular font-weight-bold mb-0" style="color: #1565c0;">
                                            Ingrese un producto para comenzar la búsqueda...
                                        </h5>
                                    </div>
                                </div>
                            </div>
                            <div class="loader-container col-auto mt-2" id="loader-product" style="display: none;">
                                <div class="loader"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    <div class="modal fade" id="modal-batch" tabindex="-1" role="dialog"
         aria-labelledby="ModalHelpTitle" data-backdrop="static" data-keyboard="false"
         aria-hidden="true"></div>

    <div class="modal fade" id="modal-client-create" tabindex="-1" role="dialog"
         aria-labelledby="ModalNewClientTitle" data-backdrop="static" data-keyboard="false"
         aria-hidden="true"></div>


    <style>
        .form-control:focus {
            box-shadow: 0 0 0 0.2rem rgba(30, 58, 95, 0.25);
            border-color: #1e3a5f;
        }
        /* Botones con contorno bordeados y más redondeados */
        .btn-outline-primary, .btn-outline-success, .btn-outline-warning, .btn-outline-danger, .btn-outline-secondary {
            border-width: 2px;
        }
        .btn-sales-rounded,
        #order-form .btn-outline-primary,
        #order-form .btn-outline-success,
        #order-form .btn-outline-warning {
            border-radius: 12px !important;
        }
        /* Chrome, Safari, Edge, Opera */
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        /* Firefox */
        input[type="number"] {
            -moz-appearance: textfield;
        }
        #id-table-detail-order td,
        #id-table-detail-order th {
            border-color: #bbdefb !important;
        }
        #product_list_sales #product-data-grid td,
        #product_list_sales #product-data-grid th {
            border-color: #bbdefb !important;
        }
        /* Autocomplete producto: una sola lupa (anular icono de autocomplete.css) y dropdown opaco */
        .autocomplete-product-sales { position: relative; }
        .autocomplete-product-sales .autocomplete-input-product {
            background-image: none !important;
            padding-left: 0.75rem !important;
        }
        .autocomplete-product-dropdown {
            list-style: none;
            margin: 4px 0 0 0;
            padding: 0;
            max-height: 280px;
            overflow-y: auto;
            background: #ffffff !important;
            background-color: #ffffff !important;
            border: 1px solid #bbdefb;
            border-radius: 12px;
            box-shadow: 0 8px 24px rgba(30, 58, 95, 0.2);
            font-size: 0.8125rem;
            min-width: 100%;
            width: 100%;
            box-sizing: border-box;
            z-index: 1060 !important;
            position: absolute !important;
            isolation: isolate;
        }
        .autocomplete-product-dropdown li {
            padding: 10px 14px;
            border-bottom: 1px solid #e3f2fd;
            cursor: pointer;
            transition: background 0.15s ease;
            background: #ffffff !important;
            background-color: #ffffff !important;
        }
        .autocomplete-product-dropdown li:last-child { border-bottom: none; }
        .autocomplete-product-dropdown li[aria-selected="true"],
        .autocomplete-product-dropdown li:hover {
            background: linear-gradient(90deg, #e3f2fd 0%, #f0f8fc 100%) !important;
            background-color: #e3f2fd !important;
        }
        .autocomplete-product-dropdown li .h6 {
            font-size: 0.875rem;
            margin-bottom: 2px;
            color: #0d47a1;
        }
        .autocomplete-product-dropdown .wiki-snippet {
            font-size: 0.75rem;
            color: #5c6bc0;
        }
        .autocomplete-product-dropdown li.group { display: none; }
        @media (max-width: 575.98px) {
            .container-fluid.py-4 { padding-left: 0.5rem; padding-right: 0.5rem; }
            .autocomplete-product-dropdown { min-width: 100%; }
        }
    </style>

{% endblock body %}


{% block extrajs %}

    <script type="text/javascript">

        loader = '<div class="container">' +
            '<div class="row">' +
            '<div class="col-md-12">' +
            '<div class="loader">' +
            '<p><strong>Cargando Reniec/Sunat...</strong></p>' +
            '<div class="loader-inner"></div>' +
            '<div class="loader-inner"></div>' +
            '<div class="loader-inner"></div>' +
            '</div>' +
            '</div>' +
            '</div>' +
            '</div>';

        loader2 = '<div class="container">' +
            '<div class="row">' +
            '<div class="col-md-12">' +
            '<div class="loader">' +
            '<p>Cargando Comprobante...</p>' +
            '<div class="loader-inner"></div>' +
            '<div class="loader-inner"></div>' +
            '<div class="loader-inner"></div>' +
            '</div>' +
            '</div>' +
            '</div>' +
            '</div>';

        $("#id-nro-document-sender").attr('maxlength', 8);
        sessionStorage.setItem('document', '01');
        sessionStorage.setItem('BillType', 'V');

        $(document).on('click', '#btn-new-form', function () {
            window.location.href = '/sales/sales_list';
        });

        // Función para limpiar el select de direcciones
        function clearClientAddress() {
            let $addressSelect = $('#client_address');
            $addressSelect.empty();
            $addressSelect.append('<option value="" selected disabled>Seleccione una dirección</option>');
        }

        // Evento para limpiar direcciones cuando se limpia el campo de cliente
        $(document).on('input', '#person-names', function() {
            if ($(this).val().trim() === '') {
                clearClientAddress();
                $('#client-id').val('');
            }
        });

        if ($("#radio2").is(':checked')) {
            $("#document_type_sender").attr('disabled', 'disabled');
            $("#id_client_name").removeAttr('disabled');
            $("#document_type_sender").find('option[value]').removeAttr('selected');
            $("#document_type_sender").find('option[value="0"]').attr('selected', 'selected');
            $("#id-nro-document-sender").attr('readonly', true);
            $("#document_type_sender").trigger('change');
        }

        $("#radio1,#radio2").click(function () {
            if ($("#radio1").is(':checked')) {
                $("#person-names").val('');
                $("#person-names").attr('disabled', 'disabled');
                $("#document_type_sender").removeAttr('disabled');
                $("#id-nro-document-client").attr('readonly', false);
                $('#document_type_sender').val(0);
                $("#client-id").val('');
                clearClientAddress();
                $("#client_name").val('');

            } else if ($("#radio2").is(':checked')) {
                $("#document_type_sender").attr('disabled', 'disabled');
                $("#document_type_sender").find('option[value]').removeAttr('selected');
                $("#document_type_sender").find('option[value="0"]').attr('selected', 'selected');
                $("#document_type_sender").trigger('change');
                $("#person-names").removeAttr('disabled');
                $("#client-id").val('');
                clearClientAddress();
                $("#client_name").val('');
                $("#id-nro-document-client").val('');
                $("#id-nro-document-client").attr('readonly', true);
            }
        });

        $('#transaction_payment_type').change(function () {
            let type = $('#transaction_payment_type').val();
            if (type === 'E') {
                $('#cash').css('display', '');
                $('#deposit').css('display', 'none');
                $('#id_cash').trigger('change');
                $('#credit').css('display', 'none');
            } else if (type === 'D') {
                $('#deposit').css('display', '');
                $('#cash').css('display', 'none');
                $('#credit').css('display', 'none');
            } else if (type === 'C') {
                $('#credit').css('display', '');
                $('#cash').css('display', 'none');
                $('#deposit').css('display', 'none');
            } else if (type === '0') {
                $('#credit').css('display', 'none');
                $('#cash').css('display', 'none');
                $('#deposit').css('display', 'none');
            }
        });

        $(document).on('change', '#document_type_sender', function () {
            let _val = $(this).val();
            if (_val === '01') {
                $("#id-nro-document-sender").attr('maxlength', 8);
                sessionStorage.setItem('document', '01')
                $('#id-nro-document-sender').val('');
                $('#id_sender').val('');
                $('#id-address-line').css('display', 'none');
                $('#id_address').val('')
                {#$('#id_address_sender').val('');#}
            } else if (_val === '06') {
                $("#id-nro-document-sender").attr('maxlength', 11);
                sessionStorage.setItem('document', '06')
                $('#id-nro-document-sender').val('');
                $('#id_sender').val('');
                $('#id-address-line').css('display', '');
                $('#id_address').val('')
            } else if (_val === '04' || _val === '07' || _val === '00') {
                $("#id-nro-document-sender").attr('maxlength', 15);
                sessionStorage.setItem('document', '')
                $('#id_sender').val('');
                $('#id-nro-document-sender').val('');
                $('#id-address-line').css('display', 'none');
                $('#id_address').val('')
            }
        });

        $('#id-nro-document-client').keypress(function (e) {

            if (e.keyCode === 13) {
                e.preventDefault()
                $(this).trigger("enterKey");

                if ($('#document_type_sender').val() === '0' || $('#document_type_sender').val() === null) {
                    toastr.warning('¡Favor seleecionar un tipo de documento!', 'Error de Datos');
                    return false;
                }

                let _document_number = $('#id-nro-document-client').val();
                if ((sessionStorage.getItem('document') === '01') && (_document_number.length !== 8)) {
                    toastr.warning('¡Favor de completar los caracteres requeridos: 8 caracteres para DNI', 'Error de Datos');
                    return false;
                } else {
                    if ((sessionStorage.getItem('document') === '06') && (_document_number.length !== 11)) {
                        toastr.warning('¡Favor de completar los caracteres requeridos: 11 caracteres para RUC!', 'Error de Datos');
                        return false;
                    }
                }

                $('#loading-666').html(loader).show()

                $.ajax({
                    url: '/sales/get_name_business/',
                    async: true,
                    dataType: 'json', // for response
                    type: 'GET',
                    data: {
                        'nro_document': $('#id-nro-document-client').val(),
                        'type': $('#document_type_sender').val()
                    },
                    contentType: 'application/json;charset=UTF-8',
                    headers: {"X-CSRFToken": '{{ csrf_token }}'},
                    success: function (response, textStatus, xhr) {
                        if (xhr.status === 200) {
                            toastr.success(response.message, '¡Bien hecho!');
                            $("#client_name").val(response.result);
                            $("#client-id").val(response.client_id);
                            $("#client_address").val(response.address);
                            $('#loading-666').hide();
                        }
                    },
                    error: function (jqXhr, textStatus, xhr) {
                        if (jqXhr.status === 500) {
                            toastr.error(jqXhr.responseJSON.error, '¡Error de Consulta!');
                        } else {
                            if (textStatus === 'timeout') {
                                toastr.error('Failed from timeout', '¡Error de Consulta!');
                            } else {
                                console.log(" STATUS: " + xhr + " " + textStatus);
                            }
                        }
                        $('#loading-666').hide();
                    },
                });
                return false;
            }
        });

        function hasRowDetails() {
            var _response = false;
            if ($("#sales-details tr").length > 0) {
                _response = true;
            }
            return _response;
        }

        function calculateTotal() {
            var sum = 0;
            $('#sales-details tr td.item-total').each(function () {
                let total_detail = Number($(this).find('input.input-total-detail').val());
                sum = sum + total_detail;
            });
            $('#sum-total').val(sum.toFixed(2));
        }

        function deleteItem($product, $unit) {
            //let quantity_delete = 0
            //let quantity_min = 0
            let rows = $('#sales-details').find("tr[product=" + $product + "][pu=" + $unit + "]");
            let quantity_delete = parseFloat(rows.find('td.item-quantity input.input-quantity').val());
            let quantity_min = parseFloat(rows.find('td.item-unit').attr('unit_min'));
            $('#sales-details').find("tr[product=" + $product + "][pu=" + $unit + "]").remove();
            let _row = $('table#product-data-grid tbody tr[product=' + $product + ']');
            //let old_stock = parseFloat(_row.find('td.td-table-stock table.table-stock-headquarters tbody tr.my-subsidiary[store_="V"] td.item-stock').text());
            //_row.find('td.td-table-stock table.table-stock-headquarters tbody tr.my-subsidiary[store_="V"] td.item-stock').text((old_stock + (quantity_delete * quantity_min)).toFixed(2));
            let quantity_minimum_calculate = quantity_min * quantity_delete
            _row.find('td.td-table-stock table.table-stock-headquarters tbody tr.my-subsidiary[store_="V"] td.item-stock div.row').each(function () {
                let current_stock = $(this).find('span.current-stock').text();
                let quantity_minimum = $(this).attr('qm');
                let difference = quantity_minimum_calculate / quantity_minimum
                let new_stock = Number(current_stock) + Number(difference)
                $(this).find('span.current-stock').text(new_stock.toFixed(2))
            })
            calculateTotal();
            counterStrike();
        }

        function counterStrike() {
            var index = 1;
            $('#sales-details tr').each(function () {
                $(this).attr('i', index);
                $(this).children('td:first').text(index);
                index++;
            });
        }

        $(document).on('click', 'table#product-data-grid tbody tr td table.table-prices tbody tr td.prices-list div button', async function () {
            let value = $(this).attr('pk');
            let price = parseFloat($(this).attr('ip'));
            let tr = $(this).parent('div').parent('div').parent('td').parent('tr');
            let unit_id = tr.attr('unit');
            let name_unit = tr.attr('unitname');
            let product_id = tr.attr('product');
            let product_brand = tr.attr('product_brand');
            let name_product = tr.attr('productname');
            let quantity_minim = parseFloat(tr.attr('quantity_minum'));
            let quantity = parseFloat(tr.find('td.quantity-sales-price input.quantity-select').val());
            let stock = parseFloat(tr.parent('tbody').parents('table.table-prices').parent('td').parent('tr').find('td.td-table-stock table.table-stock-headquarters tbody tr.my-subsidiary[store_="V"] td.item-stock').text());
            let store_id = tr.parent('tbody').parents('table.table-prices').parent('td').parent('tr').find('td.td-table-stock table.table-stock-headquarters tbody tr.my-subsidiary').attr('store_id');
            let sub_store_id = tr.parent('tbody').parents('table.table-prices').parent('td').parent('tr').find('td.td-table-stock table.table-stock-headquarters tbody tr.my-subsidiary').attr('sub_store');
            let tr_table_stock = tr.parent('tbody').parents('table.table-prices').parent('td').parent('tr').find('td.td-table-stock table.table-stock-headquarters tbody tr.my-subsidiary');
            let batch_id = tr_table_stock.find('td.item-batch input.batch-id').val();
            let batch_number = tr_table_stock.find('td.item-batch input.number-batch').val();

            if (isNaN(quantity)) {
                toastr.warning('Ingrese la cantidad del producto');
                tr.find('td.quantity-sales-price input.quantity-select').val('')
                return false
            }
            if (quantity === '' || quantity === 0) {
                toastr.warning('Ingrese la cantidad del producto');
                tr.find('td.quantity-sales-price input.quantity-select').val('')
                return false
            }
            if (quantity < 0) {
                toastr.warning('La cantidad debe ser un valor positivo');
                tr.find('td.quantity-sales-price input.quantity-select').val('')
                return false
            }
            if ($("#sales-details tr[product=" + product_id + "][pu=" + unit_id + "]").length) {
                let $msg = 'El producto con este tipo de unidad ya se encuentra en el registro.';
                toastr.warning($msg, 'Mensaje');
                tr.find('td.quantity-sales-price input.quantity-select').val('')
                return false;
            }
            let _flag_stock = await check_stock(quantity, product_id, store_id)
            //console.log("unit_id", unit_id)
            //console.log("name_unit", name_unit)
            //console.log("quantity", quantity)
            //console.log("quantity_minim", quantity_minim)
            let quantity_minimum_calculate = quantity_minim * quantity
            //console.log("quantity_minimum_calculate", quantity_minimum_calculate)
            if (_flag_stock === true) {
                addDetail(unit_id, product_id, quantity, price, name_unit, unescape(name_product), store_id, quantity_minim, product_brand, batch_id, batch_number, sub_store_id);
                //tr.parent('tbody').parents('table.table-prices').parent('td').parent('tr').find('td.td-table-stock table.table-stock-headquarters tbody tr.my-subsidiary[store_="V"] td.item-stock').text((stock - quantity * quantity_minim).toFixed(2));
                tr.parent('tbody').parents('table.table-prices').parent('td').parent('tr').find('td.td-table-stock table.table-stock-headquarters tbody tr.my-subsidiary[store_="V"] td.item-stock div.row').each(function () {
                    let current_stock = $(this).find('span.current-stock').text();
                    let quantity_minimum = $(this).attr('qm');
                    let new_stock = current_stock - (quantity_minimum_calculate / quantity_minimum)
                    $(this).find('span.current-stock').text(new_stock.toFixed(2))
                })
            } else {
                toastr.warning('STOCK INSUFICIENTE EN ALMACEN');
            }
            tr.find('td.quantity-sales-price input.quantity-select').val('');
        });


        function addDetail(a, b, c, d, e, f, g, h, i, batch_id, batch_number, sub_store_id) {

            let _unit_id = a
            let _product_id = b
            let _quantity = Number(c)
            let _price = parseFloat(d)
            let _total = _quantity * _price
            let _unit = e
            let _product_name = escapeHtml(f)
            let _product_store = g
            let _quantity_minim = parseFloat(h)

            //console.log(_quantity)
            //console.log(_price.toFixed(2))

            $('#sales-details').append(
                '<tr  guide_detail_id="' + '' + '" detail_id="' + 'NaN' + '" product="' + _product_id + '" store_p="' + _product_store + '" pu="' + _unit_id + '" batch="' + batch_id + '" sub_store="' + sub_store_id + '" class="text-uppercase small text-center" style="font-size: 14px;">' +
                '<td class="align-middle">' + '</td>' +
                '<td class="align-middle text-left item-product">' + '<input type="text" class="form-control form-control-sm input-product-name" value="' + _product_name + '">' + '</td>' +
                '<td class="align-middle item-quantity">' + '<input type="text" class="form-control form-control-sm text-right input-quantity" disabled value="' + _quantity.toFixed(2) + '">' + '</td>' +
                '<td class="align-middle item-unit" pu="' + _unit_id + '" unit_min="' + _quantity_minim + '">' + _unit + '</td>' +
                '<td class="align-middle item-batch" batch="' + batch_id + '">' + batch_number + '</td>' +
                '<td class="align-middle item-price">' + '<input type="text" class="form-control form-control-sm text-right input-price" value="' + _price.toFixed(2) + '">' + '</td>' +
                '<td class="align-middle item-total">' + '<input type="text" class="form-control form-control-sm text-right input-total-detail" value="' + _total.toFixed(2) + '">' + '</td>' +
'<td>' + '<button type="button" onclick="deleteItem(' + _product_id + ',' + _unit_id + ')" class="btn btn-outline-danger btn-sm border-2">' +
                                                '<i class="fa fa-trash"></i></button>' + '</td>' +
                '</tr>'
            );
            calculateTotal();
            counterStrike();
        }

        function escapeHtml(text) {
            var map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };

            return text.replace(/[&<>"']/g, function (m) {
                return map[m];
            });
        }

        $(document).on('keypress', '#custom-search-product', function (e) {

            $('#product_list_sales').empty();
            $('#custom-search-barcode').val(' ')

            if (e.keyCode === 13) {

                e.preventDefault()

                $(this).trigger("enterKey");

                let _product_name = $(this).val().trim();

                if (_product_name.length === 0) {
                    toastr.warning('¡Favor de ingresar una busqueda', 'Error de Datos');
                    return false;
                }
                getProduct(_product_name, '')

            }
        });

        function getProduct($product_name, $barcode) {

            $('div#loader-product').css('display', '');
            $.ajax({
                url: '/sales/get_product_grid/',
                async: true,
                dataType: 'json', // for response
                type: 'GET',
                data: {
                    'value': $product_name,
                    'barcode': $barcode
                },
                contentType: 'application/json;charset=UTF-8',
                headers: {"X-CSRFToken": '{{ csrf_token }}'},
                success: function (response, textStatus, xhr) {
                    if (xhr.status === 200) {
                        toastr.success(response.message, '¡Bien hecho!');
                        {#$('#product-grid-list').html(response.grid);#}
                        $('#product_list_sales').html(response.grid).slideDown();
                        $('div#loader-product').css('display', 'none');
                    }
                },
                error: function (jqXhr, textStatus, xhr) {
                    if (jqXhr.status === 500) {
                        toastr.error(jqXhr.responseJSON.error, '¡Error de Consulta!');
                    } else {
                        if (textStatus === 'timeout') {
                            toastr.error('Failed from timeout', '¡Error de Consulta!');
                        } else {
                            console.log(" STATUS: " + xhr + " " + textStatus);
                        }
                    }
                }
            });
        }

        $(document).on('keyup', '#sales-details tr td.item-price input.input-price', function (e) {
            let val = Number($(this).val());
            let row = $(this).parent('td.item-price').parent('tr');
            let quantity = Number(row.find('td.item-quantity input.input-quantity').val());
            {#console.log('quantity',quantity)#}
            {#console.log('val',val)#}
            if (isNaN(val)) {
                $(this).val('')
            } else {
                let total_detail = quantity * val
                if (val !== '') {
                    row.find('td.item-total input.input-total-detail').val((total_detail).toFixed(2))
                    calculateTotal();
                }
            }
        });

        $(document).on('keyup', '#sales-details tr td.item-quantity input.input-quantity', function (e) {
            let val = Number($(this).val());
            let row = $(this).parent('td.item-quantity').parent('tr');
            let price = Number(row.find('td.item-price input.input-price').val());
            if (isNaN(val)) {
                $(this).val('')
            } else {
                if (val !== '') {
                    row.find('td.item-total input.input-total-detail').val((price * val).toFixed(2))
                    calculateTotal();
                }
            }
        });

        $(document).on('keyup', '#sales-details tr td.item-total input.input-total-detail', function (e) {
            let val = Number($(this).val());
            {#console.log('total', val)#}
            let row = $(this).parent('td.item-total').parent('tr');
            let quantity = Number(row.find('td.item-quantity input.input-quantity').val());
            let price = Number(row.find('td.item-price input.input-price').val());
            {#console.log('quantity', quantity)#}

            let price_unit = val / quantity
            {#console.log('price_unit', price_unit)#}
            row.find('td.item-price input.input-price').val((price_unit).toFixed(2))
            calculateTotal();

        });

        $(document).on('change', '#document_type_client', async function () {
            let _val = $(this).val();
            if (_val === '01') {
                $("#document_number_client").attr('maxlength', 8);
                sessionStorage.setItem('client-document', '01')
                $('#document_number_client').val('');
            } else if (_val === '06') {
                $("#document_number_client").attr('maxlength', 11);
                sessionStorage.setItem('client-document', '06')
                $('#document_number_client').val('');
            } else if (_val === '00') {
                $("#document_number_client").attr('maxlength', 15);
                sessionStorage.setItem('client-document', '')
                let new_n_order = await get_last_number_others();
                $('#document_number_client').val(new_n_order);
            }
        });

        var serial_set = [
            {% for s in series %}
                [
                    '{{ s.id }}',
                    '{{ s.serial }}',
                    '{{ s.correlative }}',
                    '{{ s.type_document }}'
                ],
            {% endfor %}
        ]

        $(document).on('change', '#type_document', async function () {
            let _val = $(this).val();
            let filteredSerials = serial_set.filter(function (item) {
                return item[3] === _val;
            });
            let $idSerial = $('#id_serial');
            $idSerial.empty();
            $idSerial.append('<option selected disabled value="0">Seleccione</option>');
            filteredSerials.forEach(function (item) {
                $idSerial.append(new Option(item[1], item[0]));
            });
        });

        $(document).on('change', '#id_serial', async function () {
            let _val = $('#id_serial option:selected').text();
            $.ajax({
                url: '/sales/get_correlative/',
                async: true,
                dataType: 'json', // for response
                type: 'GET',
                data: {'serial': _val},
                contentType: 'application/json;charset=UTF-8',
                headers: {"X-CSRFToken": '{{ csrf_token }}'},
                success: function (response, textStatus, xhr) {
                    if (xhr.status === 200) {
                        $('#correlative').val(response.correlative)
                    }
                },
                error: function (jqXhr, textStatus, xhr) {
                    if (jqXhr.status === 500) {
                        toastr.error(jqXhr.responseJSON.error, '¡Error de Consulta!');
                    } else {
                        if (textStatus === 'timeout') {
                            toastr.error('Failed from timeout', '¡Error de Consulta!');
                        } else {
                            console.log(" STATUS: " + xhr + " " + textStatus);
                        }
                    }
                }
            });
        });

        $("#document_number_client").attr('maxlength', 8);
        sessionStorage.setItem('client-document', '01')

        async function check_stock(_quantity, _product_id, store_id) {

            let _flag_stock = true

            await $.ajax({
                url: '/sales/check_stock/',
                async: true,
                dataType: 'json', // for response
                type: 'GET',
                data: {
                    'quantity': _quantity,
                    'product': _product_id,
                    'store_id': store_id
                },
                contentType: 'application/json;charset=UTF-8',
                headers: {"X-CSRFToken": '{{ csrf_token }}'},
                success: function (response, textStatus, xhr) {
                    if (xhr.status === 200) {
                        {#console.log(response.flag)#}
                        _flag_stock = response.flag;
                    }
                },
                error: function (jqXhr, textStatus, xhr) {
                    toastr.error('¡ERROR!');
                }
            });
            return _flag_stock
        }

        async function get_last_number_others() {

            let new_n_order = 0;

            await $.ajax({
                url: '/sales/get_last_id_type_others/',
                async: true,
                dataType: 'json', // for response
                type: 'GET',
                data: {},
                contentType: 'application/json;charset=UTF-8',
                headers: {"X-CSRFToken": '{{ csrf_token }}'},
                success: function (response, textStatus, xhr) {
                    if (xhr.status === 200) {
                        new_n_order = response.new_n_order;
                        //console.log(new_n_order)
                    }
                },
                error: function (jqXhr, textStatus, xhr) {
                    toastr.error('¡ERROR!');
                }
            });
            return new_n_order
        }

        new Autocomplete('#autocomplete-client', {
            search: input => {
                const url = `/buys/get_client/?search=${encodeURI(input.toUpperCase())}`

                return new Promise(resolve => {
                    if (input.length < 3) {
                        //$('#person-number').val('')
                        //$('#order-number').val('')
                        return resolve([])
                    }
                    fetch(url)
                        .then(response => response.json())
                        .then(data => {
                            resolve(data.results)
                        })
                })
            },
            renderResult: (result, props) => {
                let group = ''
                if (result.index % 3 === 0) {
                    group = '<li class="group">Group</li>'
                }
                return `
                ${group}
                <li ${props}>
                 <div class="h6" style="font-family: roboto_condensed_regular">
                    ${result.names}
                 </div>
                 <div class="wiki-snippet text-black">
                    Tipo: ${result.type_client_display}
                  </div>
                </li>
                `
            },
            getResultValue: result => result.names,
            onSubmit: result => {
                if (result) {
                    let client_id = result.id;
                    let type_client = result.type_client;
                    let _address_dict = result.address;

                    $('#client-id').val(client_id);
                    //$('#client_name').val(result.names);
                    
                    // Limpiar y llenar el select de direcciones
                    let $addressSelect = $('#client_address');
                    $addressSelect.empty();
                    $addressSelect.append('<option value="" selected disabled>Seleccione una dirección</option>');
                    
                    if (_address_dict && _address_dict.length > 0) {
                        _address_dict.forEach(function(address) {
                            $addressSelect.append($('<option>').val(address.address).text(address.address.toUpperCase()));
                        });
                    } else {
                        $addressSelect.append('<option value="">Sin direcciones registradas</option>');
                    }

                } else {
                    toastr.warning('Seleccione un cliente valido', 'Error de llenado');
                    return false;
                }

            }
        });

        function searchSale() {
            let order_id = $('#search_sale').val();
            if (!order_id || order_id.trim() === '') {
                toastr.warning('Ingrese un número de orden', 'Error de Datos');
                return false;
            }
            
            $.ajax({
                url: '/sales/get_order_store/',
                async: true,
                dataType: 'json',
                type: 'GET',
                data: {'order_id': order_id},
                success: function (response) {
                    if (response.success) {
                        // Ocultar formulario de venta normal y mostrar venta de almacén
                        $(".sale").addClass('d-none');
                        $(".sale-store").removeClass('d-none');
                        
                        // Llenar ID de orden
                        $("#order_id").val(response.order_id);
                        
                        // Llenar datos del cliente
                        if (response.client_id) {
                            $("#client-id").val(response.client_id);
                            $("#person-names").val(response.client_name || '');
                            
                            // Llenar direcciones del cliente
                            let $addressSelect = $('#client_address');
                            $addressSelect.empty();
                            if (response.client_addresses && response.client_addresses.length > 0) {
                                response.client_addresses.forEach(function(address) {
                                    let selected = address.type === 'P' ? 'selected' : '';
                                    $addressSelect.append($('<option>', {
                                        value: address.address,
                                        text: address.address.toUpperCase(),
                                        selected: selected
                                    }));
                                });
                            } else if (response.client_address) {
                                $addressSelect.append($('<option>', {
                                    value: response.client_address,
                                    text: response.client_address.toUpperCase(),
                                    selected: true
                                }));
                            } else {
                                $addressSelect.append('<option value="" selected disabled>Seleccione una dirección</option>');
                            }
                        }
                        
                        // Llenar código unidad ejecutora
                        if (response.cod_unit_exe) {
                            $("#cod_unit_exe").val(response.cod_unit_exe);
                        }
                        
                        // Llenar tipo de documento
                        if (response.type_document) {
                            $("#type_document").val(response.type_document).trigger('change');
                        }
                        
                        // Llenar tipo de pago
                        if (response.transaction_payment_type) {
                            $('#transaction_payment_type').val(response.transaction_payment_type);
                            $("#transaction_payment_type").trigger('change');
                        }
                        
                        // Llenar observaciones
                        if (response.observation) {
                            $("#observation").val(response.observation);
                        }
                        
                        // Llenar orden de compra
                        if (response.order_buy) {
                            $("#order_buy").val(response.order_buy);
                        }
                        
                        // Llenar SIAF
                        if (response.n_contract) {
                            $("#n_contract").val(response.n_contract);
                        }
                        
                        // Llenar detalles de la orden
                        let Detail = response['detail'];
                        $('table#id-table-detail-order tbody#sales-details').empty();
                        Detail.forEach(
                            e =>
                                addOrderDetail(e.id, e.product_id, e.product_name, e.quantity, e.price, e.unit_id, e.unit_name, e.unit_min, e.batch_id, e.batch_number, e.store, e.subStore)
                        );
                        
                        toastr.success('Orden cargada correctamente', '¡Bien hecho!');
                    } else {
                        toastr.error(response.bill || '', response.message);
                    }
                },
                error: function (jqXhr, textStatus, xhr) {
                    if (jqXhr.status === 500) {
                        toastr.error(jqXhr.responseJSON?.error || 'Error al cargar la orden', '¡Error!');
                    } else {
                        toastr.error('Error al cargar la orden', '¡Error!');
                    }
                }
            });
        }

        function addOrderDetail(detail, product_id, product_name, quantity, price, unit, unit_name, unit_min, batch_id, batch_number, store, subStore) {

            let _total = quantity * price
            let disabledAttr = detail ? 'disabled' : '';

            $('#sales-details').append(
                '<tr detail_id="' + detail + '" product="' + product_id + '" store_p="' + (store || '') + '" pu="' + unit + '" batch="' + (batch_id || '') + '" sub_store="' + (subStore || '') + '" class="text-uppercase small text-center" style="font-size: 14px;">' +
                '<td class="align-middle">' + '</td>' +
                '<td class="align-middle text-left item-product">' + '<input type="text" class="form-control form-control-sm input-product-name"  value="' + product_name + '" ' + disabledAttr + '>' + '</td>' +
                '<td class="align-middle item-quantity">' + '<input type="number" class="form-control form-control-sm text-right input-quantity" value="' + Number(quantity).toFixed(0) + '" ' + disabledAttr + '>' + '</td>' +
                '<td class="align-middle item-unit" pu="' + unit + '" unit_min="' + unit_min + '">' + unit_name + '</td>' +
                '<td class="align-middle item-batch" batch="' + (batch_id || '') + '">' + (batch_number || '') + '</td>' +
                '<td class="align-middle item-price">' + '<input type="number" class="form-control form-control-sm text-right input-price" value="' + Number(price).toFixed(2) + '">' + '</td>' +
                '<td class="align-middle item-total">' + '<input type="number" class="form-control form-control-sm text-right input-total-detail" value="' + Number(_total).toFixed(2) + '">' + '</td>' +
                //'<td>' + '<button type="button" onclick="deleteItem(' + product_id + ',' + unit + ')" class="btn btn-danger btn-sm">' +
                '<i class="fa fa-trash"></i></button>' + '</td>' +
                '</tr>'
            );
            calculateTotal();
            counter();
        }

        function counter() {
            let index = 1;
            $('#sales-details tr').each(function () {
                $(this).attr('i', index);
                $(this).children('td:first').text(index);
                index++;
            });

        }

        $(document).on('keypress', '#order-form', function (event) {
            if (event.which === 13 || event.keyCode === 13) {
                event.preventDefault();
                return false;
            } else return true;
        });

        $('#order-form').submit(function (e) {
            e.preventDefault();

            let _transaction_payment_type = $('#transaction_payment_type')
            if ($('#client-id').val() === '') {
                toastr.warning('!Seleccione un cliente o busquelo por Numero de documento¡', 'Error de Llenado');
                return false;
            }
            if (_transaction_payment_type.val() === '0') {
                toastr.warning('¡Selecione el tipo de pago!', 'Mensaje');
                return false;
            }
            if (_transaction_payment_type.val() === 'E') {
                if ($('#id_date').val() === '') {
                    toastr.error('No puede realizar ventas sin aperturar la caja', 'Mensaje');
                    return false;
                }
            }
            if (_transaction_payment_type.val() === 'C') {
                if (hasRowDetailsCredits() === false) {
                    toastr.warning('Registre las cuotas de pago y la condicion de pago');
                    return false
                }
            }
            if (hasRowDetails() === false) {
                toastr.warning('¡Elija los productos..!', 'Mensaje');
                return false;
            }

            let detailOrder = []
            let creditDict = []

            $("#sales-details tr").each(function () {
                let _quantity = $(this).find("td.item-quantity input.input-quantity").val();
                if (_quantity === '' || _quantity <= 0) {
                    toastr.warning('Ingrese un valor valido para la cantidad');
                    return false
                }
                let _price = $(this).find("td.item-price input.input-price").val();
                if (_price === '' || _quantity <= 0) {
                    toastr.warning('Ingrese un valor valido para el precio');
                    return false
                }
                let detailObj = {
                    guide_detail: $(this).attr('guide_detail_id'),
                    detail: $(this).attr('detail_id'),
                    product: $(this).attr('product'),
                    commentary: $(this).find("td.item-product input.input-product-name").val(),
                    unit: $(this).find("td.item-unit").attr('pu'),
                    quantity: parseFloat($(this).find("td.item-quantity input.input-quantity").val()).toFixed(2),
                    price: parseFloat($(this).find("td.item-price input.input-price").val()).toFixed(2),
                    detailTotal: parseFloat($(this).find("td.item-total input.input-total-detail").val()).toFixed(2),
                    store: $(this).attr("store_p"),
                    batch: $(this).attr("batch"),
                    subStore: $(this).attr("sub_store"),
                };
                detailOrder.push(detailObj);
            });
            $("#credit_details tr").each(function () {
                let creditObj = {
                    date: $(this).find("td.item-date-credit input.input-date").val(),
                    amount: $(this).find("td.item-amount-credit input.input-amount").val(),
                };
                creditDict.push(creditObj);
            });

            let selectElement = document.getElementById('id_serial');
            let selectedOptionText = selectElement.options[selectElement.selectedIndex].text;
            let data = new FormData($('#order-form').get(0));
            data.append('detail', JSON.stringify(detailOrder));
            data.append('serial_text', selectedOptionText);
            data.append('credit', JSON.stringify(creditDict));
            console.log(detailOrder)
            //$('#save-order').prop('disabled', true)
            $.ajax({
                url: '/sales/save_order/',
                async: true,
                dataType: 'json', // for response
                type: 'POST',
                cache: false,
                processData: false,
                data: data,
                contentType: false,
                headers: {
                    "X-CSRFToken": '{{ csrf_token }}'
                },
                success: function (response, textStatus, xhr) {
                    if (xhr.status === 200) {
                        if (response.msg_sunat !== undefined) {
                            toastr.success(response.message + response.msg_sunat, '¡Mensaje!');
                        } else {
                            toastr.success(response.message, '¡Mensaje!');
                        }
                        let order_id = response.order_id
                        window.location.href = "/sales/print_order_bill/" + order_id + "/";
                        if (response.guide) {
                            setTimeout(() => {
                                window.open("/buys/contracts/", '_self');
                            }, 2000);
                        } else {
                            setTimeout(() => {
                                location.reload();
                            }, 2000);
                        }
                    }
                },
                error: function (jqXhr, textStatus, xhr) {
                    toastr.error(jqXhr.responseJSON.error, '¡ERROR!');
                }
            });
        });

        function AddDetailsCredit() {
            let _amount = 0
            let total = parseFloat($('#sum-total').val()).toFixed(2);
            let valor = parseFloat($('#amount-credit-total').val()).toFixed(2);
            let _days = isNaN(parseInt($('#condition_days').val(), 10)) ? 0 : parseInt($('#condition_days').val(), 10);
            let dateInput = $('#date');
            let currentDate = new Date(dateInput.val())
            currentDate.setDate(currentDate.getDate() + 1);
            currentDate.setDate(currentDate.getDate() + _days);
            let year = currentDate.getFullYear();
            let month = (currentDate.getMonth() + 1).toString().padStart(2, '0');
            let day = currentDate.getDate().toString().padStart(2, '0');
            let formattedDate = `${year}-${month}-${day}`;

            _amount = parseFloat(total - valor).toFixed(2)
            if (_amount > 0) {
                $('#credit_details').append(
                    '<tr class="text-uppercase small text-center" style="font-size: 14px;">' +
                    '<td class="align-middle">' + '</td>' +
                    '<td class="align-middle item-date-credit">' + '<input type="date" class="form-control form-control-sm input-date" value="' + formattedDate + '">' + '</td>' +
                    '<td class="align-middle item-amount-credit">' + '<input type="text" step="0.01" class="form-control form-control-sm text-right input-amount" value="' + _amount + '">' + '</td>' +
'<td class="align-middle item-delete">' + '<button type="button" class="btn btn-outline-secondary btn-sm border-2">' +
                                                    '<i class="fa fa-trash"></i></button>' + '</td>' +
                    '</tr>'
                );
                calculateTotalPayment();
                counterStrikePayment();
            } else {
                toastr.warning('Monto completado')
            }


        }

        function calculateTotalPayment() {
            let sum = 0;
            $('#credit_details tr td.item-amount-credit input.input-amount').each(function () {
                sum = sum + parseFloat($(this).val());
                if (sum > $('#id-total-guide').val()) {
                    toastr.warning('Monto superado')
                    sum = sum - parseFloat($(this).val());
                    $(this).val('')
                }
            });
            $('#amount-credit-total').val(sum.toFixed(2))
        }

        function counterStrikePayment() {
            let ind = 1;
            $('#credit_details tr').each(function () {
                $(this).attr('i', ind);
                $(this).children('td:first').text(ind);
                $(this).find('td.item-delete button').attr('onclick', 'deleteItemCredit(' + ind + ')')
                ind++;
            });
        }

        function deleteItemCredit($pk) {
            $('#credit_details').find("tr[i=" + $pk + "]").remove();
            calculateTotalPayment();
            counterStrikePayment();
        }

        $(document).on('keyup', '#credit_details tr td.item-amount-credit input.input-amount', function (e) {
            let val = $(this).val();
            if (isNaN(val)) {
                $(this).val('')
            } else {
                if (val !== '') {
                    calculateTotalPayment();
                }
            }
        })

        function hasRowDetailsCredits() {
            var _response = false;
            if ($("#credit_details tr").length > 0) {
                _response = true;
            }
            return _response;
        }

        $(document).on('click', '.check-store', function () {
            const $currentTable = $(this).closest('table');
            $currentTable.find('.my-subsidiary').removeClass('bg-success text-white my-subsidiary');
            $(this).closest('tr').addClass('bg-success text-white my-subsidiary');
            const $currentRow = $(this).closest('tr');
            $currentRow.find('td.item-batch button.btn-batch').text('Ver');
            $currentRow.find('td.item-batch input.number-batch').val('-');
            $currentRow.find('td.item-batch input.batch-id').val('0');
            $currentRow.find('td.item-batch input.stock-batch').val('');
            $currentRow.addClass('bg-success text-white my-subsidiary');
            $currentTable.find('.item-batch').addClass('d-none');
            $currentRow.find('.item-batch').removeClass('d-none');
            let table_prices = $currentTable.parent('td').parent('tr').find('td.prices-table table.table-prices');
            table_prices.find('tr td.prices-list div.price-select').removeClass('d-none');
            table_prices.find('tr td.prices-list span.out-stock').addClass('d-none');
        });


        new Autocomplete('#autocomplete-product', {
            autoSelect: true,
            search: input => {
                const url = `/sales/get_product_autocomplete/?search=${encodeURI(input.toUpperCase())}`

                return new Promise(resolve => {
                    if (input.length < 3) {
                        return resolve([])
                    }
                    fetch(url)
                        .then(response => response.json())
                        .then(data => {
                            resolve(data.product || [])
                        })
                })
            },
            renderResult: (result, props) => {
                return `<li ${props}>
                 <div class="h6 font-weight-bold mb-0" style="font-family: roboto_condensed_regular">${result.names}</div>
                 <div class="wiki-snippet">Marca: ${result.brand || '-'}</div>
                </li>`
            },
            getResultValue: result => result.names,
            onSubmit: result => {
                if (result) {
                    getProductSelected(result.id)
                } else {
                    toastr.warning('Seleccione un producto valido', 'Error de llenado');
                    return false;
                }

            }
        });

        function getProductSelected($product_id) {

            $('#product_list_sales').empty();
            $('div#loader-product').css('display', '');

            $.ajax({
                url: '/sales/get_product_by_id/',
                async: true,
                dataType: 'json', // for response
                type: 'GET',
                data: {
                    'productId': $product_id,
                },
                contentType: 'application/json;charset=UTF-8',
                headers: {"X-CSRFToken": '{{ csrf_token }}'},
                success: function (response, textStatus, xhr) {
                    if (xhr.status === 200) {
                        //toastr.success(response.message, '¡Bien hecho!');
                        $('#product_list_sales').html(response.grid).slideDown();
                        $('div#loader-product').css('display', 'none');
                    }
                },
                error: function (jqXhr, textStatus, xhr) {
                    if (jqXhr.status === 500) {
                        toastr.error(jqXhr.responseJSON.error, '¡Error de Consulta!');
                    } else {
                        if (textStatus === 'timeout') {
                            toastr.error('Failed from timeout', '¡Error de Consulta!');
                        } else {
                            console.log(" STATUS: " + xhr + " " + textStatus);
                        }
                    }
                }
            });
        }

        document.addEventListener('click', function (event) {
            if (event.target.id === 'clean_product') {
                document.getElementById('product_list_sales').innerHTML = '';
                document.getElementById('product-names').value = '';
            }
        });

        $(document).on('click', '.btn-batch', function (e) {

            let store_id = $(this).attr("ps");
            $.ajax({
                url: '/sales/modal_batch/',
                dataType: 'json',
                type: 'GET',
                data: {'ps': store_id},
                success: function (response, textStatus, xhr) {
                    if (response.success) {
                        $('#modal-batch').html(response.form);
                        $('#modal-batch').modal('show');

                    } else {
                        toastr.error(response.message, 'Error');
                    }
                },
                fail: function (response) {
                    toastr.error('Ocurrio un problema al mostrar el formulario', '¡Mensaje!');
                }
            });
        });

        // ----- Modal Agregar nuevo cliente (desde ventas) -----
        $(document).on('click', '#btn-new-client-sales', function () {
            $.ajax({
                url: '/sales/modal_client_create/',
                dataType: 'json',
                type: 'GET',
                success: function (response) {
                    $('#modal-client-create').html(response.form);
                    $('#modal-client-create').modal('show');
                },
                error: function () {
                    toastr.error('No se pudo cargar el formulario de cliente', 'Error');
                }
            });
        });

        $(document).on('click', '#modal-client-create #btn-save-client', function (e) {
            e.preventDefault();
            let _document_number = $('#modal-client-create #document_number').val();
            let _names = $('#modal-client-create #names').val();
            let _type_client = $('#modal-client-create #id_type_client').val();
            let _doc_type = $('#modal-client-create #document_type').val();

            if (_doc_type === '01') {
                if (_document_number.length !== 8) {
                    toastr.warning('8 caracteres para DNI', 'Error de Datos');
                    return false;
                }
                if (_names.length === 0) {
                    toastr.warning('Complete los Nombres', 'Error de Datos');
                    return false;
                }
            } else if (_doc_type === '06') {
                if (_document_number.length !== 11) {
                    toastr.warning('11 caracteres para RUC', 'Error de Datos');
                    return false;
                }
                if (_names.length === 0) {
                    toastr.warning('Complete la Razón Social', 'Error de Datos');
                    return false;
                }
            } else if (_doc_type === '00' || !_doc_type) {
                if (_document_number.length === 0 || _names.length === 0) {
                    toastr.warning('Complete tipo de documento, número y nombre', 'Error de Datos');
                    return false;
                }
            }
            if (_type_client === '0' || !_type_client) {
                toastr.warning('Seleccione el tipo de cliente', 'Error de Datos');
                return false;
            }

            let client = {
                "client_id": $('#modal-client-create #client_id').val(),
                "document_type": _doc_type,
                "document_number": _document_number,
                "names": _names,
                "phone": $('#modal-client-create #phone').val(),
                "email": $('#modal-client-create #email').val(),
                "type_client": _type_client,
                "publicAddress": "",
                "publicDistrict": "",
                "siaf": $('#modal-client-create #cod_siaf').val(),
                "price_type": $('#modal-client-create #price_type').val(),
                "Addresses": []
            };

            if (_type_client === 'PU') {
                $('#modal-client-create .address-block-public').each(function () {
                    client.Addresses.push({
                        "new_address": $(this).find("input.public-address").val(),
                        "district": $(this).find("select.select2-district").val(),
                        "province": $(this).find("select.select2-province").val(),
                        "department": $(this).find("select.select2-department").val(),
                        "type_address": $(this).find("select[name='type_address'], select[name='type_address_new']").val()
                    });
                });
                if (client.Addresses.length === 0) {
                    client.publicAddress = $('#modal-client-create #address').val();
                    client.publicDistrict = $('#modal-client-create #id_district').val();
                    client.publicProvince = $('#modal-client-create #id_province').val();
                    client.publicDepartment = $('#modal-client-create #id_department').val();
                    client.type_address = $('#modal-client-create #type_address').val();
                }
            } else if (_type_client === 'PR') {
                $('#modal-client-create .address-block-private').each(function () {
                    client.Addresses.push({
                        "new_address": $(this).find("input.new-address").val(),
                        "district": $(this).find("select.district").val(),
                        "province": $(this).find("select.province").val(),
                        "department": $(this).find("select.department").val(),
                        "type_address": $(this).find("select.type-address").val()
                    });
                });
            }

            $(this).prop("disabled", true);
            $('#modal-client-create #container-loading').css('display', 'block');

            $.ajax({
                url: '/sales/client_save/',
                dataType: 'json',
                type: 'GET',
                cache: false,
                data: { 'client': JSON.stringify(client) },
                headers: { "X-CSRFToken": '{{ csrf_token }}' },
                success: function (response) {
                    $('#modal-client-create #container-loading').css('display', 'none');
                    $('#modal-client-create #btn-save-client').prop('disabled', false);
                    if (response.success) {
                        toastr.success(response.message, '¡Bien hecho!');
                        if (response.client_id) {
                            let $footer = $('#modal-client-create .modal-footer');
                            if ($footer.find('#btn-select-client-sales').length === 0) {
                                $footer.append(
                                    '<button type="button" id="btn-select-client-sales" class="btn btn-success border-2 btn-sales-rounded ml-2">' +
                                    '<i class="fas fa-check mr-1"></i> Seleccionar</button>'
                                );
                            }
                            $('#btn-select-client-sales').off('click').on('click', function () {
                                $('#client-id').val(response.client_id);
                                $('#person-names').val(response.names);
                                let $sel = $('#client_address');
                                $sel.empty();
                                if (response.addresses && response.addresses.length > 0) {
                                    response.addresses.forEach(function (addr) {
                                        $sel.append($('<option>').val(addr).text(addr.toUpperCase()));
                                    });
                                } else {
                                    $sel.append('<option value="">Sin direcciones</option>');
                                }
                                $('#cod_unit_exe').val(response.cod_siaf || '-');
                                $('#modal-client-create').modal('hide');
                                toastr.info('Cliente cargado en el formulario', 'Listo');
                            });
                        }
                    }
                },
                error: function (jqXhr) {
                    $('#modal-client-create #container-loading').css('display', 'none');
                    $('#modal-client-create #btn-save-client').prop('disabled', false);
                    toastr.error(jqXhr.responseJSON && jqXhr.responseJSON.message ? jqXhr.responseJSON.message : 'Error al guardar', 'Error');
                }
            });
        });

        // Limpiar botón Seleccionar al cerrar el modal de nuevo cliente
        $('#modal-client-create').on('hidden.bs.modal', function () {
            $(this).find('#btn-select-client-sales').remove();
        });

    </script>

{% endblock extrajs %}
