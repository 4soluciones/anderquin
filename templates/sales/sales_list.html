{% extends 'home.html' %}
{% load static %}
{% load operations %}
{% block title %}
    Ventas
{% endblock title %}

{% block body %}

    {% if error != "" %}
        <div class="alert alert-danger" role="alert">
            <h4 class="alert-heading">Inconcebible!</h4>
            <p>{{ error }}</p>
            <hr>
        </div>
    {% endif %}

    <div class="card-group" style="display: flex;">
        <div class="card p-0" style="flex: 0 0 47%;" id="tab-two">
            {% include "sales/sales_grid_tab1.html" %}
        </div>
        <div class="card p-0" style="flex: 0 0 53%;">
            <div class="col-sm-12 m-0 p-0 align-items-center">
                <div id="product_list_sales">

                    <div class="card text-center roboto-condensed-regular p-3 border-info m-3">
                        <div class="card-header font-weight-bold text-black-50" style="background-color: #88a3b9 ">
                            Atencion!
                        </div>
                        <div class="card-body">
                            <h5 class="card-title text-info roboto-condensed-regular font-weight-bold">Ingrese un texto
                                para comenzar la búsqueda...</h5>
                        </div>
                    </div>
                </div>
            </div>
            <div class="loader-container col-auto" id="loader-product" style="display: none;">
                <div class="loader"></div>
            </div>
        </div>
    </div><!-- card-group -->


{% endblock body %}


{% block extrajs %}

    <script type="text/javascript">

        loader = '<div class="container">' +
            '<div class="row">' +
            '<div class="col-md-12">' +
            '<div class="loader">' +
            '<p><strong>Cargando Reniec/Sunat...</strong></p>' +
            '<div class="loader-inner"></div>' +
            '<div class="loader-inner"></div>' +
            '<div class="loader-inner"></div>' +
            '</div>' +
            '</div>' +
            '</div>' +
            '</div>';

        loader2 = '<div class="container">' +
            '<div class="row">' +
            '<div class="col-md-12">' +
            '<div class="loader">' +
            '<p>Cargando Comprobante...</p>' +
            '<div class="loader-inner"></div>' +
            '<div class="loader-inner"></div>' +
            '<div class="loader-inner"></div>' +
            '</div>' +
            '</div>' +
            '</div>' +
            '</div>';

        $("#id-nro-document-sender").attr('maxlength', 8);
        sessionStorage.setItem('document', '01');
        sessionStorage.setItem('BillType', 'V');

        $(document).on('click', '#btn-new-form', function () {
            location.reload();
        });

        if ($("#radio2").is(':checked')) {
            $("#document_type_sender").attr('disabled', 'disabled');
            $("#id_client_name").removeAttr('disabled');
            $("#document_type_sender").find('option[value]').removeAttr('selected');
            $("#document_type_sender").find('option[value="0"]').attr('selected', 'selected');
            $("#id-nro-document-sender").attr('readonly', true);
            $("#document_type_sender").trigger('change');
        }

        $("#radio1,#radio2").click(function () {
            if ($("#radio1").is(':checked')) {
                $("#id_client_name").attr('disabled', 'disabled');
                $("#document_type_sender").removeAttr('disabled');
                $("#id-nro-document-sender").attr('readonly', false);
                $("#id_client_name").find('option[value]').removeAttr('selected');
                $("#id_client_name").find('option[value="0"]').attr('selected', 'selected');
                $("#id_client_name").trigger('change');
                $('#document_type_sender').val(0);
                $("#id_sender").val('');
                $("#id-nro-document-sender").val('');
                $("#id_address").val('');
                $(".client-table").val('');
                $(".client-table").attr('placeholder', '')
                $(".client-table").attr('disabled', 'disabled');

            } else if ($("#radio2").is(':checked')) {
                $("#document_type_sender").attr('disabled', 'disabled');
                $("#id_client_name").removeAttr('disabled');
                $("#document_type_sender").find('option[value]').removeAttr('selected');
                $("#document_type_sender").find('option[value="0"]').attr('selected', 'selected');
                $("#id_sender").val('');
                $("#id_address").val('');
                $("#document_type_sender").trigger('change');
                $("#id-nro-document-sender").val('');
                $("#id-nro-document-sender").attr('readonly', true);
                $(".client-table").attr('placeholder', 'INGRESE CLIENTE Y PRESIONE ENTER...')
                $(".client-table").removeAttr('disabled');
            }
        });

        $('#transaction_payment_type').change(function () {
            let type = $('#transaction_payment_type').val();
            if (type === 'E') {
                $('#cash').css('display', '');
                $('#deposit').css('display', 'none');
                $('#id_cash').trigger('change');
                $('#credit').css('display', 'none');
            } else if (type === 'D') {
                $('#deposit').css('display', '');
                $('#cash').css('display', 'none');
                $('#credit').css('display', 'none');
            } else if (type === 'C') {
                $('#credit').css('display', '');
                $('#cash').css('display', 'none');
                $('#deposit').css('display', 'none');
            } else if (type === '0') {
                $('#credit').css('display', 'none');
                $('#cash').css('display', 'none');
                $('#deposit').css('display', 'none');
            }
        });

        $(document).on('change', '#document_type_sender', function () {
            let _val = $(this).val();
            if (_val === '01') {
                $("#id-nro-document-sender").attr('maxlength', 8);
                sessionStorage.setItem('document', '01')
                $('#id-nro-document-sender').val('');
                $('#id_sender').val('');
                $('#id-address-line').css('display', 'none');
                $('#id_address').val('')
                {#$('#id_address_sender').val('');#}
            } else if (_val === '06') {
                $("#id-nro-document-sender").attr('maxlength', 11);
                sessionStorage.setItem('document', '06')
                $('#id-nro-document-sender').val('');
                $('#id_sender').val('');
                $('#id-address-line').css('display', '');
                $('#id_address').val('')
            } else if (_val === '04' || _val === '07' || _val === '00') {
                $("#id-nro-document-sender").attr('maxlength', 15);
                sessionStorage.setItem('document', '')
                $('#id_sender').val('');
                $('#id-nro-document-sender').val('');
                $('#id-address-line').css('display', 'none');
                $('#id_address').val('')
            }
        });

        $('#id-nro-document-sender').keypress(function (e) {

            if (e.keyCode === 13) {
                e.preventDefault()
                $(this).trigger("enterKey");
                let _document_number = $('#id-nro-document-sender').val();
                if ((sessionStorage.getItem('document') === '01') && (_document_number.length !== 8)) {
                    toastr.warning('¡Favor de completar los caracteres requeridos: 8 caracteres para DNI', 'Error de Datos');
                    return false;
                } else {
                    if ((sessionStorage.getItem('document') === '06') && (_document_number.length !== 11)) {
                        toastr.warning('¡Favor de completar los caracteres requeridos: 11 caracteres para RUC!', 'Error de Datos');
                        return false;
                    }
                }
                if ($('#document_type_sender').val() === '0') {
                    toastr.warning('¡Favor seleecionar un tipo de documento!', 'Error de Datos');
                    return false;
                }

                $('#loading-666').html(loader).show()

                $.ajax({
                    url: '/sales/get_name_business/',
                    async: true,
                    dataType: 'json', // for response
                    type: 'GET',
                    data: {
                        'nro_document': $('#id-nro-document-sender').val(),
                        'type': $('#document_type_sender').val()
                    },
                    contentType: 'application/json;charset=UTF-8',
                    headers: {"X-CSRFToken": '{{ csrf_token }}'},
                    success: function (response, textStatus, xhr) {
                        if (xhr.status === 200) {
                            toastr.success(response.message, '¡Bien hecho!');
                            $("#client_name").val(response.result);
                            $("#client-id").val(response.client_id);
                            $("#client_address").val(response.address);
                            $('#loading-666').hide();
                        }
                    },
                    error: function (jqXhr, textStatus, xhr) {
                        if (jqXhr.status === 500) {
                            toastr.error(jqXhr.responseJSON.error, '¡Error de Consulta!');
                        } else {
                            if (textStatus === 'timeout') {
                                toastr.error('Failed from timeout', '¡Error de Consulta!');
                            } else {
                                console.log(" STATUS: " + xhr + " " + textStatus);
                            }
                        }
                        $('#loading-666').hide();
                    },
                });
                return false;
            }
        });

        function hasRowDetails() {
            var _response = false;
            if ($("#sales-details tr").length > 0) {
                _response = true;
            }
            return _response;
        }

        function calculateTotal() {
            var sum = 0;
            $('#sales-details tr td.item-total').each(function () {
                let total_detail = Number($(this).find('input.input-total-detail').val());
                sum = sum + total_detail;
            });
            $('#sum-total').val(sum.toFixed(2));
        }

        function deleteItem($product, $unit) {
            let quantity_delete = 0
            let quantity_min = 0
            let rows = $('#sales-details').find("tr[product=" + $product + "][pu=" + $unit + "]");
            quantity_delete = parseFloat(rows.find('td.item-quantity input.input-quantity').val());
            quantity_min = parseFloat(rows.find('td.item-unit').attr('unit_min'));
            $('#sales-details').find("tr[product=" + $product + "][pu=" + $unit + "]").remove();
            let _row = $('table#product-data-grid tbody tr[product=' + $product + ']');
            let old_stock = parseFloat(_row.find('td.td-table-stock table.table-stock-headquarters tbody tr.my-subsidiary[store_="V"] td.item-stock').text());
            _row.find('td.td-table-stock table.table-stock-headquarters tbody tr.my-subsidiary[store_="V"] td.item-stock').text((old_stock + (quantity_delete * quantity_min)).toFixed(2));
            calculateTotal();
            counterStrike();
        }

        function counterStrike() {
            var index = 1;
            $('#sales-details tr').each(function () {
                $(this).attr('i', index);
                $(this).children('td:first').text(index);
                index++;
            });
        }

        $(document).on('click', 'table#product-data-grid tbody tr td table.table-prices tbody tr td.prices-list div button', async function () {
            let value = $(this).attr('pk');
            let price = parseFloat($(this).attr('ip'));
            let tr = $(this).parent('div').parent('div').parent('td').parent('tr');
            let unit_id = tr.attr('unit');
            let name_unit = tr.attr('unitname');
            let product_id = tr.attr('product');
            let product_brand = tr.attr('product_brand');
            let name_product = tr.attr('productname');
            let quantity_minim = parseFloat(tr.attr('quantity_minum'));
            let quantity = parseFloat(tr.find('td.quantity-sales-price input.quantity-select').val());
            let stock = parseFloat(tr.parent('tbody').parents('table.table-prices').parent('td').parent('tr').find('td.td-table-stock table.table-stock-headquarters tbody tr.my-subsidiary[store_="V"] td.item-stock').text());
            let store_id = tr.parent('tbody').parents('table.table-prices').parent('td').parent('tr').find('td.td-table-stock table.table-stock-headquarters tbody tr.my-subsidiary').attr('store_id');
            if (isNaN(quantity)) {
                toastr.warning('Ingrese la cantidad del producto');
                tr.find('td.quantity-sales-price input.quantity-select').val('')
                return false
            }
            if (quantity === '' || quantity === 0) {
                toastr.warning('Ingrese la cantidad del producto');
                tr.find('td.quantity-sales-price input.quantity-select').val('')
                return false
            }
            if (quantity < 0) {
                toastr.warning('La cantidad debe ser un valor positivo');
                tr.find('td.quantity-sales-price input.quantity-select').val('')
                return false
            }
            if ($("#sales-details tr[product=" + product_id + "][pu=" + unit_id + "]").length) {
                let $msg = 'El producto con este tipo de unidad ya se encuentra en el registro.';
                toastr.warning($msg, 'Mensaje');
                tr.find('td.quantity-sales-price input.quantity-select').val('')
                return false;
            }
            let _flag_stock = await check_stock(quantity, product_id)

            if (_flag_stock === true) {
                addDetail(unit_id, product_id, quantity, price, name_unit, unescape(name_product), store_id, quantity_minim, product_brand);
                tr.parent('tbody').parents('table.table-prices').parent('td').parent('tr').find('td.td-table-stock table.table-stock-headquarters tbody tr.my-subsidiary[store_="V"] td.item-stock').text((stock - quantity * quantity_minim).toFixed(2));
            } else {
                toastr.warning('STOCK INSUFICIENTE EN ALMACEN');
            }

            tr.find('td.quantity-sales-price input.quantity-select').val('');
        });


        function addDetail(a, b, c, d, e, f, g, h, i) {

            let _unit_id = a
            let _product_id = b
            let _quantity = Number(c)
            let _price = parseFloat(d)
            let _total = _quantity * _price
            let _unit = e
            let _product_name = escapeHtml(f)
            let _product_store = g
            let _quantity_minim = parseFloat(h)

            console.log(_quantity)
            console.log(_price.toFixed(2))

            $('#sales-details').append(
                '<tr detail_id="' + 'NaN' + '" product="' + _product_id + '" store_p="' + _product_store + '" pu="' + _unit_id + '" class="text-uppercase small text-center" style="font-size: 14px;">' +
                '<td class="align-middle">' + '</td>' +
                '<td class="align-middle text-left item-product">' + '<input type="text" class="form-control form-control-sm input-product-name" value="' + _product_name + '">' + '</td>' +
                '<td class="align-middle item-quantity">' + '<input type="text" class="form-control form-control-sm text-right input-quantity" disabled value="' + _quantity.toFixed(2) + '">' + '</td>' +
                '<td class="align-middle item-unit" pu="' + _unit_id + '" unit_min="' + _quantity_minim + '">' + _unit + '</td>' +
                '<td class="align-middle item-price">' + '<input type="text" class="form-control form-control-sm text-right input-price" value="' + _price.toFixed(2) + '">' + '</td>' +
                '<td class="align-middle item-total">' + '<input type="text" class="form-control form-control-sm text-right input-total-detail" value="' + _total.toFixed(2) + '">' + '</td>' +
                '<td>' + '<button type="button" onclick="deleteItem(' + _product_id + ',' + _unit_id + ')" class="btn btn-danger btn-sm">' +
                '<i class="fa fa-trash"></i></button>' + '</td>' +
                '</tr>'
            );
            calculateTotal();
            counterStrike();
        }

        function escapeHtml(text) {
            var map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };

            return text.replace(/[&<>"']/g, function (m) {
                return map[m];
            });
        }

        $(document).on('keypress', '#custom-search-product', function (e) {

            $('#product_list_sales').empty();
            $('#custom-search-barcode').val(' ')

            if (e.keyCode === 13) {

                e.preventDefault()

                $(this).trigger("enterKey");

                let _product_name = $(this).val().trim();

                if (_product_name.length === 0) {
                    toastr.warning('¡Favor de ingresar una busqueda', 'Error de Datos');
                    return false;
                }
                getProduct(_product_name, '')

            }
        });

        function getProduct($product_name, $barcode) {

            $('div#loader-product').css('display', '');
            $.ajax({
                url: '/sales/get_product_grid/',
                async: true,
                dataType: 'json', // for response
                type: 'GET',
                data: {
                    'value': $product_name,
                    'barcode': $barcode
                },
                contentType: 'application/json;charset=UTF-8',
                headers: {"X-CSRFToken": '{{ csrf_token }}'},
                success: function (response, textStatus, xhr) {
                    if (xhr.status === 200) {
                        toastr.success(response.message, '¡Bien hecho!');
                        {#$('#product-grid-list').html(response.grid);#}
                        $('#product_list_sales').html(response.grid).slideDown();
                        $('div#loader-product').css('display', 'none');
                    }
                },
                error: function (jqXhr, textStatus, xhr) {
                    if (jqXhr.status === 500) {
                        toastr.error(jqXhr.responseJSON.error, '¡Error de Consulta!');
                    } else {
                        if (textStatus === 'timeout') {
                            toastr.error('Failed from timeout', '¡Error de Consulta!');
                        } else {
                            console.log(" STATUS: " + xhr + " " + textStatus);
                        }
                    }
                }
            });
        }

        $(document).on('keyup', '#sales-details tr td.item-price input.input-price', function (e) {
            let val = Number($(this).val());
            let row = $(this).parent('td.item-price').parent('tr');
            let quantity = Number(row.find('td.item-quantity input.input-quantity').val());
            {#console.log('quantity',quantity)#}
            {#console.log('val',val)#}
            if (isNaN(val)) {
                $(this).val('')
            } else {
                let total_detail = quantity * val
                if (val !== '') {
                    row.find('td.item-total input.input-total-detail').val((total_detail).toFixed(2))
                    calculateTotal();
                }
            }
        });

        $(document).on('keyup', '#sales-details tr td.item-quantity input.input-quantity', function (e) {
            let val = Number($(this).val());
            let row = $(this).parent('td.item-quantity').parent('tr');
            let price = Number(row.find('td.item-price input.input-price').val());
            if (isNaN(val)) {
                $(this).val('')
            } else {
                if (val !== '') {
                    row.find('td.item-total input.input-total-detail').val((price * val).toFixed(2))
                    calculateTotal();
                }
            }
        });

        $(document).on('keyup', '#sales-details tr td.item-total input.input-total-detail', function (e) {
            let val = Number($(this).val());
            {#console.log('total', val)#}
            let row = $(this).parent('td.item-total').parent('tr');
            let quantity = Number(row.find('td.item-quantity input.input-quantity').val());
            let price = Number(row.find('td.item-price input.input-price').val());
            {#console.log('quantity', quantity)#}

            let price_unit = val / quantity
            {#console.log('price_unit', price_unit)#}
            row.find('td.item-price input.input-price').val((price_unit).toFixed(2))
            calculateTotal();

        });

        $(document).on('change', '#document_type_client', async function () {
            let _val = $(this).val();
            if (_val === '01') {
                $("#document_number_client").attr('maxlength', 8);
                sessionStorage.setItem('client-document', '01')
                $('#document_number_client').val('');
            } else if (_val === '06') {
                $("#document_number_client").attr('maxlength', 11);
                sessionStorage.setItem('client-document', '06')
                $('#document_number_client').val('');
            } else if (_val === '00') {
                $("#document_number_client").attr('maxlength', 15);
                sessionStorage.setItem('client-document', '')
                let new_n_order = await get_last_number_others();
                $('#document_number_client').val(new_n_order);
            }
        });

        $("#document_number_client").attr('maxlength', 8);
        sessionStorage.setItem('client-document', '01')

        async function check_stock(_quantity, _product_id) {

            let _flag_stock = true

            await $.ajax({
                url: '/sales/check_stock/',
                async: true,
                dataType: 'json', // for response
                type: 'GET',
                data: {
                    'quantity': _quantity,
                    'product': _product_id
                },
                contentType: 'application/json;charset=UTF-8',
                headers: {"X-CSRFToken": '{{ csrf_token }}'},
                success: function (response, textStatus, xhr) {
                    if (xhr.status === 200) {
                        {#console.log(response.flag)#}
                        _flag_stock = response.flag;
                    }
                },
                error: function (jqXhr, textStatus, xhr) {
                    toastr.error('¡ERROR!');
                }
            });
            return _flag_stock
        }

        async function get_last_number_others() {

            let new_n_order = 0;

            await $.ajax({
                url: '/sales/get_last_id_type_others/',
                async: true,
                dataType: 'json', // for response
                type: 'GET',
                data: {},
                contentType: 'application/json;charset=UTF-8',
                headers: {"X-CSRFToken": '{{ csrf_token }}'},
                success: function (response, textStatus, xhr) {
                    if (xhr.status === 200) {
                        new_n_order = response.new_n_order;
                        //console.log(new_n_order)
                    }
                },
                error: function (jqXhr, textStatus, xhr) {
                    toastr.error('¡ERROR!');
                }
            });
            return new_n_order
        }

        new Autocomplete('#autocomplete-client', {
            search: input => {
                const url = `/buys/get_client/?search=${encodeURI(input.toUpperCase())}`

                return new Promise(resolve => {
                    if (input.length < 3) {
                        //$('#person-number').val('')
                        //$('#order-number').val('')
                        return resolve([])
                    }
                    fetch(url)
                        .then(response => response.json())
                        .then(data => {
                            resolve(data.client)
                        })
                })
            },
            renderResult: (result, props) => {
                let group = ''
                if (result.index % 3 === 0) {
                    group = '<li class="group">Group</li>'
                }
                return `
                ${group}
                <li ${props}>
                 <div class="h6" style="font-family: roboto_condensed_regular">
                    ${result.names}
                 </div>
                 <div class="wiki-snippet text-black">
                    Tipo: ${result.type_client_display}
                  </div>
                </li>
                `
            },
            getResultValue: result => result.names,
            onSubmit: result => {
                if (result) {
                    let client_id = result.id;
                    let type_client = result.type_client;
                    let _address_dict = result.address;
                    $('#id-client').val(client_id);
                    $('#client_name').val(result.names);
                    $('#client_address').val(result.last_address);

                } else {
                    toastr.warning('Seleccione un cliente valido', 'Error de llenado');
                    return false;
                }

            }
        });

        function searchSale() {
            let correlative = $('#search_sale').val();
            $.ajax({
                url: '/sales/get_order_by_correlative/',
                async: true,
                dataType: 'json',
                type: 'GET',
                data: {'correlative': correlative},
                success: function (response) {
                    if (response.success) {
                        $(".sale").addClass('d-none');
                        $(".sale-store").removeClass('d-none');
                        $("#order_id").val(response.order_id);
                        $('#transaction_payment_type').val(response.transaction_payment_type)
                        $("#transaction_payment_type").trigger('change');
                        let Detail = response['detail'];
                        console.log(Detail)
                        $('table#id-table-detail-order tbody#sales-details').empty();
                        Detail.forEach(
                            e =>
                                addOrderDetail(e.id, e.product_id, e.product_name, e.quantity, e.price, e.unit_id, e.unit_name, e.unit_min)
                        )
                    } else {
                        toastr.error(response.message);
                    }
                },
                fail: function (response) {
                    toastr.error("error");
                }
            });
        }

        function addOrderDetail(detail, product_id, product_name, quantity, price, unit, unit_name, unit_min) {

            let _total = quantity * price
            $('#sales-details').append(
                '<tr detail_id="' + detail + '" product="' + product_id + '" unit="' + unit + '" class="text-uppercase small text-center" style="font-size: 14px;">' +
                '<td class="align-middle">' + '</td>' +
                '<td class="align-middle text-left item-product">' + '<input type="text" class="form-control form-control-sm input-product-name" value="' + product_name + '">' + '</td>' +
                '<td class="align-middle item-quantity">' + '<input type="number" class="form-control form-control-sm text-right input-quantity" value="' + Number(quantity).toFixed(0) + '">' + '</td>' +
                '<td class="align-middle item-unit" unit="' + unit + '" unit_min="' + unit_min + '">' + unit_name + '</td>' +
                '<td class="align-middle item-price">' + '<input type="number" class="form-control form-control-sm text-right input-price" value="' + Number(price).toFixed(2) + '">' + '</td>' +
                '<td class="align-middle item-total">' + '<input type="number" class="form-control form-control-sm text-right input-total-detail" value="' + Number(_total).toFixed(2) + '">' + '</td>' +
                '<td>' + '<button type="button" onclick="deleteItem(' + product_id + ',' + unit + ')" class="btn btn-danger btn-sm">' +
                '<i class="fa fa-trash"></i></button>' + '</td>' +
                '</tr>'
            );
            calculateTotal();
            counter();
        }
        function counter() {
            let index = 1;
            $('#sales-details tr').each(function () {
                $(this).attr('i', index);
                $(this).children('td:first').text(index);
                index++;
            });

        }

    </script>

{% endblock extrajs %}
