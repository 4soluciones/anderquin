{% extends 'home.html' %}

{% load static %}
{% load operations %}
{% load app_filters %}

{% block title %}
    Cotización
{% endblock title %}

{% block body %}

    <input type="hidden" id="id_order_sale_quotation" value="">
    <input type="hidden" id="id_order_sale_quotation_correlative" value="">
    <input type="hidden" id="id_distribution" value="">
    <input type="hidden" id="id-type-order" value="V">
    <input type="hidden" id="id_cash" value="">
    <input type="hidden" id="id_date" value="">
    <input type="hidden" id="id_cash_deposit" value="">
    <input type="hidden" id="code-operation" value="">
    <input type="checkbox" id="demo" value="1" style="display:none;">
    <input type="hidden" id="user_id" value="">
    <input type="hidden" id="document_type_sender" value="">
    <input type="hidden" id="id-nro-document-sender" value="">

    {% if error %}
        <div class="alert alert-danger" role="alert">
            <h4 class="alert-heading">Error</h4>
            <p>{{ error }}</p>
        </div>
    {% else %}
        <div class="container-fluid py-2 roboto-condensed-regular" style="background-color: #e8f4f8; min-height: 100vh;">
            <div class="card border-0 shadow-lg mb-4 overflow-hidden" style="border-radius: 15px;">
                <!-- Barra de búsqueda de producto -->
                <div class="card-body border-bottom py-2 py-md-3" style="background-color: #f0f8fc;">
                    <div class="row align-items-center no-gutters">
                        <div class="col-12 col-lg-8 mb-2 mb-lg-0 pr-lg-2">
                            <div id="autocomplete-product-quotation" class="autocomplete autocomplete-product-sales d-flex align-items-center flex-wrap">
                                <label for="product-names-quotation" class="mb-0 mr-2 text-nowrap small font-weight-bold text-uppercase text-muted" style="font-size: 0.8rem;">Buscar producto para cotización</label>
                                <div class="input-group input-group-sm shadow-sm border rounded-pill overflow-hidden flex-grow-1" style="min-width: 200px; border-color: #bbdefb !important;">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text bg-white border-0 py-2"><i class="fas fa-search text-primary" style="font-size: 0.9rem;"></i></span>
                                    </div>
                                    <input class="form-control form-control-sm autocomplete-input autocomplete-input-product border-0 py-2"
                                           type="text" aria-label="Buscar producto"
                                           id="product-names-quotation"
                                           name="product-names"
                                           maxlength="200"
                                           autocomplete="off"
                                           placeholder="Mín. 3 letras..."
                                           style="font-size: 0.875rem;">
                                </div>
                                <ul class="autocomplete-result-list autocomplete-product-dropdown"></ul>
                            </div>
                        </div>
                        <div class="col-12 col-lg-3 col-xl-2 pl-lg-0">
                            <button type="button" id="clean_product_quotation"
                                    class="btn btn-outline-danger btn-sm border-2 btn-sales-rounded w-100 py-2">
                                <i class="fas fa-sync-alt"></i> Limpiar
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card-body p-0 p-md-3" style="background-color: #e3f2fd;">
                    <div class="row no-gutters">
                        <!-- Columna izquierda: Lista de productos -->
                        <div class="col-12 col-xl-5 pr-xl-2 mb-3 mb-xl-0">
                            <div id="product_list_sales">
                                <div class="card text-center roboto-condensed-regular p-4 border-0 shadow-sm" style="background-color: #fff; border-radius: 12px;">
                                    <div class="card-header font-weight-bold border-0 py-2" style="background: linear-gradient(180deg, #bbe0f5 0%, #90caf9 100%); border-radius: 12px 12px 0 0;">
                                        <span style="color: #0d47a1;">Atención</span>
                                    </div>
                                    <div class="card-body py-4">
                                        <h5 class="card-title roboto-condensed-regular font-weight-bold mb-0" style="color: #1565c0;">
                                            Ingrese un producto para comenzar la búsqueda...
                                        </h5>
                                    </div>
                                </div>
                            </div>
                            <div class="loader-container col-auto mt-2" id="loader-product" style="display: none;">
                                <div class="loader-quotation">
                                    <div class="loader-quotation-dot"></div>
                                    <div class="loader-quotation-dot"></div>
                                    <div class="loader-quotation-dot"></div>
                                </div>
                                <p class="text-muted small mt-2">Cargando productos...</p>
                            </div>
                        </div>

                        <!-- Columna derecha: Formulario de cotización -->
                        <div class="col-12 col-xl-7 pl-xl-0">
                            <div class="card border-0 shadow-sm roboto-condensed-regular overflow-hidden" style="border-radius: 15px;">
                                <div class="card-header py-3 text-center" style="background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);">
                                    <div class="title-without">
                                        <h5 class="roboto-condensed-regular text-white font-weight-bold mb-0">
                                            <i class="fas fa-file-invoice mr-2"></i> NUEVA COTIZACIÓN
                                        </h5>
                                    </div>
                                    <div class="title-with text-white d-none">
                                        <h5 class="roboto-condensed-regular font-weight-bold mb-0">
                                            <i class="fas fa-edit mr-2"></i> EDITAR COTIZACIÓN Nº: <span id="lbl-order"></span>
                                        </h5>
                                        <input type="hidden" id="order_id" value="">
                                    </div>
                                </div>

                                <div class="card-body p-2 p-md-3" style="background-color: #f0f8fc;">
                                    <!-- Acciones: Buscar, Guardar, Nuevo -->
                                    <div class="row mb-3 mx-0 bg-white rounded p-2 border" style="border-color: #bbdefb !important;">
                                        <div class="col-12 col-md-6 mb-2 mb-md-0">
                                            <div class="input-group input-group-sm shadow-sm rounded overflow-hidden">
                                                <input id="id-search-quotation" type="text" class="form-control" placeholder="Nº cotización"
                                                       autocomplete="off" style="border-color: #bbdefb;">
                                                <div class="input-group-append">
                                                    <button id="btn-search-quotation" class="btn btn-outline-success border-2 btn-sales-rounded btn-sm" type="button">
                                                        <i class="fa fa-search"></i> Buscar
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-12 col-md-6">
                                            <div class="d-flex flex-wrap w-100 quotation-actions-btns">
                                                <div class="flex-grow-1 save-order px-1 mb-1 mb-md-0" style="min-width: 90px;">
                                                    <button type="button" id="btn-save-quotation" class="btn btn-outline-success border-2 btn-block btn-sales-rounded btn-sm py-2">
                                                        <i class="fas fa-save"></i> Guardar
                                                    </button>
                                                </div>
                                                <div class="flex-grow-1 update-order d-none px-1 mb-1 mb-md-0" style="min-width: 90px;">
                                                    <button type="button" id="btn-update-order" class="btn btn-outline-primary border-2 btn-block btn-sales-rounded btn-sm py-2">
                                                        <i class="fas fa-sync"></i> Actualizar
                                                    </button>
                                                </div>
                                                <div class="flex-grow-1 px-1 mb-1 mb-md-0" style="min-width: 90px;">
                                                    <button type="button" id="btn-new-form" class="btn btn-outline-warning border-2 btn-block btn-sales-rounded btn-sm py-2">
                                                        <i class="far fa-check-circle"></i> Nuevo
                                                    </button>
                                                </div>
                                                <div class="flex-grow-1 px-1 mb-1 mb-md-0" style="min-width: 90px;">
                                                    <button type="button" onclick="showModalView('modal_client_create')" class="btn btn-outline-info border-2 btn-block btn-sales-rounded btn-sm py-2">
                                                        <i class="fas fa-user-plus"></i> Cliente
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Cliente -->
                                    <fieldset class="border rounded p-2 p-md-2 mb-3" style="background-color: #fff; border-color: #bbdefb !important;">
                                        <legend class="w-auto mb-0 px-2 text-uppercase small font-weight-bold" style="font-size: 11px; color: #1565c0;">Información del cliente</legend>
                                        <div class="form-row m-0">
                                            <div class="form-group col-12 col-md-5 mb-2 text-uppercase small">
                                                <label class="mb-1 font-weight-bold">Buscar cliente</label>
                                                <div id="autocomplete-client" class="autocomplete">
                                                    <input class="form-control form-control-sm autocomplete-input" type="text"
                                                           id="person-names" name="person-names" maxlength="200" autocomplete="off"
                                                           placeholder="Nombres o Razón Social..."/>
                                                    <ul class="autocomplete-result-list"></ul>
                                                </div>
                                                <input type="hidden" id="id-client-sender" name="id-client-sender" value="">
                                            </div>
                                            <div class="form-group col-12 col-md-4 mb-2 text-uppercase small">
                                                <label class="mb-1 font-weight-bold">Cliente - Nombres/Razón social</label>
                                                <input type="text" class="form-control form-control-sm text-uppercase" id="id_sender"
                                                       name="sender" readonly placeholder="">
                                            </div>
                                            <div class="form-group col-12 col-md-3 mb-2 text-uppercase small">
                                                <label class="mb-1 font-weight-bold">Dirección</label>
                                                <input type="text" class="form-control form-control-sm text-uppercase" id="id_address"
                                                       name="name_address" placeholder="">
                                            </div>
                                        </div>
                                    </fieldset>

                                    <!-- Datos de cotización -->
                                    <fieldset class="border rounded p-2 p-md-3 mb-3" style="background-color: #fff; border-color: #bbdefb !important;">
                                        <legend class="w-auto mb-0 px-2 text-uppercase small font-weight-bold" style="font-size: 11px; color: #1565c0;">Datos de la cotización</legend>
                                        <div class="form-row m-0">
                                            <div class="form-group col-6 col-md-3 mb-2 text-uppercase small">
                                                <label class="mb-1 font-weight-bold">Tipo de Pago</label>
                                                <select id="transaction_payment_type" class="form-control form-control-sm">
                                                    <option value="0">Seleccione</option>
                                                    {% for item in choices_payments %}
                                                        <option value="{{ item.0 }}">{{ item.1 }}</option>
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="form-group col-6 col-md-2 mb-2 text-uppercase small">
                                                <label class="mb-1 font-weight-bold">Serie</label>
                                                <select id="id_serie" name="id_serie" class="form-control form-control-sm">
                                                    <option value="0">Seleccione</option>
                                                    {% for serie in series %}
                                                        {% if serie.serial %}
                                                            <option value="{{ serie.id }}">{{ serie.serial|zfill:4 }}</option>
                                                        {% endif %}
                                                    {% endfor %}
                                                </select>
                                            </div>
                                            <div class="form-group col-6 col-md-2 mb-2 text-uppercase small">
                                                <label class="mb-1 font-weight-bold">Fecha</label>
                                                <input type="date" class="form-control form-control-sm" id="date" value="{{ date }}">
                                            </div>
                                            <div class="form-group col-6 col-md-2 mb-2 text-uppercase small">
                                                <label class="mb-1 font-weight-bold">Válido hasta</label>
                                                <input type="date" class="form-control form-control-sm" id="id_validity_date" value="{{ date }}">
                                            </div>
                                            <div class="form-group col-6 col-md-3 mb-2 text-uppercase small">
                                                <label class="mb-1 font-weight-bold">Días de entrega</label>
                                                <input type="number" class="form-control form-control-sm" id="id_date_completion" name="date_completion" placeholder="Ej: 7" min="0">
                                            </div>
                                            <div class="form-group col-12 col-md-6 mb-2 text-uppercase small">
                                                <label class="mb-1 font-weight-bold">Lugar de entrega</label>
                                                <input type="text" class="form-control form-control-sm text-uppercase" id="id_place_delivery"
                                                       name="place_delivery" placeholder="Dirección o referencia de entrega">
                                            </div>
                                            <div class="form-group col-12 col-md-6 mb-0 text-uppercase small">
                                                <label class="mb-1 font-weight-bold">Observación</label>
                                                <input type="text" class="form-control form-control-sm text-uppercase" id="id_observation"
                                                       name="observation" placeholder="" autocomplete="off">
                                            </div>
                                        </div>
                                    </fieldset>

                                    {% include "sales/quotation_detail.html" %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    {% endif %}

    <div id="loading-666" class="quotation-overlay-loader" style="display: none;">
        <div class="quotation-loader-content">
            <div class="loader-quotation">
                <div class="loader-quotation-dot"></div>
                <div class="loader-quotation-dot"></div>
                <div class="loader-quotation-dot"></div>
            </div>
            <p class="text-muted mt-2 mb-0">Procesando...</p>
        </div>
    </div>

    <div class="modal fade" id="modal-client-create" tabindex="-1" role="dialog"
         aria-labelledby="ModalHelpTitle" aria-hidden="true"></div>

    <style>
        .form-control:focus {
            box-shadow: 0 0 0 0.2rem rgba(30, 58, 95, 0.25);
            border-color: #1e3a5f;
        }
        .btn-outline-primary, .btn-outline-success, .btn-outline-warning, .btn-outline-danger, .btn-outline-secondary, .btn-outline-info {
            border-width: 2px;
        }
        .btn-sales-rounded { border-radius: 12px !important; }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; }
        #id-table-detail-order td, #id-table-detail-order th { border-color: #bbdefb !important; }
        .detail-order-no-scroll { overflow-y: visible !important; max-height: none !important; overflow-x: auto; }
        .quotation-actions-btns > div { flex: 1 1 0; }
        #product_list_sales #product-data-grid td, #product_list_sales #product-data-grid th { border-color: #bbdefb !important; }
        .autocomplete-product-sales { position: relative; }
        .autocomplete-product-sales .autocomplete-input-product { background-image: none !important; padding-left: 0.75rem !important; }
        .autocomplete-product-dropdown {
            list-style: none; margin: 4px 0 0 0; padding: 0; max-height: 280px; overflow-y: auto;
            background: #fff !important; border: 1px solid #bbdefb; border-radius: 12px;
            box-shadow: 0 8px 24px rgba(30, 58, 95, 0.2); font-size: 0.8125rem;
            min-width: 100%; z-index: 1060 !important; position: absolute !important;
        }
        .autocomplete-product-dropdown li {
            padding: 10px 14px; border-bottom: 1px solid #e3f2fd; cursor: pointer; transition: background 0.15s ease;
            background: #fff !important;
        }
        .autocomplete-product-dropdown li:last-child { border-bottom: none; }
        .autocomplete-product-dropdown li[aria-selected="true"],
        .autocomplete-product-dropdown li:hover {
            background: linear-gradient(90deg, #e3f2fd 0%, #f0f8fc 100%) !important;
        }
        .autocomplete-product-dropdown li .h6 { font-size: 0.875rem; margin-bottom: 2px; color: #0d47a1; }
        .autocomplete-product-dropdown .wiki-snippet { font-size: 0.75rem; color: #5c6bc0; }
        .autocomplete-product-dropdown li.group { display: none; }
        .quotation-overlay-loader {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(232, 244, 248, 0.9);
            display: flex; align-items: center; justify-content: center; z-index: 9999;
        }
        .quotation-loader-content { text-align: center; }
        .loader-quotation {
            display: flex; justify-content: center; align-items: flex-end; gap: 6px; height: 40px; margin: 0 auto;
        }
        .loader-quotation-dot {
            width: 10px; height: 10px; border-radius: 50%; background: #1565c0;
            animation: loader-quotation-bounce 1.4s ease-in-out infinite both;
        }
        .loader-quotation-dot:nth-child(1) { animation-delay: -0.32s; }
        .loader-quotation-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes loader-quotation-bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        @media (max-width: 575.98px) {
            .autocomplete-product-dropdown { min-width: 100%; }
        }
    </style>

{% endblock body %}

{% block extrajs %}
<script type="text/javascript">
(function() {
    'use strict';

    const loaderHtml = '<div class="quotation-loader-content"><div class="loader-quotation"><div class="loader-quotation-dot"></div><div class="loader-quotation-dot"></div><div class="loader-quotation-dot"></div></div><p class="text-muted mt-2 mb-0">Cargando Reniec/Sunat...</p></div>';

    function showLoader() {
        $('#loading-666').html(loaderHtml).show();
    }
    function hideLoader() {
        $('#loading-666').hide();
    }

    function getProductsByNameOrBarcode(productName, barcode) {
        $('#loader-product').show();
        $('#product_list_sales').empty();
        $.ajax({
            url: '/sales/get_product_quotation/',
            async: true,
            dataType: 'json',
            type: 'GET',
            data: { 'value': productName, 'barcode': barcode },
            headers: { "X-CSRFToken": '{{ csrf_token }}' },
            success: function(response, textStatus, xhr) {
                if (xhr.status === 200) {
                    toastr.success(response.message, '¡Bien hecho!');
                    $('#product_list_sales').html(response.grid).slideDown();
                }
                $('#loader-product').hide();
            },
            error: function(jqXhr) {
                toastr.error(jqXhr.responseJSON?.error || 'Error al buscar productos', '¡Error!');
                $('#loader-product').hide();
            }
        });
    }

    document.addEventListener('click', function(e) {
        if (e.target.id === 'clean_product_quotation' || e.target.closest('#clean_product_quotation')) {
            document.getElementById('product_list_sales').innerHTML = '';
            const input = document.getElementById('product-names-quotation');
            if (input) input.value = '';
        }
    });

    $(document).on('click', '#btn-new-form', function() { location.reload(); });

    new Autocomplete('#autocomplete-product-quotation', {
        autoSelect: true,
        search: input => {
            const url = `/sales/get_product_autocomplete/?search=${encodeURI(input.toUpperCase())}`;
            return new Promise(resolve => {
                if (input.length < 3) return resolve([]);
                fetch(url).then(r => r.json()).then(data => resolve(data.product || []));
            });
        },
        renderResult: (result, props) => `
            <li ${props}>
                <div class="h6 font-weight-bold mb-0">${result.names}</div>
                <div class="wiki-snippet">Marca: ${result.brand || '-'}</div>
            </li>`,
        getResultValue: result => result.names,
        onSubmit: result => {
            if (result) getProductsByNameOrBarcode(result.names, '');
            else toastr.warning('Seleccione un producto válido', 'Error');
        }
    });

    $(document).on('keypress', '#product-names-quotation', function(e) {
        if (e.keyCode === 13) {
            e.preventDefault();
            const val = $(this).val().trim();
            if (val.length < 3) {
                toastr.warning('Ingrese al menos 3 caracteres para buscar', 'Error');
                return false;
            }
            getProductsByNameOrBarcode(val, '');
        }
    });

    $(document).on('click', 'table#product-data-grid tbody tr td table.table-prices tbody tr td.prices-list div button', function() {
        const $btn = $(this);
        const tr = $btn.closest('tr');
        const unit_id = tr.attr('unit');
        const product_id = tr.attr('product');
        const name_unit = tr.attr('unitname');
        const name_product = tr.attr('productname');
        const product_brand = tr.attr('product_brand');
        const quantity_minim = parseFloat(tr.attr('quantity_minum'));
        const price = parseFloat($btn.attr('ip'));
        const quantity = parseFloat(tr.find('td.quantity-sales-price input.quantity-select').val());
        const store_id = tr.closest('table#product-data-grid').find('tbody tr[product="' + product_id + '"]').find('td.td-table-stock table.table-stock-headquarters tbody tr.my-subsidiary').attr('store_id') || '';

        if (isNaN(quantity) || quantity <= 0) {
            toastr.warning('Ingrese la cantidad del producto');
            tr.find('td.quantity-sales-price input.quantity-select').val('');
            return false;
        }
        if ($("#sales-details tr[product=" + product_id + "][pu=" + unit_id + "]").length) {
            toastr.warning('El producto con esta unidad ya está en el registro.');
            tr.find('td.quantity-sales-price input.quantity-select').val('');
            return false;
        }
        addOrderDetail(unit_id, product_id, quantity, price, name_unit, name_product, store_id, quantity_minim, 0, 0, product_brand);
        tr.find('td.quantity-sales-price input.quantity-select').val('');
    });

    function addOrderDetail(a, b, c, d, e, f, g, h, i, j, k) {
        const _total = parseFloat(c) * parseFloat(d);
        const stockVal = (j !== undefined && j !== null && !isNaN(j)) ? j : 999999;
        $('#sales-details').append(
            '<tr detail_id="' + i + '" product="' + b + '" store_p="' + (g || '') + '" pu="' + a + '" data-stock="' + stockVal + '" class="text-uppercase small text-center" style="font-size: 14px;">' +
            '<td class="item-check text-center align-middle" style="transform: scale(1.3);">' +
            '<div class="form-check"><input class="form-check-input position-static check-quotation" type="checkbox" checked></div></td>' +
            '<td class="align-middle text-left item-product"><input type="text" class="form-control form-control-sm input-product-name" value="' + (f + (k ? ' - ' + k : '')) + '"></td>' +
            '<td class="align-middle item-quantity"><input type="number" class="form-control form-control-sm text-right input-quantity" value="' + parseFloat(c).toFixed(2) + '"></td>' +
            '<td class="align-middle item-unit" pu="' + a + '" unit_min="' + h + '">' + e + '</td>' +
            '<td class="align-middle item-price"><input type="number" class="form-control form-control-sm text-right input-price" value="' + parseFloat(d).toFixed(2) + '"></td>' +
            '<td class="align-middle item-total"><input type="number" class="form-control form-control-sm text-right input-total-detail" value="' + _total.toFixed(2) + '"></td>' +
            '<td><button type="button" onclick="deleteItem(' + b + ',' + a + ')" class="btn btn-outline-danger btn-sm border-2"><i class="fa fa-trash"></i></button></td></tr>'
        );
        calculateTotal();
    }

    window.deleteItem = function(product, unit) {
        const rows = $('#sales-details').find("tr[product=" + product + "][pu=" + unit + "]");
        const detail_id = parseFloat(rows.attr('detail_id'));
        $('#sales-details').find("tr[product=" + product + "][pu=" + unit + "]").remove();
        calculateTotal();
        if (!isNaN(detail_id) && detail_id > 0) {
            $.get('/sales/delete_item_product/', { detail_id: detail_id, 'X-CSRFToken': '{{ csrf_token }}' });
        }
    };

    function calculateTotal() {
        let sum = 0;
        $('#sales-details tr td.item-total').each(function() {
            sum += Number($(this).find('input.input-total-detail').val()) || 0;
        });
        $('#sum-total').val(sum.toFixed(2));
    }

    $(document).on('keyup', '#sales-details tr td.item-price input.input-price, #sales-details tr td.item-quantity input.input-quantity, #sales-details tr td.item-total input.input-total-detail', function() {
        const row = $(this).closest('tr');
        const qty = Number(row.find('td.item-quantity input.input-quantity').val()) || 0;
        const price = Number(row.find('td.item-price input.input-price').val()) || 0;
        const total = Number(row.find('td.item-total input.input-total-detail').val()) || 0;
        if ($(this).hasClass('input-price') || $(this).hasClass('input-quantity')) {
            row.find('td.item-total input.input-total-detail').val((qty * price).toFixed(2));
        } else if (qty > 0) {
            row.find('td.item-price input.input-price').val((total / qty).toFixed(2));
        }
        calculateTotal();
    });

    function hasRowDetails() {
        return $("#sales-details tr").length > 0;
    }

    function validateQuotationForm() {
        if (!$('#id-client-sender').val() && !$('#id_sender').val()) {
            toastr.warning('¡Seleccione un cliente!', 'Validación');
            $('#person-names').focus();
            return false;
        }
        if ($('#transaction_payment_type').val() === '0') {
            toastr.warning('¡Seleccione el tipo de pago!', 'Validación');
            return false;
        }
        if (!hasRowDetails()) {
            toastr.warning('¡Agregue al menos un producto!', 'Validación');
            return false;
        }
        if (!$('#id_date_completion').val() || !$('#id_place_delivery').val() || !$('#id_observation').val()) {
            toastr.warning('Complete: días de entrega, lugar de entrega y observación', 'Validación');
            return false;
        }
        let invalid = false;
        $("#sales-details tr").each(function() {
            const qty = $(this).find("td.item-quantity input.input-quantity").val();
            const price = $(this).find("td.item-price input.input-price").val();
            if (!qty || parseFloat(qty) <= 0 || !price || parseFloat(price) <= 0) {
                toastr.warning('Revise cantidad y precio de los productos');
                invalid = true;
                return false;
            }
        });
        return !invalid;
    }

    $(document).on('click', '#btn-save-quotation', function() {
        if (!validateQuotationForm()) return;
        const sales = {
            Details: [],
            Client: $('#id-client-sender').val(),
            Address: $('#id_address').val(),
            SaleTotal: $('#sum-total').val(),
            TransactionPaymentType: $('#transaction_payment_type').val(),
            Distribution: $('#id_distribution').val() || '',
            order_type: $('#id-type-order').val() || 'V',
            Serie: $('#id_serie').val(),
            BillType: sessionStorage.BillType || 'V',
            Date: $('#date').val(),
            Demo: $('#demo').is(':checked') ? 1 : 0,
            type_payment: $('#transaction_payment_type').val(),
            cash: $('#id_cash').val() || '',
            date_cash: $('#id_date').val() || '',
            cash_deposit: $('#id_cash_deposit').val() || '',
            cod_operation: $('#code-operation').val() || '',
            validity_date: $('#id_validity_date').val(),
            date_completion: $('#id_date_completion').val(),
            place_delivery: $('#id_place_delivery').val(),
            observation: $('#id_observation').val(),
            order_sale_quotation: Number($('#id_order_sale_quotation').val()) || 0,
            userID: $('#user_id').val() || ''
        };
        $("#sales-details tr").each(function() {
            sales.Details.push({
                Product: $(this).attr('product'),
                Unit: $(this).find("td.item-unit").attr('pu'),
                Quantity: parseFloat($(this).find("td.item-quantity input.input-quantity").val()).toFixed(2),
                Price: parseFloat($(this).find("td.item-price input.input-price").val()).toFixed(2),
                DetailTotal: parseFloat($(this).find("td.item-total input.input-total-detail").val()).toFixed(2),
                _commentary: $(this).find("td.item-product input.input-product-name").val(),
                Check_Quotation: $(this).find("input.check-quotation").is(':checked') ? 1 : 0,
                Store: $(this).attr("store_p") || ''
            });
        });
        $('#btn-save-quotation').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Guardando...');
        $.ajax({
            url: '/sales/save_quotation/',
            dataType: 'json',
            type: 'GET',
            data: { quotations: JSON.stringify(sales) },
            headers: { "X-CSRFToken": '{{ csrf_token }}' },
            success: function(response) {
                toastr.success((response.message || '') + (response.msg_sunat || ''), '¡Guardado!');
                if (response.id_sales) window.open("/sales/print_quotation/" + response.id_sales + "/T/", '_blank');
                setTimeout(() => location.reload(), 2000);
            },
            error: function(jqXhr) {
                toastr.error(jqXhr.responseJSON?.error || 'Error al guardar', '¡Error!');
                $('#btn-save-quotation').prop('disabled', false).html('<i class="fas fa-save"></i> Guardar');
            }
        });
    });

    function SearchQuotation() {
        const correlative = $('#id-search-quotation').val().trim();
        if (!correlative) {
            toastr.warning('Ingrese el número de cotización', 'Validación');
            return;
        }
        $('#id-search-quotation').val('');
        $.ajax({
            url: '/sales/get_order_by_correlative/',
            dataType: 'json',
            type: 'GET',
            data: { correlative: correlative },
            success: function(response) {
                if (response.success) {
                    $('.update-order').removeClass('d-none');
                    $('.save-order').addClass('d-none');
                    $("#order_id").val(response.order_id);
                    $("#id_order_sale_quotation").val(response.order_id);
                    $('.title-without').addClass('d-none');
                    $('.title-with').removeClass('d-none');
                    $('#lbl-order').text(response.correlative);
                    $("#id_order_sale_quotation_correlative").val(response.correlative);
                    $("#id_validity_date").val(response.validity_date);
                    $("#id_date_completion").val(response.date_completion);
                    $("#id_place_delivery").val(response.place_delivery);
                    $("#id_observation").val(response.observation);
                    $("#transaction_payment_type").val(response.transaction_payment_type).trigger('change');
                    $('#person-names').val(response.client_name || '');
                    $('#id-client-sender').val(response.client_id || '');
                    $('#id_sender').val(response.client_name || '');
                    $('#id_address').val(response.address || '');
                    $('#document_type_sender').val(response.document_type || '');
                    $('#id-nro-document-sender').val(response.document_number || '');
                    $('table#id-table-detail-order tbody#sales-details').empty();
                    (response.detail || []).forEach(el =>
                        addOrderDetail(el.unit_id, el.product_id, el.quantity, el.price, el.unit_name, el.product_name, el.store, el.unit_min, el.id, el.stock, el.product_brand)
                    );
                    calculateTotal();
                    $('.print-ticket-bill-quotation').css('display', 'block');
                    toastr.success('Cotización cargada', '¡Bien hecho!');
                } else {
                    toastr.warning(response.message || 'No se encontró la cotización');
                }
            },
            error: function() { toastr.error('Error al buscar', '¡Error!'); }
        });
    }

    $('#btn-search-quotation').on('click', SearchQuotation);
    $('#id-search-quotation').on('keypress', function(e) {
        if (e.keyCode === 13) { e.preventDefault(); SearchQuotation(); }
    });

    $(document).on('click', '#btn-update-order', function() {
        if (!validateQuotationForm()) return;
        if (!$('#id_order_sale_quotation').val()) {
            toastr.warning('No hay cotización para actualizar');
            return false;
        }
        const sales = {
            Details: [],
            Client: $('#id-client-sender').val(),
            SaleTotal: $('#sum-total').val(),
            TransactionPaymentType: $('#transaction_payment_type').val(),
            Distribution: $('#id_distribution').val() || '',
            Type: 'T',
            order_type: $('#id-type-order').val() || 'V',
            Serie: $('#id_serie').val(),
            BillType: sessionStorage.BillType || 'V',
            Date: $('#date').val(),
            type_payment: $('#transaction_payment_type').val(),
            validity_date: $('#id_validity_date').val(),
            date_completion: $('#id_date_completion').val(),
            place_delivery: $('#id_place_delivery').val(),
            observation: $('#id_observation').val(),
            order_sale_quotation: Number($('#id_order_sale_quotation').val()),
            correlative_sale: $('#id_order_sale_quotation_correlative').val()
        };
        $("#sales-details tr").each(function() {
            sales.Details.push({
                Detail: $(this).attr('detail_id'),
                Product: $(this).attr('product'),
                Unit: $(this).find("td.item-unit").attr('pu'),
                Quantity: parseFloat($(this).find("td.item-quantity input.input-quantity").val()).toFixed(2),
                Price: parseFloat($(this).find("td.item-price input.input-price").val()).toFixed(2),
                DetailTotal: parseFloat($(this).find("td.item-total input.input-total-detail").val()).toFixed(2),
                _commentary: $(this).find("td.item-product input.input-product-name").val(),
                Store: $(this).attr("store_p") || ''
            });
        });
        $('#btn-update-order').prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i> Actualizando...');
        $.ajax({
            url: '/sales/update_quotation/',
            dataType: 'json',
            type: 'GET',
            data: { sales: JSON.stringify(sales) },
            headers: { "X-CSRFToken": '{{ csrf_token }}' },
            success: function(response) {
                toastr.success((response.message || '') + (response.msg_sunat || ''), '¡Actualizado!');
                if (response.id_sales) window.open("/sales/print_quotation/" + response.id_sales + "/T/", '_blank');
                setTimeout(() => location.reload(), 2000);
            },
            error: function(jqXhr) {
                toastr.error(jqXhr.responseJSON?.error || 'Error al actualizar', '¡Error!');
                $('#btn-update-order').prop('disabled', false).html('<i class="fas fa-sync"></i> Actualizar');
            }
        });
    });

    new Autocomplete('#autocomplete-client', {
        search: input => {
            const url = `/buys/get_client/?search=${encodeURI(input.toUpperCase())}`;
            return new Promise(resolve => {
                if (input.length < 3) return resolve([]);
                fetch(url).then(r => r.json()).then(data => resolve(data.results || []));
            });
        },
        renderResult: (result, props) => `
            <li ${props}>
                <div class="h6">${result.names}</div>
                <div class="wiki-snippet text-black">Tipo: ${result.type_client_display || '-'}</div>
            </li>`,
        getResultValue: result => result.names,
        onSubmit: result => {
            if (result) {
                $('#id-client-sender').val(result.id);
                $('#id_sender').val(result.names);
                $('#id_address').val(result.last_address || '');
                $('#document_type_sender').val(result.document_type || '');
                $('#id-nro-document-sender').val(result.number_document || '');
            } else {
                toastr.warning('Seleccione un cliente válido', 'Error');
            }
        }
    });

    function showModalView(route) {
        $.ajax({
            url: '/sales/' + route + '/',
            dataType: 'json',
            type: 'GET',
            data: { pk: 1 },
            success: function(response) {
                $('#modal-client-create').html(response.form);
                $('#modal-client-create').modal('show');
            },
            error: function() { toastr.error('Error al cargar el formulario', '¡Error!'); }
        });
    }
    window.showModalView = showModalView;

    function verifyStock() {
        let flag = true;
        $("#sales-details tr").each(function() {
            const qty = Number($(this).find("td.item-quantity input.input-quantity").val());
            const stock = Number($(this).attr('data-stock')) || 999999;
            const name = $(this).find("td.item-product input.input-product-name").val();
            const check = $(this).find("input.check-quotation").is(':checked');
            if (check && !isNaN(stock) && stock < 999999 && qty > stock) {
                toastr.error('REVISE STOCK: ' + name + ' - Cantidad: ' + qty + ' supera stock: ' + stock);
                flag = false;
                return false;
            }
        });
        return flag;
    }

    function saveOrder(type, print) {
        if ($('#transaction_payment_type').val() === '0') { toastr.warning('¡Seleccione tipo de pago!'); return false; }
        if (!hasRowDetails()) { toastr.warning('¡Agregue productos!'); return false; }
        const _type = (type === 'T') ? 'V' : 'E';
        const sales = {
            Details: [],
            Client: $('#id-client-sender').val(),
            Address: $('#id_address').val(),
            SaleTotal: $('#sum-total').val(),
            type_payment: $('#transaction_payment_type').val(),
            Type: _type,
            order_type: 'V',
            Serie: $('#id_serie').val(),
            BillType: sessionStorage.BillType || 'V',
            Date: $('#date').val(),
            cash: $('#id_cash').val(),
            date_cash: $('#id_date').val(),
            cash_deposit: $('#id_cash_deposit').val(),
            cod_operation: $('#code-operation').val(),
            validity_date: $('#id_validity_date').val(),
            date_completion: $('#id_date_completion').val(),
            place_delivery: $('#id_place_delivery').val(),
            observation: $('#id_observation').val(),
            order_sale_quotation: Number($('#id_order_sale_quotation').val()) || 0
        };
        $("#sales-details tr").each(function() {
            if ($(this).find("input.check-quotation").is(':checked')) {
                const qty = $(this).find("td.item-quantity input.input-quantity").val();
                const price = $(this).find("td.item-price input.input-price").val();
                if (!qty || parseFloat(qty) <= 0 || !price || parseFloat(price) <= 0) return;
                sales.Details.push({
                    Product: $(this).attr('product'),
                    Unit: $(this).find("td.item-unit").attr('pu'),
                    Quantity: parseFloat(qty).toFixed(2),
                    Price: parseFloat(price).toFixed(2),
                    DetailTotal: parseFloat($(this).find("td.item-total input.input-total-detail").val()).toFixed(2),
                    _commentary: $(this).find("td.item-product input.input-product-name").val(),
                    Store: $(this).attr("store_p") || ''
                });
            }
        });
        if (sales.Details.length === 0) { toastr.warning('Marque los productos a incluir'); return false; }
        $.ajax({
            url: '/sales/create_order_detail/',
            dataType: 'json',
            type: 'GET',
            data: { sales: JSON.stringify(sales) },
            headers: { "X-CSRFToken": '{{ csrf_token }}' },
            success: function(response) {
                toastr.success((response.message || '') + (response.msg_sunat || ''), '¡Listo!');
                if (type === 'T' && print === 'T') window.open("/sales/print_ticket_order_sales/" + response.id_sales + "/0/", '_blank');
                else if ((type === 'F' || type === 'B') && print === 'T') window.open("/sales/print_ticket_order_sales/" + response.id_sales + "/1/", '_blank');
                else if ((type === 'F' || type === 'B') && print === 'A4') window.location.href = "/sales/print_order_bill/" + response.id_sales + "/";
                setTimeout(() => location.reload(), 2000);
            },
            error: function(jqXhr) { toastr.error(jqXhr.responseJSON?.error || 'Error', '¡Error!'); }
        });
    }

    window.create_order = function(type, print) {
        if (type === 'T') { saveOrder(type, print); return; }
        const docType = $("#document_type_sender").val();
        const docNum = $('#id-nro-document-sender').val() || '';
        if (type === 'F') {
            if (docType && docType !== '06') { toastr.warning('Factura requiere RUC'); return; }
            if (docNum && docNum.length !== 11) { toastr.warning('RUC debe tener 11 caracteres'); return; }
        }
        if (type === 'B') {
            if (docType && docType !== '01') { toastr.warning('Boleta requiere DNI'); return; }
            if (docNum && docNum.length !== 8) { toastr.warning('DNI debe tener 8 caracteres'); return; }
        }
        if (verifyStock()) saveOrder(type, print);
    };

    sessionStorage.setItem('BillType', 'V');
})();
</script>
{% endblock extrajs %}
