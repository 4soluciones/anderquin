{% extends 'home.html' %}

{% block title %}
    Logística - Facturas en Almacén
{% endblock title %}

{% block body %}

    <div class="container-fluid py-4 roboto-condensed-regular" style="background-color: #e8f4f8; min-height: 100vh;">
        <div class="card border-0 shadow-lg mb-4 overflow-hidden" style="border-radius: 15px;">
            <div class="card-header py-3 position-relative" style="background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h3 class="text-white mb-0 font-weight-bold roboto-condensed-regular">
                            <i class="fas fa-warehouse mr-2"></i> LOGÍSTICA - LISTADO DE FACTURAS EN ALMACÉN
                        </h3>
                    </div>
                </div>
            </div>

            <div class="card-body p-0" style="background-color: #e3f2fd;">
                <div id="purchase-grid-list">{% include "sales/logistic_bill_warehouse_grid.html" %}</div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="assignment" data-backdrop="static" data-keyboard="false"
         tabindex="-1" role="dialog" aria-labelledby="ModalHelpTitle"
         aria-hidden="true"></div>

    <div class="modal fade" id="modal-credit-note" tabindex="-1" role="dialog"
         aria-labelledby="ModalCreditNoteTitle"
         aria-hidden="true"></div>

    <style>
        .form-control:focus {
            box-shadow: 0 0 0 0.2rem rgba(30, 58, 95, 0.25);
            border-color: #1e3a5f;
        }
        #purchase-grid-list .card {
            background-color: transparent !important;
            box-shadow: none !important;
        }
        #purchase-list-with-bill td,
        #purchase-list-with-bill th {
            border-color: #bbdefb !important;
        }
    </style>

{% endblock body %}

{% block extrajs %}

    <script type="text/javascript">

        $(document).on('click', '.btn-show-detail', function () {
            let bill_id = $(this).attr('pk');
            let _table = $(this).closest('td').parent('tr').next('tr').children('td.table-details-bill');
            let _icon = $(this).find('i.see-icon')

            if (_icon.hasClass("fas fa-sort-down fa-lg")) {
                _icon.removeClass('fas fa-sort-down fa-lg');
                _icon.addClass('fas fa-sort-up fa-lg')

                openDetail(bill_id, _table)
            } else {
                _icon.removeClass('fas fa-sort-up fa-lg');
                _icon.addClass('fas fa-sort-down fa-lg');

                closeDetail(_table)
            }
        });

        function openDetail(bill_id, _table) {
            $.ajax({
                url: '/sales/get_details_by_bill/',
                async: true,
                dataType: 'json',
                type: 'GET',
                data: {'bill_id': bill_id},
                success: function (response) {
                    _table.html(response.grid);
                    _table.parent('tr').slideDown("fast");
                },
            });
        }

        function closeDetail($td) {
            $td.parent('tr').slideUp("fast");
        }

        $(document).on('click', '.generate-credit-note', function () {
            let bill_detail_id = $(this).attr('pk');
            let bill_id = $(this).attr('bill');
            $.ajax({
                url: '/buys/bill_credit_note/',
                dataType: 'json',
                type: 'GET',
                data: {'bill_detail_id': bill_detail_id, 'bill_id': bill_id},
                success: function (response) {
                    $('#modal-credit-note').html(response.form);
                    $('#modal-credit-note').modal('show');
                },
                error: function (response) {
                    toastr.error('Error en la petición', '¡Mensaje!');
                }
            });
        });

    </script>

{% endblock extrajs %}
