{% load operations %}
{% if orders_data %}

    <table class="table table-sm table-bordered table-hover roboto-condensed-regular m-0" id="table-dictionary">
        <thead>
        <tr class="text-white small text-uppercase">
            <th class="bg-primary text-center align-middle" style="width: 4%;">#</th>
            <th class="bg-primary text-center align-middle" style="width: 10%;">DOCUMENTO</th>
            <th class="bg-primary text-center align-middle" style="width: 8%;">FECHA</th>
            <th class="bg-primary text-center align-middle" style="width: 12%;">CLIENTE</th>
            <th class="bg-info text-center align-middle" style="width: 8%;">TOTAL</th>
            <th class="bg-success text-center align-middle" style="width: 8%;">PAGADO</th>
            <th class="bg-warning text-center align-middle" style="width: 7%;">RETENCIÓN</th>
            <th class="bg-secondary text-center align-middle" style="width: 7%;">GARANTÍA</th>
            <th class="bg-danger text-center align-middle" style="width: 8%;">POR VERIFICAR</th>
            <th class="bg-info text-center align-middle" style="width: 18%;">PAGOS</th>
            <th class="bg-success text-center align-middle" style="width: 10%;">ACCIONES</th>
        </tr>
        </thead>
        <tbody>
        {% for order in orders_data %}
            <tr class="text-center" 
                {% if order.is_paid %}style="background-color: #e8f5e8;"
                {% else %}style="background-color: #fff3cd;"{% endif %}>
                <td class="align-middle text-center font-weight-bold">
                    {% if order.is_paid %}
                        <div class="badge badge-success">{{ forloop.counter }}</div>
                    {% else %}
                        <div class="badge badge-warning">{{ forloop.counter }}</div>
                    {% endif %}
                </td>
                <td class="align-middle text-center">
                    <div class="badge badge-outline-primary">
                        {{ order.document }}
                    </div>
                    <div class="small text-muted">{{ order.type_document }}</div>
                </td>
                <td class="align-middle text-center">
                    {{ order.order_date|date:"d/m/Y" }}
                </td>
                <td class="align-middle text-left">
                    <div class="font-weight-bold" style="font-size: 13px;">{{ order.client_name }}</div>
                </td>
                <td class="align-middle text-right">
                    <div class="input-icon">
                        <input type="text" readonly
                               style="background-color: #e3f2fd; color: #1565c0; border: 1px solid #bbdefb"
                               class="form-control form-control-sm font-weight-bold text-right"
                               value="{{ order.order_total|replace_round_separator }}">
                        <i class="change-money font-weight-bold">S/</i>
                    </div>
                </td>
                <td class="align-middle text-right">
                    <div class="input-icon">
                        <input type="text" readonly
                               style="background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb"
                               class="form-control form-control-sm font-weight-bold text-right"
                               value="{{ order.total_payed|replace_round_separator }}">
                        <i class="change-money font-weight-bold">S/</i>
                    </div>
                </td>
                <td class="align-middle text-right">
                    <div class="input-icon">
                        {% if order.total_retention > 0 %}
                            <input type="text" readonly
                                   style="background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7"
                                   class="form-control form-control-sm font-weight-bold text-right"
                                   value="{{ order.total_retention|replace_round_separator }}">
                        {% else %}
                            <input type="text" readonly
                                   style="background-color: #f8f9fa; color: #6c757d; border: 1px solid #dee2e6"
                                   class="form-control form-control-sm text-right"
                                   value="0.00"
                                   disabled>
                        {% endif %}
                        <i class="change-money font-weight-bold">S/</i>
                    </div>
                </td>
                <td class="align-middle text-right">
                    <div class="input-icon">
                        {% if order.total_warranty > 0 %}
                            <input type="text" readonly
                                   style="background-color: #e2e3e5; color: #383d41; border: 1px solid #d6d8db"
                                   class="form-control form-control-sm font-weight-bold text-right"
                                   value="{{ order.total_warranty|replace_round_separator }}">
                        {% else %}
                            <input type="text" readonly
                                   style="background-color: #f8f9fa; color: #6c757d; border: 1px solid #dee2e6"
                                   class="form-control form-control-sm text-right"
                                   value="0.00"
                                   disabled>
                        {% endif %}
                        <i class="change-money font-weight-bold">S/</i>
                    </div>
                </td>
                <td class="align-middle text-right">
                    <div class="input-icon">
                        {% if order.pending_amount > 0 %}
                            <input type="text" readonly
                                   style="background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb"
                                   class="form-control form-control-sm font-weight-bold text-right"
                                   value="{{ order.pending_amount|replace_round_separator }}">
                        {% else %}
                            <input type="text" readonly
                                   style="background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb"
                                   class="form-control form-control-sm font-weight-bold text-right"
                                   value="0.00">
                        {% endif %}
                        <i class="change-money font-weight-bold">S/</i>
                    </div>
                </td>
                <td class="align-middle">
                    <div class="row m-0">
                        <!-- Columna izquierda: Pagos de Factura (type='V') -->
                        <div class="col-md-6 p-1 border-right">
                            <div class="small font-weight-bold mb-1 text-info">
                                <i class="fas fa-file-invoice-dollar mr-1"></i>FACTURA
                            </div>
                            {% if order.payment_details %}
                                <div class="payment-details" style="max-height: 150px; overflow-y: auto;">
                                    {% for payment in order.payment_details %}
                                        <div class="mb-2 p-2 border rounded" style="background-color: #f8f9fa; cursor: pointer;"
                                             onclick="viewPaymentDetail('{{ payment.loan_payment_id }}', '{{ order.order_id }}', '{{ order.client_id }}')">
                                            <small class="d-block">
                                                <i class="fas fa-calendar text-info mr-1"></i>
                                                {{ payment.date|date:"d/m/Y" }}
                                            </small>
                                            <small class="d-block">
                                                <i class="fas fa-money-bill text-success mr-1"></i>
                                                S/ {{ payment.amount|replace_round_separator }}
                                                <span class="badge badge-sm badge-primary ml-1 font-weight-bold" style="background-color: #007bff; color: white; padding: 0.2rem 0.4rem;">{{ payment.type }}</span>
                                            </small>
                                            {% if payment.operation_code and payment.operation_code != '-' %}
                                                <small class="d-block text-muted">
                                                    <i class="fas fa-hashtag mr-1"></i>{{ payment.operation_code }}
                                                </small>
                                            {% endif %}
                                            {% if payment.file %}
                                                <small class="d-block text-primary">
                                                    <i class="fas fa-file-check mr-1"></i>Comprobante disponible
                                                </small>
                                            {% endif %}
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="text-muted small">
                                    <i class="fas fa-exclamation-circle"></i> Sin pagos
                                </div>
                            {% endif %}
                            {% if not order.is_paid %}
                                <button type="button" class="btn btn-xs btn-success btn-verify-payment mt-2"
                                        data-order-id="{{ order.order_id }}"
                                        data-client-id="{{ order.client_id }}"
                                        style="font-size: 0.7rem; padding: 0.2rem 0.4rem;">
                                    <i class="fas fa-check-circle mr-1"></i>
                                    Verificar Pago
                                </button>
                            {% else %}
                                <div class="badge badge-info mt-2" style="font-size: 0.7rem; background-color: #17a2b8; color: white;">
                                    <i class="fas fa-check mr-1"></i>Factura Pagada
                                </div>
                            {% endif %}
                        </div>
                        
                        <!-- Columna derecha: Pagos de Garantía (type='G') -->
                        <div class="col-md-6 p-1">
                            <div class="small font-weight-bold mb-1 text-warning">
                                <i class="fas fa-shield-alt mr-1"></i>GARANTÍA
                            </div>
                            {% if order.warranty_details %}
                                <div class="payment-details" style="max-height: 150px; overflow-y: auto;">
                                    {% for warranty in order.warranty_details %}
                                        <div class="mb-2 p-2 border rounded" style="background-color: #fff9e6; cursor: pointer;"
                                             onclick="viewPaymentDetail('{{ warranty.loan_payment_id }}', '{{ order.order_id }}', '{{ order.client_id }}')">
                                            <small class="d-block">
                                                <i class="fas fa-calendar text-warning mr-1"></i>
                                                {{ warranty.date|date:"d/m/Y" }}
                                            </small>
                                            <small class="d-block">
                                                <i class="fas fa-money-bill text-success mr-1"></i>
                                                S/ {{ warranty.amount|replace_round_separator }}
                                                <span class="badge badge-sm badge-primary ml-1 font-weight-bold" style="background-color: #007bff; color: white; padding: 0.2rem 0.4rem;">{{ warranty.type }}</span>
                                            </small>
                                            {% if warranty.operation_code and warranty.operation_code != '-' %}
                                                <small class="d-block text-muted">
                                                    <i class="fas fa-hashtag mr-1"></i>{{ warranty.operation_code }}
                                                </small>
                                            {% endif %}
                                            {% if warranty.file %}
                                                <small class="d-block text-primary">
                                                    <i class="fas fa-file-check mr-1"></i>Comprobante disponible
                                                </small>
                                            {% endif %}
                                        </div>
                                    {% endfor %}
                                </div>
                            {% else %}
                                <div class="text-muted small">
                                    <i class="fas fa-exclamation-circle"></i> Sin pagos
                                </div>
                            {% endif %}
                            {% if order.total_warranty > 0 %}
                                {% if order.is_warranty_complete %}
                                    <div class="badge badge-info mt-2" style="font-size: 0.7rem; background-color: #17a2b8; color: white;">
                                        <i class="fas fa-check mr-1"></i>Garantía Pagada
                                    </div>
                                {% else %}
                                    {% if order.is_paid %}
                                        <button type="button" class="btn btn-xs btn-warning btn-verify-warranty mt-2"
                                                data-order-id="{{ order.order_id }}"
                                                data-client-id="{{ order.client_id }}"
                                                style="font-size: 0.7rem; padding: 0.2rem 0.4rem;">
                                            <i class="fas fa-shield-alt mr-1"></i>
                                            Verificar Garantía
                                        </button>
                                    {% endif %}
                                {% endif %}
                            {% endif %}
                        </div>
                    </div>
                </td>
                <td class="align-middle text-center">
                    <div class="d-flex flex-column align-items-center">
                        {% if order.is_complete %}
                            <span class="badge badge-success badge-lg mb-1" style="font-size: 0.85rem; padding: 0.4rem 0.6rem;">
                                <i class="fas fa-check-circle mr-1"></i>
                                COMPLETADA
                            </span>
                            <small class="text-muted">Factura y Garantía pagadas</small>
                        {% elif order.is_paid %}
                            {% if order.total_warranty > 0 %}
                                <span class="badge badge-warning badge-lg mb-1" style="font-size: 0.85rem; padding: 0.4rem 0.6rem;">
                                    <i class="fas fa-exclamation-triangle mr-1"></i>
                                    FACTURA PAGADA
                                </span>
                                <small class="text-muted">Falta verificar garantía</small>
                            {% else %}
                                <span class="badge badge-info badge-lg mb-1" style="font-size: 0.85rem; padding: 0.4rem 0.6rem; background-color: #17a2b8; color: white;">
                                    <i class="fas fa-check mr-1"></i>
                                    FACTURA PAGADA
                                </span>
                                <small class="text-muted">Sin garantía</small>
                            {% endif %}
                        {% else %}
                            <span class="badge badge-danger badge-lg mb-1" style="font-size: 0.85rem; padding: 0.4rem 0.6rem;">
                                <i class="fas fa-clock mr-1"></i>
                                PENDIENTE
                            </span>
                            <small class="text-muted">Factura pendiente</small>
                        {% endif %}
                    </div>
                </td>
            </tr>
        {% endfor %}
        </tbody>
    </table>

    <table class="table table-sm mt-2">
        <thead>
        <tr class="text-center roboto-condensed-regular" style="background-color: #e3f2fd">
            <th class="border-left" style="width: 4%;"></th>
            <th class="" style="width: 10%;"></th>
            <th class="" style="width: 8%;"></th>
            <th class="" style="width: 12%;"></th>
            <th class="text-center align-middle" style="width: 8%;">
                <i class="fas fa-file-invoice-dollar"></i> TOTAL
            </th>
            <th class="text-center align-middle" style="width: 8%;">
                <i class="fas fa-credit-card"></i> PAGADO
            </th>
            <th class="text-center align-middle" style="width: 7%;">
                <i class="fas fa-hand-holding-usd"></i> RETENCIÓN
            </th>
            <th class="text-center align-middle" style="width: 7%;">
                <i class="fas fa-shield-alt"></i> GARANTÍA
            </th>
            <th class="text-center align-middle" style="width: 8%;">
                <i class="fas fa-exclamation-triangle"></i> POR VERIFICAR
            </th>
            <th class="" style="width: 18%;"></th>
            <th class="border-right" style="width: 10%;"></th>
        </tr>
        </thead>
        <tbody>
        <tr class="text-center" style="background-color: #e3f2fd">
            <td colspan="4" class="font-weight-bold">TOTALES DEL REPORTE</td>
            <td class="align-middle text-center">
                <div class="input-icon">
                    <input type="text" readonly
                           style="background-color: #e3f2fd; color: #1565c0; border: 1px solid #bbdefb"
                           class="form-control form-control-sm font-weight-bold text-right"
                           value="{{ total_debt|replace_round_separator }}">
                    <i class="change-money font-weight-bold">S/</i>
                </div>
            </td>
            <td class="align-middle text-center">
                <div class="input-icon">
                    <input type="text" readonly
                           style="background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb"
                           class="form-control form-control-sm font-weight-bold text-right"
                           value="{{ total_payed|replace_round_separator }}">
                    <i class="change-money font-weight-bold">S/</i>
                </div>
            </td>
            <td class="align-middle text-center">
                <div class="input-icon">
                    <input type="text" readonly
                           style="background-color: #fff3cd; color: #856404; border: 1px solid #ffeaa7"
                           class="form-control form-control-sm font-weight-bold text-right"
                           value="{{ total_retention|replace_round_separator }}">
                    <i class="change-money font-weight-bold">S/</i>
                </div>
            </td>
            <td class="align-middle text-center">
                <div class="input-icon">
                    <input type="text" readonly
                           style="background-color: #e2e3e5; color: #383d41; border: 1px solid #d6d8db"
                           class="form-control form-control-sm font-weight-bold text-right"
                           value="{{ total_warranty|replace_round_separator }}">
                    <i class="change-money font-weight-bold">S/</i>
                </div>
            </td>
            <td class="align-middle text-center">
                <div class="input-icon">
                    <input type="text" readonly
                           style="background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb"
                           class="form-control form-control-sm font-weight-bold text-right"
                           value="{{ total_pending|replace_round_separator }}">
                    <i class="change-money font-weight-bold">S/</i>
                </div>
            </td>
            <td class="text-muted">{{ total_orders }} órdenes</td>
            <td colspan="2"></td>
        </tr>
        </tbody>
    </table>

    <style>
        .input-icon {
            position: relative;
        }

        .input-icon > i {
            position: absolute;
            display: block;
            transform: translate(0, -50%);
            top: 50%;
            pointer-events: none;
            width: 25px;
            text-align: center;
            font-style: normal;
            left: 5px;
        }

        .input-icon > input {
            padding-left: 30px;
            padding-right: 8px;
        }

        .table-hover tbody tr:hover {
            background-color: rgba(0, 0, 0, .05) !important;
        }

        .badge {
            font-size: 0.75em;
            padding: 0.375rem 0.75rem;
        }

        .badge-success {
            background-color: #28a745;
            color: white;
        }

        .badge-warning {
            background-color: #ffc107;
            color: #212529;
        }

        .badge-info {
            background-color: #17a2b8;
            color: white;
        }

        .badge-secondary {
            background-color: #6c757d;
            color: white;
        }

        .badge-sm {
            font-size: 0.65em;
            padding: 0.25rem 0.5rem;
        }
        
        .badge-lg {
            font-size: 0.95rem;
            padding: 0.5rem 0.75rem;
            font-weight: 600;
        }

        .payment-details {
            font-size: 12px;
        }
        
        .payment-details .border {
            border-color: #dee2e6 !important;
        }
        
        /*.row.m-0 .col-md-6 {
            min-height: 180px;
        }*/
        
        .row.m-0 .col-md-6 .border-right {
            border-right: 2px solid #dee2e6 !important;
        }
        
        .btn-xs {
            padding: 0.15rem 0.3rem;
            font-size: 0.7rem;
            line-height: 1.3;
        }
    </style>
{% else %}
    <!-- Mensaje cuando no hay datos -->
    <div class="card">
        <div class="card-body text-center py-5">
            <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
            <h4 class="text-muted">No hay cuentas por cobrar</h4>
            <p class="text-muted">No se encontraron órdenes con pagos pendientes en el período seleccionado.</p>
            <button type="button" class="btn btn-primary" onclick="$('#id_btn_show').click()">
                <i class="fas fa-refresh mr-1"></i>
                Actualizar Reporte
            </button>
        </div>
    </div>
{% endif %}
