{% extends 'home.html' %}

{% load static %}

{% block title %}
    Lista de Cotizaciones
{% endblock title %}

{% block body %}

    <div class="container-fluid py-2 roboto-condensed-regular" style="background-color: #e8f4f8; min-height: 100vh;">
        <div class="card border-0 shadow-lg mb-4 overflow-hidden" style="border-radius: 15px;">
            <div class="card-header py-3 text-center" style="background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);">
                <h5 class="roboto-condensed-regular font-weight-bold mb-0 text-white" style="color: #fff !important;">
                    <i class="fas fa-file-invoice mr-2"></i> LISTADO DE COTIZACIONES
                </h5>
            </div>

            <div class="card-body p-3 p-md-4" style="background-color: #f0f8fc;">
                <form id="search-form" method="POST">
                    {% csrf_token %}
                    <fieldset class="border rounded p-3 p-md-3 mb-0" style="background-color: #fff; border-color: #bbdefb !important;">
                        <legend class="w-auto mb-0 px-2 text-uppercase small font-weight-bold" style="font-size: 11px; color: #1565c0;">
                            <i class="fas fa-filter mr-1"></i> Filtrar por rango de fechas
                        </legend>
                        <div class="form-row align-items-end">
                            <div class="form-group col-12 col-md-4 mb-2 mb-md-0">
                                <label class="mb-1 font-weight-bold small text-uppercase" for="id-start-date">Fecha inicial</label>
                                <input type="date" class="form-control form-control-sm" id="id-start-date"
                                       name="start-date" value="{{ formatdate }}" style="border-color: #bbdefb;">
                            </div>
                            <div class="form-group col-12 col-md-4 mb-2 mb-md-0">
                                <label class="mb-1 font-weight-bold small text-uppercase" for="id-end-date">Fecha final</label>
                                <input type="date" class="form-control form-control-sm" id="id-end-date"
                                       name="end-date" value="{{ formatdate }}" style="border-color: #bbdefb;">
                            </div>
                            <div class="form-group col-12 col-md-4 mb-0">
                                <button type="submit" class="btn btn-outline-success border-2 btn-sales-rounded btn-block py-2" id="btn-search">
                                    <i class="fas fa-search"></i> Buscar cotizaciones
                                </button>
                            </div>
                        </div>
                    </fieldset>
                </form>
            </div>

            <div class="card-body p-0 p-md-3 pt-0" style="background-color: #e3f2fd;">
                <div id="table-order-quotation" class="order-quotation-table-wrapper">
                    <div class="text-center py-5 text-muted">
                        <i class="fas fa-search fa-3x mb-3" style="color: #90caf9;"></i>
                        <p class="mb-0">Seleccione un rango de fechas y haga clic en <strong>Buscar</strong> para cargar las cotizaciones.</p>
                    </div>
                </div>
                <div id="loader-order-quotation" class="text-center py-5" style="display: none;">
                    <div class="loader-quotation-order">
                        <div class="loader-quotation-dot"></div>
                        <div class="loader-quotation-dot"></div>
                        <div class="loader-quotation-dot"></div>
                    </div>
                    <p class="text-muted small mt-2 mb-0">Cargando cotizaciones...</p>
                </div>
            </div>
        </div>
    </div>

    <style>
        .form-control:focus {
            box-shadow: 0 0 0 0.2rem rgba(30, 58, 95, 0.25);
            border-color: #1e3a5f;
        }
        .btn-sales-rounded { border-radius: 12px !important; }
        .btn-outline-success { border-width: 2px; }
        .order-quotation-table-wrapper .table { border-color: #bbdefb !important; }
        .order-quotation-table-wrapper .table td,
        .order-quotation-table-wrapper .table th { border-color: #bbdefb !important; }
        .loader-quotation-order {
            display: flex; justify-content: center; align-items: flex-end; gap: 6px; height: 40px; margin: 0 auto;
        }
        .loader-quotation-order .loader-quotation-dot {
            width: 10px; height: 10px; border-radius: 50%; background: #1565c0;
            animation: loader-quotation-bounce 1.4s ease-in-out infinite both;
        }
        .loader-quotation-order .loader-quotation-dot:nth-child(1) { animation-delay: -0.32s; }
        .loader-quotation-order .loader-quotation-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes loader-quotation-bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
    </style>

{% endblock body %}

{% block extrajs %}
<script type="text/javascript">
    $('#search-form').submit(function (event) {
        event.preventDefault();
        $('#table-order-quotation').empty();
        $('#loader-order-quotation').show();
        let _data = new FormData($('#search-form').get(0));
        $.ajax({
            url: '/sales/get_sales_quotation_by_subsidiary/',
            type: "POST",
            data: _data,
            cache: false,
            processData: false,
            contentType: false,
            success: function (response, textStatus, xhr) {
                if (xhr.status === 200) {
                    $('#table-order-quotation').html(response.grid);
                    toastr.success(response.message || 'Cotizaciones cargadas', '¡Bien hecho!');
                }
                $('#loader-order-quotation').hide();
            },
            error: function (jqXhr) {
                toastr.error(jqXhr.responseJSON?.error || 'Error al cargar cotizaciones', '¡Error!');
                $('#loader-order-quotation').hide();
            }
        });
    });
</script>
{% endblock extrajs %}
