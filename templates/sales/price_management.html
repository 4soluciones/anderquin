{% extends 'home.html' %}

{% block title %}
    Gestión de Precios
{% endblock title %}

{% block body %}
    <div class="container-fluid py-2 roboto-condensed-regular" style="background-color: #e8f4f8; min-height: 100vh;">
        <div class="card border-0 shadow-lg mb-4 overflow-hidden" style="border-radius: 15px;">
            <div class="card-body border-bottom py-3 px-4" style="background: linear-gradient(135deg, #bbe0f5 0%, #90caf9 100%);">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h4 class="mb-0 roboto-condensed-regular font-weight-bold" style="color: #0d47a1;">
                            <i class="fas fa-dollar-sign mr-2"></i>Gestión de precios
                        </h4>
                        <small class="d-block mt-1" style="color: #1565c0;">Tipos de precio y precios por producto</small>
                    </div>
                </div>
            </div>

            <div class="card-body p-0" style="background-color: #e3f2fd;">
                <ul class="nav nav-tabs px-3 pt-2" id="priceTabs" role="tablist" style="border-bottom-color: #bbdefb;">
                    <li class="nav-item">
                        <a class="nav-link active" id="price-types-tab" data-toggle="tab" href="#price-types" role="tab"
                           aria-controls="price-types" aria-selected="true" style="color: #0d47a1; font-weight: 600;">
                            <i class="fas fa-tags mr-2"></i>Tipos de precio
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="product-prices-tab" data-toggle="tab" href="#product-prices" role="tab"
                           aria-controls="product-prices" aria-selected="false" style="color: #0d47a1; font-weight: 600;">
                            <i class="fas fa-shopping-cart mr-2"></i>Precios de productos
                        </a>
                    </li>
                </ul>

                <div class="tab-content p-4" id="priceTabsContent">
                    <div class="tab-pane fade show active" id="price-types" role="tabpanel" aria-labelledby="price-types-tab">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="mb-0 roboto-condensed-regular font-weight-bold" style="color: #0d47a1;">Tipos de precio</h5>
                            <button type="button" onclick="showModalPriceType()" 
                                    class="btn btn-success btn-sm border-2 btn-sales-rounded">
                                <i class="fas fa-plus mr-1"></i>Nuevo tipo de precio
                            </button>
                        </div>

                        <div class="table-responsive rounded overflow-hidden" style="border: 1px solid #bbdefb;">
                            <table class="table table-hover table-bordered mb-0 price-management-table">
                                <thead class="text-white text-center" style="background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);">
                                    <tr>
                                        <th class="font-weight-bold py-2 border-0" style="width: 5%;">ID</th>
                                        <th class="font-weight-bold py-2 border-0" style="width: 25%;">Nombre</th>
                                        <th class="font-weight-bold py-2 border-0" style="width: 40%;">Descripción</th>
                                        <th class="font-weight-bold py-2 border-0" style="width: 10%;">Estado</th>
                                        <th class="font-weight-bold py-2 border-0" style="width: 20%;">Acciones</th>
                                    </tr>
                                </thead>
                                <tbody style="background: #fff;">
                                    {% for price_type in price_types %}
                                    <tr>
                                        <td class="align-middle">{{ price_type.id }}</td>
                                        <td class="align-middle"><strong style="color: #1565c0;">{{ price_type.name }}</strong></td>
                                        <td class="align-middle">{{ price_type.description|default:"<em class='text-muted'>Sin descripción</em>"|safe }}</td>
                                        <td class="align-middle text-center">
                                            {% if price_type.is_enabled %}
                                                <span class="badge badge-pill px-2 py-1" style="background-color: #2e7d32;">Habilitado</span>
                                            {% else %}
                                                <span class="badge badge-danger badge-pill px-2 py-1">Deshabilitado</span>
                                            {% endif %}
                                        </td>
                                        <td class="align-middle">
                                            <button type="button" class="btn btn-sm btn-outline-primary border-2 btn-sales-rounded mr-1" 
                                                    onclick="editPriceType({{ price_type.id }}, '{{ price_type.name|escapejs }}', '{{ price_type.description|default:""|escapejs }}', {{ price_type.is_enabled|lower }})"
                                                    title="Editar">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <button type="button" class="btn btn-sm btn-outline-danger border-2 btn-sales-rounded" 
                                                    onclick="deletePriceType({{ price_type.id }})"
                                                    title="Eliminar">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="5" class="text-center py-5" style="background: #fff;">
                                            <i class="fas fa-inbox fa-3x mb-2" style="color: #90caf9;"></i>
                                            <p class="mb-0 font-weight-bold" style="color: #1565c0;">No hay tipos de precio registrados</p>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="product-prices" role="tabpanel" aria-labelledby="product-prices-tab">
                        <div class="row mb-3 align-items-center">
                            <div class="col-md-6 mb-2 mb-md-0">
                                <h5 class="mb-0 roboto-condensed-regular font-weight-bold" style="color: #0d47a1;">Precios de productos</h5>
                            </div>
                            <div class="col-md-6">
                                <div class="input-group input-group-sm shadow-sm rounded" style="border: 1px solid #bbdefb;">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text bg-white border-0" style="color: #1565c0;"><i class="fas fa-tags mr-1"></i>Tipo:</span>
                                    </div>
                                    <select class="form-control border-0" id="select-price-type" onchange="loadProductsByPriceType()" style="border-radius: 0 8px 8px 0;">
                                        <option value="">Seleccione un tipo de precio...</option>
                                        {% for price_type in price_types_enabled %}
                                        <option value="{{ price_type.id }}">{{ price_type.name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div id="products-price-container" style="display: none;">
                            <div class="rounded px-3 py-2 mb-3 d-flex align-items-center" style="background: linear-gradient(90deg, #e3f2fd 0%, #f0f8fc 100%); border: 1px solid #bbdefb;">
                                <i class="fas fa-info-circle mr-2" style="color: #1976d2;"></i>
                                <span><strong id="selected-price-type-name"></strong> — Clic en un producto para expandir y configurar precios por unidad.</span>
                            </div>
                            <div class="mb-3">
                                <div class="input-group input-group-sm shadow-sm rounded" style="max-width: 320px; border: 1px solid #bbdefb;">
                                    <div class="input-group-prepend">
                                        <span class="input-group-text bg-white border-0"><i class="fas fa-search text-primary"></i></span>
                                    </div>
                                    <input type="text" class="form-control border-0" id="product-search-input" placeholder="Buscar producto..." autocomplete="off">
                                </div>
                            </div>
                            <div class="products-price-list" id="products-price-list"></div>
                        </div>

                        <div id="no-price-type-selected" class="text-center py-5 rounded" style="background: #fff; border: 1px solid #e3f2fd;">
                            <i class="fas fa-hand-pointer fa-3x mb-3" style="color: #90caf9;"></i>
                            <p class="mb-0 font-weight-bold" style="color: #1565c0;">Seleccione un tipo de precio para configurar precios</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal crear/editar tipo de precio -->
    <div class="modal fade" id="modal-price-type" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content border-0 shadow-lg overflow-hidden" style="border-radius: 16px;">
                <div class="modal-header border-0 py-3" style="background: linear-gradient(135deg, #bbe0f5 0%, #90caf9 100%);">
                    <h5 class="modal-title font-weight-bold" id="modal-price-type-title" style="color: #0d47a1;">
                        <i class="fas fa-tags mr-2"></i>Nuevo tipo de precio
                    </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Cerrar" style="color: #0d47a1; opacity: 0.9;">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form id="form-price-type">
                    {% csrf_token %}
                    <input type="hidden" id="price_type_id" name="price_type_id">
                    <div class="modal-body py-4" style="background-color: #f0f8fc;">
                        <div class="form-group">
                            <label for="name" class="font-weight-bold small" style="color: #1565c0;">Nombre <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="name" name="name" required placeholder="Ej: Precio distribuidor" style="border-color: #bbdefb; border-radius: 8px;">
                        </div>
                        <div class="form-group">
                            <label for="description" class="font-weight-bold small" style="color: #1565c0;">Descripción</label>
                            <textarea class="form-control" id="description" name="description" rows="3" placeholder="Opcional" style="border-color: #bbdefb; border-radius: 8px;"></textarea>
                        </div>
                        <div class="form-group mb-0">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="is_enabled" name="is_enabled" checked>
                                <label class="form-check-label font-weight-bold small" for="is_enabled" style="color: #1565c0;">Habilitado</label>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer border-0 py-3" style="background-color: #e3f2fd;">
                        <button type="button" class="btn btn-outline-secondary border-2 btn-sales-rounded" data-dismiss="modal">
                            <i class="fas fa-times mr-1"></i>Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary border-2 btn-sales-rounded">
                            <i class="fas fa-save mr-1"></i>Guardar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endblock body %}

{% block extrajs %}
    <style>
        .form-control:focus { border-color: #1e3a5f; box-shadow: 0 0 0 0.2rem rgba(30, 58, 95, 0.25); }
        .btn-sales-rounded { border-radius: 12px !important; }
        .nav-tabs .nav-link { border: none; border-bottom: 3px solid transparent; font-weight: 500; }
        .nav-tabs .nav-link:hover { border-color: #90caf9; color: #1565c0; }
        .nav-tabs .nav-link.active { color: #0d47a1 !important; background: transparent; border-color: #0d47a1; border-bottom: 3px solid #0d47a1; }
        .price-management-table td, .price-management-table th { border-color: #bbdefb !important; }
        .product-price-card {
            border: 1px solid #bbdefb;
            border-radius: 12px;
            margin-bottom: 0.5rem;
            overflow: hidden;
            transition: all 0.2s ease;
            background: #fff;
        }
        .product-price-card:hover { border-color: #90caf9; box-shadow: 0 2px 8px rgba(30, 58, 95, 0.08); }
        .product-price-card.expanded { border-color: #1976d2; box-shadow: 0 4px 12px rgba(25, 118, 210, 0.2); }
        .product-price-header {
            padding: 0.9rem 1.2rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: background 0.2s;
            user-select: none;
        }
        .product-price-header:hover { background: #f0f8fc; }
        .product-price-header .product-name { font-weight: 600; color: #0d47a1; font-size: 0.95rem; flex: 1; }
        .product-price-header .expand-icon {
            width: 28px; height: 28px; border-radius: 8px; margin-left: 1rem;
            display: flex; align-items: center; justify-content: center;
            background: #e3f2fd; color: #1565c0; transition: all 0.2s;
        }
        .product-price-card.expanded .expand-icon { background: #1976d2; color: white; transform: rotate(180deg); }
        .product-price-header .units-badge {
            font-size: 0.75rem; padding: 0.25rem 0.6rem; border-radius: 20px;
            background: #e3f2fd; color: #1565c0; margin-right: 0.75rem;
        }
        .product-price-body {
            max-height: 0; overflow: hidden; padding: 0 1.2rem; border-top: 1px solid transparent;
            background: #f0f8fc; transition: max-height 0.35s ease, padding 0.3s ease, border-color 0.2s;
        }
        .product-price-card.expanded .product-price-body {
            max-height: 800px; padding: 0 1.2rem 1rem; border-top-color: #e3f2fd;
        }
        .units-table-wrapper { margin-top: 1rem; }
        .units-table { width: 100%; background: #fff; border-radius: 12px; overflow: hidden; border: 1px solid #bbdefb; }
        .units-table thead th {
            background: linear-gradient(180deg, #e3f2fd 0%, #bbdefb 100%);
            padding: 0.65rem 1rem; font-size: 0.8rem; font-weight: 600; color: #0d47a1;
            text-align: center; border-color: #bbdefb !important;
        }
        .units-table tbody td { padding: 0.6rem 1rem; vertical-align: middle; text-align: center; border-color: #e3f2fd !important; }
        .units-table tbody tr:hover { background: #f8fbfd; }
        .unit-badge {
            display: inline-block; padding: 0.4rem 0.85rem; border-radius: 8px; font-weight: 500; font-size: 0.875rem;
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%); color: #0d47a1;
        }
        .price-input-group { max-width: 150px; margin: 0 auto; }
        .price-input-group .input-group-text { background: #f0f8fc; border-color: #bbdefb; color: #1565c0; font-weight: 500; }
        .price-input-group .form-control { border-color: #bbdefb; border-radius: 8px; }
    </style>

    <script type="text/javascript">
        function showModalPriceType() {
            $('#form-price-type')[0].reset();
            $('#price_type_id').val('');
            $('#modal-price-type-title').html('<i class="fas fa-tags mr-2"></i>NUEVO TIPO DE PRECIO');
            $('#modal-price-type').modal('show');
        }

        function editPriceType(id, name, description, is_enabled) {
            $('#price_type_id').val(id);
            $('#name').val(name);
            $('#description').val(description);
            $('#is_enabled').prop('checked', is_enabled);
            $('#modal-price-type-title').html('<i class="fas fa-edit mr-2"></i>EDITAR TIPO DE PRECIO');
            $('#modal-price-type').modal('show');
        }

        $('#form-price-type').on('submit', function(e) {
            e.preventDefault();
            let formData = new FormData(this);
            
            $.ajax({
                url: '{% url "sales:price_type_save" %}',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    if (response.success) {
                        toastr.success(response.message, '¡Éxito!');
                        $('#modal-price-type').modal('hide');
                        setTimeout(function() {
                            location.reload();
                        }, 1000);
                    } else {
                        toastr.error(response.message, '¡Error!');
                    }
                },
                error: function(xhr) {
                    let errorMsg = 'Error al guardar';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMsg = xhr.responseJSON.message;
                    }
                    toastr.error(errorMsg, '¡Error!');
                }
            });
        });

        function deletePriceType(id) {
            if (!confirm('¿Está seguro de eliminar este tipo de precio?')) {
                return;
            }

            let formData = new FormData();
            formData.append('price_type_id', id);
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

            $.ajax({
                url: '{% url "sales:price_type_delete" %}',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    if (response.success) {
                        toastr.success(response.message, '¡Éxito!');
                        setTimeout(function() {
                            location.reload();
                        }, 1000);
                    } else {
                        toastr.error(response.message, '¡Error!');
                    }
                },
                error: function(xhr) {
                    let errorMsg = 'Error al eliminar';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMsg = xhr.responseJSON.message;
                    }
                    toastr.error(errorMsg, '¡Error!');
                }
            });
        }

        // Variable para cancelar peticiones AJAX pendientes y evitar duplicados
        let loadProductsAjaxRequest = null;

        function loadProductsByPriceType() {
            let priceTypeId = $('#select-price-type').val();
            
            if (!priceTypeId) {
                $('#products-price-container').hide();
                $('#no-price-type-selected').show();
                return;
            }

            // Cancelar petición anterior si existe (evita duplicados por múltiples onchange)
            if (loadProductsAjaxRequest) {
                loadProductsAjaxRequest.abort();
            }

            // Mostrar loading
            $('#products-price-list').html('<div class="text-center py-5"><i class="fas fa-spinner fa-spin fa-2x text-primary"></i><p class="mt-2 text-muted">Cargando productos...</p></div>');
            $('#products-price-container').show();
            $('#no-price-type-selected').hide();

            loadProductsAjaxRequest = $.ajax({
                url: '{% url "sales:get_prices_by_price_type" %}',
                type: 'GET',
                data: { 'price_type_id': priceTypeId },
                success: function(response) {
                    if (response.success) {
                        $('#selected-price-type-name').text(response.price_type);
                        $('#product-search-input').val('');
                        let container = $('#products-price-list');
                        container.empty();
                        
                        if (response.products.length === 0) {
                            container.html('<div class="text-center py-5"><i class="fas fa-inbox fa-3x text-muted mb-3"></i><p class="text-muted">No hay productos disponibles</p></div>');
                        } else {
                            response.products.forEach(function(product, index) {
                                let unitsRows = (product.units || []).length === 0 ? 
                                    '<tr><td colspan="3" class="text-center text-muted py-3">Sin unidades configuradas</td></tr>' :
                                    product.units.map(function(unit) {
                                    let priceValue = unit.price > 0 ? unit.price : '';
                                    let priceId = unit.price_id || '';
                                    return `
                                        <tr data-product-detail-id="${unit.product_detail_id}" data-price-id="${priceId || ''}">
                                            <td><span class="unit-badge">${unit.unit_name_full || unit.unit_name}</span></td>
                                            <td>
                                                <div class="input-group input-group-sm price-input-group">
                                                    <div class="input-group-prepend">
                                                        <span class="input-group-text">S/</span>
                                                    </div>
                                                    <input type="number" class="form-control price-input" step="0.01" min="0" 
                                                           value="${priceValue}" data-product-detail-id="${unit.product_detail_id}" 
                                                           data-price-id="${priceId}" placeholder="0.00">
                                                </div>
                                            </td>
                                            <td class="text-center">
                                                <button type="button" class="btn btn-sm btn-success save-price-btn" 
                                                        onclick="saveProductPrice(${priceTypeId}, ${unit.product_detail_id}, this)" title="Guardar">
                                                    <i class="fas fa-check"></i>
                                                </button>
                                                ${priceId ? `<button type="button" class="btn btn-sm btn-outline-danger delete-price-btn ml-1" 
                                                        onclick="deleteProductPrice(${priceId})" title="Eliminar"><i class="fas fa-times"></i></button>` : ''}
                                            </td>
                                        </tr>
                                    `;
                                }).join('');
                                let card = $(`
                                    <div class="product-price-card" data-index="${index}">
                                        <div class="product-price-header">
                                            <span class="product-name">${product.product_name}</span>
                                            <span class="units-badge">${(product.units || []).length} unidad${(product.units || []).length !== 1 ? 'es' : ''}</span>
                                            <span class="expand-icon"><i class="fas fa-chevron-down"></i></span>
                                        </div>
                                        <div class="product-price-body">
                                            <div class="units-table-wrapper">
                                                <table class="units-table table table-sm mb-0">
                                                    <thead><tr><th>Unidad</th><th>Precio (S/)</th><th>Acciones</th></tr></thead>
                                                    <tbody>${unitsRows}</tbody>
                                                </table>
                                            </div>
                                        </div>
                                    </div>
                                `);
                                card.find('.product-price-header').on('click', function() {
                                    card.toggleClass('expanded');
                                });
                                container.append(card);
                            });
                            $('#product-search-input').off('input').on('input', function() {
                                let q = $(this).val().toLowerCase().trim();
                                $('.product-price-card').each(function() {
                                    let name = $(this).find('.product-name').text().toLowerCase();
                                    $(this).toggle(q === '' || name.indexOf(q) >= 0);
                                });
                            });
                        }
                    } else {
                        toastr.error(response.message, '¡Error!');
                    }
                },
                error: function(xhr, status) {
                    if (status !== 'abort') {
                        let errorMsg = 'Error al cargar productos';
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMsg = xhr.responseJSON.message;
                        }
                        toastr.error(errorMsg, '¡Error!');
                    }
                },
                complete: function() {
                    loadProductsAjaxRequest = null;
                }
            });
        }

        function saveProductPrice(priceTypeId, productDetailId, btnElement) {
            let row = $(btnElement).closest('tr');
            let input = row.find('.price-input');
            let price = input.val();
            let priceId = input.data('price-id') || '';

            // Si el precio es 0 o vacío, no guardar
            if (!price || price === '' || parseFloat(price) === 0) {
                toastr.warning('El precio debe ser mayor a 0 para guardar', '¡Atención!');
                return;
            }

            // Deshabilitar botón mientras se guarda
            $(btnElement).prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');

            let formData = new FormData();
            formData.append('price_type', priceTypeId);
            formData.append('product_detail', productDetailId);
            formData.append('price', price);
            formData.append('is_enabled', 'on');
            if (priceId) {
                formData.append('product_price_id', priceId);
            }
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

            $.ajax({
                url: '{% url "sales:product_price_save" %}',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    if (response.success) {
                        toastr.success(response.message, '¡Éxito!');
                        // Actualizar el data-price-id del input y agregar botón de eliminar si no existe
                        if (response.product_price_id) {
                            input.data('price-id', response.product_price_id);
                            row.attr('data-price-id', response.product_price_id);
                            if (!row.find('.delete-price-btn').length) {
                                let deleteBtn = $(`<button type="button" class="btn btn-sm btn-outline-danger delete-price-btn ml-1" 
                                    onclick="deleteProductPrice(${response.product_price_id})" title="Eliminar"><i class="fas fa-times"></i></button>`);
                                $(btnElement).after(deleteBtn);
                            } else {
                                row.find('.delete-price-btn').attr('onclick', `deleteProductPrice(${response.product_price_id})`);
                            }
                        }
                    } else {
                        toastr.error(response.message, '¡Error!');
                    }
                    $(btnElement).prop('disabled', false).html('<i class="fas fa-check"></i>');
                },
                error: function(xhr) {
                    let errorMsg = 'Error al guardar';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMsg = xhr.responseJSON.message;
                    }
                    toastr.error(errorMsg, '¡Error!');
                    $(btnElement).prop('disabled', false).html('<i class="fas fa-check"></i>');
                }
            });
        }


        function deleteProductPrice(id) {
            if (!confirm('¿Está seguro de eliminar este precio de producto?')) {
                return;
            }

            let formData = new FormData();
            formData.append('product_price_id', id);
            formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

            $.ajax({
                url: '{% url "sales:product_price_delete" %}',
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(response) {
                    if (response.success) {
                        toastr.success(response.message, '¡Éxito!');
                        // Limpiar el input y remover el botón de eliminar
                        let row = $('tr[data-price-id="' + id + '"]');
                        row.find('.price-input').val('').data('price-id', '');
                        row.attr('data-price-id', '');
                        row.find('.delete-price-btn').remove();
                        // Recargar la lista
                        loadProductsByPriceType();
                    } else {
                        toastr.error(response.message, '¡Error!');
                    }
                },
                error: function(xhr) {
                    let errorMsg = 'Error al eliminar';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMsg = xhr.responseJSON.message;
                    }
                    toastr.error(errorMsg, '¡Error!');
                }
            });
        }
    </script>
{% endblock extrajs %}

