{% extends 'home.html' %}
{% load static %}

{% block title %}
    Notas de Crédito de Ventas
{% endblock title %}

{% block body %}
<div class="container-fluid py-4 roboto-condensed-regular" style="background-color: #f4f7f6; min-height: 100vh;">
    <!-- Header -->
    <div class="card border-0 shadow-lg mb-4 overflow-hidden" style="border-radius: 15px;">
        <div class="card-header bg-gradient-info py-3 position-relative" style="background: linear-gradient(135deg, #17a2b8 0%, #117a8b 100%);">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h4 class="text-white mb-0 font-weight-bold roboto-condensed-regular">
                        <i class="fas fa-file-invoice-dollar mr-2"></i> NOTAS DE CRÉDITO DE VENTAS
                    </h4>
                </div>
                <div class="col-md-6 text-md-right mt-3 mt-md-0">
                    <button class="btn btn-light shadow-sm font-weight-bold" onclick="openCreditNoteModal()">
                        <i class="fas fa-plus-circle text-success mr-1"></i> NUEVA NOTA DE CRÉDITO
                    </button>
                </div>
            </div>
        </div>
        
        <div class="card-body bg-white border-bottom">
            <form id="filter-form" class="row align-items-end" method="GET">
                <div class="col-md-3">
                    <label class="small font-weight-bold text-uppercase text-muted mb-1">Fecha Inicio</label>
                    <div class="input-group shadow-sm border-0">
                        <div class="input-group-prepend">
                            <span class="input-group-text bg-white border-right-0"><i class="far fa-calendar-alt text-info"></i></span>
                        </div>
                        <input type="date" name="start_date" class="form-control border-left-0" style="border-radius: 0 5px 5px 0;" value="{{ start_date }}">
                    </div>
                </div>
                <div class="col-md-3">
                    <label class="small font-weight-bold text-uppercase text-muted mb-1">Fecha Fin</label>
                    <div class="input-group shadow-sm border-0">
                        <div class="input-group-prepend">
                            <span class="input-group-text bg-white border-right-0"><i class="far fa-calendar-alt text-info"></i></span>
                        </div>
                        <input type="date" name="end_date" class="form-control border-left-0" style="border-radius: 0 5px 5px 0;" value="{{ end_date }}">
                    </div>
                </div>
                <div class="col-md-4">
                    <button type="submit" class="btn btn-info px-4 font-weight-bold shadow-sm">
                        <i class="fas fa-filter mr-1"></i> FILTRAR
                    </button>
                    <a href="{% url 'sales:credit_note_order_list' %}" class="btn btn-outline-secondary px-3 shadow-sm ml-1">
                        <i class="fas fa-sync-alt"></i>
                    </a>
                </div>
            </form>
        </div>

        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="bg-light text-muted uppercase small font-weight-bold">
                        <tr>
                            <th class="px-4 py-3">Serie-Número</th>
                            <th class="py-3">Fecha Emisión</th>
                            <th class="py-3">Orden Referencia</th>
                            <th class="py-3">Cliente</th>
                            <th class="py-3">Motivo</th>
                            <th class="py-3 text-right">Total</th>
                            <th class="py-3 text-center px-4">Estado</th>
                            <th class="py-3 text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for cn in credit_note_order_set %}
                        <tr>
                            <td class="px-4 align-middle">
                                <span class="badge badge-soft-info p-2 text-dark font-weight-bold" style="background-color: #e0f2fe; color: #0369a1;">
                                    {{ cn.credit_note_serial }}-{{ cn.credit_note_number }}
                                </span>
                            </td>
                            <td class="align-middle">
                                {{ cn.issue_date|date:"d/m/Y" }}
                            </td>
                            <td class="align-middle">
                                <span class="badge badge-light border">{{ cn.order.serial }}-{{ cn.order.correlative }}</span>
                            </td>
                            <td class="align-middle">
                                <span class="font-weight-bold">{{ cn.order.client.names }}</span>
                            </td>
                            <td class="align-middle">
                                <small class="text-truncate d-inline-block text-muted" style="max-width: 200px;">{{ cn.motive|default:"-" }}</small>
                            </td>
                            <td class="align-middle text-right font-weight-bold text-info">
                                S/ {{ cn.get_total|floatformat:2 }}
                            </td>
                            <td class="align-middle text-center px-4">
                                {% if cn.status == 'E' %}
                                    <span class="badge badge-pill badge-success px-3">EMITIDA</span>
                                {% elif cn.status == 'P' %}
                                    <span class="badge badge-pill badge-warning px-3">PENDIENTE</span>
                                {% else %}
                                    <span class="badge badge-pill badge-danger px-3">ANULADA</span>
                                {% endif %}
                            </td>
                            <td class="align-middle text-center">
                                <button class="btn btn-sm btn-outline-primary shadow-sm rounded-pill px-3" 
                                        onclick="viewCreditNoteDetail({{ cn.id }})" 
                                        title="Ver Detalle">
                                    <i class="fas fa-eye mr-1"></i> Ver
                                </button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="8" class="text-center py-5 text-muted">
                                <i class="fas fa-folder-open fa-3x mb-3 d-block opacity-25"></i>
                                No se encontraron notas de crédito registradas.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal Container for Credit Note Creation -->
<div class="modal fade" id="modal-credit-note-order" tabindex="-1" role="dialog" 
     data-backdrop="static" data-keyboard="false" aria-hidden="true"></div>

<!-- Modal Container for Credit Note Detail View -->
<div class="modal fade" id="modal-credit-note-detail" tabindex="-1" role="dialog" aria-hidden="true"></div>

<style>
    .bg-gradient-info {
        background: linear-gradient(135deg, #17a2b8 0%, #0c6a7a 100%);
    }
    .badge-soft-info {
        border-radius: 6px;
    }
    .table thead th {
        border-top: none;
        border-bottom: 2px solid #f8f9fa;
        letter-spacing: 0.5px;
    }
    .form-control:focus {
        box-shadow: 0 0 0 0.2rem rgba(23, 162, 184, 0.25);
        border-color: #17a2b8;
    }
    .btn-outline-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(23, 162, 184, 0.3);
        transition: all 0.2s ease;
    }
</style>

<script>
    function openCreditNoteModal(orderId = '') {
        $.ajax({
            url: '{% url "sales:modal_credit_note_order" %}',
            dataType: 'json',
            type: 'GET',
            data: { 'order_id': orderId },
            success: function (response) {
                $('#modal-credit-note-order').html(response.form);
                $('#modal-credit-note-order').modal('show');
            },
            error: function () {
                toastr.error('Error al cargar el formulario', '¡Mensaje!');
            }
        });
    }

    function viewCreditNoteDetail(creditNoteId) {
        $.ajax({
            url: '{% url "sales:view_credit_note_order_detail" %}',
            dataType: 'json',
            type: 'GET',
            data: { 'credit_note_id': creditNoteId },
            success: function (response) {
                $('#modal-credit-note-detail').html(response.html);
                $('#modal-credit-note-detail').modal('show');
            },
            error: function () {
                toastr.error('Error al cargar el detalle de la nota de crédito', '¡Error!');
            }
        });
    }
</script>
{% endblock body %}
