{% load operations %}
<div class="p-2">
    <table class="table table-sm table-bordered mb-0 table-details roboto-condensed-regular" pk="{{ bill_obj.id }}" style="background: #fff; font-size: 0.8rem;">
        <thead>
        <tr class="text-center text-uppercase" style="background: linear-gradient(180deg, #bbe0f5 0%, #90caf9 100%); color: #0d47a1;">
            <th class="py-2" style="width: 18%;">Estado</th>
            <th class="py-2" style="width: 32%;">Producto</th>
            <th class="py-2" style="width: 20%;">Cantidad</th>
        </tr>
        </thead>
        <tbody>
        <tr class="almacen-header" style="background: linear-gradient(180deg, #e3f2fd 0%, #bbdefb 100%);">
            <td colspan="3" class="py-3 px-4">
                <div class="d-flex flex-wrap align-items-center" style="font-size: 0.95rem; gap: 2rem;">
                    <span class="font-weight-bold text-primary">
                        <i class="fas fa-warehouse mr-1"></i>Almacén: {% if bill_obj.store_destiny %}{{ bill_obj.store_destiny.name }}{% else %}-{% endif %}
                    </span>
                    {% if first_batch_lote %}
                    <span class="text-muted" style="opacity: 0.5;">|</span>
                    <span class="pl-2"><i class="fas fa-barcode mr-1 text-secondary"></i><strong>Lote:</strong> {{ first_batch_lote|upper }}</span>
                    {% endif %}
                    {% if first_batch_venc %}
                    <span class="text-muted" style="opacity: 0.5;">|</span>
                    <span class="pl-2"><i class="far fa-calendar-alt mr-1 text-secondary"></i><strong>Venc.:</strong> {{ first_batch_venc|date:'d/m/Y' }}</span>
                    {% endif %}
                </div>
            </td>
        </tr>
        {% for dt in details_dict %}
            {% if dt.status_quantity == 'C' %}
                <tr class="text-center" detail="{{ dt.id }}" style="background-color: #f5f5f5;">
                    <td class="align-middle">
                        <span class="badge badge-secondary px-2 py-1">{{ dt.status_display }}</span>
                    </td>
                    <td class="align-middle text-left">
                        {{ dt.product }}
                        {% if dt.order_number %}
                            <br><small class="text-muted">Nro Orden: {{ dt.order_number }}</small>
                        {% endif %}
                    </td>
                    <td class="align-middle font-weight-bold">{{ dt.quantity_display }}</td>
                </tr>
            {% else %}
                {% for b in dt.details_batch %}
                    <tr class="text-center" detail="{{ dt.id }}" style="background-color: {% if dt.status_quantity == 'I' %}#e8f5e9{% elif dt.status_quantity == 'D' %}#fff3e0{% elif dt.status_quantity == 'V' %}#e3f2fd{% else %}#f5f5f5{% endif %};">
                        <td class="align-middle">
                            <span class="badge badge-pill px-2 py-1 font-weight-bold" style="{% if dt.status_quantity == 'I' %}background-color: #2e7d32; color: #fff;{% elif dt.status_quantity == 'D' %}background-color: #e65100; color: #fff;{% elif dt.status_quantity == 'V' %}background-color: #1565c0; color: #fff;{% else %}background-color: #757575; color: #fff;{% endif %}">
                                {{ dt.status_display }}
                            </span>
                            {% if dt.status_quantity == 'I' or dt.status_quantity == 'D' or dt.status_quantity == 'V' %}
                                {% if forloop.first and dt.show_conversion_und %}
                                    <br><small class="text-muted d-block mt-1" style="font-size: 0.65rem;">({{ dt.quantity_und_display|floatformat:0 }} UND)</small>
                                {% endif %}
                            {% endif %}
                        </td>
                        <td class="align-middle text-left">
                            {{ dt.product }}
                            {% if b.order_number %}
                                <br><small class="text-muted font-weight-bold">Nro Orden: {{ b.order_number }}</small>
                                {% if b.order_number_bill %}<br><small class="text-muted font-weight-bold">Comprobante: {{ b.order_number_bill }}</small>{% endif %}
                            {% endif %}
                            {% if dt.status_quantity == 'D' %}
                                <div class="mt-2 credit-note">
                                    {% if dt.credit_note %}
                                        <small class="text-primary font-weight-bold">NC: {{ dt.credit_note|upper }}</small><br>
                                        <small class="text-muted">Factura: {{ dt.bill_applied }}</small>
                                    {% else %}
                                        <button type="button" class="btn btn-danger btn-sm generate-credit-note mt-1" pk="{{ dt.id }}" bill="{{ bill_obj.id }}">
                                            <i class="fas fa-file-invoice mr-1"></i>Nota de Crédito
                                        </button>
                                    {% endif %}
                                </div>
                            {% endif %}
                        </td>
                        <td class="align-middle font-weight-bold">
                            {% if dt.status_quantity == 'I' or dt.status_quantity == 'D' or dt.status_quantity == 'V' %}
                                {% if forloop.first %}
                                    {{ dt.quantity_display }}
                                {% else %}
                                    -
                                {% endif %}
                            {% else %}
                                {{ b.batch_quantity|replace_round }} {{ b.batch_unit }}
                            {% endif %}
                        </td>
                    </tr>
                {% empty %}
                    <tr class="text-center" detail="{{ dt.id }}" style="background-color: {% if dt.status_quantity == 'I' %}#e8f5e9{% elif dt.status_quantity == 'D' %}#fff3e0{% elif dt.status_quantity == 'V' %}#e3f2fd{% else %}#f5f5f5{% endif %};">
                        <td class="align-middle">
                            <span class="badge badge-pill px-2 py-1 font-weight-bold" style="{% if dt.status_quantity == 'I' %}background-color: #2e7d32; color: #fff;{% elif dt.status_quantity == 'D' %}background-color: #e65100; color: #fff;{% elif dt.status_quantity == 'V' %}background-color: #1565c0; color: #fff;{% else %}background-color: #757575; color: #fff;{% endif %}">
                                {{ dt.status_display }}
                            </span>
                            {% if dt.show_conversion_und %}
                                <br><small class="text-muted d-block mt-1" style="font-size: 0.65rem;">({{ dt.quantity_und_display|floatformat:0 }} UND)</small>
                            {% endif %}
                        </td>
                        <td class="align-middle text-left">
                            {{ dt.product }}
                            {% if dt.status_quantity == 'D' %}
                                <div class="mt-2 credit-note">
                                    {% if dt.credit_note %}
                                        <small class="text-primary font-weight-bold">NC: {{ dt.credit_note|upper }}</small><br>
                                        <small class="text-muted">Factura: {{ dt.bill_applied }}</small>
                                    {% else %}
                                        <button type="button" class="btn btn-danger btn-sm generate-credit-note mt-1" pk="{{ dt.id }}" bill="{{ bill_obj.id }}">
                                            <i class="fas fa-file-invoice mr-1"></i>Nota de Crédito
                                        </button>
                                    {% endif %}
                                </div>
                            {% endif %}
                        </td>
                        <td class="align-middle font-weight-bold">{{ dt.quantity_display }}</td>
                    </tr>
                {% endfor %}
            {% endif %}
        {% endfor %}
        </tbody>
    </table>
</div>
