{% extends 'home.html' %}
{% block title %}
    Guia de Remision
{% endblock title %}

{% block body %}

    <div class="card m-1 roboto-condensed-regular">
        <div class="card-header pt-0">
            <div class="row row-head" style="background: #3e6787">
                <div class="col-sm-4 col-md-4 col-lg-4 mb-0" >
                    <input type="hidden" id="contract_detail_id" name="contract-detail"
                           value="{{ contract_detail_obj.id }}">
                    {% if contract_detail_obj %}
                        <h6 class="roboto-condensed-regular text-white font-weight-bold mt-4 mb-0">
                            <label>{{ contract_detail_obj.contract.contract_number }} -
                                FECHA: {{ contract_detail_obj.date|date:'d-m-Y' }}</label>
                        </h6>
                    {% else %}
                        <h6 class="text-white font-weight-bold mt-4 mb-0 roboto-condensed-regular title-contract">
                            <label>GUÍA DE REMISIÓN REMITENTE:</label>
                        </h6>
                    {% endif %}
                </div>
                <div class="col-sm-4 col-md-4 col-lg-4 text-black-50">
                    <table class="table table-bordered mt-1 mb-1" style="background: #ffffff">
                        <tbody>
                        <tr class="text-center">
                            <td class="font-weight-bold align-middle" style="border-width: 3px; border-color: black">
                                Guia de Remisión Electrónica - Remitente<br>RUC: 20604193053
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
                <div class="col-sm-4 col-md-4 col-lg-4 p-3">
                    <div class="btn-group btn-block" role="group" aria-label="Basic example">
                        <button type="button" class="btn btn-info m-1" onclick="saveGuide()">EMITIR GUÍA</button>
                        <button type="button" class="btn btn-secondary m-1">NUEVO</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="card-body bg-light p-0">
            <div class="row col-md-12 mb-1 mt-1 pr-0">
                <div class="col-md-2">
                    <label for="issue" class="text-primary">Fecha Emisión:</label>
                    <input class="form-control form-control-sm" type="date" value="{{ date_now }}" id="issue"
                           name="issue" required>
                </div>
                <div class="col-md-2">
                    <label for="transfer" class="text-primary">Fecha Traslado:</label>
                    <input class="form-control form-control-sm" type="date" value="{{ date_now }}" id="transfer"
                           name="transfer" required>
                </div>
                <div class="col-md-2">
                    <label for="store_id" class="text-primary">Almacen:</label>
                    <select class="form-control form-control-sm font-weight-bold" style="background-color: #dbeaee"
                            id="store_id"
                            name="store">
                        <option selected disabled value="0">Seleccione</option>
                        {% for s in subsidiary_store_set %}
                            <option value="{{ s.id }}">{{ s.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-1 pl-0 pr-1">
                    <label for="serial" class="text-primary">Serie:</label>
                    <input type="text"
                           class="form-control form-control-sm text-center" name="serial" id="serial"
                           placeholder="" disabled
                           value="EG07">
                </div>
                <div class="col-md-1 pr-0 ">
                    <label for="correlative" class="text-primary">Correlativo:</label>
                    <input type="text" autocomplete="off"
                           class="form-control form-control-sm text-right" name="correlative" id="correlative"
                           value="">
                </div>
                <div class="col-md-2">
                    <label for="oc" class="text-primary">Nº O/C:</label>
                    <input class="form-control form-control-sm" type="text" value="" id="oc"
                           placeholder="Orden de Compra"
                           name="oc" required>
                </div>
                <div class="col-md-2">
                    <label for="bill" class="text-primary">Doc. Referencia:</label>
                    <input class="form-control form-control-sm" type="text" value="" id="bill" placeholder="Factura"
                           name="bill" required>
                </div>
            </div>
            {#            <div class="d-flex">#}
            {#                <hr class="my-auto flex-grow-1 bg-lightblue">#}
            {#                <div class="px-2 font-weight-bold" style="font-size: .8375rem;">DATOS DEL DESTINATARIO</div>#}
            {#                <hr class="my-auto flex-grow-1 bg-lightblue">#}
            {#            </div>#}
            <div class="row col-md-12 mb-1 mt-2 pr-0">
                <div class="col-md-2">
                    <label for="id_motive" class="text-primary">Motivo de Traslado:</label>
                    <select class="form-control form-control-sm" id="id_motive"
                            name="id-motive">
                        <option selected disabled value="0">Seleccione</option>
                        {% for m in motive_set %}
                            <option value="{{ m.id }}">{{ m.description }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <input type="hidden" id="client_id" value="{{ contract_detail_obj.contract.client.id }}">
                    <label for="person-names" class="text-primary">RUC (Destinatario):</label>
                    <div id="autocomplete-client" class="autocomplete">
                        <input class="form-control form-control-sm autocomplete-input"
                               type="text"
                               id="person-names"
                               name="person-names"
                               maxlength="200"
                               autocomplete="off"
                               value="{{ contract_detail_obj.contract.client.clienttype_set.last.document_number }}"
                               {% if contract_detail_obj %}disabled{% endif %}
                               placeholder="Buscar Cliente..."/>
                        <ul class="autocomplete-result-list"></ul>
                    </div>
                    {#                    {% if contract_detail_obj %}#}
                    {#                        <label for="document-client" class="text-primary">RUC (Destinatario)</label>#}
                    {#                        <input type="text"#}
                    {#                               class="form-control form-control-sm" name="document-client" id="document-client" disabled#}
                    {#                               required#}
                    {#                               value="{{ contract_detail_obj.contract.client.clienttype_set.last.document_number }}"#}
                    {#                               maxlength="200">#}
                    {#                    {% else %}#}
                    {#                        <label for="person-names">RUC (Destinatario)</label>#}
                    {#                        <div id="autocomplete-client" class="autocomplete">#}
                    {#                            <input class="form-control form-control-sm autocomplete-input"#}
                    {#                                   type="text"#}
                    {#                                   id="person-names"#}
                    {#                                   name="person-names"#}
                    {#                                   maxlength="200"#}
                    {#                                   autocomplete="off"#}
                    {#                                   value=""#}
                    {#                                   placeholder="Buscar Cliente..."/>#}
                    {#                            <ul class="autocomplete-result-list"></ul>#}
                    {#                        </div>#}
                    {#                    {% endif %}#}
                </div>
                <div class="col-md-8">
                    <label for="name-client" class="text-primary">Razón Social (Destinatario):</label>
                    <input type="text"
                           class="form-control form-control-sm" name="name-client" id="name-client" disabled
                           value="{{ contract_detail_obj.contract.client.names }}" maxlength="500">
                </div>
            </div>
            <div class="row col-md-12 mb-1 mt-2 pr-0">
                <div class="col-md-2">
                    <label for="btn-add-origin" class="text-primary">Punto de partida:</label>
                    <button id="btn-add-origin" class="btn btn-sm btn-block btn-primary" type="button"
                            onclick="AddOrigin('modal_guide_origin')">
                        <i class="fas fa-plus"></i> Agregar
                    </button>
                </div>
                <div class="col-md-2">
                    <label for="location-origin" class="text-primary">Ubigeo Origen:</label>
                    <input type="text"
                           class="form-control form-control-sm" name="location-origin" id="location-origin"
                           placeholder="" disabled value="">
                </div>
                <div class="col-md-8">
                    <label for="origin-address" class="text-primary">Direccion de partida:</label>
                    <input type="text"
                           class="form-control form-control-sm" name="origin-address" id="origin-address"
                           placeholder="" disabled value="">
                </div>
            </div>
            <div class="row col-md-12 mb-1 mt-1 pr-0">
                <div class="col-md-2">
                    <label for="btn-add-origin" class="text-primary">Punto de llegada:</label>
                    <button id="btn-add-origin" class="btn btn-sm btn-block btn-primary" type="button"
                            onclick="AddDestiny('modal_guide_destiny')">
                        <i class="fas fa-plus"></i> Agregar
                    </button>
                </div>
                <div class="col-md-2">
                    <label for="location-destiny" class="text-primary">Ubigeo Destino:</label>
                    <input type="text"
                           class="form-control form-control-sm" name="location-destiny" id="location-destiny"
                           placeholder="" disabled value="">
                </div>
                <div class="col-md-8">
                    <label for="destiny-address" class="text-primary">Direccion de Destino:</label>
                    <input type="text"
                           class="form-control form-control-sm" name="destiny-address" id="destiny-address"
                           placeholder="" disabled value="">
                </div>
            </div>
            <div class="row col-md-12 mb-1 mt-1 pr-0">
                <div class="col-md-2">
                    <label for="transport-modality" class="text-primary">Modalidad de Transporte:</label>
                    <select class="form-control form-control-sm" id="transport-modality"
                            name="transport-modality">
                        <option selected disabled value="0">Seleccione</option>
                        <option value="1">PUBLICO</option>
                        <option value="2">PRIVADO</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label for="transport-modality" class="text-primary">Agregar Transportista:</label>
                    <button id="btn-add-origin" class="btn btn-sm btn-block btn-success" type="button"
                            onclick="AddCarrier('modal_guide_carrier')">
                        <i class="fas fa-plus"></i> Agregar
                    </button>
                </div>

                <div class="col-md-2">
                    <label for="document-transport" class="text-primary">Nº de Documento (Transportista):</label>
                    <input type="text"
                           class="form-control form-control-sm" name="document-transport" id="document-transport"
                           placeholder=""
                           value="" maxlength="200">
                    <input type="hidden" id="guide_carrier_id">
                </div>
                <div class="col-md-4">
                    <label for="name-transport" class="text-primary">Razón Social (Transportista):</label>
                    <input type="text"
                           class="form-control form-control-sm" name="name-transport" id="name-transport"
                           placeholder=""
                           value="" maxlength="500">
                </div>
                <div class="col-md-2">
                    <label for="register_mtc" class="text-primary">Nº Registro MTC:</label>
                    <input type="text"
                           class="form-control form-control-sm" name="register_mtc" id="register_mtc"
                           value="" maxlength="500">
                </div>
            </div>
            <div class="row col-md-12 mb-1 mt-1 pr-0">
                <div class="col-md-2">
                    <label for="plate" class="text-primary">Vehiculo (Placa):</label>
                    <input type="text"
                           class="form-control form-control-sm" name="plate" id="plate"
                           placeholder=""
                           value="" maxlength="20">
                    <input type="hidden" id="guide_vehicle_id">
                </div>
                <div class="col-md-2">
                    <label for="document-driver" class="text-primary">DNI (Conductor):</label>
                    <input type="text"
                           class="form-control form-control-sm" name="document-driver" id="document-driver"
                           placeholder=""
                           value="" maxlength="20">
                    <input type="hidden" id="driver_id">
                </div>
                <div class="col-md-2">
                    <label for="license-driver" class="text-primary">Nº Licencia (Conductor):</label>
                    <input type="text"
                           class="form-control form-control-sm" name="license-driver" id="license-driver"
                           placeholder=""
                           value="" maxlength="20">
                </div>
                <div class="col-md-6">
                    <label for="names-driver" class="text-primary">Nombres y Apellidos (Conductor):</label>
                    <input type="text"
                           class="form-control form-control-sm" name="names-driver" id="names-driver"
                           placeholder=""
                           value="" maxlength="20">
                </div>
            </div>

            <div class="row col-md-12 mb-1 mt-1 pr-0">
                <div class="col-md-2">
                    <label for="weight" class="text-primary">Peso bruto total (KGM):</label>
                    {#                    <input type="text"#}
                    {#                           class="form-control form-control-sm" name="weight" id="weight"#}
                    {#                           placeholder="" required#}
                    {#                           value="{{ weight_total }}" maxlength="20">#}
                    <div class="input-icon">
                        <input type="text"
                               name="weight" id="weight"
                               class="form-control form-control-sm text-right text-uppercase total-detail"
                               style="padding-right: 33px"
                               value="{% if weight_total > '0' %}{{ weight_total }}{% endif %}">
                        <i class="change-money">Kg</i>
                    </div>
                </div>
                <div class="col-md-2">
                    <label for="id-package" class="text-primary">Numero Bultos:</label>
                    <input type="text"
                           class="form-control form-control-sm" name="id-package" id="id-package"
                           autocomplete="off" required
                           value="" maxlength="20">
                </div>
                <div class="col-md-8 align-self-center">
                    <label for="id_observation" class="text-primary">Observaciones:</label>
                    <input type="text"
                           class="form-control form-control-sm" name="id-observation" id="id_observation"
                           autocomplete="off" required
                           value="" maxlength="20">
                </div>
            </div>

            <div class="d-flex mt-3">
                <hr class="my-auto flex-grow-1 bg-lightblue">
                <div class="px-2 font-weight-bold" style="font-size: .8375rem;">DETALLE DE LA GUIA</div>
                <hr class="my-auto flex-grow-1 bg-lightblue">
            </div>
            <div class="row m-1 mt-2">
                <div class="col-sm-12 p-1">
                    <div class="card col-sm-12 p-0">
                        <table class="table-hover table-sm table-bordered" id="id-table-detail-guide"
                               style="width: 100%;">
                            <thead class="text-uppercase small text-center">
                            <tr class="text-white" style="background: #3e6787">
                                <th scope="col" class="font-weight-normal" style="width: 5%;">Nº</th>
                                <th scope="col" class="font-weight-normal" style="width: 55%;">Descripcion</th>
                                <th scope="col" class="font-weight-normal" style="width: 10%;">Cantidad</th>
                                <th scope="col" class="font-weight-normal" style="width: 10%;">Unidad</th>
                                <th scope="col" class="font-weight-normal"
                                    style="width: 10%; background-color: #518d86">Cant. / U. M.
                                </th>
{#                                <th scope="col" class="font-weight-normal" style="width: 15%;">Sucursal</th>#}
                                <th scope="col" class="font-weight-normal" style="width: 10%;">Lote</th>
                                {#                                <th scope="col" class="font-weight-normal" style="width: 10%;">Eliminar</th>#}
                            </tr>
                            </thead>
                            <tbody id="guide-details">
                            {% if contract_detail_obj %}
                                {% for c in contract_dict %}
                                    <tr product="{{ c.product_id }}" unit_id="">
                                        <td class="item-numero align-middle text-center">{{ c.counter }}</td>
                                        <td class="align-middle text-left product-item-table">
                                            <input type="text"
                                                   class="form-control text-uppercase product-table dropdown-toggle"
                                                   data-toggle="dropdown" aria-expanded="false"
                                                   placeholder="Ingrese producto..."
                                                   value="{{ c.product_name }}"
                                                   disabled>
                                            <div class="dropdown-menu"></div>
                                        </td>
                                        <td class="align-middle item-quantity">
                                            <input type="text"
                                                   class="form-control text-center quantity-product text-uppercase"
                                                   placeholder="0"
                                                   value="{{ c.quantity|safe|floatformat:0 }}">
                                        </td>
                                        <td class="align-middle unit">
                                            <select class="form-control unit-product text-center" id="id_unit_product"
                                                    name="unit_product" required>
                                                <option value="0">Seleccione</option>
                                                {% for u in c.units %}
                                                    <option value="{{ u.unit_id }}"
                                                            qm="{{ u.quantity_minimum }}"
                                                            unit="{{ u.unit_description }}">{{ u.unit_name }}
                                                        ({{ u.quantity_minimum }}{{ u.unit_name }})
                                                    </option>
                                                {% endfor %}
                                            </select>
                                        </td>
                                        <td class="align-middle quantity-minimum">
                                            <input type="text"
                                                   style="background-color: #bde7e2"
                                                   class="form-control text-center quantity-minimum-val text-uppercase"
                                                   placeholder="0">
                                        </td>
                                    </tr>
                                {% endfor %}
                            {% endif %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modal-origin" data-backdrop="static" data-keyboard="false" tabindex="-1"
         aria-labelledby="ModalHelpTitle" aria-hidden="true"></div>
    <div class="modal fade" id="modal-destiny" data-backdrop="static" data-keyboard="false" tabindex="-1"
         aria-labelledby="ModalHelpTitle" aria-hidden="true"></div>
    <div class="modal fade" id="modal-carrier" data-backdrop="static" data-keyboard="false" tabindex="-1"
         aria-labelledby="ModalHelpTitle" aria-hidden="true"></div>

    <style>

        .input-icon {
            position: relative;
        }

        .input-icon > i {
            position: absolute;
            display: block;
            transform: translate(0, -50%);
            top: 50%;
            pointer-events: none;
            width: 520px;
            text-align: center;
            font-style: normal;
        }

        /*.input-icon > input {
            padding-left: 25px;
            padding-right: 8px;
        }*/

        .input-icon-right > i {
            right: 0;
        }

        .input-icon-right > input {
            /*padding-left: 0;
            padding-right: 33px;*/
            text-align: center;
        }

    </style>

    <div class="modal fade" id="modal-batch" tabindex="-1" role="dialog"
         aria-labelledby="ModalHelpTitle" data-backdrop="static" data-keyboard="false"
         aria-hidden="true"></div>

{% endblock body %}

{% block extrajs %}
    <script type="text/javascript">


        const urlParams = new URLSearchParams(window.location.search);
        const data = urlParams.get('selected_data');
        const dataObject = JSON.parse(data);

        console.log(dataObject);

        if (dataObject !== null && Object.keys(dataObject).length > 0) {
            $('#id-table-detail-guide > tbody').empty();
            $('.row-head').css('background', '#62a239');

            const clientData = dataObject[0].client_data;
            let client = {
                names: clientData[0].names,
                number_document: clientData[0].number,
                id: clientData[0].id,
                type_client: clientData[0].type_client,
                address: clientData[0].address
            };
            $('#person-names').val(clientData[0].names)
            handleClientSubmitGuide(client);

            $(".title-contract label").text("CONTRATO: " + dataObject[0].contract_number);
            const contractDetailIds = dataObject[0].contract_data.map(detail => detail.contract_detail_id).join(',');
            $('#contract_detail_id').val(contractDetailIds);

            var deliveryDatesHtml = '<p class="mb-0"></p><ul>';
            dataObject[0].contract_data.forEach(function (contractDetail) {
                deliveryDatesHtml += '<li>' +
                                        '<span>Nro. de Entrega:</span> ' +
                                        '<span class="text-white">' + contractDetail.nro_quota + '</span>, ' +
                                        'Fecha: <span class="text-white">' + contractDetail.date + '</span>, ' +
                                        'O/C: <span class="text-white">' + contractDetail.o_c + '</span>' +
                                     '</li>';
            });
            deliveryDatesHtml += "</ul>";

            $(".title-contract").after(deliveryDatesHtml);

            for (let productID in dataObject) {
                if (dataObject.hasOwnProperty(productID)) {
                    let _check = $("#check_dollar");
                    let _val_money = 'S/'

                    if (_check.is(':checked')) {
                        _val_money = '$'
                    }
                    let item = dataObject[productID];
                    let options = '';
                    let optionsSubsidiary = '';
                    for (let i = 0; i < item.units.length; i++) {
                        options += '<option value="' + item.units[i].unit_id + '" qm="' + item.units[i].quantity_minimum + '" unit="'+ item.units[i].unit_name +'">' + item.units[i].unit_name + ' (' + item.units[i].quantity_minimum + item.units[i].unit_name + ')' + '</option>';
                    }
                    /*let subsidiaries = JSON.parse('{{ subsidiary_set|safe|escapejs }}');
                    let selectedSubsidiary = '{{ subsidiary_user|default:"0" }}';
                    subsidiaries.forEach(function (subsidiary) {
                        let isSelected = subsidiary.id.toString() === selectedSubsidiary ? 'selected' : '';
                        optionsSubsidiary += '<option value="' + subsidiary.id + '" ' + isSelected + '>' + subsidiary.name + '</option>';
                    });*/

                    let newRow = '<tr class="text-center" weight="'+ item.product_weight +'" product="' + item.product_id + '">' +
                        '<td class="item-numero align-middle">' + '</td>' +
                        '<td class="align-middle text-left product-item-table">' +
                        '<input type="text" class="form-control text-uppercase product-table dropdown-toggle" ' +
                        '               data-toggle="dropdown" aria-expanded="false" placeholder="Ingrese producto..." value="' + item.product_name + '" ' + 'iv class="dropdown-menu"></div>' + '</td>' +
                        '<td class="align-middle item-quantity">' + '<input type="text" class="form-control text-center quantity-product text-uppercase" placeholder="0" value="' + item.quantity + '">' + '</td>' +
                        '<td class="align-middle unit text-center">' +
                        '<select class="form-control unit-product text-center bg-warning" id="id_unit_product" name="unit_product" required>' +
                        '<option disabled selected value="0">Seleccione</option>' +
                        options +
                        '</td>' +
                        '<td class="align-middle quantity-minimum text-center">' +
                        '<input type="text" class="form-control text-center quantity-minimum-val" readonly>' +
                        '</td>' +
                        /*'<td class="align-middle subsidiary text-center">' +
                        '<select class="form-control subsidiary-product text-center bg-light" id="id_subsidiary_product" name="subsidiary_product" required>' +
                        '<option disabled selected value="0">Seleccione</option>' +
                        optionsSubsidiary +
                        '</select>' +
                        '</td>' +*/
                        '<td class="align-middle batch text-center">' +
                        '<button type="button" class="btn btn-warning btn-sm btn-batch" style="font-size: 0.95em">Sin Lote </button>' +
                        '<input type="hidden" class="batch-id" value="">' +
                        '<input type="hidden" class="stock-batch" value="">' +
                        '</td>' +
                        //'<td class="align-middle text-center"> ' + '<button type="button" onclick="deleteItem(this)" class="btn btn-danger delete-detail"><i class="fa fa-trash"></i></button>' + '</td>' +
                        '</tr>';

                    $('#id-table-detail-guide > tbody').append(newRow);
                    counterTable();
                }
            }
            setTimeout(function () {
                $(".unit-product").trigger('change');
            }, 500);
        }

        function counterTable() {
            let l = 1;
            $('#guide-details tr').each(function () {
                $(this).attr('i', l);
                $(this).children('td:nth-child(1)').text(l);
                l++;
            });

        }

        let ubigeo_origin;
        let ubigeo_destiny;

        new Autocomplete('#autocomplete-client', {
            search: input => {
                const url = `/buys/get_client/?search=${encodeURI(input.toUpperCase())}`

                return new Promise(resolve => {
                    if (input.length < 3) {
                        //$('#person-number').val('')
                        //$('#order-number').val('')
                        return resolve([])
                    }
                    fetch(url)
                        .then(response => response.json())
                        .then(data => {
                            resolve(data.client)
                        })
                })
            },
            renderResult: (result, props) => {
                let group = ''
                if (result.index % 3 === 0) {
                    group = '<li class="group">Group</li>'
                }
                return `
                ${group}
                <li ${props}>
                 <div class="h6" style="font-family: roboto_condensed_regular">
                    ${result.names}
                 </div>
                 <div class="wiki-snippet text-black">
                    RUC: ${result.number_document}
                  </div>
                </li>
                `
            },
            getResultValue: result => result.number_document,
            onSubmit: handleClientSubmitGuide
        })

        async function handleClientSubmitGuide(result) {
            if (result) {
                let client_id = result.id;
                let document_number = result.number_document;
                let _client_names = result.names;
                let _client_address = result.address;
                $('#client_id').val(client_id);
                $('#name-client').val(_client_names);
                $('#person-names').val(document_number);
            } else {
                toastr.warning('Seleccione un cliente valido', 'Error de llenado');
                return false;
            }
        }

        function AddOrigin(route) {
            $('#modal-origin').empty();
            $.ajax({
                url: '/comercial/' + route + '/',
                dataType: 'json',
                type: 'GET',
                data: {},
                success: function (response) {
                    $('#modal-origin').html(response.form);
                    $('#modal-origin').modal('show');
                },
                fail: function (response) {
                    toastr.error('Ocurrio un problema al mostrar el formulario', '¡Mensaje!');
                }
            });
        }

        function AddDestiny(route) {
            let client = $('#client_id').val();
            if (client !== '') {
                $('#modal-destiny').empty();
                $.ajax({
                    url: '/comercial/' + route + '/',
                    dataType: 'json',
                    type: 'GET',
                    data: {'client': client},
                    success: function (response) {
                        $('#modal-destiny').html(response.form);
                        $('#modal-destiny').modal('show');
                    },
                    fail: function (response) {
                        toastr.error('Ocurrio un problema al mostrar el formulario', '¡Mensaje!');
                    }
                });
            } else {
                toastr.warning('Primero Seleccione el Destinatario', '¡Mensaje!');
                return false;
            }
        }

        function AddCarrier(route) {
            $('#modal-carrier').empty();
            $.ajax({
                url: '/comercial/' + route + '/',
                dataType: 'json',
                type: 'GET',
                data: {},
                success: function (response) {
                    $('#modal-carrier').html(response.form);
                    $('#modal-carrier').modal('show');
                },
                fail: function (response) {
                    toastr.error('Ocurrio un problema al mostrar el formulario', '¡Mensaje!');
                }
            });

        }

        function checkUnitGuide() {
            let flag = false
            $('tbody#guide-details tr').each(function () {
                let _unit = $(this).find('td.unit select.unit-product').val()
                if (_unit === '0') {
                    flag = true
                }
            });
            return flag
        }

        function saveGuide() {

            let _contract_detail = $("#contract_detail_id").val()
            let _issue = $('#issue').val();
            let _transfer = $('#transfer').val();
            let _motive = $('#id_motive').val();
            let _client = $('#client_id').val();

            let _origin = $('#location-origin').val();
            let _origin_address = $('#origin-address').val();
            let _destiny = $('#location-destiny').val();
            let _destiny_address = $('#destiny-address').val();

            let _transport_modality = $('#transport-modality').val();

            let _carrier = $('#guide_carrier_id').val();
            let _vehicle_id = $('#guide_vehicle_id').val();
            let _driver_id = $('#driver_id').val();

            let _weight = $('#weight').val();
            let _n_package = $('#id-package').val();
            let _observations = $('#id_observation').val();

            let _serial = $('#serial').val();
            let _correlative = $('#correlative').val();

            let _store = $('#store_id').val();

            let _oc = $('#oc').val();
            let _register_mtc = $('#register_mtc').val();

            let document_transport = $('#document-transport').val();
            let name_transport = $('#name-transport').val();
            let plate = $('#plate').val();
            let document_driver = $('#document-driver').val();
            let license_driver = $('#license-driver').val();
            let names_driver = $('#names-driver').val();

            if (_store === null) {
                toastr.warning('¡Seleccione el Almacen!', 'Mensaje');
                return false;
            }
            if (_motive === null) {
                toastr.warning('¡Seleccione Motivo de Traslado!', 'Mensaje');
                return false;
            }
            if (_origin === '' && _origin_address === '') {
                toastr.warning('¡Agregue el Origen!', 'Mensaje');
                return false;
            }
            if (_destiny === '' && _destiny_address === '') {
                toastr.warning('¡Agregue el Destino!', 'Mensaje');
                return false;
            }
            if (_transport_modality === null) {
                toastr.warning('¡Seleccione la modalidad de Transporte!', 'Mensaje');
                return false;
            }
            if (_transport_modality === '1') {
               if (document_transport === '') {
                   toastr.warning('¡Si el Transporte es publico llene el Nº de Documento (Transportista)!', 'Mensaje');
                   return false;
               }
               if (name_transport === '') {
                   toastr.warning('¡Si el Transporte es publico llene la Razón Social (Transportista):!', 'Mensaje');
                   return false;
               }
            }
            if (_transport_modality === '2') {
                if (document_transport === '') {
                   toastr.warning('¡Si el Transporte es privado llene el Nº de Documento (Transportista)!', 'Mensaje');
                   return false;
               }
               if (name_transport === '') {
                   toastr.warning('¡Si el Transporte es privado llene la Razón Social (Transportista)!', 'Mensaje');
                   return false;
               }
               if (plate === '') {
                   toastr.warning('¡Si el Transporte es privado llene la placa!', 'Mensaje');
                   return false;
               }
               if (document_driver === '') {
                   toastr.warning('¡Si el Transporte es privado llene el nombre del conductor!', 'Mensaje');
                   return false;
               }
               if (license_driver === '') {
                   toastr.warning('¡Si el Transporte es privado llene la licencia!', 'Mensaje');
                   return false;
               }
               if (names_driver === '') {
                   toastr.warning('¡Si el Transporte es privado llene el nombre del conductor!', 'Mensaje');
                   return false;
               }
            }
            /*if (_carrier === '') {
                toastr.warning('¡Agregue un Transportista!', 'Mensaje');
                return false;
            }*/
            if (_weight === '') {
                toastr.warning('¡Agregue el Peso Total!', 'Mensaje');
                return false;
            }
            if (_n_package === '') {
                toastr.warning('¡Agregue la cantidad de bultos!', 'Mensaje');
                return false;
            }
            if (_correlative === '') {
                toastr.warning('¡El correlativo no puede estar vacio!', 'Mensaje');
                return false;
            }
            if (checkUnitGuide() === true) {
                toastr.warning('¡Selecione el tipo de unidad en los productos!', 'Mensaje');
                return false;
            }

            let Guide = {
                "Details": [],
                "contract_detail": _contract_detail,
                "issue_date": _issue,
                "transfer_date": _transfer,
                "motive": _motive,
                "client": _client,
                "origin": _origin,
                "origin_address": _origin_address,
                "destiny": _destiny,
                "destiny_address": _destiny_address,
                "transport_modality": _transport_modality,
                "carrier": _carrier,
                "vehicle": _vehicle_id,
                "driver": _driver_id,
                "weight": _weight,
                "n_package": _n_package,
                "observations": _observations,
                "store": _store,
                "serial": _serial,
                "correlative": _correlative,
                "oc": _oc,
                "register_mtc": _register_mtc,

                "document_transport": document_transport,
                "name_transport": name_transport,
                "plate": plate,
                "document_driver": document_driver,
                "license_driver": license_driver,
                "names_driver": names_driver,
            }

            $("#id-table-detail-guide tbody#guide-details tr").each(function () {
                let detailObj = {
                    "Product": $(this).attr('product'),
                    "Quantity": $(this).find("td.item-quantity input.quantity-product").val(),
                    "Unit": $(this).find("td.unit select.unit-product").val(),
                    "QuantityUnit": $(this).find("td.quantity-minimum input.quantity-minimum-val").val(),
                    "Batch": $(this).find("td.batch input.batch-id").val(),
                };
                Guide.Details.push(detailObj);
            });
            //console.log(Guide)
            $.ajax({
                url: '/comercial/save_guide/',
                async: true,
                dataType: 'json', // for response
                type: 'GET',
                data: {'guide': JSON.stringify(Guide)},
                contentType: 'application/json;charset=UTF-8',
                headers: {"X-CSRFToken": '{{ csrf_token }}'},
                success: function (response, textStatus, xhr) {
                    if (xhr.status === 200) {
                        toastr.success(response.message, '¡Guía Registrada Correctamente!');
                        let guide_id = response.pk
                        window.location.href = "/comercial/guide/" + guide_id + "/";
                        if (response.contract) {
                            //console.log("contract")
                            setTimeout(() => {
                                window.open("/buys/contracts/", '_self');
                            }, 2000);
                        } else {
                            //console.log("Order")
                            setTimeout(() => {
                                location.reload();
                            }, 2000);
                        }
                    }
                },
                error: function (jqXhr, textStatus, xhr) {
                    toastr.error("ERROR. ", '¡INCONCEBIBLE!');
                }
            });
        }

        $(document).on('change', '.unit-product', async function (e) {
            let unit_id = $(this).val();
            if (unit_id !== null) {
                let product_id = $(this).parent('td').parent('tr').attr('product')
                let _quantity = Number($(this).parent('td').parent('tr').find('td.item-quantity input.quantity-product').val())
                let _tr = $(this).parent('td').parent('tr')
                let _select_quantity_unit = _tr.find('td.item-quantity-x-unit select.quantity-unit');
                if (unit_id !== '0') {
                    await getQuantityMinimumByProduct(product_id, unit_id, _tr, _quantity)
                    if (unit_id === '1') { /*optimizar*/
                        _select_quantity_unit.val('1').change();
                    }
                } else {
                    toastr.warning('Seleccione una unidad valida', 'Error de llenado');
                    $(this).val(1).change();
                    return false;
                }
            }
            else {
                toastr.warning('SELECCIONE UN TIPO DE UNIDAD', 'Error de llenado');
            }

        });

        function sumWeight(){

            let sum_weight_total = 0

            $('tbody#guide-details tr').each(function () {

                let product_weight = $(this).attr('weight');

            });

        }

        function sumQuantities() {
            let _q_x_u = 0;
            let _q_x_u_decimal = 0;
            let _unit_name = '';
            let text = '';
            let full_weight = 0;
            $('tbody#guide-details tr').each(function () {
                _unit_name = $(this).find('td.unit select.unit-product option:selected').attr('unit');
                let _unit_id = $(this).find('td.unit select.unit-product option:selected').val()
                if (_unit_id !== '0' && _unit_id !== null) {
                    if (_unit_name !== 'KILOS') {
                        /*let validOption = $(this).find('td.unit select.unit-product option').filter(function () {
                            return $(this).attr('unit') !== 'UNIDAD(ES)';
                        }).last();*/
                        let validOption = $(this).find('td.unit select.unit-product option:selected');
                        let qmValue = validOption.attr('qm');
                        let qmUnit = validOption.attr('unit');
                        let _item_quantity = $(this).find('td.item-quantity input.quantity-product').val();
                        let product_weight = $(this).attr('weight');
                        _q_x_u = _item_quantity / qmValue
                        _q_x_u_decimal = _item_quantity % qmValue
                        full_weight = (_item_quantity * product_weight) / 1000
                        //console.log("full_weight", full_weight)

                        if (_q_x_u_decimal === 0) {
                            text = (parseInt(_q_x_u)).toString() + ' ' + qmUnit
                        } else {
                            text = (parseInt(_q_x_u)).toString() + ' ' + qmUnit + ' / ' + _q_x_u_decimal.toString() + ' UND'
                        }
                        /*let _quantity_x_u = $(this).find('td.quantity-minimum input.quantity-minimum-val').val();
                        _unit_name = $(this).find('td.unit select.unit-product option:selected').attr('unit');
                        let _qm = $(this).find('td.unit select.unit-product option:selected').attr('qm');
                        n_package += parseInt(_quantity_x_u);
                        item_quantity_sum += parseFloat(_item_quantity)
                        _qm_total = parseFloat(_qm)
                        let _q_x_u = item_quantity_sum / _qm_total
                        let _q_x_u_decimal = item_quantity_sum % _qm_total
                        _text = 'SON ' + (parseInt(_q_x_u)).toString() + ' ' + _unit_name + ' Y ' + _q_x_u_decimal.toString() + ' UND'*/
                    }
                } else {
                    toastr.warning('SELECCIONE LOS TIPOS DE UNIDAD DE TODOS LOS PRODUCTOS', 'Error de llenado');
                }
            });
            //console.log("_q_x_u", _q_x_u)
            //console.log("text", text)
            $('#id-package').val(parseInt(_q_x_u));
            $('#id_observation').val(text);
            $('#weight').val(full_weight);
        }

        async function getQuantityMinimumByProduct(product_id, _unit, _tr, _quantity) {
            let _input_quantity_minimum = _tr.find('td.quantity-minimum input.quantity-minimum-val');
            let _price_unit_product = _tr.find('td.item-price input.price-unit-product');
            _input_quantity_minimum.val('')
            if (product_id !== '0') {
                $.ajax({
                    url: '/buys/get_quantity_minimum/',
                    async: true,
                    dataType: 'json',
                    type: 'GET',
                    data: {
                        'product_id': product_id,
                        'unit_id': _unit
                    },
                    success: function (response) {
                        let _quantity_minimum = Number(response.quantity_minimum).toFixed(2)
                        if (_quantity_minimum && _quantity) {
                            let _q_x_u = _quantity / _quantity_minimum
                            //let _q_x_u_decimal = _quantity % 48
                            _input_quantity_minimum.val(parseInt(_q_x_u).toString())
                            sumQuantities()
                        }
                        _price_unit_product.val(response.price_purchase);
                        $('.price-unit-product').trigger('keyup');
                    },
                });
            }
        }

        $(document).on('click', '.btn-batch', function (e) {

            let store_id = document.getElementById('store_id').value;
            let productID = this.closest('tr').getAttribute('product');

            if (store_id === '0') {
                toastr.warning('¡SELECCIONE EL ALMACEN!', 'Mensaje');
                return false;
            }

            $.ajax({
                url: '/comercial/modal_batch_guide/',
                dataType: 'json',
                type: 'GET',
                data: {'store_id': store_id, 'productID': productID},
                success: function (response, textStatus, xhr) {
                    if (response.success) {
                        $('#modal-batch').html(response.form);
                        $('#modal-batch').modal('show');

                    } else {
                        toastr.error(response.message, 'Error');
                    }
                },
                fail: function (response) {
                    toastr.error('Ocurrio un problema al mostrar el formulario', '¡Mensaje!');
                }
            });
        });


    </script>
{% endblock extrajs %}
