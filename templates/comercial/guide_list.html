{% extends 'home.html' %}

{% block title %}
    Listado de Guias
{% endblock title %}

{% block body %}

    <div class="container-fluid">
        <div class="card p-2 bg-light">
            <div class="row">
                <div class="col-lg-2 pt-3 ml-3">
                </div>
                <div class="col-lg-8 text-center pt-2">
                    <h2 class="font-weight-bold roboto-condensed-regular"> LISTADO DE GUIAS DE REMISIÓN</h2>
                </div>
            </div>

            <div class="card-body p-2 roboto-condensed-regular">
                <ul class="nav nav-tabs" id="multi-tab" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active" id="purchase-list-tab" data-toggle="pill"
                           href="#purchase-without-bill" role="tab" aria-controls="purchase-without-bill"
                           aria-selected="true">SIN ASIGNAR</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" id="picking-tab" data-toggle="pill"
                           href="#picking-with-guide" role="tab" aria-controls="picking-with-guide"
                           aria-selected="false">ASIGNADAS</a>
                    </li>
                </ul>
            </div>

            <div class="tab-content" id="multi-tabContent">
                <div class="tab-pane active" id="purchase-without-bill" role="tabpanel"
                     aria-labelledby="purchase-list-tab">
                    <div class="card-body pt-2 pb-0">
                        <div class="row p-2">
                            <div class="col-sm-2">
                                <button type="button"
                                        class="btn font-weight-light text-white font-italic generate-picking"
                                        style="background-color: #3e6787">
                                    Generar Picking
                                </button>
                            </div>
                            <div class="col-sm-2 text-right">
                                <label class="font-weight-bold text-center mb-0 mt-1"
                                       for="weight_total">PESO ACUMULADO:</label>
                            </div>
                            <div class="col-sm-1 text-center">
                                <h4 class="roboto-condensed-regular font-weight-bold" id="weight_total">0</h4>
                            </div>
                            <div class="col-sm-1 text-left">
                                <h4 class="roboto-condensed-regular font-weight-bold">KG</h4>
                            </div>
                        </div>
                    </div>
                    <div id="file-list-grid">
                        <div id="client-grid-list ">{% include "comercial/unassigned_guides_list.html" %}</div>
                    </div>
                </div>

                <div class="tab-pane fade" id="picking-with-guide" role="tabpanel"
                     aria-labelledby="picking-tab">
                    <div class="card-body p-2">
                        <div class="container">
                            <div class="text-center">
                                <h4 class="font-weight-bold roboto-condensed-light">PICKING DE TRANSPORTE</h4>
                            </div>
                        </div>
                        <div class="row mb-1 mt-0">
                            <div class="col-lg-12">
                                <div class="loader-container col-auto" id="loader-bill"
                                     style="display: none;
                                             opacity: 1.5;
                                             width: 100%;
                                             padding-top: 3em;">
                                    <div class="loader"></div>
                                </div>
                                <div id="picking-guides-grid"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>



    <div class="modal fade" id="modal-picking-create" tabindex="-1" role="dialog"
         data-backdrop="static" data-keyboard="false" aria-labelledby="ModalHelpTitle"
         aria-hidden="true"></div>

    <style>

        .loader {
            width: 100px;
            height: 70px;
            margin: 40px auto;
        }

        .input-icon {
            position: relative;
        }

        .input-icon > i {
        {#content: "$";#} position: absolute;
            display: block;
            transform: translate(0, -50%);
            top: 50%;
            pointer-events: none;
            width: 25px;
            text-align: center;
            font-style: normal;
        }

        .input-icon > input {
            padding-left: 25px;
            padding-right: 8px;
        }

        .input-icon-right > i {
            right: 0;
        }

        .input-icon-right > input {
            padding-left: 0;
            padding-right: 25px;
            text-align: right;
        }

    </style>

{% endblock body %}


{% block extrajs %}

    <script type="text/javascript">

        loader = '<div class="container">' +
            '<div class="row">' +
            '<div class="col-md-12">' +
            '<div class="loader">' +
            '<p><strong>Cargando..</strong></p>' +
            '<div class="loader-inner"></div>' +
            '<div class="loader-inner"></div>' +
            '<div class="loader-inner"></div>' +
            '</div>' +
            '</div>' +
            '</div>' +
            '</div>';

        $(document).on('click', '#picking-tab', function () {

            $('#purchase-list-with-bill').empty();
            $('#loader-bill').html(loader).show()
            $.ajax({
                url: '/comercial/get_picking_with_guide/',
                dataType: 'json',
                type: 'GET',
                data: {},
                success: function (response) {
                    if (response) {
                        $('#picking-guides-grid').html(response['grid']);
                    } else {
                        toastr.error('No se encontraron compras registradas.', '¡Mensaje!');
                    }
                    $('#loader-bill').hide();
                },
                fail: function (response) {
                    toastr.error('Error en la peticion, Contactar con Sistemas', '¡Mensaje!');
                    $('#loader-bill').hide();
                }
            });
        });

        $(document).on('click', '.generate-picking', function () {
            const tbody = $('#body-finances');
            const guidesID = [];
            const firstValues = {
                vehicle: null,
                modality: null,
                carrier: null,
                driver: null
            };
            let error = false;

            const rows = tbody.find('tr td.item-check input.check-guide:checked');

            rows.each(function () {
                const _tr = $(this).closest('tr');
                const guideID = parseInt(_tr.attr('pk'));
                const values = {
                    vehicle: _tr.attr('vehicle'),
                    modality: _tr.attr('modality'),
                    carrier: _tr.attr('carrier'),
                    driver: _tr.attr('driver'),
                    store: _tr.attr('store')
                };

                if (firstValues.vehicle === null) {
                    Object.assign(firstValues, values);
                } else {
                    for (let key in values) {
                        if (values[key] !== firstValues[key]) {
                            error = true;
                            break;
                        }
                    }
                }

                if (error) return false;
                guidesID.push(guideID);
            });

            if (error) {
                toastr.warning('Las guías seleccionadas deben tener el mismo vehículo, modalidad, transportista y conductor.', 'Mensaje');
                return;
            }

            if (guidesID.length > 0) {
                $.ajax({
                    url: '/comercial/modal_picking_create/',
                    dataType: 'json',
                    type: 'GET',
                    data: {
                        vehicleID: firstValues.vehicle,
                        modality: firstValues.modality,
                        carrierID: firstValues.carrier,
                        driverID: firstValues.driver,
                        storeID: firstValues.store,
                        guides: JSON.stringify(guidesID)
                    },
                    success: function (response) {
                        $('#modal-picking-create').html(response.form);
                        $('#modal-picking-create').modal('show');
                    },
                    fail: function () {
                        toastr.error('Error en la petición', '¡Mensaje!');
                    }
                });
            }
        });

        $(document).on('change', 'input.check-guide', function () {
            updateWeightTotal();
        });

        function updateWeightTotal() {
            let totalWeight = 0;

            $('#body-finances').find('tr td.item-check input.check-guide:checked').each(function () {
                let _tr = $(this).closest('tr');
                let productWeight = parseFloat(_tr.find('td.item-weight').attr('weight')) || 0;
                totalWeight += productWeight;
            });

            $('#weight_total').text(totalWeight.toFixed(2));
        }


        $(document).on('click', '.btn-show-guides', function (e) {
            let _picking_id = $(this).attr("pk");
            let _table = $(this).closest('tbody').find('tr[pk="' + _picking_id + '"].show-detail').find('td.table-details-guide');
            let _icon = $(this).find('i.see-icon')

            if (_icon.hasClass("fas fa-sort-down fa-xs")) {
                _icon.removeClass('fas fa-sort-down fa-xs');
                _icon.addClass('fas fa-sort-up fa-xs')

                openDetail(_picking_id, _table)
            } else {
                _icon.removeClass('fas fa-sort-up fa-xs');
                _icon.addClass('fas fa-sort-down fa-xs');

                closeDetail(_table)
            }
        });

        function openDetail(_picking_id, _table) {
            $.ajax({
                url: '/comercial/get_guide/',
                async: true,
                dataType: 'json',
                type: 'GET',
                cache: false,
                data: {'picking': _picking_id},
                contentType: 'application/json;charset=UTF-8',
                headers: {"X-CSRFToken": ' {{ csrf_token }}'},
                success: function (response, textStatus, xhr) {
                    if (response.success) {
                        _table.html(response.grid);
                        _table.parent('tr').slideDown("fast");
                    } else {
                        toastr.error(response.message, 'ERROR');
                    }
                }
            });
        }

        function closeDetail($td) {
            $td.parent('tr').slideUp("fast");
        }

        // Manejar el botón de destino de mercadería de reserva
        $(document).on('click', '.btn-reserve-destination', function() {
            const button = $(this);
            const product = button.data('product');
            const batch = button.data('batch');
            const quantity = button.data('quantity');
            const weight = button.data('weight');
            const unit = button.data('unit');
            
            // Mostrar información del producto en el modal
            $('#product-info').html(`
                <div class="row">
                    <div class="col-md-6">
                        <strong>Producto:</strong> ${product}<br>
                        <strong>Lote:</strong> ${batch}
                    </div>
                    <div class="col-md-6">
                        <strong>Cantidad:</strong> ${quantity} ${unit}<br>
                        <strong>Peso:</strong> ${weight} Kg
                    </div>
                </div>
            `);
            
            // Establecer fecha actual por defecto
            const today = new Date().toISOString().split('T')[0];
            $('#destination-date').val(today);
            
            // Mostrar el modal
            $('#modal-reserve-destination').modal('show');
        });

        // Guardar destino de mercadería
        $('#btn-save-destination').click(function() {
            const form = $('#reserve-destination-form');
            const formData = new FormData(form[0]);
            
            // Validar campos requeridos
            if (!formData.get('destination_type') || !formData.get('destination_date')) {
                toastr.error('Debe completar todos los campos requeridos', 'Error');
                return;
            }
            
            // Aquí puedes agregar la lógica para guardar el destino
            // Por ahora solo mostramos un mensaje de éxito
            toastr.success('Destino de la mercadería registrado correctamente', 'Éxito');
            
            // Cerrar el modal
            $('#modal-reserve-destination').modal('hide');
            
            // Limpiar el formulario
            form[0].reset();
        });

        // Limpiar formulario cuando se cierre el modal
        $('#modal-reserve-destination').on('hidden.bs.modal', function() {
            $('#reserve-destination-form')[0].reset();
        });

    </script>

{% endblock extrajs %}