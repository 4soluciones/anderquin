<div class="modal-dialog modal-xl" role="document">
    <div class="modal-content border-0 shadow-lg roboto-condensed-regular">
        <div class="modal-header" style="background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%); border-bottom: none;">
            <h4 class="modal-title text-white font-weight-bold">
                <i class="fas fa-file-invoice mr-2"></i> REGISTRAR NOTA DE CRÉDITO DE COMPRA
            </h4>
            <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close" style="opacity: 0.9;">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
        <div class="modal-body bg-light">
            <form id="form-credit-note-modal">
                <div class="row">
                    <!-- Left Column: Header Info -->
                    <div class="col-md-4">
                        <div class="card border-0 shadow-sm mb-3">
                            <div class="card-body">
                                <h6 class="text-success font-weight-bold mb-3 roboto-condensed-regular"><i class="fas fa-search mr-2"></i> Buscar Factura</h6>
                                <div class="form-group">
                                    <label class="small font-weight-bold">Factura de Compra:</label>
                                    <select class="form-control select2-modal" id="bill-search-modal" name="bill_id" required style="width: 100%;">
                                        <option value="">Buscar por serie-correlativo...</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="small font-weight-bold">Proveedor:</label>
                                    <input type="text" class="form-control form-control-sm" id="supplier-name-modal" readonly placeholder="Se cargará al elegir factura">
                                </div>
                            </div>
                        </div>

                        <div class="card border-0 shadow-sm">
                            <div class="card-body">
                                <h6 class="text-success font-weight-bold mb-3 roboto-condensed-regular"><i class="fas fa-info-circle mr-2"></i> Datos de la Nota</h6>
                                <div class="form-group">
                                    <label class="small font-weight-bold">Doc. Nota de Crédito (Serie y Número):</label>
                                    <div class="input-group input-group-sm">
                                        <input type="text" class="form-control" id="serial-modal" name="credit_note_serial" placeholder="F001" required style="max-width: 80px;">
                                        <div class="input-group-append">
                                            <span class="input-group-text">-</span>
                                        </div>
                                        <input type="text" class="form-control" id="number-modal" name="credit_note_number" placeholder="00000001" required>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label class="small font-weight-bold">Fecha de Emisión:</label>
                                    <input type="date" class="form-control form-control-sm" id="issue-date-modal" name="issue_date" value="{{ date }}" required>
                                </div>
                                <div class="form-group">
                                    <label class="small font-weight-bold">Motivo:</label>
                                    <textarea class="form-control form-control-sm" id="motive-modal" name="motive" rows="3" placeholder="Ej. Devolución de mercadería por falla..."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right Column: Details Table -->
                    <div class="col-md-8">
                        <div class="card border-0 shadow-sm h-100">
                            <div class="card-header bg-white py-3">
                                <h6 class="m-0 text-success font-weight-bold roboto-condensed-regular"><i class="fas fa-list mr-2"></i> Detalles de la Nota</h6>
                            </div>
                            <div class="card-body p-0" style="max-height: 400px; overflow-y: auto;">
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0 table-bordered" id="table-details-modal">
                                        <thead class="bg-light text-primary">
                                            <tr>
                                                <th class="small font-weight-bold" style="width: 30%">Producto / Almacén</th>
                                                <th class="small font-weight-bold" style="width: 15%">Und.</th>
                                                <th class="small font-weight-bold" style="width: 15%">Cantidad</th>
                                                <th class="small font-weight-bold" style="width: 15%">Precio Unit.</th>
                                                <th class="small font-weight-bold" style="width: 15%">Total</th>
                                                <th class="small font-weight-bold text-center" style="width: 10%">Acción</th>
                                            </tr>
                                        </thead>
                                        <tbody id="details-tbody-modal">
                                            <tr>
                                                <td colspan="6" class="text-center text-muted py-5">
                                                    <i class="fas fa-info-circle mr-2"></i> Seleccione una factura
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                            <div class="card-footer bg-white py-3">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h5 class="m-0 font-weight-bold text-dark roboto-condensed-regular">TOTAL NC:</h5>
                                    <h5 class="m-0 font-weight-bold text-success roboto-condensed-regular" id="grand-total-modal">0.00</h5>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer bg-white border-top">
            <button type="button" class="btn btn-secondary px-4" data-dismiss="modal">
                <i class="fas fa-times mr-2"></i> Cerrar
            </button>
            <button type="button" class="btn btn-success px-4 font-weight-bold" id="btn-save-credit-note-modal">
                <i class="fas fa-save mr-1"></i> Guardar Nota de Crédito
            </button>
        </div>
    </div>
</div>

<script>
    (function() {
        // Variables globales para el modal
        let modalInitialized = false;

        // Inicialización cuando se abre el modal
        $('#modal-register-credit-note').on('shown.bs.modal', function () {
            if (!modalInitialized) {
                initializeModal();
                modalInitialized = true;
            }
        });

        // Limpiar cuando se cierra el modal
        $('#modal-register-credit-note').on('hidden.bs.modal', function () {
            resetModal();
        });

        function initializeModal() {
            // Initialize Select2
            $('#bill-search-modal').select2({
                theme: 'bootstrap4',
                dropdownParent: $('#modal-register-credit-note'),
                ajax: {
                    url: '{% url "accounting:search_bill_ajax" %}',
                    dataType: 'json',
                    delay: 250,
                    data: function (params) {
                        return { term: params.term };
                    },
                    processResults: function (data) {
                        return { results: data.results };
                    },
                    cache: true
                },
                minimumInputLength: 2,
                placeholder: 'Buscar por serie-correlativo...',
                allowClear: true
            });

            // Event: Cuando se selecciona una factura
            $('#bill-search-modal').on('select2:select', function (e) {
                let billId = e.params.data.id;
                loadBillDetails(billId);
            });

            // Event: Guardar nota de crédito
            $('#btn-save-credit-note-modal').on('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                submitCreditNoteData();
            });

            // Event: Calcular totales al cambiar cantidad o precio
            $(document).on('input', '.row-quantity-modal, .row-price-modal', function() {
                let row = $(this).closest('tr');
                updateRowTotal(row);
            });

            // Event: Cambiar Unidad y aplicar equivalencias
            $(document).on('change', '.row-unit-modal', function() {
                let row = $(this).closest('tr');
                let selectedOption = $(this).find('option:selected');
                
                let oldFactor = parseFloat(row.attr('data-current-factor')) || 1;
                let newFactor = parseFloat(selectedOption.attr('data-factor')) || 1;
                
                let oldQuantity = parseFloat(row.find('.row-quantity-modal').val()) || 0;
                let oldPrice = parseFloat(row.find('.row-price-modal').val()) || 0;

                // Conversión: Cantidad Nueva = Cantidad Antigua * (Factor Antiguo / Factor Nuevo)
                let newQuantity = oldQuantity * (oldFactor / newFactor);
                // Conversión: Precio Nuevo = Precio Antiguo * (Factor Nuevo / Factor Antiguo)
                let newPrice = oldPrice * (newFactor / oldFactor);

                row.find('.row-quantity-modal').val(newQuantity.toFixed(2));
                row.find('.row-price-modal').val(newPrice.toFixed(4));
                
                // Actualizar factor actual y unit_id en la fila
                row.attr('data-current-factor', newFactor);
                row.attr('data-unit-id', $(this).val());

                updateRowTotal(row);
            });

            // Event: Remover fila
            $(document).on('click', '.remove-row-modal', function() {
                $(this).closest('tr').remove();
                if ($('#details-tbody-modal tr').length === 0) {
                    $('#details-tbody-modal').html('<tr><td colspan="6" class="text-center text-muted py-5"><i class="fas fa-info-circle mr-2"></i> No hay items</td></tr>');
                }
                calculateGrandTotal();
            });
        }

        function updateRowTotal(row) {
            let quantity = parseFloat(row.find('.row-quantity-modal').val()) || 0;
            let price = parseFloat(row.find('.row-price-modal').val()) || 0;
            let total = quantity * price;
            row.find('.row-total-modal').text(total.toFixed(2));
            calculateGrandTotal();
        }

        function loadBillDetails(billId) {
            // Mostrar loading
            $('#details-tbody-modal').html('<tr><td colspan="6" class="text-center py-4"><i class="fas fa-spinner fa-spin mr-2"></i> Cargando detalles...</td></tr>');

            $.ajax({
                url: '{% url "accounting:get_bill_details_ajax" %}',
                method: 'GET',
                data: { bill_id: billId },
                dataType: 'json',
                success: function(response) {
                    if (response.success) {
                        $('#supplier-name-modal').val(response.supplier_name);
                        renderTableRows(response.details);
                    } else {
                        toastr.error(response.message || 'Error al cargar detalles');
                        $('#details-tbody-modal').html('<tr><td colspan="6" class="text-center text-danger py-4"><i class="fas fa-exclamation-triangle mr-2"></i> Error al cargar detalles</td></tr>');
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error al cargar detalles:', error);
                    toastr.error('Error de red al cargar detalles de la factura');
                    $('#details-tbody-modal').html('<tr><td colspan="6" class="text-center text-danger py-4"><i class="fas fa-exclamation-triangle mr-2"></i> Error de conexión</td></tr>');
                }
            });
        }

        function renderTableRows(details) {
            let tbody = $('#details-tbody-modal');
            tbody.empty();

            if (!details || details.length === 0) {
                tbody.html('<tr><td colspan="6" class="text-center text-muted py-5">No hay detalles "Ingresados" en esta factura</td></tr>');
                $('#grand-total-modal').text('0.00');
                return;
            }

            details.forEach(item => {
                let unitOptions = '';
                item.units.forEach(u => {
                    unitOptions += `<option value="${u.id}" data-factor="${u.factor}" ${u.id == item.unit_id ? 'selected' : ''}>${u.name}</option>`;
                });

                let row = `
                    <tr data-bill-detail-id="${item.bill_detail_id}"
                        data-product-id="${item.product_id}"
                        data-unit-id="${item.unit_id}"
                        data-current-factor="${item.current_factor}"
                        data-warehouse-id="${item.warehouse_id || ''}"
                        data-warehouse-name="${item.warehouse_name || ''}">
                        <td class="small">
                            <strong>${item.product_name}</strong><br>
                            <span class="badge badge-info"><i class="fas fa-warehouse mr-1"></i> ${item.warehouse_name}</span>
                        </td>
                        <td>
                            <select class="form-control form-control-sm row-unit-modal">
                                ${unitOptions}
                            </select>
                        </td>
                        <td>
                            <input type="number" step="0.01" class="form-control form-control-sm row-quantity-modal"
                                value="${parseFloat(item.quantity).toFixed(2)}"
                                min="0" required>
                        </td>
                        <td>
                            <input type="number" step="0.0001" class="form-control form-control-sm row-price-modal"
                                value="${parseFloat(item.price_unit).toFixed(4)}" min="0" required>
                        </td>
                        <td class="row-total-modal font-weight-bold small">${parseFloat(item.total).toFixed(2)}</td>
                        <td class="text-center">
                            <button type="button" class="btn btn-sm btn-outline-danger remove-row-modal" title="Eliminar item">
                                <i class="fas fa-times"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });
            calculateGrandTotal();
        }

        function calculateGrandTotal() {
            let sum = 0;
            $('#details-tbody-modal .row-total-modal').each(function() {
                let value = parseFloat($(this).text()) || 0;
                sum += value;
            });
            $('#grand-total-modal').text(sum.toFixed(2));
        }

        function submitCreditNoteData() {
            // Validar factura seleccionada
            let billId = $('#bill-search-modal').val();
            if (!billId) {
                toastr.warning('Debe seleccionar una factura');
                $('#bill-search-modal').focus();
                return;
            }

            // Validar serie y número
            let serial = $('#serial-modal').val().trim();
            let number = $('#number-modal').val().trim();
            if (!serial || !number) {
                toastr.warning('Debe ingresar la serie y el número de la NC');
                if (!serial) $('#serial-modal').focus();
                else $('#number-modal').focus();
                return;
            }

            // Validar fecha
            let issueDate = $('#issue-date-modal').val();
            if (!issueDate) {
                toastr.warning('Debe ingresar la fecha de emisión');
                $('#issue-date-modal').focus();
                return;
            }

            // Recopilar detalles
            let details = [];
            let hasErrors = false;

            $('#details-tbody-modal tr').each(function() {
                let row = $(this);
                let productId = row.attr('data-product-id');

                if (productId) {
                    let quantity = parseFloat(row.find('.row-quantity-modal').val()) || 0;
                    let price = parseFloat(row.find('.row-price-modal').val()) || 0;
                    let total = parseFloat(row.find('.row-total-modal').text()) || 0;

                    if (quantity <= 0) {
                        toastr.error('Las cantidades deben ser mayores a 0');
                        hasErrors = true;
                        return false; // break
                    }

                    if (price < 0) {
                        toastr.error('Los precios no pueden ser negativos');
                        hasErrors = true;
                        return false; // break
                    }

                    details.push({
                        bill_detail_id: row.attr('data-bill-detail-id'),
                        product_id: productId,
                        unit_id: row.attr('data-unit-id'),
                        warehouse_id: row.attr('data-warehouse-id') || null,
                        quantity: quantity,
                        price_unit: price,
                        total: total
                    });
                }
            });

            if (hasErrors) return;

            if (details.length === 0) {
                toastr.warning('Debe tener al menos un item en la nota de crédito');
                return;
            }

            // Preparar datos
            let formData = {
                bill_id: billId,
                credit_note_serial: serial,
                credit_note_number: number,
                issue_date: issueDate,
                motive: $('#motive-modal').val().trim(),
                details: details
            };

            // Deshabilitar botón para evitar doble envío
            $('#btn-save-credit-note-modal').prop('disabled', true).html('<i class="fas fa-spinner fa-spin mr-1"></i> Guardando...');

            $.ajax({
                url: '{% url "accounting:create_credit_note_ajax" %}',
                type: 'POST',
                contentType: 'application/x-www-form-urlencoded; charset=UTF-8',
                data: {
                    credit_note: JSON.stringify(formData),
                    csrfmiddlewaretoken: $('input[name="csrfmiddlewaretoken"]').val() || '{{ csrf_token }}'
                },
                dataType: 'json',
                success: function(response) {
                    if (response.success) {
                        $('#modal-register-credit-note').modal('hide');
                        toastr.success(response.message || 'Nota de crédito registrada exitosamente');
                        setTimeout(function() {
                            location.reload();
                        }, 1000);
                    } else {
                        toastr.error(response.message || 'Error al registrar la nota de crédito');
                        $('#btn-save-credit-note-modal').prop('disabled', false).html('<i class="fas fa-save mr-1"></i> Guardar Nota de Crédito');
                    }
                },
                error: function(xhr, status, error) {
                    let errorMsg = 'Error al procesar la solicitud';
                    if (xhr.responseJSON && xhr.responseJSON.message) {
                        errorMsg = xhr.responseJSON.message;
                    } else if (xhr.responseText) {
                        try {
                            let response = JSON.parse(xhr.responseText);
                            errorMsg = response.message || errorMsg;
                        } catch (e) {
                            errorMsg = 'Error del servidor: ' + xhr.status;
                        }
                    }
                    toastr.error(errorMsg);
                    $('#btn-save-credit-note-modal').prop('disabled', false).html('<i class="fas fa-save mr-1"></i> Guardar Nota de Crédito');
                }
            });
        }

        function resetModal() {
            // Limpiar select2
            $('#bill-search-modal').val(null).trigger('change');

            // Limpiar campos
            $('#supplier-name-modal').val('');
            $('#serial-modal').val('');
            $('#number-modal').val('');
            $('#issue-date-modal').val('{{ date }}');
            $('#motive-modal').val('');

            // Limpiar tabla
            $('#details-tbody-modal').html('<tr><td colspan="5" class="text-center text-muted py-5"><i class="fas fa-info-circle mr-2"></i> Seleccione una factura</td></tr>');
            $('#grand-total-modal').text('0.00');

            // Rehabilitar botón
            $('#btn-save-credit-note-modal').prop('disabled', false).html('<i class="fas fa-save mr-1"></i> Guardar Nota de Crédito');
        }
    })();
</script>