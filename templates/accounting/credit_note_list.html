{% extends 'home.html' %}

{% block title %}
    Notas de Crédito de Compra
{% endblock title %}

{% block body %}
<div class="container-fluid py-4 roboto-condensed-regular" style="background-color: #f4f7f6; min-height: 100vh;">
    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-0 shadow-sm h-100 hover-lift">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">Total NC</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ stats.total_count }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-file-invoice-dollar fa-2x text-primary opacity-25"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-0 shadow-sm h-100 hover-lift">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-success text-uppercase mb-1">Monto Total</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800 roboto-condensed-regular">S/ {{ stats.total_amount|floatformat:2 }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-money-bill-wave fa-2x text-success opacity-25"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-0 shadow-sm h-100 hover-lift">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-info text-uppercase mb-1">Emitidas</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ stats.emitted_count }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-check-circle fa-2x text-info opacity-25"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-4">
            <div class="card border-0 shadow-sm h-100 hover-lift">
                <div class="card-body">
                    <div class="row no-gutters align-items-center">
                        <div class="col mr-2">
                            <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">Pendientes</div>
                            <div class="h5 mb-0 font-weight-bold text-gray-800">{{ stats.pending_count }}</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-clock fa-2x text-warning opacity-25"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Card -->
    <div class="card border-0 shadow-lg mb-4 overflow-hidden" style="border-radius: 15px;">
        <div class="card-header bg-gradient-success py-3 position-relative" style="background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h4 class="text-white mb-0 font-weight-bold roboto-condensed-regular">
                        <i class="fas fa-file-invoice-dollar mr-2"></i> NOTAS DE CRÉDITO DE COMPRA
                    </h4>
                </div>
                <div class="col-md-6 text-md-right mt-3 mt-md-0">
                    <button class="btn btn-light shadow-sm font-weight-bold" id="btn-open-credit-note-modal">
                        <i class="fas fa-plus-circle text-success mr-1"></i> NUEVA NOTA DE CRÉDITO
                    </button>
                </div>
            </div>
        </div>
        
        <div class="card-body bg-white border-bottom">
            <form id="filter-form" class="row align-items-end" method="GET">
                <div class="col-md-3">
                    <label class="small font-weight-bold text-uppercase text-muted mb-1">Fecha Inicio</label>
                    <div class="input-group shadow-sm border-0">
                        <div class="input-group-prepend">
                            <span class="input-group-text bg-white border-right-0"><i class="far fa-calendar-alt text-success"></i></span>
                        </div>
                        <input type="date" name="start_date" class="form-control border-left-0" style="border-radius: 0 5px 5px 0;" value="{{ start_date }}">
                    </div>
                </div>
                <div class="col-md-3">
                    <label class="small font-weight-bold text-uppercase text-muted mb-1">Fecha Fin</label>
                    <div class="input-group shadow-sm border-0">
                        <div class="input-group-prepend">
                            <span class="input-group-text bg-white border-right-0"><i class="far fa-calendar-alt text-success"></i></span>
                        </div>
                        <input type="date" name="end_date" class="form-control border-left-0" style="border-radius: 0 5px 5px 0;" value="{{ end_date }}">
                    </div>
                </div>
                <div class="col-md-4">
                    <button type="submit" class="btn btn-success px-4 font-weight-bold shadow-sm">
                        <i class="fas fa-filter mr-1"></i> FILTRAR
                    </button>
                    <a href="{% url 'accounting:credit_note_list' %}" class="btn btn-outline-secondary px-3 shadow-sm ml-1">
                        <i class="fas fa-sync-alt"></i>
                    </a>
                </div>
            </form>
        </div>

        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="bg-light text-muted uppercase small font-weight-bold">
                        <tr>
                            <th class="px-4 py-3">Serie-Número</th>
                            <th class="py-3">Fecha Emisión</th>
                            <th class="py-3">Factura Relacionada</th>
                            <th class="py-3">Proveedor</th>
                            <th class="py-3">Motivo</th>
                            <th class="py-3 text-right">Total</th>
                            <th class="py-3 text-center px-4">Estado</th>
                            <th class="py-3 text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for cn in credit_notes %}
                        <tr>
                            <td class="px-4 align-middle">
                                <span class="badge badge-soft-success p-2 text-dark font-weight-bold" style="background-color: #d4edda; color: #155724;">
                                    {{ cn.credit_note_serial }}-{{ cn.credit_note_number }}
                                </span>
                            </td>
                            <td class="align-middle">
                                {{ cn.issue_date|date:"d/m/Y" }}
                            </td>
                            <td class="align-middle">
                                <span class="badge badge-light border">{{ cn.bill.serial }}-{{ cn.bill.correlative }}</span>
                            </td>
                            <td class="align-middle">
                                <span class="font-weight-bold">{{ cn.bill.supplier.name|truncatechars:30 }}</span>
                            </td>
                            <td class="align-middle">
                                <small class="text-truncate d-inline-block text-muted" style="max-width: 200px;">{{ cn.motive|default:"-" }}</small>
                            </td>
                            <td class="align-middle text-right font-weight-bold text-success">
                                S/ {{ cn.get_total|floatformat:2 }}
                            </td>
                            <td class="align-middle text-center px-4">
                                {% if cn.status == 'E' %}
                                    <span class="badge badge-pill badge-success px-3">EMITIDA</span>
                                {% elif cn.status == 'P' %}
                                    <span class="badge badge-pill badge-warning px-3">PENDIENTE</span>
                                {% else %}
                                    <span class="badge badge-pill badge-danger px-3">ANULADA</span>
                                {% endif %}
                            </td>
                            <td class="align-middle text-center">
                                <button class="btn btn-sm btn-outline-success shadow-sm rounded-pill px-3 view-details" 
                                        pk="{{ cn.id }}" 
                                        title="Ver Detalle">
                                    <i class="fas fa-eye mr-1"></i> Ver
                                </button>
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="8" class="text-center py-5 text-muted">
                                <i class="fas fa-folder-open fa-3x mb-3 d-block opacity-25"></i>
                                No se encontraron notas de crédito registradas.
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- Modal Container for Register -->
<div class="modal fade" id="modal-register-credit-note" tabindex="-1" role="dialog" 
     data-backdrop="static" data-keyboard="false" aria-hidden="true">
    <div id="modal-content-container"></div>
</div>

<!-- Modal Container for Details -->
<div class="modal fade" id="modal-view-details" tabindex="-1" role="dialog" aria-hidden="true">
    <div id="modal-details-content"></div>
</div>

<style>
    .bg-gradient-success {
        background: linear-gradient(135deg, #28a745 0%, #1e7e34 100%);
    }
    .badge-soft-success {
        border-radius: 6px;
    }
    .table thead th {
        border-top: none;
        border-bottom: 2px solid #f8f9fa;
        letter-spacing: 0.5px;
    }
    .form-control:focus {
        box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
        border-color: #28a745;
    }
    .btn-outline-success:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
        transition: all 0.2s ease;
    }
    .hover-lift {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .hover-lift:hover {
        transform: translateY(-5px);
        box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    }
</style>
{% endblock body %}

{% block extrajs %}
    <script>
        $(document).ready(function() {
            // Open Register Modal
            $('#btn-open-credit-note-modal').click(function() {
                openRegisterCreditNoteModal();
            });

            // Open Details Modal
            $(document).on('click', '.view-details', function() {
                let pk = $(this).attr('pk');
                openViewDetailsModal(pk);
            });
        });

        function openRegisterCreditNoteModal() {
            $.ajax({
                url: '{% url "accounting:modal_register_credit_note" %}',
                type: 'GET',
                success: function(response) {
                    $('#modal-content-container').html(response);
                    $('#modal-register-credit-note').modal('show');
                },
                error: function() {
                    toastr.error('No se pudo cargar el formulario');
                }
            });
        }

        function openViewDetailsModal(pk) {
            $.ajax({
                url: '{% url "accounting:get_credit_note_details_ajax" %}',
                type: 'GET',
                data: { pk: pk },
                success: function(response) {
                    if (response.success) {
                        $('#modal-details-content').html(response.modal);
                        $('#modal-view-details').modal('show');
                    } else {
                        toastr.error(response.message || 'Error al cargar detalles');
                    }
                },
                error: function() {
                    toastr.error('Error de conexión al cargar detalles');
                }
            });
        }
    </script>
{% endblock extrajs %}
