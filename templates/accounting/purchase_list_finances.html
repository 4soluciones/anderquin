{% extends 'home.html' %}

{% block title %}
    Compras
{% endblock title %}

{% block body %}

    <div class="container-fluid py-4" style="background-color: #f4f7f6; min-height: 100vh;">
        <!-- Encabezado y Filtros -->
        <div class="card border-0 shadow-lg mb-4 overflow-hidden" style="border-radius: 15px;">
            <div class="card-header bg-gradient-info py-3 position-relative" style="background: linear-gradient(135deg, #17a2b8 0%, #117a8b 100%);">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h3 class="text-white mb-0 font-weight-bold">
                            <i class="fas fa-file-invoice-dollar mr-2"></i> GESTIÓN DE COMPRAS Y FACTURAS
                        </h3>
                    </div>
                    <div class="col-md-6 text-md-right mt-3 mt-md-0">
                        <div class="dropdown d-inline-block">
                            <button class="btn btn-light shadow-sm font-weight-bold dropdown-toggle" type="button" id="newPurchaseDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                <i class="fas fa-plus-circle text-success mr-1"></i> NUEVA COMPRA
                            </button>
                            <div class="dropdown-menu dropdown-menu-right shadow-lg border-0" aria-labelledby="newPurchaseDropdown" style="border-radius: 10px;">
                                <a class="dropdown-item py-2 generate-bill" href="javascript:void(0)">
                                    <i class="fas fa-tasks text-primary mr-2"></i> Factura con Orden de Compra
                                </a>
                                <div class="dropdown-divider"></div>
                                <a class="dropdown-item py-2 bill-manual-create" href="javascript:void(0)">
                                    <i class="fas fa-edit text-info mr-2"></i> Factura sin Orden de Compra
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="card-body bg-white border-bottom">
                <form id="filter-form" class="row align-items-end">
                    <div class="col-md-3">
                        <label class="small font-weight-bold text-uppercase text-muted mb-1">Fecha Inicio</label>
                        <div class="input-group shadow-sm border-0">
                            <div class="input-group-prepend">
                                <span class="input-group-text bg-white border-right-0"><i class="far fa-calendar-alt text-info"></i></span>
                            </div>
                            <input type="date" id="start_date" class="form-control border-left-0" style="border-radius: 0 5px 5px 0;" value="{{ start_date }}">
                        </div>
                    </div>
                    <div class="col-md-3">
                        <label class="small font-weight-bold text-uppercase text-muted mb-1">Fecha Fin</label>
                        <div class="input-group shadow-sm border-0">
                            <div class="input-group-prepend">
                                <span class="input-group-text bg-white border-right-0"><i class="far fa-calendar-alt text-info"></i></span>
                            </div>
                            <input type="date" id="end_date" class="form-control border-left-0" style="border-radius: 0 5px 5px 0;" value="{{ end_date }}">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <button type="button" id="btn-filter" class="btn btn-info px-4 font-weight-bold shadow-sm">
                            <i class="fas fa-filter mr-1"></i> FILTRAR
                        </button>
                        <button type="button" id="btn-reset" class="btn btn-outline-secondary px-3 shadow-sm ml-1">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </form>
            </div>

            <div class="card-body p-0">
                <ul class="nav nav-pills custom-pills bg-light p-2" id="multi-tab" role="tablist">
                    <li class="nav-item flex-fill text-center">
                        <a class="nav-link active font-weight-bold py-3" id="purchase-list-tab" data-toggle="pill"
                           href="#purchase-without-bill" role="tab" aria-controls="purchase-without-bill"
                           aria-selected="true">
                           <i class="fas fa-clock mr-2"></i> SIN FACTURAR (ORDENES DE COMPRA)
                        </a>
                    </li>
                    <li class="nav-item flex-fill text-center">
                        <a class="nav-link font-weight-bold py-3" id="bill-purchase-tab" data-toggle="pill"
                           href="#purchase-with-bill" role="tab" aria-controls="purchase-with-bill"
                           aria-selected="false">
                           <i class="fas fa-check-circle mr-2"></i> FACTURAS REGISTRADAS
                        </a>
                    </li>
                </ul>

                <div class="tab-content" id="multi-tabContent">
                    <div class="tab-pane fade show active" id="purchase-without-bill" role="tabpanel"
                         aria-labelledby="purchase-list-tab">
                        <div id="file-list-grid" class="p-3">
                            <div id="client-grid-list">{% include "accounting/purchase_grid_list_finances.html" %}</div>
                        </div>
                    </div>

                    <div class="tab-pane fade" id="purchase-with-bill" role="tabpanel"
                         aria-labelledby="bill-purchase-tab">
                        <div class="p-3">
                            <div class="loader-container" id="loader-bill" style="display: none; padding: 3rem 0;">
                                <div class="d-flex flex-column align-items-center">
                                    <div class="spinner-border text-info mb-3" role="status" style="width: 3rem; height: 3rem;"></div>
                                    <span class="text-muted font-weight-bold">Cargando facturas...</span>
                                </div>
                            </div>
                            <div id="purchases-with-bill-grid"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        .bg-gradient-info {
            background: linear-gradient(135deg, #17a2b8 0%, #0c6a7a 100%);
        }
        .custom-pills .nav-link {
            border-radius: 8px;
            color: #6c757d;
            transition: all 0.3s ease;
        }
        .custom-pills .nav-link.active {
            background-color: #fff !important;
            color: #17a2b8 !important;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        .dropdown-item:hover {
            background-color: #f8f9fa;
        }
        .dropdown-item i {
            width: 20px;
        }
        .form-control:focus {
            box-shadow: 0 0 0 0.2rem rgba(23, 162, 184, 0.25);
            border-color: #17a2b8;
        }
    </style>
    </div>



    <div class="modal fade" id="modal-bill-create" tabindex="-1" role="dialog"
         data-backdrop="static" data-keyboard="false" aria-labelledby="ModalHelpTitle"
         aria-hidden="true"></div>

    <style>

        .loader {
            width: 100px;
            height: 70px;
            margin: 40px auto;
        }

        .input-icon {
            position: relative;
        }

        .input-icon > i {
            /* content: "$"; */
            position: absolute;
            display: block;
            transform: translate(0, -50%);
            top: 50%;
            pointer-events: none;
            width: 25px;
            text-align: center;
            font-style: normal;
        }

        .input-icon > input {
            padding-left: 25px;
            padding-right: 8px;
        }

        .input-icon-right > i {
            right: 0;
        }

        .input-icon-right > input {
            padding-left: 0;
            padding-right: 25px;
            text-align: right;
        }

    </style>

{% endblock body %}

{% block extrajs %}

    <script type="text/javascript">

        loader = '<div class="container">' +
            '<div class="row">' +
            '<div class="col-md-12">' +
            '<div class="loader">' +
            '<p><strong>Cargando..</strong></p>' +
            '<div class="loader-inner"></div>' +
            '<div class="loader-inner"></div>' +
            '<div class="loader-inner"></div>' +
            '</div>' +
            '</div>' +
            '</div>' +
            '</div>';

        function checkQuantity() {
            let check = true;
            $('#bill-details tr').each(function () {
                let purchaseQuantity = $(this).find('td.item-quantity input.quantity-invoice').val()
                let oldPurchaseQuantity = $(this).find('td.item-quantity input.quantity-purchased').val()
                if (purchaseQuantity !== oldPurchaseQuantity) {
                    check = false;
                }
            });
            return check;
        }

        $(document).on('click', '.bill-create', function () {
            let _pk = $(this).attr('pk');
            $.ajax({
                url: '/accounting/modal_bill_create/',
                dataType: 'json',
                type: 'GET',
                data: {'pk': _pk},
                success: function (response) {
                    $('#modal-bill-create').html(response.form);
                    $('#modal-bill-create').modal('show');
                },
                fail: function (response) {
                    toastr.error('Error en la peticion', '¡Mensaje!');
                }
            });
        });


        function getBillList() {
            let start = $('#start_date').val();
            let end = $('#end_date').val();
            
            $('#purchases-with-bill-grid').empty();
            $('#loader-bill').show();
            
            $.ajax({
                url: '/accounting/get_purchases_with_bill/',
                dataType: 'json',
                type: 'GET',
                data: {
                    'start_date': start,
                    'end_date': end
                },
                success: function (response) {
                    if (response.success) {
                        $('#purchases-with-bill-grid').html(response['grid']);
                    } else {
                        toastr.error('No se encontraron compras registradas.', '¡Mensaje!');
                    }
                    $('#loader-bill').hide();
                },
                error: function (response) {
                    toastr.error('Error en la petición, contactar con Sistemas', '¡Mensaje!');
                    $('#loader-bill').hide();
                }
            });
        }

        function getPurchaseList() {
            let start = $('#start_date').val();
            let end = $('#end_date').val();
            
            $('#client-grid-list').css('opacity', '0.5');
            
            // Recargar la tabla "SIN FACTURAR" (Partial)
            // Nota: Aquí asumo que existe una vista que devuelve solo el grid de compras pendientes
            // Si no, podemos recargar la página completa con los parámetros
            window.location.href = window.location.pathname + '?start_date=' + start + '&end_date=' + end;
        }

        $(document).on('click', '#btn-filter', function() {
            if ($('#purchase-list-tab').hasClass('active')) {
                getPurchaseList();
            } else {
                getBillList();
            }
        });

        $(document).on('click', '#btn-reset', function() {
            $('#start_date').val('');
            $('#end_date').val('');
            getPurchaseList();
        });

        $(document).on('click', '#bill-purchase-tab', function () {
            getBillList();
        });

        $(document).on('click', '.bill-manual-create', function () {
            $.ajax({
                url: '/accounting/modal_bill_create/',
                dataType: 'json',
                type: 'GET',
                data: {'purchases': '[]'}, // Envía arreglo vacío para modo manual
                success: function (response) {
                    $('#modal-bill-create').html(response.form);
                    $('#modal-bill-create').modal('show');
                },
                fail: function (response) {
                    toastr.error('Error en la peticion', '¡Mensaje!');
                }
            });
        });

        $(document).on('click', '.generate-bill', function () {
            let tbody = $('#body-finances')
            let firstSupplierID = null;
            let purchasesID = [];
            let error = false;

            tbody.find('tr td.item-check input.check-oc').each(function () {
                if ($(this).prop('checked')) {
                    let _tr = $(this).closest('tr');
                    let supplierID = parseInt(_tr.attr('supplier'));
                    let purchaseID = parseInt(_tr.attr('pk'));
                    if (firstSupplierID === null) {
                        firstSupplierID = supplierID;
                    } else {
                        if (supplierID !== firstSupplierID) {
                            error = true;
                            return false;
                        }
                    }
                    purchasesID.push(purchaseID);
                }
            });

            if (purchasesID.length === 0) {
                toastr.warning('Debe seleccionar al menos una Orden de Compra.', 'Mensaje');
                return;
            }

            if (error) {
                toastr.warning('No puedes seleccionar Ordenes de Compra de diferentes proveedores para generar una factura.', 'Mensaje');
            }

            if (!error) {
                $.ajax({
                    url: '/accounting/modal_bill_create/',
                    dataType: 'json',
                    type: 'GET',
                    data: {'purchases': JSON.stringify(purchasesID)},
                    success: function (response) {
                        $('#modal-bill-create').html(response.form);
                        $('#modal-bill-create').modal('show');
                    },
                    fail: function (response) {
                        toastr.error('Error en la peticion', '¡Mensaje!');
                    }
                });
            }
        });

        $(document).on('click', '#btn-save-bill', function (e) {

            e.preventDefault()
            let supplier_id = $("#supplier_id");
            let purchases = $("#purchase_id");
            let bill_date = $('#bill_date');
            let bill_date_expiration = $('#bill_date_expiration');
            let bill_serial = $('#bill_serial');
            let bill_correlative = $('#bill_correlative');
            let bill_address = $('#bill_delivery_address');
            let bill_order_number = $('#order_number');
            let bill_purchases_numbers = $('#purchases_numbers');

            let bill_total_base = $('.total-base-bill');
            let bill_igv = $('.total-igv-bill');
            let bill_total = $('.total-bill');

            let quantity_total = $('#quantity_total');
            let observation = $('#observation');

            if (bill_serial.val() === '') {
                toastr.warning('¡Ingresar la serie la de Factura!', 'Error de Datos');
                return false;
            }
            if (bill_correlative.val() === '') {
                toastr.warning('¡Ingresar el correlativo de la Factura!', 'Error de Datos');
                return false;
            }
            
            // Obtener el modo manual desde el input hidden
            let isManualMode = $('#is_manual_mode').val() === 'true';
            
            if (isManualMode) {
                // Validar que se haya seleccionado o buscado un proveedor
                let supplier_id_val = supplier_id.val();
                let supplier_ruc_val = $('#supplier_ruc_value').val();
                let supplier_name_val = $('#supplier_name').val();
                let supplier_name_text = $('#supplier_name option:selected').text();
                
                // Verificar si es una opción temporal (proveedor nuevo)
                let isTemporarySupplier = supplier_name_val && supplier_name_val.startsWith('TEMP_');
                
                if (!supplier_name_val || supplier_name_val === '' || supplier_name_text === 'Seleccionar Proveedor...') {
                    toastr.warning('Debe seleccionar un proveedor o buscar uno por RUC', 'Error de Datos');
                    return false;
                }
                
                // Si es un proveedor temporal (nuevo), debe tener RUC
                if (isTemporarySupplier && !supplier_ruc_val) {
                    toastr.warning('Debe buscar un proveedor por RUC primero', 'Error de Datos');
                    return false;
                }
                // En modo manual no se valida el número de pedido
            } else {
                // Modo con órdenes de compra - validar número de pedido
                if (bill_order_number.val() === '') {
                    toastr.warning('¡Ingresar el numero de pedido!', 'Error de Datos');
                    return false;
                }
            }

            /*if (checkQuantity() === true) {
                let previousTotal = parseFloat($('#current_total').val());
                if (bill_total.val() > previousTotal + 2 || bill_total.val() < previousTotal - 2) {
                    toastr.warning('¡El valor no puede estar fuera del rango +2 y -2!, favor de corregir', 'Mensaje');
                    return false;
                }
            }*/

            // Obtener datos del proveedor
            let supplier_id_val = supplier_id.val();
            let supplier_name_selected = $('#supplier_name option:selected');
            let isTemporarySupplier = supplier_id_val === '' || (supplier_id_val && supplier_id_val.startsWith('TEMP_'));
            
            let Bill = {
                "supplier_id": isTemporarySupplier ? '' : supplier_id_val,
                "supplier_ruc": $('#supplier_ruc_value').val() || '',
                "supplier_name_new": supplier_name_selected.text() || '',
                "supplier_address_new": $('#address').val() || '',

                "purchase_id": purchases.val(),
                "bill_date": bill_date.val(),
                "bill_date_expiration": bill_date_expiration.val(),
                'bill_serial': bill_serial.val(),
                'bill_correlative': bill_correlative.val(),
                'bill_delivery_address': bill_address.val(),
                'bill_order_number': bill_order_number.val(),

                'bill_total_base': bill_total_base.val(),
                'bill_igv': bill_igv.val(),
                'bill_total': bill_total.val(),

                'bill_quantity': quantity_total.val(),
                'observation': observation.val(),
                'billPurchases': []
            };
            /*$('#bill-details tr').each(function () {
                let details = {
                    'purchaseDetailID': $(this).attr('detail'),
                    'purchaseQuantity': $(this).find('td.item-quantity input.quantity-purchased').val(),
                    'invoiceQuantity': $(this).find('td.item-quantity input.quantity-invoice').val(),
                    'product': $(this).attr('product'),
                };
                Bill.billPurchases.push(details)
            })*/
            let billPurchases = {};
            let hasError = false;
            let rowCount = 0;
            
            $('#bill-details tr:not(.empty-row-template)').each(function () {
                rowCount++;
                let $tr = $(this);
                let product_id = $tr.attr('product') || $tr.attr('data-product');
                
                // Validar que el producto no esté vacío
                if (!product_id || product_id === '' || product_id === 'undefined') {
                    hasError = true;
                    toastr.warning('Todas las filas deben tener un producto seleccionado. Fila ' + rowCount, 'Error de Datos');
                    return false; // Continúa con la siguiente iteración
                }
                
                // Validar que tenga unidad seleccionada
                let unit_id = $tr.find('td.unit select.unit-select').val();
                if (!unit_id || unit_id === '') {
                    hasError = true;
                    toastr.warning('Todas las filas deben tener una unidad seleccionada. Fila ' + rowCount, 'Error de Datos');
                    return false;
                }
                
                // Validar que tenga cantidad
                let invoiceQuantity = $tr.find('td.item-quantity input.quantity-invoice').val();
                if (!invoiceQuantity || parseFloat(invoiceQuantity) <= 0) {
                    hasError = true;
                    toastr.warning('Todas las filas deben tener una cantidad mayor a 0. Fila ' + rowCount, 'Error de Datos');
                    return false;
                }
                
                // Validar que tenga precio
                let priceUnit = $tr.find('td.item-price input.price-product').val();
                if (!priceUnit || parseFloat(priceUnit) <= 0) {
                    hasError = true;
                    toastr.warning('Todas las filas deben tener un precio mayor a 0. Fila ' + rowCount, 'Error de Datos');
                    return false;
                }
                
                let details = {
                    'unit_id': unit_id,
                    'purchaseDetailID': $tr.attr('detail') || $tr.data('detail') || '',
                    'purchaseID': $tr.attr('purchase') || $tr.data('purchase') || '',
                    'purchaseQuantity': $tr.find('td.item-quantity input.quantity-purchased').val() || 0,
                    'invoiceQuantity': invoiceQuantity.toString().replace(',', '.'),
                    'invoiceQuantityMinimum': $tr.find('td.item-quantity-min input.quantity-min').val() || 0,
                    'priceUnit': priceUnit.toString().replace(',', '.')
                };
                
                // Asegurar que product_id sea string para usarlo como clave
                let productKey = String(product_id);
                if (!billPurchases[productKey]) {
                    billPurchases[productKey] = [];
                }
                billPurchases[productKey].push(details);
            });
            
            // Si hay errores, detener el proceso
            if (hasError) {
                $('#btn-save-bill').prop('disabled', false);
                return false;
            }
            
            // Validar que haya al menos un detalle
            if (Object.keys(billPurchases).length === 0) {
                toastr.warning('Debe agregar al menos un producto al detalle de la factura', 'Error de Datos');
                $('#btn-save-bill').prop('disabled', false);
                return false;
            }
            
            Bill.billPurchases = billPurchases;
            
            // Debug: mostrar en consola los datos que se enviarán
            console.log('Datos a enviar:', {
                'billPurchases': billPurchases,
                'total_productos': Object.keys(billPurchases).length,
                'is_manual': isManualMode
            });
            
            //let purchases_array = JSON.parse(purchases.val())
            $('#btn-save-bill').prop('disabled', true)
            $.ajax({
                url: '/accounting/save_bill/',
                async: true,
                dataType: 'json',
                type: 'GET',
                cache: false,
                data: {'Bill': JSON.stringify(Bill)},
                contentType: 'application/json;charset=UTF-8',
                headers: {"X-CSRFToken": ' {{ csrf_token }}'},
                success: function (response, textStatus, xhr) {
                    if (response.success) {
                        toastr.success(response.message, '¡Bien hecho!');
                        setTimeout(() => {
                            location.reload();
                        }, 1000);
                        $('#modal-bill-create').modal('hide');
                    }
                },
                error: function (jqXhr, textStatus, error) {
                    console.log('Error completo:', jqXhr);
                    console.log('Response Text:', jqXhr.responseText);
                    let errorMessage = 'Error al guardar la factura';
                    if (jqXhr.responseJSON && jqXhr.responseJSON.message) {
                        errorMessage = jqXhr.responseJSON.message;
                    } else if (jqXhr.responseJSON && jqXhr.responseJSON.error) {
                        errorMessage = jqXhr.responseJSON.error;
                    }
                    toastr.error(errorMessage, '¡Ocurrió un error!');
                    $('#btn-save-bill').prop('disabled', false);
                    $('#container-loading').css('display', 'none');
                }
            });
            //$('#btn-save-bill').prop('disabled', false)
        });

        $(document).on('click', '.bill-cancel', function (e) {
            let _bill_id = $(this).attr("pk")
            let r = confirm("¿Está seguro que desea eliminar la factura?");
            if (r === true) {
                $.ajax({
                    url: '/accounting/cancel_bill/',
                    async: true,
                    dataType: 'json',
                    type: 'GET',
                    cache: false,
                    data: {'bill': _bill_id},
                    contentType: 'application/json;charset=UTF-8',
                    headers: {"X-CSRFToken": ' {{ csrf_token }}'},
                    success: function (response, textStatus, xhr) {
                        if (response.success) {
                            toastr.success(response.message, '¡Bien hecho!');
                            setTimeout(() => {
                                location.reload();
                            }, 1000);
                        } else {
                            toastr.error(response.message, 'ERROR DE ANULACION');
                        }
                    }
                });
            }
        });

        $(document).on('click', '.btn-show-bill', function (e) {
            let _bill_id = $(this).attr("pk");
            let _table = $(this).closest('tbody').find('tr[pk="' + _bill_id + '"].show-detail').find('td.table-details-bill');
            let _icon = $(this).find('i');

            if (_icon.hasClass("fa-eye")) {
                _icon.removeClass('fa-eye');
                _icon.addClass('fa-eye-slash');

                openDetail(_bill_id, _table)
            } else {
                _icon.removeClass('fa-eye-slash');
                _icon.addClass('fa-eye');

                closeDetail(_table)
            }
        });

        function openDetail(_bill_id, _table) {
            console.log(_bill_id, _table)
            $.ajax({
                url: '/accounting/get_bill/',
                async: true,
                dataType: 'json',
                type: 'GET',
                cache: false,
                data: {'bill': _bill_id},
                contentType: 'application/json;charset=UTF-8',
                headers: {"X-CSRFToken": ' {{ csrf_token }}'},
                success: function (response, textStatus, xhr) {
                    if (response.success) {
                        _table.html(response.grid);
                        _table.parent('tr').slideDown("fast");
                    } else {
                        toastr.error(response.message, 'ERROR');
                    }
                }
            });
        }

        function closeDetail($td) {
            $td.parent('tr').slideUp("fast");
        }

    </script>

{% endblock extrajs %}