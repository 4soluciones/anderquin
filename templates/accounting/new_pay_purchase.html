{% load operations %}
{% load static %}
<div class="modal-content border-0 shadow-lg" style="border-radius: 16px; overflow: hidden;">
    <div class="modal-header border-0 py-3 px-4" style="background: linear-gradient(135deg, #1565c0 0%, #0d47a1 100%);">
        <div class="container-fluid px-0">
            <div class="row align-items-center">
                <div class="col pr-4">
                    <h5 class="modal-title text-white roboto-condensed-regular font-weight-bold mb-2">
                        <i class="fas fa-credit-card mr-2"></i>Registrar Pago a Proveedor
                    </h5>
                    <p class="mb-0 text-white-50 small mb-1">{{ bill.supplier.name }}</p>
                    <p class="mb-0 text-white font-weight-bold" style="font-size: 1.35rem; letter-spacing: 0.5px;">
                        Factura {{ bill.serial }}-{{ bill.correlative }}
                    </p>
                </div>
                <div class="col-auto pl-3">
                    <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close" style="opacity: 1; font-size: 1.5rem; padding: 0.5rem; margin: 0;">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-body roboto-condensed-regular" style="background-color: #f8fbff;">
        <form id="purchase-payment-form" action="" method="POST">
            {% csrf_token %}
            <input type="hidden" id="bill_id" name="bill" value="{{ bill.id }}">
            <input type="hidden" id="date-ini" name="date-ini" value="{{ start_date }}">
            <input type="hidden" id="date-fin" name="date-fin" value="{{ end_date }}">

            <!-- Resumen de deuda -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card border-0 shadow-sm h-100" style="border-radius: 12px; border-left: 4px solid #1565c0;">
                        <div class="card-body py-3">
                            <label class="small text-uppercase text-muted font-weight-bold mb-1">Deuda Total</label>
                            <div class="input-icon">
                                <input type="text" readonly class="form-control form-control-lg font-weight-bold border-0 bg-transparent" style="color: #1565c0; font-size: 1.25rem;"
                                       id="total_debt" name="total-debt" value="{{ total_debt }}">
                                <i class="change-money font-weight-bold text-primary">S/</i>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card border-0 shadow-sm h-100" style="border-radius: 12px; border-left: 4px solid #ff9800;">
                        <div class="card-body py-3">
                            <label class="small text-uppercase text-muted font-weight-bold mb-1">Saldo Pendiente</label>
                            <div class="input-icon">
                                <input type="text" readonly class="form-control form-control-lg font-weight-bold border-0 bg-transparent" style="color: #e65100; font-size: 1.25rem;"
                                       id="repay_loan_text" name="repay-loan-text" value="{{ bill.remaining_balance|replace_round_separator }}">
                                <i class="change-money font-weight-bold text-warning">S/</i>
                                <input type="hidden" id="repay_loan" name="repay_loan" value="{{ bill.remaining_balance }}">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Modo de pago -->
            <div class="card border-0 shadow-sm mb-4" style="border-radius: 12px;">
                <div class="card-header bg-white border-0 py-2" style="border-radius: 12px 12px 0 0;">
                    <label class="mb-0 font-weight-bold text-uppercase small" style="color: #0d47a1;">
                        <i class="fas fa-wallet mr-1"></i> Modo de Pago
                    </label>
                </div>
                <div class="card-body pt-2">
                    <div class="form-group mb-0">
                        <select id="payment_method_id" name="payment_method" class="form-control form-control-lg" style="border-radius: 10px; border-color: #bbdefb;">
                            <option value="M" selected>Efectivo / Depósito</option>
                            <option value="C">Nota de Crédito</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- Sección: Efectivo/Depósito -->
            <div class="money">
                <div class="card border-0 shadow-sm mb-3" style="border-radius: 12px;">
                    <div class="card-header bg-white border-0 py-2">
                        <span class="font-weight-bold small text-uppercase" style="color: #0d47a1;">Datos del Pago</span>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 col-lg-3 mb-3">
                                <label class="small font-weight-bold text-muted">Cuenta Anderquin</label>
                                <select id="cash" name="cash" class="form-control form-control-sm" style="border-radius: 8px;">
                                    {% for c in all_cashes %}
                                        <option value="{{ c.id }}">{{ c.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6 col-lg-3 mb-3">
                                <label class="small font-weight-bold text-muted">Monto a Pagar</label>
                                <div class="input-icon">
                                    <input type="text" id="bill_pay" name="bill-pay" autocomplete="off"
                                           class="form-control form-control-sm font-weight-bold text-right" style="border-radius: 8px; background-color: #e8f5e9;">
                                    <i class="change-money font-weight-bold">S/</i>
                                </div>
                            </div>
                            <div class="col-md-6 col-lg-3 mb-3">
                                <label class="small font-weight-bold text-muted">Tipo de Pago</label>
                                <select id="way_to_pay" name="way_to_pay" class="form-control form-control-sm" style="border-radius: 8px;">
                                    <option disabled selected value="0">Seleccione</option>
                                    <option value="E">Contado</option>
                                    <option value="D">Depósito</option>
                                </select>
                            </div>
                            <div class="col-md-6 col-lg-3 mb-3">
                                <label class="small font-weight-bold text-muted">Fecha de Pago</label>
                                <input type="date" id="pay_date" name="pay_date" value="{{ date }}"
                                       class="form-control form-control-sm" style="border-radius: 8px;">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6 col-lg-3 mb-3">
                                <label class="small font-weight-bold text-muted">Cuenta Proveedor</label>
                                <select id="account_supplier" name="account_supplier" class="form-control form-control-sm" style="border-radius: 8px;">
                                    <option disabled selected value="0">Seleccione</option>
                                    {% for c in accounts_supplier %}
                                        <option value="{{ c.id }}">{{ c.bank|default_if_none:'-' }}: {{ c.account }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6 col-lg-3 mb-3">
                                <label class="small font-weight-bold text-muted">Descripción</label>
                                <input type="text" id="pay_description" name="pay_description"
                                       value="PAGO A LA FACTURA: {{ bill.serial }}-{{ bill.correlative }}"
                                       class="form-control form-control-sm" style="border-radius: 8px;">
                            </div>
                            <div class="col-md-6 col-lg-3 mb-3">
                                <label class="small font-weight-bold text-muted">Código de Operación</label>
                                <input type="text" id="id_code_operation" name="code_operation" class="form-control form-control-sm" style="border-radius: 8px;">
                            </div>
                            <div class="col-md-6 col-lg-3 mb-3">
                                <label class="small font-weight-bold text-muted">Escaneo Depósito</label>
                                <input type="file" name="file" id="file" class="form-control form-control-sm" style="font-size: 12px; border-radius: 8px;">
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-12">
                                <label class="small font-weight-bold text-muted">Observación</label>
                                <input type="text" id="observation" name="observation" class="form-control form-control-sm" style="border-radius: 8px;">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sección: Nota de Crédito -->
            <div class="credit-note d-none">
                <div class="card border-0 shadow-sm" style="border-radius: 12px; border-left: 4px solid #7b1fa2;">
                    <div class="card-header bg-white border-0 py-2">
                        <span class="font-weight-bold small text-uppercase" style="color: #7b1fa2;">
                            <i class="fas fa-file-invoice mr-1"></i> Aplicar Nota de Crédito
                        </span>
                    </div>
                    <div class="card-body">
                        <p class="small text-muted mb-3">
                            Seleccione una nota de crédito pendiente del proveedor para aplicar su monto a esta factura.
                        </p>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="small font-weight-bold text-muted">Nota de Crédito</label>
                                <select id="credit_search" name="credit-search" class="form-control form-control-lg" style="border-radius: 10px; border-color: #ce93d8;">
                                    <option value="" disabled selected>Seleccione una nota de crédito</option>
                                    {% for c in credit_note_pending_set %}
                                        <option value="{{ c.id }}" data-total="{{ c.get_total }}" data-date="{{ c.issue_date|date:'Y-m-d' }}" data-motive="{{ c.motive|default:'' }}">
                                            {{ c.credit_note_serial|default:'' }}-{{ c.credit_note_number|default:'' }} — S/ {{ c.get_total|floatformat:2 }}
                                        </option>
                                    {% endfor %}
                                </select>
                                {% if not credit_note_pending_set %}
                                    <small class="text-muted">No hay notas de crédito pendientes para este proveedor.</small>
                                {% endif %}
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="small font-weight-bold text-muted">Monto a Aplicar</label>
                                <div class="input-icon">
                                    <input type="text" id="credit_total_display" name="credit-total-display" readonly
                                           class="form-control form-control-lg font-weight-bold text-right" style="border-radius: 10px; background-color: #f3e5f5; border: 1px solid #ce93d8;"
                                           placeholder="Seleccione una N/C">
                                    <i class="change-money font-weight-bold">S/</i>
                                    <input type="hidden" id="credit-total" name="credit-total" value="">
                                </div>
                            </div>
                        </div>
                        <div class="row" id="credit-note-info" style="display: none;">
                            <div class="col-12">
                                <div class="alert alert-light border py-2 mb-0" style="border-radius: 8px;">
                                    <small class="text-muted">
                                        <strong>Fecha:</strong> <span id="credit-info-date"></span> —
                                        <strong>Motivo:</strong> <span id="credit-info-motive"></span>
                                    </small>
                                </div>
                            </div>
                        </div>
                        <input type="hidden" id="credit-serial" name="credit-serial" value="">
                        <input type="hidden" id="credit-number" name="credit-number" value="">
                        <input type="hidden" id="credit-note-date" name="credit-note-date" value="{{ date }}">
                        <input type="hidden" id="credit_note_motive" name="credit-note-motive" value="">
                        <input type="hidden" id="credit-code" name="credit-code" value="NC">
                        <input type="hidden" id="credit-quantity" name="credit-quantity" value="1">
                        <input type="hidden" id="credit-unit" name="credit-unit" value="NIU">
                        <input type="hidden" id="credit-description" name="credit-description" value="Aplicación de nota de crédito">
                        <input type="hidden" id="credit-price-unit" name="credit-price-unit" value="0">
                    </div>
                </div>
            </div>

            <div class="modal-footer border-0 bg-white pt-3">
                <button type="button" class="btn btn-outline-secondary" id="close-modal" data-dismiss="modal" style="border-radius: 10px;">Cerrar</button>
                <button type="submit" id="btn-save" class="btn btn-primary shadow-sm" style="border-radius: 10px;">
                    <i class="fas fa-save mr-1"></i> Guardar Pago
                </button>
            </div>
        </form>
    </div>
</div>

<style>
    .input-icon { position: relative; }
    .input-icon > i {
        position: absolute; top: 50%; transform: translate(0, -50%);
        pointer-events: none; width: 25px; text-align: center; font-style: normal;
    }
    .input-icon > input { padding-left: 25px; padding-right: 8px; }
    .form-control:focus {
        box-shadow: 0 0 0 0.2rem rgba(30, 58, 95, 0.25);
        border-color: #1e3a5f;
    }
</style>

<script type="text/javascript">
$(document).ready(function () {
    setTimeout(function () { $('#bill_pay').focus(); }, 500);
});

$('#payment_method_id').change(function () {
    let payment_method = $(this).val();
    if (payment_method === 'M') {
        $('.money').removeClass('d-none');
        $('.credit-note').addClass('d-none');
    } else {
        $('.money').addClass('d-none');
        $('.credit-note').removeClass('d-none');
        $('#credit_search').focus();
    }
});

$('#credit_search').change(function () {
    let $opt = $(this).find('option:selected');
    let total = $opt.data('total');
    let date = $opt.data('date') || '';
    let motive = $opt.data('motive') || '';
    
    if (total !== undefined && total !== '' && $(this).val()) {
        let totalStr = parseFloat(total).toFixed(2);
        $('#credit_total_display').val(totalStr);
        $('#credit-total').val(totalStr);
        $('#credit-note-date').val(date);
        $('#credit_note_motive').val(motive);
        $('#credit-info-date').text(date || '-');
        $('#credit-info-motive').text(motive || '-');
        $('#credit-note-info').show();
        // Vacíos para que el backend use credit-search (aplicar N/C existente)
        $('#credit-serial').val('');
        $('#credit-number').val('');
    } else {
        $('#credit_total_display').val('');
        $('#credit-total').val('');
        $('#credit-note-info').hide();
    }
});

$('#purchase-payment-form').submit(function (event) {
    event.preventDefault();
    let data = new FormData($('#purchase-payment-form').get(0));
    let _total_debt = $('#total_debt').val().replace(/,/g, '');
    let _bill_pay = $('#bill_pay').val().replace(/,/g, '');
    let _repay_loan = $('#repay_loan').val().replace(/,/g, '.');
    let payment_method = $('#payment_method_id').val();
    let credit_total = $('#credit-total').val();

    if (payment_method === 'M') {
        if (_bill_pay === '') {
            toastr.warning('Ingrese un monto antes de guardar el pago', 'Mensaje');
            return false;
        }
        if ($('#way_to_pay').val() === null || $('#way_to_pay').val() === '0') {
            toastr.warning('Seleccione un método de pago', 'Mensaje');
            return false;
        }
        if (Number(_bill_pay) > Number(_total_debt)) {
            toastr.warning('El monto no puede ser mayor a la deuda total', 'Mensaje');
            return false;
        }
        if (Number(_bill_pay) > Number(_repay_loan)) {
            toastr.warning('El monto no puede ser mayor al saldo restante', 'Mensaje');
            return false;
        }
    } else if (payment_method === 'C') {
        let credit_search = $('#credit_search').val();
        if (!credit_search || credit_search === '') {
            toastr.warning('Seleccione una nota de crédito para aplicar', 'Mensaje');
            return false;
        }
        if (!credit_total || credit_total === '') {
            toastr.warning('El monto de la nota de crédito no está definido', 'Mensaje');
            return false;
        }
        let creditTotalNum = parseFloat(credit_total.replace(/,/g, ''));
        if (creditTotalNum > parseFloat(_repay_loan)) {
            toastr.warning('El monto de la nota de crédito no puede ser mayor al saldo restante', 'Mensaje');
            return false;
        }
    }

    $('#btn-save').prop('disabled', true);

    $.ajax({
        url: '/accounting/new_payment_purchase/',
        type: 'POST',
        data: data,
        cache: false,
        processData: false,
        contentType: false,
        success: function (response, textStatus, xhr) {
            if (xhr.status === 200) {
                $('#modal-payment-purchase').modal('hide');
                toastr.success(response['message'], '¡Bien hecho!');
                $("#id_btn_show").trigger('click');
            }
            $('#btn-save').prop('disabled', false);
        },
        error: function (jqXhr) {
            toastr.error(jqXhr.responseJSON?.error || 'Error al registrar el pago', 'Error');
            $('#btn-save').prop('disabled', false);
        }
    });
});
</script>
