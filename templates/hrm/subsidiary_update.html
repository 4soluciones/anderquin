{% load static %}
{% load operations %}
<div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content border-0 shadow-lg" style="border-radius: 15px; overflow: hidden;">
        <div id="modal-loader" class="overlay" style="display: none">
            <i class="fas fa-3x fa-sync fa-spin"></i>
        </div>
        <div class="modal-header border-0 py-3" style="background: linear-gradient(180deg, #bbe0f5 0%, #90caf9 100%);">
            <h6 class="modal-title font-weight-bold text-uppercase roboto-condensed-regular" style="color: #0d47a1;">
                <i class="fas fa-edit mr-2"></i>Editar Sede
            </h6>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
        <form id="update_form" action="{% url 'hrm:update_subsidiary' %}" method="POST">
            {% csrf_token %}
            <div class="modal-body p-4" style="background-color: #f0f8fc;">
                <input type="hidden" name="subsidiary" value="{{ subsidiary_obj.id }}" id="subsidiary">
                <div class="card border-0 shadow-sm" style="border-radius: 12px; background-color: #fff;">
                    <div class="card-body p-4">
                        <div class="form-group mb-3">
                            <label class="small font-weight-bold text-uppercase text-muted" style="font-size: 0.8rem;">Serie</label>
                            <input type="text" name="subsidiary_serial" class="form-control form-control-sm shadow-sm"
                                   placeholder="Ingrese serie" required autocomplete="off"
                                   value="{{ subsidiary_obj.serial|default_if_none:'' }}" id="subsidiary_serial"
                                   style="border-color: #bbdefb;">
                        </div>
                        <div class="form-group mb-3">
                            <label class="small font-weight-bold text-uppercase text-muted" style="font-size: 0.8rem;">Nombre de la Sede</label>
                            <input type="text" name="subsidiary_name" class="form-control form-control-sm shadow-sm"
                                   placeholder="Ingrese nombre de la sede" required autocomplete="off"
                                   value="{{ subsidiary_obj.name }}" id="subsidiary_name"
                                   style="border-color: #bbdefb;">
                        </div>
                        <div class="form-group mb-3">
                            <label class="small font-weight-bold text-uppercase text-muted" style="font-size: 0.8rem;">Dirección</label>
                            <input type="text" name="subsidiary_address" class="form-control form-control-sm shadow-sm"
                                   placeholder="Ingrese dirección" required autocomplete="off"
                                   value="{{ subsidiary_obj.address }}" id="subsidiary_address"
                                   style="border-color: #bbdefb;">
                        </div>
                        <div class="form-group mb-3">
                            <label class="small font-weight-bold text-uppercase text-muted" style="font-size: 0.8rem;">Distrito</label>
                            <select id="district" name="district" class="form-control form-control-sm shadow-sm" style="border-color: #bbdefb;">
                                {% for d in districts %}
                                    <option value="{{ d.id }}" {% if d.id == subsidiary_obj.district.id %}selected{% endif %}>{{ d.description }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group mb-0">
                            <div class="custom-control custom-checkbox">
                                <input type="checkbox" name="is_main" class="custom-control-input" id="is_main" {% if subsidiary_obj.is_main %}checked{% endif %}>
                                <label class="custom-control-label small font-weight-bold" for="is_main" style="color: #0d47a1;">Sede Principal</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-0 py-3" style="background-color: #f0f8fc;">
                <button type="button" class="btn btn-outline-secondary btn-sm font-weight-bold" data-dismiss="modal" style="border-radius: 10px;">Cerrar</button>
                <button id="btn-update" type="submit" class="btn btn-primary btn-sm font-weight-bold shadow-sm" style="border-radius: 10px;">
                    <i class="fas fa-save mr-1"></i> Actualizar
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    $('#district').select2({
        width: '100%'
    });

    $('#update_form').submit(function (event) {
        event.preventDefault();

        let data = new FormData($('#update_form').get(0));
        $('#btn-update').attr('disabled', true);
        $.ajax({
            url: $(this).attr('action'),
            type: $(this).attr('method'),
            async: true,
            data: data,
            cache: false,
            processData: false,
            contentType: false,
            headers: {"X-CSRFToken": '{{ csrf_token }}'},
            success: function (response) {
                if (response.success) {
                    toastr.success(response.message);
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                }
            },
            error: function (response) {
                toastr.error(response.message || "Error al actualizar", "Guardado Fallido");
                $('#btn-update').attr('disabled', false);
            }
        });
    });
</script>
