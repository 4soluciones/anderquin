{% extends 'home.html' %}
{% block title %}
    Sedes
{% endblock title %}

{% block body %}
    <div class="container-fluid py-2 roboto-condensed-regular" style="background-color: #e8f4f8; min-height: 100vh;">
        <div class="card border-0 shadow-lg mb-4 overflow-hidden" style="border-radius: 15px;">
            <div class="card-body border-bottom py-3" style="background: linear-gradient(180deg, #bbe0f5 0%, #90caf9 100%);">
                <div class="row align-items-center no-gutters">
                    <div class="col-12 col-lg-10">
                        <h5 class="mb-0 font-weight-bold text-uppercase" style="color: #0d47a1; font-size: 1rem;">
                            <i class="fas fa-building mr-2"></i>Gestión de Sedes
                        </h5>
                    </div>
                    <div class="col-12 col-lg-2 mt-2 mt-lg-0 pl-lg-2">
                        <button type="button" class="btn btn-primary btn-sm shadow-sm w-100" style="border-radius: 10px;"
                                data-toggle="modal" data-target="#modal-subsidiary-store">
                            <i class="fas fa-plus"></i> Nueva Sede
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body p-0 p-md-3" style="background-color: #e3f2fd;">
                <div id="ss-grid-list">{% include "hrm/subsidiary_grid_list.html" %}</div>
            </div>
        </div>
    </div>

    <div class="modal" id="modal-subsidiary-store" tabindex="-1" role="dialog">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content border-0 shadow-lg" style="border-radius: 15px; overflow: hidden;">
                <div class="modal-header border-0 py-3" style="background: linear-gradient(180deg, #bbe0f5 0%, #90caf9 100%);">
                    <h6 class="modal-title font-weight-bold text-uppercase roboto-condensed-regular" style="color: #0d47a1;">
                        <i class="fas fa-warehouse mr-2"></i>Registrar Nueva Sede
                    </h6>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <form id="subsidiary-form" action="" method="POST">
                    {% csrf_token %}
                    <div class="modal-body p-4 roboto-condensed-regular" style="background-color: #f0f8fc;">
                        <div class="card border-0 shadow-sm" style="border-radius: 12px; background-color: #fff;">
                            <div class="card-body p-4">
                                <div class="form-group mb-3">
                                    <label class="small font-weight-bold text-uppercase text-muted" style="font-size: 0.8rem;">Serie</label>
                                    <input type="text" name="serial" class="form-control form-control-sm shadow-sm" placeholder="Ingrese serie"
                                           required autocomplete="off" id="serial" style="border-color: #bbdefb;">
                                </div>
                                <div class="form-group mb-3">
                                    <label class="small font-weight-bold text-uppercase text-muted" style="font-size: 0.8rem;">Nombre de la Sede</label>
                                    <input type="text" name="name" class="form-control form-control-sm shadow-sm" placeholder="Ingrese nombre de la nueva sede"
                                           required autocomplete="off" id="name" style="border-color: #bbdefb;">
                                </div>
                                <div class="form-group mb-3">
                                    <label class="small font-weight-bold text-uppercase text-muted" style="font-size: 0.8rem;">Dirección</label>
                                    <input type="text" name="address" class="form-control form-control-sm shadow-sm" placeholder="Ingrese dirección completa"
                                           required autocomplete="off" id="address" style="border-color: #bbdefb;">
                                </div>
                                <div class="form-group mb-3">
                                    <label class="small font-weight-bold text-uppercase text-muted" style="font-size: 0.8rem;">Distrito</label>
                                    <select id="district_id" name="district_id" class="form-control form-control-sm shadow-sm" required style="border-color: #bbdefb;">
                                        <option value="0">Seleccione distrito...</option>
                                        {% for d in districts %}
                                            <option value="{{ d.id }}">{{ d.description }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="form-group mb-0">
                                    <div class="custom-control custom-checkbox">
                                        <input type="checkbox" name="is_principal" class="custom-control-input" id="is_principal">
                                        <label class="custom-control-label small font-weight-bold" for="is_principal" style="color: #0d47a1;">Sede Principal</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer border-0 py-3" style="background-color: #f0f8fc;">
                        <button type="button" class="btn btn-outline-secondary btn-sm font-weight-bold" data-dismiss="modal" style="border-radius: 10px;">Cerrar</button>
                        <button id="btn-save" type="submit" class="btn btn-primary btn-sm font-weight-bold shadow-sm" style="border-radius: 10px;">
                            <i class="fas fa-save mr-1"></i> Registrar Sede
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modal-edit" data-backdrop="static" data-keyboard="false"
         tabindex="-1" role="dialog"
         aria-labelledby="ModalHelpTitle"
         aria-hidden="true"></div>

    <style>
        .form-control:focus {
            box-shadow: 0 0 0 0.2rem rgba(30, 58, 95, 0.25);
            border-color: #1e3a5f;
        }
        .btn-outline-primary, .btn-outline-success, .btn-outline-warning, .btn-outline-danger, .btn-outline-secondary {
            border-width: 2px;
        }
    </style>
{% endblock body %}

{% block extrajs %}

    <script type="text/javascript">
        $('#district_id').select2()

        $('#subsidiary-form').submit(function (event) {
            event.preventDefault();
            let data = new FormData($('#subsidiary-form').get(0));
            $('#btn-save').prop("disabled", "true");
            let _district_id = $('#district_id').val();
            if (_district_id === '0') {
                toastr.warning('Seleccione un distrito', '¡Atención!');
                $('#btn-save').removeAttr("disabled");
                return false;
            }
            $.ajax({
                url: '/hrm/new_subsidiary/',
                type: "POST",
                data: data,
                cache: false,
                processData: false,
                contentType: false,
                success: function (response, textStatus, xhr) {
                    if (xhr.status === 200) {
                        toastr.success(response['message'], '¡Bien hecho!');
                        setTimeout(() => {
                            location.reload();
                        }, 500);
                    }
                },
                error: function (jqXhr, textStatus, xhr) {
                    if (jqXhr.status === 500) {
                        toastr.error(jqXhr.responseJSON.error, '¡Error!');
                    }
                }
            });
        });

        $(document).on('click', '.btn-edit-subsidiary', async function () {
            let _pk = $(this).attr('pk');
            $.ajax({
                url: '/hrm/modal_subsidiary_edit/',
                dataType: 'json',
                type: 'GET',
                data: {'pk': _pk},
                success: function (response) {
                    $('#modal-edit').html(response.form);
                    $('#modal-edit').modal('show');
                },
                fail: function (response) {
                    toastr.error('Error en la petición', '¡Mensaje!');
                }
            });
        });
    </script>

{% endblock extrajs %}
