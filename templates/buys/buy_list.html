{% extends 'home.html' %}
{% block title %}
    Orden de Compra
{% endblock title %}

{% block body %}
    <div class="col-sm-12 col-sm-12 col-lg-12 pt-3 roboto-condensed-regular">
        <div class="card">
            <div class="card-header pt-0">
                <div class="row"{% if contract_detail_obj %} style="background: #62a239" {% else %}
                     style="background: #1a77c8"{% endif %}>
                    <div class="col-sm-12 col-md-12 col-lg-12" style="font-size: 12px">
                        <div class="row p-2">
                            <div class="col-sm-3 col-md-3 col-lg-3 pr-0">
                                <input type="hidden" id="contract_detail_id" name="contract-detail"
                                       value="{{ contract_detail_obj.id }}">
                                {% if contract_detail_obj %}
                                    <h6 class="montserrat text-white font-weight-bold mt-4 mb-0">
                                        <label>{{ contract_detail_obj.contract.contract_number }} -
                                            FECHA: {{ contract_detail_obj.date|date:'d-m-Y' }}</label>
                                    </h6>
                                {% else %}
                                    <h6 class="montserrat text-white font-weight-bold mt-4 mb-0">
                                        <label>ORDEN DE COMPRA:</label>
                                    </h6>
                                {% endif %}
                            </div>
                            {#                            {% if contract_detail_obj %}#}
                            {#                                <div class="col-sm-2 col-md-2 col-lg-2">#}
                            {#                                    <h5 class="montserrat text-white font-weight-bold mt-4 mb-0">#}
                            {#                                        <label>FECHA: {{ contract_detail_obj.date|date:'d-m-Y' }}</label>#}
                            {#                                    </h5>#}
                            {#                                </div>#}
                            {#                            {% endif %}#}

                            <div class="col-sm-2 col-md-2 col-lg-2 mb-3">
                                <button type="button" onclick="showModalView('modal_supplier_create')"
                                        class="btn btn-sm btn-secondary btn-block mt-3 mb-0 col-sm-12 col-md-12 col-lg-12">
                                    Nuevo Proveedor
                                </button>
                            </div>

                            <div class="col-sm-2 col-md-2 col-lg-2 mt-3">
                                <form>
                                    <div class="form-group row">
                                        <button type="button"
                                                class="col-sm-5 btn btn-sm btn-outline-secondary border-0 text-white btn-block p-1"
                                                id="btn-type-change">Tipo de Cambio:
                                        </button>
                                        <div class="col-sm-7">
                                            <input type="text" class="form-control text-center font-weight-bold"
                                                   id="type_change" readonly>
                                        </div>
                                    </div>
                                </form>
                            </div>

                            <div class="col-sm-2 col-md-2 col-lg-2">
                                <div class="form-check mt-4">
                                    <input class="form-check-input check-dollar" type="checkbox" value=""
                                           id="check_dollar">
                                    <label class="form-check-label text-white" for="check_dollar">
                                        COMPRA EN DOLARES
                                    </label>
                                </div>
                            </div>
                            <div class="col-sm-3 col-md-3 col-lg-3 mt-3">
                                <form>
                                    <div class="form-group row">
                                        <label for="correlative"
                                               class="col-sm-5 border-0 text-white pt-2 text-right pr-0">Correlativo:</label>
                                        <div class="col-sm-7">
                                            <div class="input-group">
                                                <div class="input-group-prepend">
                                                    <span class="input-group-text font-weight-bold"
                                                          style="font-size: 11px">OC-2023</span>
                                                </div>
                                                <input type="text" style="font-size: 12px"
                                                       class="form-control text-center font-weight-bold"
                                                       id="correlative" value="{{ correlative }}" autocomplete="off">
                                            </div>
                                        </div>
                                    </div>
                                </form>
                            </div>

                        </div>
                    </div>
                    {#                    <div class="col-sm-4 col-md-4 col-lg-4">#}
                    {#                        <div class="row">#}
                    {#                        </div>#}
                    {#                    </div>#}

                </div>
                <div class="card-body p-0">
                    <div class="row border">
                        <div class="col-sm-5 col-md-5 col-lg-5 pr-0">
                            <div class="card">
                                <div class="card-header pb-1 pt-1">
                                    <div class="row">
                                        <div class="col-sm-9 col-md-9 col-lg-9 font-weight-bold">
                                            DATOS DE LA ORDEN:
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body pt-1">
                                    {% include "buys/buy_register.html" %}
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-7 col-md-7 col-lg-7 pl-0">
                            <div class="card">
                                <div class="card-header pb-1 pt-1">
                                    <div class="row">
                                        <div class="col-sm-9 col-md-9 col-lg-9 font-weight-bold">
                                            REFERENCIA DE VENTA:
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body pt-1">
                                    {% include "buys/buys_reference.html" %}
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </div>

    </div>


    <div class="col-sm-12 col-md-12 col-lg-12 pt-1 roboto-condensed-regular">
        <div class="card">
            <div class="card-body pt-2">
                <div class="table-responsive" id="render-table">
                    {% include "buys/buy_detail.html" %}
                </div>
            </div>
        </div>
    </div>

    <div class="card-body">
        <div id="product-grid-list"></div>
    </div>
    <div class="modal fade bd-example-modal-lg" id="add-modal" tabindex="-1" role="dialog"
         aria-labelledby="exampleModalLabel" aria-hidden="true"></div>


    <div class="mr-3 ml-0" style="
            display: none;
            position: absolute;
            top: 83px;
            left: 0px;
            background: #e9ecef;
            opacity: 0.5;
            width: 100%;
            {#height: 46em;#}
            !important;bottom: 560px;
            padding-right: 65em;
            padding-top: 2em;" id="loading-666">

    </div>



    <div class="modal" id="modal-debs" tabindex="-1" role="dialog">

        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header pb-2 pt-2">
                    <h4 class="modal-title mb-3 mt-3 text-uppercase">Cantidad de coutas/letras:</h4>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    {#                    {% include "buys/modal_debs.html" with formatdate=formatdate %}#}
                </div>
            </div>
        </div>
    </div>



    <style>

        .input-icon {
            position: relative;
        }

        .input-icon > i {
        {#content: "$";#} position: absolute;
            display: block;
            transform: translate(0, -50%);
            top: 50%;
            pointer-events: none;
            width: 25px;
            text-align: center;
            font-style: normal;
        }

        .input-icon > input {
            padding-left: 25px;
            padding-right: 8px;
        }

        .input-icon-right > i {
            right: 0;
        }

        .input-icon-right > input {
            padding-left: 0;
            padding-right: 25px;
            text-align: right;
        }

    </style>

{% endblock body %}


{% block extrajs %}
    <script type="text/javascript">

        loader = '<div class="container">' +
            '<div class="row">' +
            '<div class="col-md-12">' +
            '<div class="loader">' +
            '<p><strong>Cargando Reniec/Sunat...</strong></p>' +
            '<div class="loader-inner"></div>' +
            '<div class="loader-inner"></div>' +
            '<div class="loader-inner"></div>' +
            '</div>' +
            '</div>' +
            '</div>' +
            '</div>';

        $(document).on('click', '#check_dollar', function (e) {
            let _check = $(this);
            if (_check.is(':checked')) {
                $(".change-money").text('$')
            } else {
                $(".change-money").text('S/')
            }
        });

        $(document).on('click', '#btn-type-change', function (e) {
            let _input_type_change = $('#type_change')

            $.ajax({
                url: '/buys/get_type_change/',
                async: true,
                dataType: 'json', // for response
                type: 'GET',
                data: {},
                contentType: 'application/json;charset=UTF-8',
                headers: {"X-CSRFToken": '{{ csrf_token }}'},
                success: function (response, textStatus, xhr) {
                    if (xhr.status === 200) {
                        {#toastr.success(response.message, '¡Bien hecho!');#}
                        {#console.log(response)#}
                        _input_type_change.val('$' + response.buy);
                        {#_provider.attr('provider', response.pk);#}
                        {#$('#loading-666').hide();#}
                    }
                },
                error: function (jqXhr, textStatus, xhr) {
                    if (jqXhr.status === 500) {
                        toastr.error(jqXhr.responseJSON.error, 'Mensaje');
                    } else {
                        if (textStatus === 'timeout') {
                            toastr.error('Failed from timeout', 'Mensaje');
                        } else {
                            console.log(" STATUS: " + xhr + " " + textStatus);
                        }
                    }
                    {#$('#loading-666').hide();#}
                },
            });
            return false;
        });

        $("#btn-type-change").trigger('click');

        $(document).ready(function () {
            if ($('#contract_detail_id').val() !== '') {
                //let client_set = {{ client|safe }};
                let client = {
                    names: {{ client|safe }}[0].names,
                    id: {{ client|safe }}[0].id,
                    type_client: {{ client|safe }}[0].type_client,
                    address: {{ client|safe }}[0].address
                };
                //console.log(client)
                handleClientSubmit(client)
            }
        });

        $("#btn-new").click(function () {
            setTimeout(() => {
                location.reload()
            }, 1000);
        });

        function showModalView(ruta) {
            $.ajax({
                url: '/buys/' + ruta + '/',
                dataType: 'json',
                type: 'GET',
                data: {'pk': 1},
                success: function (response) {
                    $('#add-modal').html(response.form);
                    $('#add-modal').modal('show');
                },
                fail: function (response) {
                    console.log(response);
                }
            });

        }

        function checkUnit() {
            let flag = false
            $('tbody#details-table tr').each(function () {
                let _unit = $(this).find('td.unit select.unit-product').val()
                if (_unit === '0') {
                    flag = true
                }
            });
            return flag
        }

        $('#purchase-form').submit(function (event) {
            event.preventDefault();
            let reference = $('#reference').val()
            let _contract = $("#contract_detail_id")
            let delivery_date = $('#delivery_date').val()
            if (_contract.val() !== '') {
                if (delivery_date === '') {
                    toastr.warning('¡Seleccione la fecha de entrega!', 'Mensaje');
                    return false;
                }
            } else {
                delivery_date = ''
            }

            if ($('#payment_type').val() === '0') {
                toastr.warning('¡Selecione el tipo de pago!', 'Mensaje');
                return false;
            }
            if ($('#supplier_id').val() === '0') {
                toastr.warning('¡Selecione el proveedor!', 'Mensaje');
                return false;
            }
            if (checkUnit() === true) {
                toastr.warning('¡Selecione el tipo de unidad en los productos!', 'Mensaje');
                return false;
            }

            if ($("#id_detail_data_grid tbody#details-table tr").length > 0 && $('.product-table').val() !== '') {
                let table_foot = $("#id_detail_data_grid tfoot#details-table-foot tr td.td-table-foot").find("#id_detail_data_foot tbody#table-detail-foot tr")
                let Detail_purchase = {
                    "SupplierId": $('#supplier_id').val(),
                    "Date": $('#id_fechacompra').val(),
                    "Reference": reference,
                    "Delivery_date": delivery_date,
                    "Type_Pay": $('#payment_type').val(),
                    "Pay_condition": $('#pay_condition').val(),
                    "Base_Total": Number(table_foot.find("td.foot-base input.total-foot-base").val()),
                    "Igv_Total": Number(table_foot.find("td.foot-igv input.total-foot-igv").val()),
                    "Import_Total": Number(table_foot.find("td.foot-total input.total-foot-total").val()),
                    "Check_Igv": ($("#id_detail_data_grid tfoot#details-table-foot tr td.td-table-foot").find("div.form-check input.check-igv").is(':checked')) ? 1 : 0,
                    "Check_Dollar": ($("#check_dollar").is(':checked')) ? 1 : 0,
                    "Details": [],

                    "client_reference_id": $('#client_reference_id').val(),
                    "client_final": $('#client_final').val(),

                    "check-subsidiary": ($("#check-subsidiary").is(':checked')) ? 1 : 0,
                    "check-provider": ($("#check-provider").is(':checked')) ? 1 : 0,
                    "check-client-final": ($("#check-client-final").is(':checked')) ? 1 : 0,
                    "check-client": ($("#check-client").is(':checked')) ? 1 : 0,

                    "address_subsidiary": $("#address_subsidiary").val(),
                    "address_provider": $("#address_provider").val(),
                    "client_address_reference": $("#client_address_reference").val(),
                    "client_final_address": $("#client_final_address").val(),
                    "observations": $("#observations").val(),
                    "contract_detail_id": _contract.val(),
                    "correlative": $('#correlative').val()
                };
                $("#id_detail_data_grid tbody#details-table tr").each(function () {
                    let detailObj = {
                        "Product": $(this).attr('product'),
                        "Unit": $(this).find("td.unit select.unit-product").val(),
                        "Quantity": $(this).find("td.item-quantity input.quantity-product").val(),
                        "Price": Number($(this).find("td.item-price input.price-unit-product").val()),
                        "Total": Number($(this).find("td.item-total input.total-detail").val()),
                    };
                    Detail_purchase.Details.push(detailObj);
                });
                console.log(Detail_purchase)
                $.ajax({
                    url: '/buys/save_purchase/',
                    async: true,
                    dataType: 'json', // for response
                    type: 'GET',
                    data: {'purchase': JSON.stringify(Detail_purchase)},
                    contentType: 'application/json;charset=UTF-8',
                    headers: {"X-CSRFToken": '{{ csrf_token }}'},
                    success: function (response, textStatus, xhr) {
                        if (xhr.status === 200) {
                            toastr.success(response.message, '¡COMPRA REGISTRADA CORRECTAMENTE!');
                            let purchase_id = response.pk
                            window.location.href = "/buys/print_pdf_purchase_order/" + purchase_id + "/";
                            if (response.contract) {
                                //console.log("contract")
                                setTimeout(() => {
                                    window.open("/buys/contracts/", '_self');
                                }, 2000);
                            } else {
                                //console.log("Order")
                                setTimeout(() => {
                                    location.reload();
                                }, 2000);
                            }
                        }
                    },
                    error: function (jqXhr, textStatus, xhr) {
                        toastr.error("ERROR. ", '¡INCONCEBIBLE!');
                    }
                });

            } else {
                toastr.warning("PARA REALIZAR LA COMPRA AGREGUE AL MENOS UN PRODUCTO. ", '¡ADVERTENCIA!');
                return false;
            }
        });

        function deleteItem(btn) {
            btn.parentNode.parentNode.remove();
            counterStrike();
        }

        function counterStrike() {
            let l = 1;
            $('#details-table tr').each(function () {
                $(this).attr('i', l);
                $(this).children('td:nth-child(1)').text(l);
                l++;
            });

        }

        $(document).on('focusin', '.product-table', function (e) {
            let _tr = $(this).parent('td').parent('tr')
            $(this).val(' ');
            let _select = _tr.find('td.unit select.unit-product');
            _select.empty();
            let option = $('<option>').val(0).text('Seleccione');
            _select.append(option);
            $(this).parent('td').find('div.dropdown-menu').css({
                'background-color': 'transparent',
                'border': 'transparent',
                {#'margin-top': '10px'#}
            })
            //$('#id_unit_product').val('0')
        });

        $(document).on('keypress', '.product-table', function (e) {

            $(this).parent('td').find('div.dropdown-menu').empty();
            let _select_unit = $(this).parent('td').parent('tr').find('td.unit select.unit-product');
            let _select_quantity_unit = $(this).parent('td').parent('tr').find('td.item-quantity-x-unit select.quantity-unit');

            if (e.keyCode === 13) {

                e.preventDefault()

                $(this).trigger("enterKey");
                let _product_name = $(this).val();
                // let _td = $(this).parent('div.btn-group').parent('td')
                let _td = $(this).parent('td')
                let _menu = _td.find('.dropdown-menu')

                if (_product_name.length > 3) {

                    $.ajax({
                        url: '/buys/get_product_by_criteria_table/',
                        async: true,
                        dataType: 'json', // for response
                        type: 'GET',
                        data: {
                            'value': _product_name,
                        },
                        contentType: 'application/json;charset=UTF-8',
                        headers: {"X-CSRFToken": '{{ csrf_token }}'},
                        success: function (response, textStatus, xhr) {
                            if (xhr.status === 200) {
                                _select_unit.empty()
                                _select_quantity_unit.empty()
                                //console.log(response.productList[0].unit_dict)
                                let _unit_dict = response.productList[0].unit_dict
                                let list = response.productList;
                                _menu.css({'background-color': '#fff', 'border': '1px solid rgba(0,0,0,.15)'})
                                for (let i = 0; i < list.length; i++) {
                                    let unit_dict = JSON.stringify(list[i].unit_dict)
                                    //console.log(JSON.stringify(list[i].unit_dict, null, 2))
                                    _menu.append(`<a class="dropdown-item product-item" unit='${unit_dict}'  brand="${list[i].brand}" href="#" data-id="${list[i].id}">${list[i].name} - ${list[i].brand}</a>`)
                                }
                                /*_select_unit.append($('<option>').text('Seleccione'));
                                for (let i = 0; i < _unit_dict.length; i++) {
                                    let option = $('<option>').val(_unit_dict[i].unit_id).text(_unit_dict[i].unit_name);
                                    _select_unit.append(option);
                                }*/

                            }
                        },
                        error: function (jqXhr, textStatus, xhr) {
                            if (jqXhr.status === 500) {
                                toastr.error(jqXhr.responseJSON.error, 'Mensaje');
                            } else {
                                if (textStatus === 'timeout') {
                                    toastr.error('Failed from timeout', 'Mensaje');
                                } else {
                                    console.log(" STATUS: " + xhr + " " + textStatus);
                                }
                            }
                        }
                    });
                } else {
                    toastr.warning('Para la busqueda ingrese minimo 3 caracteres', 'Error de llenado');
                    return false;
                }
            }
        });


        $(document).on('click', '.product-item', function (e) {

            let _product_id = $(this).attr('data-id');
            let _unit_dict = $(this).attr('unit');
            let _product_name = $(this).text();
            let _tr = $(this).parent('div.dropdown-menu').parent('td').parent('tr')
            let _td = $(this).parent('div.dropdown-menu').parent('td')
            let _select_unit = _tr.find('td.unit select.unit-product');
            //let _select_unit_quantity = _tr.find('td.item-quantity-x-unit select.quantity-unit');
            _tr.attr('product', _product_id);
            _td.find('input.product-table').val(_product_name);
            _select_unit.append($('<option>').val(0).text('Seleccione'));
            //_select_unit_quantity.append($('<option>').val(0).text('Seleccione'));
            let units = JSON.parse(_unit_dict);
            //console.log(units)
            for (let i = 0; i < units.length; i++) {
                let _quantity_minimum = Number(units[i].quantity_minimum).toFixed(0);
                {#let option = $('<option>').val(units[i].unit_id).text(units[i].unit_name + ' ' + '(' + _quantity_minimum + 'UND' + ')');#}
                let option = $('<option>')
                    .val(units[i].unit_id)
                    .text(units[i].unit_name + ' ' + '(' + _quantity_minimum + 'UND' + ')')
                    .attr('qm', _quantity_minimum);
                //let option2 = $('<option>').val(units[i].unit_id).text(units[i].unit_name);

                _select_unit.append(option);
                //_select_unit_quantity.append(option2);
            }

            $(this).parent('div.dropdown-menu').empty()
            $(this).parent('div.dropdown-menu').addClass('hide')
        });

        function get_units_by_product($product_id, _tr) {

            let _select = _tr.find('td.unit #id_unit_product').val()
            if ($product_id !== '0') {
                $.ajax({
                    url: '/buys/get_units_by_product/',
                    async: true,
                    dataType: 'json',
                    type: 'GET',
                    data: {'ip': $product_id},
                    success: function (response) {
                        let units = JSON.parse(response['units']);
                        //console.log(units)
                        units.forEach(
                            element =>
                                _tr.find('td.unit input.unit-product').val(element[0])
                        )
                    },
                });
            }
        }

        let flag_function = false;

        $(document).on('change', '.unit-product', async function (e) {
            let unit_id = $(this).val();
            let product_id = $(this).parent('td').parent('tr').attr('product')
            let _quantity = Number($(this).parent('td').parent('tr').find('td.item-quantity input.quantity-product').val())
            let _tr = $(this).parent('td').parent('tr')
            let _select_quantity_unit = _tr.find('td.item-quantity-x-unit select.quantity-unit');
            if (unit_id !== '0') {
                await getQuantityMinimumByProduct(product_id, unit_id, _tr, _quantity)
                {#if (!flag_function) {#}
                if (unit_id === '1') { /*optimizar*/
                    _select_quantity_unit.val('1').change();
                }
                {#flag_function = true;#}
                {# }#}
            } else {
                toastr.warning('Seleccione una unidad valida', 'Error de llenado');
                $(this).val(1).change();
                return false;
            }

        });

        $(document).on('keyup', '.quantity-minimum-val', async function (e) {
            let _tr = $(this).parent('td').parent('tr');
            //let product_id = _tr.attr('product');
            //let unit_id = _tr.find('td.unit select.unit-product').val();
            let _quantity_minimum = _tr.find('td.unit select.unit-product option:selected').attr('qm');
            /*let _quantity_minimum = await getQuantityMinimum2(product_id, unit_id).then(e => {
                    return e
                });*/
            let _val = $(this).val();
            let _quantity = _tr.find('td.item-quantity input.quantity-product');
            let _new_quantity = _val * _quantity_minimum
            _quantity.val(_new_quantity);
            $('.quantity-product').trigger('keyup');
        });

        //$('.unit-product').trigger('change')
        let _quantity_minimum = 0

        async function getQuantityMinimumByProduct(product_id, _unit, _tr, _quantity) {
            let _input_quantity_minimum = _tr.find('td.quantity-minimum input.quantity-minimum-val');
            //let _input_cant_x_und = _tr.find('td.item-quantity-x-unit input.quantity-x-unit');
            let _price_unit_product = _tr.find('td.item-price input.price-unit-product');
            _input_quantity_minimum.val('')
            if (product_id !== '0') {
                $.ajax({
                    url: '/buys/get_quantity_minimum/',
                    async: true,
                    dataType: 'json',
                    type: 'GET',
                    data: {
                        'product_id': product_id,
                        'unit_id': _unit
                    },
                    success: function (response) {
                        let _quantity_minimum = Number(response.quantity_minimum).toFixed(2)
                        if (_quantity_minimum && _quantity) {
                            let _q_x_u = _quantity / _quantity_minimum
                            //_input_cant_x_und.val(_q_x_u.toFixed(2))
                            _input_quantity_minimum.val(_q_x_u.toFixed(2))
                            {#_input_cant_x_und.val(Math.ceil(_q_x_u))#}
                        }
                        //_input_quantity_minimum.val(response.quantity_minimum + ' UND');
                        _price_unit_product.val(response.price_purchase);
                        $('.price-unit-product').trigger('keyup');
                    },
                });
            }
        }

        $(document).on('change', '.quantity-unit', async function (e) {
            let unit_id = $(this).val();
            if (unit_id !== '0') {
                let _input_quantity_x_unit = $(this).closest('td').find('input.quantity-x-unit');
                {#let product_id = $(this).parent('div').parent('div.row').parent('td').parent('tr').attr('product')#}
                let product_id = $(this).closest('td').parent('tr').attr('product')
                let _quantity = Number($(this).closest('td').parent('tr').find('td.item-quantity input.quantity-product').val())
                let _tr = $(this).closest('td').parent('tr')

                let quantity_minimum = await getQuantityMinimum2(product_id, unit_id).then(e => {
                    return e
                });
                let new_quantity_x_unit = _quantity / quantity_minimum;
                _input_quantity_x_unit.val(new_quantity_x_unit.toFixed(2));
            } else {
                toastr.warning('Seleccione una unidad valida', 'Error de llenado');
                $(this).val(1).change();
                return false;
            }

        });

        function getQuantityMinimum2(product_id, _unit) {
            if (product_id !== '' && product_id !== '0') {
                return new Promise(function (resolve, reject) {
                    $.ajax({
                        url: '/buys/get_quantity_minimum/',
                        async: true,
                        dataType: 'json',
                        type: 'GET',
                        data: {
                            'product_id': product_id,
                            'unit_id': _unit
                        },
                        success: function (data) {
                            resolve(data.quantity_minimum)
                        },
                        fail: function (err) {
                            toastr.error('Error en la peticion, Contactar con Sistemas', '¡Mensaje!');
                            reject(err)
                        }
                    });
                })
            }
        }

        $(document).on('keyup', '.quantity-x-unit', function () {
            let _val = $(this).val()
            let _tr = $(this).closest('td').parent('tr');
            let _quantity_minimum = $(this).closest('td').find('select.quantity-unit option:selected').attr('qm');
            let _input_quantity = $(this).closest('td').parent('tr').find('td.item-quantity input.quantity-product');
            let _new_quantity = _val * _quantity_minimum
            _input_quantity.val(_new_quantity)
            calculate_total(_tr)
            sum_table()
        });

        $(document).on('click', '#btn-add-new-detail', function () {

            let _check = $("#check_dollar");
            let _val_money = 'S/'

            if (_check.is(':checked')) {
                _val_money = '$'
            }

            $('#id_detail_data_grid > tbody').append(
                '<tr class="text-center">' +
                '<td class="item-numero align-middle">' + '</td>' +
                '<td class="align-middle text-left product-item-table">' +
                '<input type="text" class="form-control text-uppercase product-table dropdown-toggle" ' +
                '               data-toggle="dropdown" aria-expanded="false" placeholder="Ingrese producto...">' + '<div class="dropdown-menu"></div>' + '</td>' +
                '<td class="align-middle item-quantity">' + '<input type="text" class="form-control text-center quantity-product text-uppercase" placeholder="0">' + '</td>' +
                '<td class="align-middle unit text-center">' +
                '<select class="form-control unit-product text-center" id="id_unit_product" name="unit_product" required>' +
                '<option disabled value="0">Seleccione</option>' +
                '</td>' +
                '<td class="align-middle quantity-minimum text-center">' +
                '<input type="text" class="form-control text-center quantity-minimum-val" readonly>' +
                '</td>' +
                /*'<td class="align-middle item-quantity-x-unit" style="background-color: #bde7e2">' +
                '<div class="row">' +
                '<div class="col-sm-3 text-center pr-0">' +
                '<label class="mt-2">Ver en:</label>' +
                '</div>' +
                '<div class="col-sm-3 pr-0 pl-0 mt-1">' +
                '<select class="form-control quantity-unit pl-0 pr-0 text-center" aria-label="..." style="font-size: 0.7585em; background-color: #bde7e2">' +
                '<option value="0">Seleccione</option>' +
                '</select>' +
                '</div>' +
                '<div class="col-sm-6 pl-1">' +
                '<input type="text" aria-label="..." class="form-control text-center quantity-x-unit text-uppercase" readonly style="background-color: #bde7e2">' +
                '</div>' +
                '</td>' +*/
                '<td class="item-price text-right align-middle" price-unit-with-discount="">' + '<div class="input-icon">' +
                '<input type="text" class="form-control text-right text-uppercase price-unit-product" placeholder="0.00">' + '<i class="change-money">' + _val_money + '</i>' + '</div>' + '</td>' +
                '<td class="item-total text-right align-middle total-row">' + '<div class="input-icon">' +
                '<input type="text" class="form-control text-right text-uppercase total-detail" placeholder="0.00">' + '<i class="change-money">' + _val_money + '</i>' + '</div>' + '</td>' +
                '<td class="align-middle text-center"> ' + '<button type="button" onclick="deleteItem(this)" class="btn btn-danger delete-detail"><i class="fa fa-trash"></i></button>' + '</td>' +
                '</tr>');
            counterStrike()
        });

        $(document).on('keyup', '.total-detail', function () {
            let _tr = $(this).parent('div').parent('td').parent('tr')
            {#let _tr = $("#id_detail_data_grid tbody#details-table tr")#}
            let _total = Number(_tr.find('td.total-row div.input-icon input.total-detail').val());
            let _quantity = Number(_tr.find('td.item-quantity input.quantity-product').val())
            {#console.log('_total',_total)#}
            {#console.log('_quantity',_quantity)#}
            let price_unit = _total / _quantity
            {#console.log(price_unit)#}

            _tr.find('td.item-price div.input-icon input.price-unit-product').val(Number(price_unit).toFixed(2));
            calculate_total(_tr)
            sum_table()
        });

        function quantityDivideUnit(quantity, quantity_minimum, tr) {
            let _quantity_quantity_minimum = quantity / quantity_minimum
            tr.find('td.quantity-minimum input.quantity-minimum-val').val(_quantity_quantity_minimum.toFixed(2));
        }

        $(document).on('keyup', '.quantity-product', function () {

            let _tr = $(this).parent('td').parent('tr')
            let _quantity = Number(_tr.find('td.item-quantity input.quantity-product').val())
            let _quantity_minimum = Number((_tr.find('td.unit select.unit-product option:selected').attr("qm")))
            //let _price_unit = Number(_tr.find('td.item-price div.input-icon input.price-unit-product').val())
            //let _total = Number(_tr.find('td.total-row div.input-icon input.total-detail').val());

            //console.log("_tr", _tr.find('td.item-price div.input-icon input.price-unit-product'))
            //console.log("_quantity", _quantity)
            {#console.log("_price_unit", _price_unit)#}
            {#console.log("_total", _total)#}
            //console.log("_quantity_minimum", _quantity_minimum)
            if (!isNaN(_quantity_minimum)) {
                quantityDivideUnit(_quantity, _quantity_minimum, _tr)
            }
            /*if (_quantity !== 0 && _price_unit !== 0) {
                _total = _quantity * _price_unit
                _tr.find('td.item-total div.input-icon input.total-detail').val(Number(_total).toFixed(2));
            }*/
            calculate_total(_tr)
            sum_table()
        });

        $(document).on('keyup', '.price-unit-product', function () {

            let _tr = $(this).parent('div').parent('td').parent('tr')
            let _quantity = Number(_tr.find('td.item-quantity input.quantity-product').val())
            let _quantity_x_und = Number(_tr.find('td.item-quantity-x-unit input.quantity-x-unit').val())
            let _quantity_minimum = Number(_tr.find('td.quantity-minimum input.quantity-minimum-val').val())
            let _price_unit = Number(_tr.find('td.item-price div.input-icon input.price-unit-product').val())
            let _total = Number(_tr.find('td.total-row div.input-icon input.total-detail').val());

            //console.log("_quantity_x_und", _quantity_x_und)
            //console.log("_price_unit", _price_unit)
            //console.log("_total", _total)

            if (_quantity !== 0 && _price_unit !== 0) {
                _total = _quantity_minimum * _price_unit
                _tr.find('td.item-total div.input-icon input.total-detail').val(Number(_total).toFixed(4));
            }
            calculate_total(_tr)
            sum_table()
        });

        function calculate_total(_tr) {

            let $quantity = Number(_tr.find('td.item-quantity input.quantity-product').val());
            let $quantity_x_und = Number(_tr.find('td.item-quantity-x-unit input.quantity-x-unit').val())
            let $quantity_minimum = Number(_tr.find('td.quantity-minimum input.quantity-minimum-val').val())
            let $price_unit = Number(_tr.find('td.item-price input.price-unit-product').val());
            let $total = Number(_tr.find('td.total-row input.total-detail').val());
            let amount

            amount = $quantity_minimum * $price_unit

            _tr.find('td.total-row input.total-detail').val(amount.toFixed(4))

        }

        function sum_table() {
            let igv = 0;
            let base = 0;
            let sum_total = 0;
            let total_freight = 0;
            let total_document = 0;
            let _total;

            $("#id_detail_data_grid tbody#details-table tr").each(function () {
                let td_total = Number($(this).find("td.total-row input.total-detail").val());
                sum_total = sum_total + td_total
            });

            let _check_igv = $("#id_detail_data_grid tfoot tr input.check-igv")

            if (_check_igv.is(':checked')) {
                base = sum_total / 1.18
                igv = sum_total - base
                _total = base + igv
                total_document = _total

            } else {
                base = sum_total
                igv = sum_total * 0.18
                _total = base + igv
                total_document = _total
            }

            $("#id_detail_data_grid tfoot tr input.total-foot-base").val(base.toFixed(4));
            $("#id_detail_data_grid tfoot tr input.total-foot-igv").val(igv.toFixed(4));
            $("#id_detail_data_grid tfoot tr input.total-foot-total").val(_total.toFixed(4));
            $("#id_detail_data_grid tfoot tr input.total-foot-document").val(total_document.toFixed(4));
        }

        $(document).on('change', '#id_detail_data_grid tfoot tr input.check-igv', function (e) {
            sum_table()
        });


        $(document).on('change', '#payment_type', function (e) {
            let type_pay = $(this).val();
            if (type_pay === 'L') {
                $('.dues').removeClass('d-none');
                $('.table-dues').removeClass('d-none');
                {#$('#modal-debs').modal('show');#}
            } else {
                $('.dues').addClass('d-none');
                $('.table-dues').addClass('d-none');
                $("#details-dues").empty();
            }
        });

        function getAddress(client_id, _client_address) {
            let _select = $('#client_final_address');
            _select.empty();
            _select.append($('<option>').val("0").text('Seleccione'));
            if (_client_address !== '[]') {
                for (let i = 0; i < _client_address.length; i++) {
                    let option = $('<option>').val(_client_address[i]['id']).text(_client_address[i]['address'].toUpperCase());
                    _select.append(option);
                }
            }
            /*$.ajax({
                url: '/buys/get_address_by_client_id/',
                async: true,
                dataType: 'json',
                type: 'GET',
                data: {'client_id': client_id},
                success: function (response) {
                    _select.empty();
                    let _client_address = JSON.parse(response['client_address_set']);
                    //console.log(_client_address)
                    _select.append($('<option>').val("0").text('Seleccione'));
                    if (response['client_address_set'] !== '[]') {
                        for (let i = 0; i < _client_address.length; i++) {
                            let option = $('<option>').val(_client_address[i]['pk']).text(_client_address[i]['fields']['address'].toUpperCase());
                            _select.append(option);
                        }
                    }
                },
            });*/
        }

        /*$(document).on('change', '#client_reference_id', function (e) {
            let client_id = $(this).val();
            let _select = $('#client_address_reference')

            if (client_id !== '0') {
                let type_client = $('#client_reference_id option:selected').attr("type");
                if (type_client === 'PR') {
                    $('#client_final').val("0");
                    $('#client_final_address').val("0");
                    $('.client-final').removeClass('d-none');
                    $('.delivery-client-final').removeClass('d-none');
                    $('.delivery-client').addClass('d-none');

                } else {
                    $('.client-final').addClass('d-none');
                    $('#client_final_address').val("0");
                    $('.delivery-client-final').addClass('d-none');
                    $('.delivery-client').removeClass('d-none');
                    getAddress(client_id, _select)
                }

            } else {
                toastr.warning('Seleccione un cliente valido', 'Error de llenado');
                return false;
            }
        });*/

        $(document).on('change', '#client_final', function (e) {
            let client_id = $(this).val();
            let _select = $('#client_final_address');
            getAddress(client_id, _select);
        });

        $(document).on('change', '#check-subsidiary', function (e) {
            if ($(this).is(":checked")) {
                $(this).attr("checked");
                $('#check-provider').prop('checked', false);
                $('#check-client').prop('checked', false);
                $('#check-client-final').prop('checked', false);
            }
        });
        $(document).on('change', '#check-provider', function (e) {
            if ($(this).is(":checked")) {
                $(this).attr("checked");
                $('#check-subsidiary').prop('checked', false);
                $('#check-client').prop('checked', false);
                $('#check-client-final').prop('checked', false);
            }
        });
        $(document).on('change', '#check-client', function (e) {
            if ($(this).is(":checked")) {
                $(this).attr("checked");
                $('#check-subsidiary').prop('checked', false);
                $('#check-provider').prop('checked', false);
                $('#check-client-final').prop('checked', false);
            }
        });
        $(document).on('change', '#check-client-final', function (e) {
            if ($(this).is(":checked")) {
                $(this).attr("checked");
                $('#check-subsidiary').prop('checked', false);
                $('#check-provider').prop('checked', false);
                $('#check-client').prop('checked', false);
            }
        });

        $(document).on('change', '#supplier_id', function (e) {
            let supplier_id = $(this).val();
            let _select = $('#address_provider');
            if (supplier_id !== '0') {
                $.ajax({
                    url: '/buys/get_address_by_supplier_id/',
                    async: true,
                    dataType: 'json',
                    type: 'GET',
                    data: {'supplier_id': supplier_id},
                    success: function (response) {
                        _select.empty();
                        let _supplier_address = JSON.parse(response['supplier_address_set']);
                        //console.log(_supplier_address)
                        _select.append($('<option>').val("0").text('Seleccione'));
                        if (response['client_address_set'] !== '[]') {
                            for (let i = 0; i < _supplier_address.length; i++) {
                                let option = $('<option>').val(_supplier_address[i]['pk']).text(_supplier_address[i]['fields']['address'].toUpperCase());
                                _select.append(option);
                            }
                        }
                    },
                });
            }
        });

        new Autocomplete('#autocomplete-client', {
            search: input => {
                const url = `/buys/get_client/?search=${encodeURI(input.toUpperCase())}`

                return new Promise(resolve => {
                    if (input.length < 3) {
                        //$('#person-number').val('')
                        //$('#order-number').val('')
                        return resolve([])
                    }
                    fetch(url)
                        .then(response => response.json())
                        .then(data => {
                            resolve(data.client)
                        })
                })
            },
            renderResult: (result, props) => {
                let group = ''
                if (result.index % 3 === 0) {
                    group = '<li class="group">Group</li>'
                }
                return `
                ${group}
                <li ${props}>
                 <div class="h6" style="font-family: roboto_condensed_regular">
                    ${result.names}
                 </div>
                 <div class="wiki-snippet text-black">
                    Tipo: ${result.type_client_display}
                  </div>
                </li>
                `
            },
            getResultValue: result => result.names,
            onSubmit: handleClientSubmit
        })

        async function handleClientSubmit(result) {
            if (result) {
                let client_id = result.id;
                let _select = $('#client_address_reference');
                let type_client = result.type_client;
                let _client_address = result.address;
                $('#client_reference_id').val(client_id);
                $('#client_final').val('');
                $('#person-final-names').val("");
                if (type_client === 'PR') {
                    $('#client_final_address').val("0");
                    $('.client-final').removeClass('d-none');
                    $('.delivery-client-final').removeClass('d-none');
                    $('.delivery-client').addClass('d-none');

                } else {
                    $('.client-final').addClass('d-none');
                    $('#client_final_address').val("0");
                    $('.delivery-client-final').addClass('d-none');
                    $('.delivery-client').removeClass('d-none');
                    //await getAddress(client_id, _client_address)
                    _select.empty();
                    //console.log("_result", result)
                    _select.append($('<option>').val("0").text('Seleccione'));
                    if (_client_address !== '[]') {
                        for (let i = 0; i < _client_address.length; i++) {
                            let option = $('<option>').val(_client_address[i]['id']).text(_client_address[i]['address'].toUpperCase());
                            _select.append(option);
                        }
                    }
                }
            } else {
                toastr.warning('Seleccione un cliente valido', 'Error de llenado');
                return false;
            }
        }

        new Autocomplete('#autocomplete-client-final', {
            search: input => {
                const url = `/buys/get_client/?search=${encodeURI(input.toUpperCase())}`

                return new Promise(resolve => {
                    if (input.length < 3) {
                        return resolve([])
                    }
                    fetch(url)
                        .then(response => response.json())
                        .then(data => {
                            resolve(data.client)
                        })
                })
            },
            renderResult: (result, props) => {
                let group = ''
                if (result.index % 3 === 0) {
                    group = '<li class="group">Group</li>'
                }
                return `
                ${group}
                <li ${props}>
                 <div class="h6" style="font-family: roboto_condensed_regular">
                    ${result.names}
                 </div>
                 <div class="wiki-snippet text-black">
                    Tipo: ${result.type_client_display}
                  </div>
                </li>
                `
            },
            getResultValue: result => result.names,
            onSubmit: result => {
                if (result) {
                    let client_id = result.id;
                    let _client_address = result.address;
                    let _select = $('#client_final_address');
                    $('#client_final').val(client_id);
                    _select.empty();
                    _select.append($('<option>').val("0").text('Seleccione'));
                    if (_client_address !== '[]') {
                        for (let i = 0; i < _client_address.length; i++) {
                            let option = $('<option>').val(_client_address[i]['id']).text(_client_address[i]['address'].toUpperCase());
                            _select.append(option);
                        }
                    }
                }
            }
        })

    </script>

{% endblock extrajs %}