{% load static %}
<div class="modal-dialog modal-xl" role="document">

    <div class="modal-content">
        <div id="modal-loader" class="overlay" style="display: none">
            <i class="fas fa-3x fa-sync fa-spin"></i>
        </div>
        <div class="modal-header bg-primary text-white">
            <h5 class="modal-title font-weight-bold roboto-condensed-light text-white">
                <i class="fas fa-file-contract mr-2"></i>REGISTRAR NUEVO CONTRATO
            </h5>
            <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>

        <div class="modal-body p-2 roboto-condensed-regular">
            <div class="card">
                <div class="card-body bg-light">
                    <div class="row">
                        <div class="col-lg-12">
                            <div class="row p-1">
                                <div class="col-9">
                                    <label class="font-weight-light" for="client_id">Cliente:</label>
                                    <div class="position-relative">
                                        <div class="input-group">
                                            <div class="input-group-prepend">
                                                <span class="input-group-text bg-light">
                                                    <i class="fas fa-user text-primary"></i>
                                                </span>
                                            </div>
                                            <input type="text" aria-label="..."
                                                   class="form-control form-control-sm text-uppercase client-table"
                                                   id="client_search"
                                                   placeholder="Buscar cliente (mínimo 3 caracteres)..."
                                                   autocomplete="off">
                                        </div>
                                        <div id="client-autocomplete-results" class="autocomplete-results" style="display: none;"></div>
                                    </div>
                                    <input type="hidden"
                                           id="client_id"
                                           name="client">
                                </div>
                                <div class="col-lg-3">
                                    <label class="font-weight-light"
                                           for="number_contract">Nº de Contrato:</label>
                                    <div class="input-group">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text">
                                                <i class="fas fa-id-badge"></i>
                                            </span>
                                        </div>
                                        <input type="text" class="form-control form-control-sm number-contract"
                                               id="number_contract"
                                               name="number-contract" autocomplete="off">
                                    </div>
                                </div>
                            </div>
                            <div class="row p-1">
                                <div class="col-lg-3">
                                    <label class="font-weight-light" for="register_date">Fecha de
                                        registro</label>
                                    <input type="date" class="form-control form-control-sm" id="register_date"
                                           name="register-name" value="{{ date_now }}">
                                </div>
                                <div class="col-sm-6 col-md-6 col-lg-6">
                                    <label for="observations" class="">Observaciones:</label>
                                    <input type="text" class="form-control form-control-sm" id="observations"
                                           name="observations"
                                           placeholder="...">
                                </div>
                                <div class="col-sm-3 col-md-3 col-lg-3">
                                    <label for="user_id">Vendedor:</label>
                                    <select id="user_id" name="user" class="form-control form-control-sm">
                                        <option selected disabled value="0">Seleccione..</option>
                                        {% for u in user_set %}
                                            <option value="{{ u.id }}">{{ u.username|upper }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="row p-1 mb-2">
                                <div class="col-12">
                                    <div class="card border-primary shadow-sm">
                                        <div class="card-header bg-primary text-white py-1">
                                            <h6 class="mb-0 font-weight-bold roboto-condensed-light text-white" style="font-size: 0.9rem;">
                                                <i class="fas fa-boxes mr-1"></i>PRODUCTOS Y ENTREGAS
                                            </h6>
                                        </div>
                                        <div class="card-body p-2">
                                            <div class="row align-items-center mb-2">
                                                <div class="col-12">
                                                    <div class="d-flex align-items-center">
                                                        <label class="font-weight-bold text-dark mb-0 mr-2" for="nro_dates" style="font-size: 0.85rem;">
                                                            <i class="fas fa-calendar-check mr-1"></i>Nº de Entregas:
                                                        </label>
                                                        <div class="input-group input-group-sm" style="max-width: 150px;">
                                                            <div class="input-group-prepend">
                                                                <span class="input-group-text bg-primary text-white">
                                                                    <i class="fas fa-hashtag"></i>
                                                                </span>
                                                            </div>
                                                            <input type="text"
                                                                   class="form-control text-center font-weight-bold"
                                                                   id="nro_dates" name="nro-dates" placeholder="0">
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="table-responsive">
                                                <table id="table-product-add"
                                                       class="table table-sm table-hover align-content-center mb-1"
                                                       style="border: 1px solid #dee2e6; font-size: 0.85rem;">
                                                    <thead class="thead-light">
                                                    <tr>
                                                        <th scope="col" class="align-middle font-weight-bold text-center py-1"
                                                            style="width: 40%; color: #495057; background-color: #f8f9fa; font-size: 0.8rem;">
                                                            <i class="fas fa-box mr-1"></i>Producto
                                                        </th>
                                                        <th scope="col" class="align-middle font-weight-bold text-center py-1"
                                                            style="width: 12%; color: #495057; background-color: #f8f9fa; font-size: 0.8rem;">
                                                            <i class="fas fa-ruler mr-1"></i>Tipo UND
                                                        </th>
                                                        <th scope="col" class="align-middle font-weight-bold text-right py-1"
                                                            style="width: 12%; color: #495057; background-color: #f8f9fa; font-size: 0.8rem;">
                                                            <i class="fas fa-sort-numeric-up mr-1"></i>Cantidad
                                                        </th>
                                                        <th scope="col" class="align-middle font-weight-bold text-right py-1"
                                                            style="width: 12%; color: #495057; background-color: #f8f9fa; font-size: 0.8rem;">
                                                            <i class="fas fa-dollar-sign mr-1"></i>Precio Unit.
                                                        </th>
                                                        <th scope="col" class="align-middle font-weight-bold text-right py-1"
                                                            style="width: 14%; color: #495057; background-color: #f8f9fa; font-size: 0.8rem;">
                                                            <i class="fas fa-calculator mr-1"></i>Monto
                                                        </th>
                                                        <th scope="col" class="align-middle font-weight-bold text-center py-1"
                                                            style="width: 10%; color: #495057; background-color: #f8f9fa; font-size: 0.8rem;">
                                                            <i class="fas fa-cog mr-1"></i>Acción
                                                        </th>
                                                    </tr>
                                                    </thead>
                                                    <tbody id="tbody-product-add">
                                                    <tr class="text-center" i="1">
                                                        <td class="item-product-add align-middle py-1">
                                                            <select id="product_add-id"
                                                                    class="form-control form-control-sm product-add">
                                                                <option value="0">Seleccione producto</option>
                                                                {% for p in product_set %}
                                                                    <option value="{{ p.id }}">{{ p.name }}</option>
                                                                {% endfor %}
                                                            </select>
                                                        </td>
                                                        <td class="item-unit-add align-middle py-1">
                                                            <select class="form-control form-control-sm unit-add" disabled>
                                                                <option value="0">Seleccione producto</option>
                                                            </select>
                                                        </td>
                                                        <td class="item-quantity-add align-middle py-1">
                                                            <input type="text" class="form-control form-control-sm text-right quantity-add"
                                                                   placeholder="0.00" autocomplete="off">
                                                        </td>
                                                        <td class="item-price-unit-add align-middle py-1">
                                                            <input type="text" class="form-control form-control-sm text-right price-unit-add"
                                                                   placeholder="0.00" autocomplete="off">
                                                        </td>
                                                        <td class="item-amount-add align-middle py-1">
                                                            <input type="text" class="form-control form-control-sm text-right amount-add font-weight-bold"
                                                                   placeholder="0.00" autocomplete="off" readonly style="background-color: #f8f9fa;">
                                                        </td>
                                                        <td class="align-middle py-1">
                                                            <button type="button" onclick="addProductHeader()"
                                                                    class="btn btn-outline-success btn-sm rounded-pill" style="padding: 0.15rem 0.5rem;">
                                                                <i class="fas fa-plus"></i>
                                                            </button>
                                                        </td>
                                                    </tr>
                                                    </tbody>
                                                </table>
                                            </div>
                                            <div class="row mt-2">
                                                <div class="col-sm-6 col-md-6 col-lg-6">
                                                    <button type="button" id="btn-add-dates"
                                                            class="btn btn-success btn-sm btn-block rounded-pill font-weight-bold"
                                                            onclick="addDates()">
                                                        <i class="fas fa-calendar-plus mr-1"></i>Agregar Fechas
                                                    </button>
                                                </div>
                                                <div class="col-sm-6 col-md-6 col-lg-6">
                                                    <button type="button" id="clean-dates"
                                                            class="btn btn-danger btn-sm btn-block rounded-pill font-weight-bold">
                                                        <i class="fas fa-eraser mr-1"></i>Limpiar
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <div class="d-flex pt-4 pb-3">
                                <hr class="my-auto flex-grow-1 bg-primary">
                                <div class="px-3 font-weight-bold text-primary" style="font-size: 1.1375rem;">
                                    <i class="fas fa-calendar-alt mr-2"></i>FECHAS DE ENTREGA
                                </div>
                                <hr class="my-auto flex-grow-1 bg-primary">
                            </div>

                            <div class="row pt-2">
                                <div class="col-sm-12 col-md-12 col-lg-12 dates-quotas">

                                </div>
                            </div>
                            <div class="row pt-2">
                                <div class="col-12">
                                    <div class="d-flex justify-content-end align-items-center">
                                        <div class="mr-4">
                                            <label class="font-weight-bold text-dark mb-1" style="font-size: 0.9rem;">
                                                <i class="fas fa-calculator mr-1 text-primary"></i>TOTAL CANTIDAD:
                                            </label>
                                            <input type="text" class="form-control form-control-sm text-right font-weight-bold border-primary"
                                                   id="total-quantity" aria-label="..."
                                                   placeholder="0.00" readonly style="min-width: 120px; background-color: #e7f3ff;">
                                        </div>
                                        <div>
                                            <label class="font-weight-bold text-dark mb-1" style="font-size: 0.9rem;">
                                                <i class="fas fa-money-bill-wave mr-1 text-success"></i>TOTAL MONTO:
                                            </label>
                                            <input type="text" class="form-control form-control-sm text-right font-weight-bold border-success"
                                                   id="total-amount" aria-label="..."
                                                   placeholder="0.00" readonly style="min-width: 120px; background-color: #d4edda;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- /.card -->
            </div>
        </div><!-- modal-body -->
        <div class="modal-footer bg-light p-3">
            <button type="button" class="btn btn-secondary font-weight-light" data-dismiss="modal">
                <i class="fas fa-times mr-1"></i>Cerrar
            </button>
            <button id="btn-save-contract" type="button" class="btn btn-primary font-weight-light">
                <i class="fas fa-save mr-1"></i>Registrar Contrato
            </button>
        </div>

        <div class="mr-3 ml-0" style="
                display: none;
                position: fixed;
                top: 8px;
                left: 5px;
                background: #bdd9f5;
                opacity: 0.5;
                width: 100%;
                {#height: 46em;#}
                !important;bottom: 6px;
                padding-right: 65em;
                padding-left: 55em;
                padding-top: 22em;" id="loading">

        </div>
    </div>
</div>


<style>
    .autocomplete-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        z-index: 1000;
        background: white;
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        max-height: 300px;
        overflow-y: auto;
        margin-top: 2px;
    }

    .autocomplete-item {
        padding: 0.75rem 1rem;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        transition: background-color 0.2s ease;
        display: flex;
        align-items: center;
    }

    .autocomplete-item:last-child {
        border-bottom: none;
    }

    .autocomplete-item:hover,
    .autocomplete-item.active {
        background-color: #f8f9fa;
        color: #0056b3;
    }

    .autocomplete-item .client-name {
        font-weight: 600;
        color: #212529;
        flex: 1;
    }

    .autocomplete-item .client-doc {
        font-size: 0.85rem;
        color: #6c757d;
        margin-left: 0.5rem;
    }

    .autocomplete-item:hover .client-name,
    .autocomplete-item.active .client-name {
        color: #0056b3;
    }

    .autocomplete-loading {
        padding: 1rem;
        text-align: center;
        color: #6c757d;
    }

    .autocomplete-loading i {
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    .autocomplete-no-results {
        padding: 1rem;
        text-align: center;
        color: #6c757d;
        font-style: italic;
    }
</style>

<script type="text/javascript">

    loader = '<div class="container">' +
        '<div class="row">' +
        '<div class="col-md-12">' +
        '<div class="loader">' +
        '<p><strong><h4>Consultando datos...</h4></strong></p>' +
        '<div class="loader-inner"></div>' +
        '<div class="loader-inner"></div>' +
        '<div class="loader-inner"></div>' +
        '</div>' +
        '</div>' +
        '</div>' +
        '</div>';

    let searchTimeout;
    let selectedIndex = -1;

    // Autocomplete mejorado para cliente
    $(document).on('input', '#client_search', function() {
        clearTimeout(searchTimeout);
        let $input = $(this);
        let $results = $('#client-autocomplete-results');
        let query = $input.val().trim();

        if (query.length < 3) {
            $results.hide().empty();
            selectedIndex = -1;
            return;
        }

        // Mostrar loading
        $results.html('<div class="autocomplete-loading"><i class="fas fa-spinner fa-spin mr-2"></i>Buscando...</div>').show();

        searchTimeout = setTimeout(function() {
            $.ajax({
                url: '/sales/get_clients_by_criteria/',
                type: 'GET',
                data: { 'value': query },
                dataType: 'json',
                headers: {"X-CSRFToken": '{{ csrf_token }}'},
                success: function(response) {
                    $results.empty();
                    selectedIndex = -1;

                    if (response.client_list && response.client_list.length > 0) {
                        response.client_list.forEach(function(client, index) {
                            let $item = $('<div class="autocomplete-item" data-id="' + client.client_id + 
                                         '" data-name="' + client.client_names + 
                                         '" data-doc="' + client.client_document_number + 
                                         '" data-address="' + (client.client_address || '') + 
                                         '" data-type-doc="' + (client.client_type_document || '') + '">' +
                                         '<span class="client-name"><i class="fas fa-user-circle mr-2 text-primary"></i>' + client.client_names + '</span>' +
                                         '<span class="client-doc">RUC: ' + client.client_document_number + '</span>' +
                                         '</div>');
                            $results.append($item);
                        });
                    } else {
                        $results.html('<div class="autocomplete-no-results">No se encontraron clientes</div>');
                    }
                },
                error: function() {
                    $results.html('<div class="autocomplete-no-results">Error al buscar clientes</div>');
                }
            });
        }, 300);
    });

    // Seleccionar cliente al hacer clic
    $(document).on('click', '.autocomplete-item', function() {
        let $item = $(this);
        let clientId = $item.attr('data-id');
        let clientName = $item.attr('data-name');

        $('#client_id').val(clientId);
        $('#client_search').val(clientName);
        $('#client-autocomplete-results').hide().empty();
        selectedIndex = -1;
    });

    // Navegación con teclado
    $(document).on('keydown', '#client_search', function(e) {
        let $results = $('#client-autocomplete-results');
        let $items = $results.find('.autocomplete-item');

        if ($items.length === 0) return;

        if (e.keyCode === 40) { // Flecha abajo
            e.preventDefault();
            selectedIndex = (selectedIndex < $items.length - 1) ? selectedIndex + 1 : 0;
            $items.removeClass('active').eq(selectedIndex).addClass('active');
            $results.scrollTop($items.eq(selectedIndex).position().top + $results.scrollTop() - 50);
        } else if (e.keyCode === 38) { // Flecha arriba
            e.preventDefault();
            selectedIndex = (selectedIndex > 0) ? selectedIndex - 1 : $items.length - 1;
            $items.removeClass('active').eq(selectedIndex).addClass('active');
            $results.scrollTop($items.eq(selectedIndex).position().top + $results.scrollTop() - 50);
        } else if (e.keyCode === 13) { // Enter
            e.preventDefault();
            if (selectedIndex >= 0 && $items.eq(selectedIndex).length) {
                $items.eq(selectedIndex).click();
            }
        } else if (e.keyCode === 27) { // ESC
            $results.hide().empty();
            selectedIndex = -1;
        }
    });

    // Ocultar resultados al hacer clic fuera
    $(document).on('click', function(e) {
        if (!$(e.target).closest('#client_search, #client-autocomplete-results').length) {
            $('#client-autocomplete-results').hide();
        }
    });

    $(document).on('click', '#btn-save-contract', function (e) {
        if (old_timestamp == null || old_timestamp + 2000 < e.timeStamp) {
            let _save = saveContract();
            if (_save !== false) {
                old_timestamp = e.timeStamp;
                $(this).slideUp();
            }
        }
    });


</script>