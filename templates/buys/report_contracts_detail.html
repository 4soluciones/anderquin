{% extends 'home.html' %}

{% block title %}
    Fechas de Entrega
{% endblock title %}

{% block body %}

    <div class="card m-1 bg-light">
        <div class="row">
            <div class="col-lg-2 pt-3 ml-3">

            </div>
            <div class="col-lg-8 text-center pt-2">
                <h2 class="font-weight-bold roboto-condensed-regular"> LISTADO DE ENTREGAS PENDIENTES</h2>
            </div>
        </div>

        <div class="card-body pt-0">
            <div class="row mt-1">
                <div id="file-list-grid" class="table-responsive small">
                    <div id="client-grid-list">{% include "buys/report_contracts_detail_grid.html" %}</div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modal-phase" tabindex="-1" role="dialog"
         aria-labelledby="ModalHelpTitle" data-backdrop="static" data-keyboard="false"
         aria-hidden="true"></div>

{% endblock body %}

{% block extrajs %}

    <script type="text/javascript">
        let activeCheckbox = null;
        $(document).on('change', '.check-c', function () {
            if ($(this).is(":checked")) {
                modal_phase($(this).attr("order"), 'C')
                activeCheckbox = this;
            } else {
                console.log("false")
            }
        });
        $(document).on('change', '.check-d', function () {
            if ($(this).is(":checked")) {
                modal_phase($(this).attr("order"), 'D')
                activeCheckbox = this;
            } else {
                console.log("false")
            }
        });
        $(document).on('change', '.check-g', function () {
            if ($(this).is(":checked")) {
                modal_phase($(this).attr("order"), 'G')
                activeCheckbox = this;
            } else {
                console.log("false")
            }
        });

        function modal_phase(order, phase) {

            $.ajax({
                url: '/comercial/modal_phase/',
                dataType: 'json',
                type: 'GET',
                data: {'order': order, 'phase': phase},
                success: function (response, textStatus, xhr) {
                    if (response.success) {
                        $('#modal-phase').html(response.form);
                        $('#modal-phase').modal('show');

                    } else {
                        toastr.error(response.message, 'Error');
                    }
                },
                fail: function (response) {
                    toastr.error('Ocurrio un problema al mostrar el formulario', '¡Mensaje!');
                }
            });
        }

        $(document).on('click', '#close-modal', function () {
            $('#modalConfirm').modal('hide');

            if (activeCheckbox) {
                $(activeCheckbox).prop('checked', false);
                activeCheckbox = null; // limpiamos
            }
        });

        // Cuando se hace clic en el botón de registrar garantía
        $(document).on('click', '.check-warranty', function() {
            let orderId = $(this).attr('order');
            $('#warranty-order-id').val(orderId);

            // Establecer fecha actual
            let today = new Date().toISOString().split('T')[0];
            $('#warranty-payment-date').val(today);
        });

        // Guardar fecha de pago de garantía
    $('#save-warranty-payment').on('click', function () {
        let orderId = $('#warranty-order-id').val();
        let paymentDate = $('#warranty-payment-date').val();

        if (!paymentDate) {
            toastr.error('Por favor seleccione una fecha', '¡Mensaje!');
            return false;
        }

        $.ajax({
            url: '/buys/save_warranty_payment/',
            dataType: 'json',
            type: 'GET',
            data: {
                'order': orderId,
                'payment_date': paymentDate,
            },
            success: function (response) {
                if (response.success) {
                    let order = response.order_id;
                    let paymentDate = response.payment_date;
                    let [year, month, day] = paymentDate.split('-');
                    let formattedDateStr = `${day}-${month}-${year}`;

                    // Actualizar la celda de garantía - buscar el div que contiene el botón
                    let targetDiv = $(`.check-warranty[order="${order}"]`).closest('div[order]');
                    if (targetDiv.length === 0) {
                        // Si no se encuentra, buscar directamente el div con el atributo order
                        targetDiv = $(`div[order="${order}"]`).filter(function () {
                            return $(this).find('.check-warranty').length > 0 || $(this).text().includes('Registrar');
                        });
                    }

                    if (targetDiv.length > 0) {
                        targetDiv.html(`<div class="small text-success font-weight-bold">${formattedDateStr}</div>`);
                    } else {
                        // Recargar la página si no se encuentra el elemento
                        setTimeout(function () {
                            location.reload();
                        }, 1000);
                    }

                    toastr.success('Fecha de pago de garantía registrada', '¡Mensaje!');
                    $('#modal-warranty').modal('hide');
                } else {
                    toastr.error(response.message || 'Error al guardar', 'Error');
                }
            },
            error: function () {
                toastr.error('Ocurrió un problema al guardar la fecha', '¡Mensaje!');
            }
        });
    });

    </script>

{% endblock extrajs %}