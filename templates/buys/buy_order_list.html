{% extends 'home.html' %}

{% block title %}
    Listado de Ordenes de compras
{% endblock title %}

{% block body %}


    <div class="card m-0 ml-1 mr-1">
        <div class="card-header" style="background: #3e6787">
            <h4 class="card-title text-center text-white roboto-condensed-regular">LISTA DE ORDENES DE COMPRAS</h4>
        </div>
        <div class="card-body p-0">
            <div class="" id="purchase-grid-list">{% include "buys/buy_order_grid_list.html" %}</div>
        </div>

    </div>


    <div class="modal fade" id="assignment" data-backdrop="static" data-keyboard="false"
         tabindex="-1" role="dialog" aria-labelledby="ModalHelpTitle"
         aria-hidden="true"></div>

    <div class="modal fade" id="modal-credit-note" tabindex="-1" role="dialog"
         aria-labelledby="ModalHelpTitle"
         aria-hidden="true"></div>

{#    <div class="modal fade" id="modal-assign-store" tabindex="-1" role="dialog"#}
{#         aria-labelledby="ModalHelpTitle"#}
{#         aria-hidden="true"></div>#}

    <style>
        .input-icon {
            position: relative;
        }

        .input-icon > i {
            position: absolute;
            display: block;
            transform: translate(0, -50%);
            top: 50%;
            pointer-events: none;
            width: 25px;
            text-align: center;
            font-style: normal;
        }

        .input-icon > input {
            padding-left: 25px;
            padding-right: 8px;
        }

        .input-icon-right > i {
            right: 0;
        }

        .input-icon-right > input {
            padding-left: 0;
            padding-right: 25px;
            text-align: right;
        }

    </style>

{% endblock body %}

{% block extrajs %}

    <script type="text/javascript">

        $(document).on('click', '.assignment-store', function () {
            let search = $(this).attr('pk');
            $.ajax({
                url: '/buys/get_detail_purchase_store/',
                dataType: 'json',
                type: 'GET',
                data: {'pk': search},

                contentType: 'application/json;charset=UTF-8',
                headers: {"X-CSRFToken": '{{ csrf_token }}'},
                success: function (response, textStatus, xhr) {
                    if (xhr.status === 200) {
                        $('#assignment').html(response.form);
                        $('#assignment').modal('show');

                    }
                },
                error: function (jqXhr, textStatus, xhr) {
                    //$('#assignment').html(jqXhr.form);
                    toastr.error(jqXhr.responseJSON.detalle, '¡MENSAJE!');
                }

            });
        });

        $(document).on('click', '.btn-annular', function () {
            let search = $(this).attr('pk');
            let mensaje = confirm("¿Esta seguro de anular la compra?");
            if (mensaje) {
                $.ajax({
                    url: '/buys/update_state_annular_purchase/',
                    dataType: 'json',
                    type: 'GET',
                    data: {'pk': search},
                    success: function (response) {
                        toastr.success(response.message, '¡COMPRA ANULADA CORRECTAMENTE!');
                        setTimeout(() => {
                            location.reload();
                        }, 500);
                    },
                    fail: function (response) {
                        toastr.error(response.message, '¡PROBLEMAS AL ANULAR LA COMPRA!');
                    }
                });
            }
        });

        //let count = 0;
        //let array_purchase_id = []

        /*$(document).on('click', '.check-purchase', function () {
            let _tr = $(this).parent('td').parent('tr');
            let _purchase_id = _tr.attr("pk");
            if (this.checked) {
                count++;
                array_purchase_id.push(_purchase_id)
            } else {
                count--;
                array_purchase_id = array_purchase_id.filter(item => item !== _purchase_id);
            }
            console.log(array_purchase_id)
            $('#btn-assign-store span.badge').text(count);
        });

        $(document).on('click', '#btn-assign-store', function () {
            if (array_purchase_id.length === 0) {
                toastr.warning('Favor de seleccionar al menos una ORDEN DE COMPRA', 'Error de Datos');
                return false;
            }
            console.log(array_purchase_id)
            $.ajax({
                url: '/buys/assign_store_modal/',
                dataType: 'json',
                type: 'GET',
                data: {'array_purchases': JSON.stringify(array_purchase_id)},
                success: function (response) {
                    $('#modal-assign-store').html(response.form);
                    $('#modal-assign-store').modal('show');
                },
                fail: function (response) {
                    toastr.error('Error en la petición', '¡Mensaje!');
                }
            });
        });*/


        $(document).on('click', '.btn-update', function () {
            let _purchase = $(this).attr('pk');
            let mensaje = confirm("¿Editar la compra seleccionada?");
            if (mensaje) {
                window.open("/buys/update_purchase/" + _purchase + "/", '_blank');
            }
        });

        $(document).on('click', '.btn-show-detail', function () {
            let _id = $(this).attr('pk');
            let _table = $(this).closest('td').parent('tr').next('tr').children('td.table-details-purchase');
            let _icon = $(this).find('i.see-icon')

            if (_icon.hasClass("fas fa-sort-down fa-lg")) {
                _icon.removeClass('fas fa-sort-down fa-lg');
                _icon.addClass('fas fa-sort-up fa-lg')

                openDetail(_id, _table)
            } else {
                _icon.removeClass('fas fa-sort-up fa-lg');
                _icon.addClass('fas fa-sort-down fa-lg');

                closeDetail(_table)
            }
        });

        function openDetail(_id, _table) {
            $.ajax({
                url: '/buys/get_details_by_buy/',
                async: true,
                dataType: 'json',
                type: 'GET',
                data: {'ip': _id},
                success: function (response) {
                    _table.html(response.grid);
                    _table.parent('tr').slideDown("fast");
                },
            });
        }

        function closeDetail($td) {
            $td.parent('tr').slideUp("fast");
        }

        $(document).on('click', '.generate-credit-note', function () {
            let purchase_detail_id = $(this).attr('pk');
            $.ajax({
                url: '/buys/buys_credit_note/',
                dataType: 'json',
                type: 'GET',
                data: {'purchase_detail_id': purchase_detail_id},
                success: function (response) {
                    $('#modal-credit-note').html(response.form);
                    $('#modal-credit-note').modal('show');
                },
                fail: function (response) {
                    toastr.error('Error en la petición', '¡Mensaje!');
                }
            });
        });


    </script>
{% endblock extrajs %}
