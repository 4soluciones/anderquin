{% load static %}
{% load operations %}
<div class="modal-dialog modal-xl roboto-condensed-regular" role="document">

    <div class="modal-content">
        <div id="modal-loader" class="overlay" style="display: none">
            <i class="fas fa-3x fa-sync fa-spin"></i>
        </div>
        <div class="modal-header bg-warning text-dark">
            <h5 class="modal-title font-weight-bold roboto-condensed-regular">
                <i class="fas fa-edit mr-2"></i>EDITAR CONTRATO: {{ contract_obj.contract_number }}
            </h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
        <form id="contract-update-form" action="{% url 'buys:save_update_contract' %}" method="POST">
            {% csrf_token %}
            <div class="modal-body p-2">
                <div class="card">
                    <div class="card-body bg-light">
                        <div class="row">
                            <div class="col-lg-12">
                                <div class="row p-1">
                                    <div class="col-6">
                                        <input type="hidden"
                                               value="{{ contract_obj.id }}"
                                               id="contract_id"
                                               name="contract">
                                        <label class="font-weight-light" for="client_id_update">Cliente:</label>
                                        <div class="position-relative">
                                            <div class="input-group">
                                                <div class="input-group-prepend">
                                                    <span class="input-group-text bg-light">
                                                        <i class="fas fa-user text-primary"></i>
                                                    </span>
                                                </div>
                                                <input type="text" aria-label="..."
                                                       class="form-control form-control-sm text-uppercase client-table-update"
                                                       id="client_search_update"
                                                       value="{{ contract_obj.client }}" required
                                                       placeholder="Buscar cliente (mínimo 3 caracteres)..."
                                                       autocomplete="off">
                                            </div>
                                            <div id="client-autocomplete-results-update" class="autocomplete-results" style="display: none;"></div>
                                        </div>
                                        <input type="hidden"
                                               value="{{ contract_obj.client.id }}"
                                               id="client_id_update"
                                               name="client">
                                    </div>
                                    <div class="col-lg-6">
                                        <label class="font-weight-light"
                                               for="number_contract">Nº de Contrato:</label>
                                        <div class="input-group">
                                            <div class="input-group-prepend">
                                            <span class="input-group-text">
                                                <i class="fas fa-id-badge"></i>
                                            </span>
                                            </div>
                                            <input type="text" class="form-control form-control-sm number-contract"
                                                   id="number_contract_update" required
                                                   value="{{ contract_obj.contract_number }}"
                                                   name="number_contract_update" autocomplete="off">
                                        </div>
                                    </div>
                                </div>
                                <div class="row p-1">
                                    <div class="col-lg-3">
                                        <label class="font-weight-light" for="register_date">Fecha de
                                            registro</label>
                                        <input type="date" class="form-control form-control-sm"
                                               id="register_date_update"
                                               name="register_date_update" required
                                               value="{{ contract_obj.register_date|date:'Y-m-d' }}">
                                    </div>
                                    <div class="col-sm-3 col-md-3 col-lg-3">
                                        <label for="user_id_update">Vendedor:</label>
                                        <select id="user_id_update" name="user_update" required
                                                class="form-control form-control-sm">
                                            <option selected disabled value="0">Seleccione..</option>
                                            {% for u in user_set %}
                                                {% if u.id == contract_obj.user.id %}
                                                    <option selected value="{{ u.id }}">{{ u.username|upper }}</option>
                                                {% else %}
                                                    <option value="{{ u.id }}">{{ u.username|upper }}</option>
                                                {% endif %}
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-sm-6 col-md-6 col-lg-6">
                                        <label for="observations_update" class="">Observaciones:</label>
                                        <input type="text" class="form-control form-control-sm" id="observations_update"
                                               name="observations_update"
                                               value="{{ contract_obj.observation }}"
                                               placeholder="...">
                                    </div>
                                </div>
                                <div class="row p-1 mb-2">
                                    <div class="col-12">
                                        <div class="card border-primary shadow-sm">
                                            <div class="card-header bg-primary text-white py-1">
                                                <h6 class="mb-0 font-weight-bold roboto-condensed-light text-white" style="font-size: 0.9rem;">
                                                    <i class="fas fa-boxes mr-1"></i>PRODUCTOS Y ENTREGAS
                                                </h6>
                                            </div>
                                            <div class="card-body p-2">
                                                <div class="row align-items-end mb-2">
                                                    <div class="col-sm-12 col-md-4 col-lg-3">
                                                        <label class="font-weight-bold text-dark mb-1" for="nro_dates-update" style="font-size: 0.85rem;">
                                                            <i class="fas fa-calendar-check mr-1"></i>Nº de Entregas:
                                                        </label>
                                                        <div class="input-group input-group-sm">
                                                            <div class="input-group-prepend">
                                                                <span class="input-group-text bg-primary text-white">
                                                                    <i class="fas fa-hashtag"></i>
                                                                </span>
                                                            </div>
                                                            <input type="text" class="form-control text-center font-weight-bold" 
                                                                   id="nro_dates-update" name="nro-dates" placeholder="-">
                                                        </div>
                                                    </div>
                                                </div>
                                                <div class="table-responsive">
                                                    <table id="table-product-add-update"
                                                           class="table table-sm table-hover align-content-center mb-1"
                                                           style="border: 1px solid #dee2e6; font-size: 0.85rem;">
                                                        <thead class="thead-light">
                                                        <tr>
                                                            <th scope="col" class="align-middle font-weight-bold text-center py-1"
                                                                style="width: 40%; color: #495057; background-color: #f8f9fa; font-size: 0.8rem;">
                                                                <i class="fas fa-box mr-1"></i>Producto
                                                            </th>
                                                            <th scope="col" class="align-middle font-weight-bold text-center py-1"
                                                                style="width: 12%; color: #495057; background-color: #f8f9fa; font-size: 0.8rem;">
                                                                <i class="fas fa-ruler mr-1"></i>Tipo UND
                                                            </th>
                                                            <th scope="col" class="align-middle font-weight-bold text-right py-1"
                                                                style="width: 12%; color: #495057; background-color: #f8f9fa; font-size: 0.8rem;">
                                                                <i class="fas fa-sort-numeric-up mr-1"></i>Cantidad
                                                            </th>
                                                            <th scope="col" class="align-middle font-weight-bold text-right py-1"
                                                                style="width: 12%; color: #495057; background-color: #f8f9fa; font-size: 0.8rem;">
                                                                <i class="fas fa-dollar-sign mr-1"></i>Precio Unit.
                                                            </th>
                                                            <th scope="col" class="align-middle font-weight-bold text-right py-1"
                                                                style="width: 14%; color: #495057; background-color: #f8f9fa; font-size: 0.8rem;">
                                                                <i class="fas fa-calculator mr-1"></i>Monto
                                                            </th>
                                                            <th scope="col" class="align-middle font-weight-bold text-center py-1"
                                                                style="width: 10%; color: #495057; background-color: #f8f9fa; font-size: 0.8rem;">
                                                                <i class="fas fa-cog mr-1"></i>Acción
                                                            </th>
                                                        </tr>
                                                        </thead>
                                                        <tbody id="tbody-product-add-update">
                                                        <tr class="text-center" i="1">
                                                            <td class="item-product-add-update align-middle py-1">
                                                                <select id="product_add-id-update"
                                                                        class="form-control form-control-sm product-add-update">
                                                                    <option value="0">Seleccione producto</option>
                                                                    {% for p in product_set %}
                                                                        <option value="{{ p.id }}">{{ p.name }}</option>
                                                                    {% endfor %}
                                                                </select>
                                                            </td>
                                                            <td class="item-unit-add-update align-middle py-1">
                                                                <select class="form-control form-control-sm unit-add-update" disabled>
                                                                    <option value="0">Seleccione producto</option>
                                                                </select>
                                                            </td>
                                                            <td class="item-quantity-add-update align-middle py-1">
                                                                <input type="text"
                                                                       class="form-control form-control-sm text-right quantity-add-update"
                                                                       placeholder="0.00" autocomplete="off">
                                                            </td>
                                                            <td class="item-price-unit-add-update align-middle py-1">
                                                                <input type="text"
                                                                       class="form-control form-control-sm text-right price-unit-add-update"
                                                                       placeholder="0.00" autocomplete="off">
                                                            </td>
                                                            <td class="item-amount-add-update align-middle py-1">
                                                                <input type="text"
                                                                       class="form-control form-control-sm text-right amount-add-update font-weight-bold"
                                                                       placeholder="0.00" autocomplete="off" readonly style="background-color: #f8f9fa;">
                                                            </td>
                                                            <td class="align-middle py-1">
                                                                <button type="button" onclick="addProductHeaderUpdate()"
                                                                        class="btn btn-outline-success btn-sm rounded-pill" style="padding: 0.15rem 0.5rem;">
                                                                    <i class="fas fa-plus"></i>
                                                                </button>
                                                            </td>
                                                        </tr>
                                                        </tbody>
                                                    </table>
                                                </div>
                                                <div class="row mt-2">
                                                    <div class="col-sm-6 col-md-6 col-lg-6">
                                                        <button type="button" id="btn-add-dates-update"
                                                                class="btn btn-success btn-sm btn-block rounded-pill font-weight-bold"
                                                                onclick="addDatesUpdate()">
                                                            <i class="fas fa-calendar-plus mr-1"></i>Agregar Fechas
                                                        </button>
                                                    </div>
                                                    <div class="col-sm-6 col-md-6 col-lg-6">
                                                        <button type="button" id="clean-dates-update"
                                                                {% if check_oc %}disabled{% endif %}
                                                                class="btn btn-danger btn-sm btn-block rounded-pill font-weight-bold">
                                                            <i class="fas fa-eraser mr-1"></i>Limpiar
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div class="d-flex pt-4 pb-3">
                                    <hr class="my-auto flex-grow-1 bg-primary">
                                    <div class="px-3 font-weight-bold text-primary" style="font-size: 1.1375rem;">
                                        <i class="fas fa-calendar-alt mr-2"></i>FECHAS DE ENTREGA
                                    </div>
                                    <hr class="my-auto flex-grow-1 bg-primary">
                                </div>

                                <div class="row pt-2">
                                    <div class="col-sm-12 col-md-12 col-lg-12 dates-quotas-update">
                                        {% for c in contract_obj.contractdetail_set.all %}
                                            <div class="card mb-2 main-dates-update"
                                                 {% if c.contractdetailpurchase_set.last %} type="B" {% else %} type="E" cd="{{ c.id }}" {% endif %}
                                                 style="border-color: #848d9f">
                                                <div class="card-header pt-1 pb-1"
                                                     {% if c.contractdetailpurchase_set.last %}style="background: #efc8c8"{% endif %}>
                                                    <div class="row">
                                                        <div class="col-sm-2 col-md-2 col-lg-2 text-left item-number-update">
                                                            <label for="number-quota-update"
                                                                   class="mt-2 font-weight-bold">
                                                                FECHA
                                                                DE ENTREGA </label>
                                                            <label class="font-weight-bold number">{{ c.nro_quota }}</label>
                                                            <input type=hidden class="number-quota-update"
                                                                   value="{{ c.nro_quota }}">
                                                            <input type="hidden" class="contract_detail"
                                                                   value="{{ c.id }}">
                                                        </div>
                                                        <div class="col-sm-3 col-md-3 col-lg-3 item-date-quota-update">
                                                            <input type="date"
                                                                   {% if c.contractdetailpurchase_set.last %}disabled{% endif %}
                                                                   class="form-control date-quota-update text-center"
                                                                   id="date-quota-update"
                                                                   value="{{ c.date|date:'Y-m-d' }}">
                                                        </div>
                                                        {% if c.contractdetailpurchase_set.last %}
                                                            <div class="col-sm-3 col-md-3 col-lg-3 item-date-quota-update">
                                                                <input type="text" readonly aria-label="..."
                                                                       style="background: #ffe9ce"
                                                                       class="form-control text-center font-weight-bold"
                                                                       value="{{ c.contractdetailpurchase_set.last.purchase.bill_number }}">
                                                            </div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                                <div class="card-body p-1"
                                                     {% if c.contractdetailpurchase_set.last %}style="background: #efc8c8"{% endif %}>
                                                    <table id="table-date-update-{{ c.nro_quota }}"
                                                           class="table table-hover table-sm align-content-center table-bordered mb-0">
                                                        <thead>
                                                        <tr class="text-center text-white" style="background: #1a77c8">
                                                            <th scope="col" class="align-middle font-weight-normal"
                                                                style="width: 8%;">Item
                                                            </th>
                                                            <th scope="col" class="align-middle font-weight-normal"
                                                                style="width: 40%;">Producto
                                                            </th>
                                                            <th scope="col" class="align-middle font-weight-normal"
                                                                style="width: 12%;">Tipo UND
                                                            </th>
                                                            <th scope="col" class="align-middle font-weight-normal"
                                                                style="width: 12%;">Cantidad
                                                            </th>
                                                            <th scope="col" class="align-middle font-weight-normal"
                                                                style="width: 12%;">P. U.
                                                            </th>
                                                            <th scope="col" class="align-middle font-weight-normal"
                                                                style="width: 12%;">Monto
                                                            </th>
                                                        </tr>
                                                        </thead>
                                                        <tbody id="details-table-date-update-{{ c.nro_quota }}"
                                                               number="{{ c.nro_quota }}">
                                                        {% for cd in c.contractdetailitem_set.all %}
                                                            <tr class="text-center">
                                                                <td class="item-number-update align-middle text-center">{{ forloop.counter }}
                                                                    <input type="hidden" class="contract-detail-item"
                                                                           value="{{ cd.id }}">
                                                                </td>
                                                                <td class="item-product-add-update align-middle text-center">
                                                                    <label for="product_id"
                                                                           class="sr-only">Producto</label>
                                                                    <select id="product_id"
                                                                            {% if c.contractdetailpurchase_set.last %}disabled{% endif %}
                                                                            class="form-control form-control-sm product-add-update"
                                                                            data-product-id="{{ cd.product.id }}">
                                                                        {% for p in product_set %}
                                                                            {% if p.id == cd.product.id %}
                                                                                <option value="{{ p.id }}"
                                                                                        selected>{{ p.name }}</option>
                                                                            {% else %}
                                                                                <option value="{{ p.id }}">{{ p.name }}</option>
                                                                            {% endif %}
                                                                        {% endfor %}
                                                                    </select>
                                                                </td>
                                                                <td class="item-unit-add-update align-middle text-center">
                                                                    <select {% if c.contractdetailpurchase_set.last %}disabled{% endif %}
                                                                            class="form-control form-control-sm unit-add-update"
                                                                            data-product-id="{{ cd.product.id }}"
                                                                            data-unit-id="{% if cd.unit %}{{ cd.unit.id }}{% else %}0{% endif %}">
                                                                        <option value="0">Cargando...</option>
                                                                    </select>
                                                                </td>
                                                                <td class="item-quantity-add-update align-middle text-center">
                                                                    <input type="text"
                                                                           {% if c.contractdetailpurchase_set.last %}disabled{% endif %}
                                                                           class="form-control text-right quantity-add-update"
                                                                           autocomplete="off"
                                                                           value="{{ cd.quantity|replace_round }}">
                                                                </td>
                                                                <td class="item-price-unit-add-update align-middle text-center">
                                                                    <input type="text"
                                                                           {% if c.contractdetailpurchase_set.last %}disabled{% endif %}
                                                                           class="form-control text-right price-unit-add-update"
                                                                           value="{{ cd.price_unit|replace_round }}"
                                                                           autocomplete="off">
                                                                </td>
                                                                <td class="item-amount-add-update align-middle text-center">
                                                                    <input type="text"
                                                                           {% if c.contractdetailpurchase_set.last %}disabled{% endif %}
                                                                           class="form-control text-right amount-add-update"
                                                                           value="{{ cd.amount|replace_round }}"
                                                                           placeholder="0.00" autocomplete="off" readonly>
                                                                </td>
                                                            </tr>
                                                        {% endfor %}
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        {% endfor %}
                                    </div>
                                </div>
                                <div class="row pt-2">
                                    <div class="col-12">
                                        <div class="d-flex justify-content-end align-items-center">
                                            <div class="mr-4">
                                                <label class="font-weight-bold text-dark mb-1" style="font-size: 0.9rem;">
                                                    <i class="fas fa-calculator mr-1 text-primary"></i>TOTAL CANTIDAD:
                                                </label>
                                                <input type="text" class="form-control form-control-sm text-right font-weight-bold border-primary"
                                                       id="total-quantity-update" aria-label="..."
                                                       value="{{ sum_quantity|replace_round_separator }}"
                                                       placeholder="0.00" readonly style="min-width: 120px; background-color: #e7f3ff;">
                                            </div>
                                            <div>
                                                <label class="font-weight-bold text-dark mb-1" style="font-size: 0.9rem;">
                                                    <i class="fas fa-money-bill-wave mr-1 text-success"></i>TOTAL MONTO:
                                                </label>
                                                <input type="text" class="form-control form-control-sm text-right font-weight-bold border-success"
                                                       id="total-amount-update" aria-label="..."
                                                       value="{{ sum_amount|replace_round_separator }}"
                                                       placeholder="0.00" readonly style="min-width: 120px; background-color: #d4edda;">
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- /.card -->
                </div>

            </div><!-- modal-body -->

            <div class="modal-footer bg-light p-3">
                <button type="button" class="btn btn-secondary font-weight-light" data-dismiss="modal">
                    <i class="fas fa-times mr-1"></i>Cerrar
                </button>
                <button id="btn-update-contract" type="submit" class="btn btn-warning font-weight-light">
                    <i class="fas fa-save mr-1"></i>Actualizar Contrato
                </button>
            </div>
        </form>
        <div class="mr-3 ml-0" style="
                display: none;
                position: fixed;
                top: 8px;
                left: 5px;
                background: #bdd9f5;
                opacity: 0.5;
                width: 100%;
                {#height: 46em;#}
                !important;bottom: 6px;
                padding-right: 65em;
                padding-left: 55em;
                padding-top: 22em;" id="loading">

        </div>
    </div>
</div>

<style>
    .autocomplete-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        z-index: 1000;
        background: white;
        border: 1px solid #ced4da;
        border-radius: 0.25rem;
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        max-height: 300px;
        overflow-y: auto;
        margin-top: 2px;
    }

    .autocomplete-item {
        padding: 0.75rem 1rem;
        cursor: pointer;
        border-bottom: 1px solid #f0f0f0;
        transition: background-color 0.2s ease;
        display: flex;
        align-items: center;
    }

    .autocomplete-item:last-child {
        border-bottom: none;
    }

    .autocomplete-item:hover,
    .autocomplete-item.active {
        background-color: #f8f9fa;
        color: #0056b3;
    }

    .autocomplete-item .client-name {
        font-weight: 600;
        color: #212529;
        flex: 1;
    }

    .autocomplete-item .client-doc {
        font-size: 0.85rem;
        color: #6c757d;
        margin-left: 0.5rem;
    }

    .autocomplete-item:hover .client-name,
    .autocomplete-item.active .client-name {
        color: #0056b3;
    }

    .autocomplete-loading {
        padding: 1rem;
        text-align: center;
        color: #6c757d;
    }

    .autocomplete-loading i {
        animation: spin 1s linear infinite;
    }

    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    .autocomplete-no-results {
        padding: 1rem;
        text-align: center;
        color: #6c757d;
        font-style: italic;
    }

    .input-icon {
        position: relative;
    }

    .input-icon > i {
    {#content: "$";#} position: absolute;
        display: block;
        transform: translate(0, -50%);
        top: 50%;
        pointer-events: none;
        width: 25px;
        text-align: center;
        font-style: normal;
    }

    .input-icon > input {
        padding-left: 25px;
        padding-right: 8px;
    }

    .input-icon-right > i {
        right: 0;
    }

    .input-icon-right > input {
        padding-left: 0;
        padding-right: 25px;
        text-align: right;
    }

</style>

<script>

    /*let product_set = [
        {% for p in product_set %}
            [
                '{{ p.id }}',
                '{{ p.name }}'
            ],
        {% endfor %}
    ]*/

    function loadUnitsForProductUpdate(productId, unitSelectElement, selectedUnitId = null, callback = null, forceUnd = false) {
        if (!productId || productId === '0') {
            $(unitSelectElement).html('<option value="0">Seleccione producto</option>').prop('disabled', true);
            if (callback) callback('');
            return;
        }

        $.ajax({
            url: '/buys/get_units_product/',
            type: 'GET',
            data: {'ip': productId},
            dataType: 'json',
            success: function (response) {
                let units = JSON.parse(response.units);
                let options = '<option value="0">Seleccione unidad</option>';
                let undUnitId = null;
                
                for (let i = 0; i < units.length; i++) {
                    let unit = units[i];
                    // Buscar UND para usarlo por defecto si no hay unidad seleccionada
                    if (unit.fields.name === 'UND' || unit.fields.name === 'und') {
                        undUnitId = unit.pk;
                    }
                    let selected = (selectedUnitId && unit.pk == selectedUnitId) ? 'selected' : '';
                    options += '<option value="' + unit.pk + '" ' + selected + '>' + unit.fields.name + '</option>';
                }
                
                $(unitSelectElement).html(options).prop('disabled', false);
                
                // Si no hay unidad seleccionada o se fuerza UND, usar UND por defecto
                if ((!selectedUnitId || selectedUnitId === '0' || forceUnd) && undUnitId) {
                    $(unitSelectElement).val(undUnitId);
                } else if (!selectedUnitId || selectedUnitId === '0') {
                    // Si no existe UND, usar la primera unidad disponible
                    if (units.length > 0) {
                        $(unitSelectElement).val(units[0].pk);
                    }
                }
                
                if (callback) callback(options);
            },
            error: function () {
                toastr.error('Error al cargar las unidades del producto', 'Error');
                $(unitSelectElement).html('<option value="0">Error al cargar</option>').prop('disabled', true);
                if (callback) callback('');
            }
        });
    }

    function addProductHeaderUpdate() {
        let _products = '{% for p in product_set %}' + '<option value="{{ p.id }}">{{ p.name }}</option>' +
            '{% endfor %}'
        $('#table-product-add-update > tbody').append(
            '<tr class="text-center">' +
            '<td class="item-product-add-update align-middle text-center">' +
            '<select class="form-control form-control-sm product-add-update">' +
            '<option value="0">Seleccione</option>' + _products + '</select>' +
            '</td>' +
            '<td class="item-unit-add-update align-middle text-center pt-0">' +
            '<select class="form-control form-control-sm unit-add-update" disabled>' +
            '<option value="0">Seleccione producto</option>' +
            '</select>' +
            '</td>' +
            '<td class="item-quantity-add-update align-middle text-center pt-0">' +
            '<input type="text" class="form-control form-control-sm text-right quantity-add-update" placeholder="0.00" autocomplete="off">' +
            '</td>' +
            '<td class="item-price-unit-add-update align-middle text-center pt-0">' +
            '<input type="text" class="form-control form-control-sm text-right price-unit-add-update" placeholder="0.00" autocomplete="off">' +
            '</td>' +
            '<td class="item-amount-add-update align-middle text-center pt-0">' +
            '<input type="text" class="form-control form-control-sm text-right amount-add-update" placeholder="0.00" autocomplete="off" readonly>' +
            '</td>' +
            '<td class="align-middle pt-0">' +
            '<button type="button" onclick="deleteItemHeader(this)" class="btn btn-danger btn-sm delete-detail-update"><i class="fa fa-trash"></i></button>' +
            '</td>' +
            '</tr>'
        );
        counterHeader()
    }

    $(document).on('change', '.product-add-update', function () {
        let $tr = $(this).closest('tr');
        let productId = $(this).val();
        let unitSelect = $tr.find('.unit-add-update');
        loadUnitsForProductUpdate(productId, unitSelect);
    });

    $(document).on('change', '.dates-quotas-update .product-add-update', function () {
        let $tr = $(this).closest('tr');
        let productId = $(this).val();
        let unitSelect = $tr.find('.unit-add-update');
        loadUnitsForProductUpdate(productId, unitSelect);
    });

    function deleteItemHeader(btn) {
        btn.parentNode.parentNode.remove();
        counterHeader()
    }

    function counterHeader() {
        let l = 1;
        $(`#tbody-product-add-update tr`).each(function () {
            $(this).attr('i', l);
            l++;
        });
    }

    $(document).on('keyup', '.quantity-add-update', function (e) {
        calculateTotalHeaderUpdate($(this));
    });

    $(document).on('keyup', '.price-unit-add-update', function (e) {
        calculateTotalHeaderUpdate($(this));
    });

    function calculateTotalHeaderUpdate(input) {
        let _tr = input.closest('tr');
        let _quantity = Number(_tr.find('.quantity-add-update').val().replace(/,/g, ''));
        let _price_unit = Number(_tr.find('.price-unit-add-update').val().replace(/,/g, ''));
        let _total = _quantity * _price_unit;
        _tr.find('.amount-add-update').val(_total.toLocaleString('es-PE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }));

    }

    function calculateTotalUpdate() {
        let sum_quantity = 0;
        let sum_amount = 0;
        $('.dates-quotas-update td.item-quantity-add-update input.quantity-add-update').each(function () {
            let quantity = Number($(this).val().replace(/,/g, ''))
            sum_quantity = sum_quantity + quantity
        });
        $('.dates-quotas-update td.item-amount-add-update input.amount-add-update').each(function () {
            let amount = Number($(this).val().replace(/,/g, ''))
            sum_amount = sum_amount + amount
        });
        // Formatear con separador de miles (punto) y decimales (coma) - igual que replace_round_separator
        function formatNumberWithSeparator(num) {
            let rounded = Math.round(num * 100) / 100; // Redondear a 2 decimales
            let parts = rounded.toFixed(2).split('.');
            let integerPart = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, '.');
            return integerPart + ',' + parts[1];
        }
        $("#total-quantity-update").val(formatNumberWithSeparator(sum_quantity));
        $("#total-amount-update").val(formatNumberWithSeparator(sum_amount));
    }

    $(document).on('keyup', '.quantity-add-update', function () {
        let _tr = $(this).parent('td').parent('tr');
        let _quantity_row = Number($(this).val().replace(/,/g, ''));
        let _price_unit_row = Number(_tr.find('td.item-price-unit-add-update input.price-unit-add-update').val().replace(/,/g, ''));
        let _amount = _tr.find('td.item-amount-add-update input.amount-add-update');
        let _new_amount = _quantity_row * _price_unit_row
        _amount.val(_new_amount.toLocaleString('es-PE', { minimumFractionDigits: 2, maximumFractionDigits: 2 }))
        calculateTotalUpdate()
    });

    $(document).on('click', '#clean-dates-update', function () {
        $('.dates-quotas-update').empty();
        $('#nro_dates-update').val('');
        $('#nro_dates-update').focus();

        $('#total-quantity-update').val('');
        $('#total-amount-update').val('');
        $('#tbody-product-add-update tr:not([i="1"])').remove();
        $('#tbody-product-add-update tr[i="1"]').find('input').val('');
        $('#tbody-product-add-update tr[i="1"]').find('select.product-add-update').val('0');
        $('#tbody-product-add-update tr[i="1"]').find('select.unit-add-update').html('<option value="0">Seleccione producto</option>').prop('disabled', true);

        $('#btn-add-dates-update').removeAttr('disabled');
        $('#product_add-id-update').val('0');
    });

    function validateHeaderUpdate() {
        let flag = true;

        $('#tbody-product-add-update tr').each(function () {
            let $tr = $(this);
            let product = $tr.find('.product-add-update').val();
            let unit = $tr.find('.unit-add-update').val();
            let quantity = $tr.find('.quantity-add-update').val();
            let price = $tr.find('.price-unit-add-update').val();

            if (product === '0' || unit === '0' || quantity === '' || price === '') {
                toastr.warning('Por favor, complete todos los campos antes de continuar: Producto, Tipo UND, Cantidad y Precio Unitario');
                flag = false;
                return false;
            }
        });

        return flag;
    }

    function addDatesUpdate() {
        let _nro_dates = $('#nro_dates-update');
        //let product = $('#product_add_id').val();
        //let _quantity = $('#quantity_add');
        //let _price_unit = $('#price_unit');
        let _btn_add = $('#btn-add-dates-update');
        if (_nro_dates.val().length === 0) {
            toastr.warning('Favor de ingresar una numero de fechas', 'Error de llenado');
            _nro_dates.focus();
            _btn_add.removeAttr('disabled');
            return false;
        }
        _btn_add.attr('disabled', true);

        if (!validateHeaderUpdate()) {
            _btn_add.removeAttr('disabled');
            return false;
        }
        let datesContainer = $('.dates-quotas-update');
        let currentCount = datesContainer.children('.main-dates-update').length;


        for (let i = 0; i < _nro_dates.val(); i++) {
            //let _number = i + 1;
            let _number = currentCount + i + 1;

            let _date_quota = '{{ date_now }}';

            datesContainer.append(
                '<div class="card mb-2 main-dates-update" type="N" style="border-color: #848d9f">' +
                '<div class="card-header pt-1 pb-1">' +
                '<div class="row">' +
                '<div class="col-sm-2 col-md-2 col-lg-2 text-left item-number-update">' +
                '<label for="number-quota-update" class="mt-2 font-weight-bold">' + 'FECHA DE ENTREGA' + '</label>' + '<label class="font-weight-bold number pl-1"></label>' +
                '<input type=hidden class="number-quota-update" value="' + _number + '">' +
                '<input type=hidden class="contract_detail" value="">' +
                '</div>' +
                '<div class="col-sm-3 col-md-3 col-lg-3 item-date-quota-update">' +
                '<input type="date" class="form-control date-quota-update text-center" id="date-quota-update" value="' + _date_quota + '">' +
                '</div>' +
                '</div>' +
                '</div>' +
                '<div class="card-body p-1">' +
                '<table id="table-date-update-' + _number + '" class="table table-hover table-sm align-content-center table-bordered mb-0">' +
                '<thead>' +
                    '<tr class="text-center text-white" style="background: #1a77c8">' +
                    '<th scope="col" class="align-middle font-weight-normal" style="width: 8%;">' + 'Item' + '</th>' +
                    '<th scope="col" class="align-middle font-weight-normal" style="width: 40%;">' + 'Producto' + '</th>' +
                    '<th scope="col" class="align-middle font-weight-normal" style="width: 12%;">' + 'Tipo UND' + '</th>' +
                    '<th scope="col" class="align-middle font-weight-normal" style="width: 12%;">' + 'Cantidad' + '</th>' +
                    '<th scope="col" class="align-middle font-weight-normal" style="width: 12%;">' + 'P. U.' + '</th>' +
                    '<th scope="col" class="align-middle font-weight-normal" style="width: 12%;">' + 'Monto' + '</th>' +
                    '</tr>' +
                '</thead>' +
                '<tbody id="details-table-date-update-' + _number + '" number="' + _number + '">' +
                '</tbody>' +
                '</table>' +
                '</div>' +
                '</div>'
            );

            $('#tbody-product-add-update tr').each(function () {
                let selectOptions = '';
                let _tr = $(this);
                let item = _tr.attr("i");
                let product = _tr.find('td.item-product-add-update select.product-add-update').val()
                let unit = _tr.find('td.item-unit-add-update select.unit-add-update').val()
                let _quantity = _tr.find('td.item-quantity-add-update input.quantity-add-update');
                let _quantity_add = Number(_quantity.val()) / Number(_nro_dates.val());
                let _price_unit = _tr.find('td.item-price-unit-add-update input.price-unit-add-update');
                let _amount = _quantity_add * Number(_price_unit.val())

                for (let j = 0; j < product_set.length; j++) {
                    let productId = product_set[j][0];
                    if (productId === product) {
                        selectOptions += '<option value="' + productId + '" selected>' + product_set[j][1] + '</option>';
                    } else {
                        selectOptions += '<option value="' + productId + '">' + product_set[j][1] + '</option>';
                    }
                }
                
                let rowHtml = '<tr class="text-center">' +
                    '<td class="item-number-update align-middle text-center">' + item +
                    '<input type="hidden" class="contract-detail-item" value="">' +
                    '</td>' +
                    '<td class="item-product-add-update align-middle text-center">' +
                    '<select class="form-control form-control-sm product-add-update">' + selectOptions +
                    '</select>' +
                    '</td>' +
                    '<td class="item-unit-add-update align-middle text-center">' +
                    '<select class="form-control form-control-sm unit-add-update" data-product="' + product + '">' +
                    '<option value="0">Cargando...</option>' +
                    '</select>' +
                    '</td>' +
                    '<td class="item-quantity-add-update align-middle text-center">' +
                    '<input type="text" class="form-control text-right quantity-add-update" placeholder="0.00" autocomplete="off" value="' + _quantity_add.toFixed(2) + ' ">' +
                    '</td>' +
                    '<td class="item-price-unit-add-update align-middle text-center">' +
                    '<input type="text" class="form-control text-right price-unit-add-update" placeholder="0.00" autocomplete="off" value="' + _price_unit.val() + ' ">' +
                    '</td>' +
                    '<td class="item-amount-add-update align-middle text-center">' +
                    '<input type="text" class="form-control text-right amount-add-update" placeholder="0.00" autocomplete="off" value="' + _amount.toFixed(2) + '" readonly>' +
                    '</td>' +
                    '</tr>';
                
                $('#details-table-date-update-' + _number).append(rowHtml);
                
                // Cargar unidades después de agregar la fila
                let newRow = $('#details-table-date-update-' + _number + ' tr:last');
                let unitSelect = newRow.find('.unit-add-update');
                loadUnitsForProductUpdate(product, unitSelect, unit);
            });

        }
        calculateTotalUpdate()
        counterDates()
    }

    function counterDates() {
        let l = 1;
        $('.dates-quotas-update div.main-dates-update label.number').each(function () {
            $(this).text(l);
            l++;
        });
    }


    // Autocomplete mejorado para cliente en edición
    let searchTimeoutUpdate;
    let selectedIndexUpdate = -1;

    $(document).on('input', '#client_search_update', function() {
        clearTimeout(searchTimeoutUpdate);
        let $input = $(this);
        let $results = $('#client-autocomplete-results-update');
        let query = $input.val().trim();

        if (query.length < 3) {
            $results.hide().empty();
            selectedIndexUpdate = -1;
            return;
        }

        // Mostrar loading
        $results.html('<div class="autocomplete-loading"><i class="fas fa-spinner fa-spin mr-2"></i>Buscando...</div>').show();

        searchTimeoutUpdate = setTimeout(function() {
            $.ajax({
                url: '/sales/get_clients_by_criteria/',
                type: 'GET',
                data: { 'value': query },
                dataType: 'json',
                headers: {"X-CSRFToken": '{{ csrf_token }}'},
                success: function(response) {
                    $results.empty();
                    selectedIndexUpdate = -1;

                    if (response.client_list && response.client_list.length > 0) {
                        response.client_list.forEach(function(client, index) {
                            let $item = $('<div class="autocomplete-item" data-id="' + client.client_id + 
                                         '" data-name="' + client.client_names + 
                                         '" data-doc="' + client.client_document_number + 
                                         '" data-address="' + (client.client_address || '') + 
                                         '" data-type-doc="' + (client.client_type_document || '') + '">' +
                                         '<span class="client-name"><i class="fas fa-user-circle mr-2 text-primary"></i>' + client.client_names + '</span>' +
                                         '<span class="client-doc">RUC: ' + client.client_document_number + '</span>' +
                                         '</div>');
                            $results.append($item);
                        });
                    } else {
                        $results.html('<div class="autocomplete-no-results">No se encontraron clientes</div>');
                    }
                },
                error: function() {
                    $results.html('<div class="autocomplete-no-results">Error al buscar clientes</div>');
                }
            });
        }, 300);
    });

    // Seleccionar cliente al hacer clic
    $(document).on('click', '#client-autocomplete-results-update .autocomplete-item', function() {
        let $item = $(this);
        let clientId = $item.attr('data-id');
        let clientName = $item.attr('data-name');

        $('#client_id_update').val(clientId);
        $('#client_search_update').val(clientName);
        $('#client-autocomplete-results-update').hide().empty();
        selectedIndexUpdate = -1;
    });

    // Navegación con teclado
    $(document).on('keydown', '#client_search_update', function(e) {
        let $results = $('#client-autocomplete-results-update');
        let $items = $results.find('.autocomplete-item');

        if ($items.length === 0) return;

        if (e.keyCode === 40) { // Flecha abajo
            e.preventDefault();
            selectedIndexUpdate = (selectedIndexUpdate < $items.length - 1) ? selectedIndexUpdate + 1 : 0;
            $items.removeClass('active').eq(selectedIndexUpdate).addClass('active');
            $results.scrollTop($items.eq(selectedIndexUpdate).position().top + $results.scrollTop() - 50);
        } else if (e.keyCode === 38) { // Flecha arriba
            e.preventDefault();
            selectedIndexUpdate = (selectedIndexUpdate > 0) ? selectedIndexUpdate - 1 : $items.length - 1;
            $items.removeClass('active').eq(selectedIndexUpdate).addClass('active');
            $results.scrollTop($items.eq(selectedIndexUpdate).position().top + $results.scrollTop() - 50);
        } else if (e.keyCode === 13) { // Enter
            e.preventDefault();
            if (selectedIndexUpdate >= 0 && $items.eq(selectedIndexUpdate).length) {
                $items.eq(selectedIndexUpdate).click();
            }
        } else if (e.keyCode === 27) { // ESC
            $results.hide().empty();
            selectedIndexUpdate = -1;
        }
    });

    // Ocultar resultados al hacer clic fuera
    $(document).on('click', function(e) {
        if (!$(e.target).closest('#client_search_update, #client-autocomplete-results-update').length) {
            $('#client-autocomplete-results-update').hide();
        }
    });

    // Cargar unidades cuando se carga el modal
    $(document).ready(function() {
        $('.dates-quotas-update .unit-add-update').each(function() {
            let $select = $(this);
            let productId = $select.attr('data-product-id');
            let unitId = $select.attr('data-unit-id');
            if (productId && productId !== '0') {
                // Si no hay unidad (unitId es 0 o null), forzar UND por defecto
                let finalUnitId = (unitId && unitId !== '0' && unitId !== '') ? unitId : null;
                let forceUnd = (!finalUnitId || finalUnitId === '0' || finalUnitId === '');
                // Forzar búsqueda de UND cuando no hay unidad en fechas de entrega
                loadUnitsForProductUpdate(productId, $select, finalUnitId, null, forceUnd);
            }
        });
    });

    $('#contract-update-form').submit(function (event) {
        event.preventDefault();
        let detailsUpdate = [];
        //let itemUpdateObj = {};
        $('.main-dates-update').each(function () {
            let nro_quota = $(this).find("div.item-number-update input.number-quota-update").val()
            let detailsObj = {
                "contract_detail": $(this).find("div.item-number-update input.contract_detail").val(),
                "nro_quota": nro_quota,
                "date_quota": $(this).find("div.item-date-quota-update input.date-quota-update").val(),
                "type": $(this).attr("type"),
                "items": []
            }
            $(`tbody#details-table-date-update-${nro_quota} tr`).each(function () {
                let itemUpdateObj = {
                    "contract_detail_item": $(this).find("td.item-number-update input.contract-detail-item").val(),
                    "product": $(this).find("td.item-product-add-update select.product-add-update").val(),
                    "unit": $(this).find("td.item-unit-add-update select.unit-add-update").val(),
                    "quantity": $(this).find("td.item-quantity-add-update input.quantity-add-update").val(),
                    "price_unit": $(this).find("td.item-price-unit-add-update input.price-unit-add-update").val(),
                }
                detailsObj.items.push(itemUpdateObj)
            });
            detailsUpdate.push(detailsObj);
        });
        let data = new FormData($('#contract-update-form').get(0));
        data.append('detail_update', JSON.stringify(detailsUpdate));
        $('#btn-update-contract').attr('disabled', true);
        console.log(detailsUpdate)
        $.ajax({
            url: $(this).attr('action'),
            type: $(this).attr('method'),
            async: true,
            data: data,
            cache: false,
            processData: false,
            contentType: false,
            headers: {"X-CSRFToken": '{{ csrf_token }}'},
            success: function (response) {
                if (response.success) {
                    toastr.success(response.message);
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                }
            },
            error: function (response) {
                toastr.error(response.message, "Guardado Fallido");
            }
        });
    });


</script>