{% extends 'home.html' %}
{% block title %}
    Compras Administrativas
{% endblock title %}

{% block body %}

<div class="container-fluid py-2 px-2 px-sm-3 roboto-condensed-regular" style="background-color: #e8f4f8; min-height: 100vh;">
    <!-- Encabezado -->
    <div class="card border-0 shadow-lg mb-3 overflow-hidden" style="border-radius: 15px;">
        <div class="card-body py-2 py-md-3" style="background-color: #f0f8fc;">
                <div class="row align-items-center no-gutters">
                <div class="col-12 col-lg-8 mb-2 mb-lg-0">
                    <h4 class="mb-0 font-weight-bold roboto-condensed-regular" style="color: #0d47a1; font-size: clamp(1rem, 4vw, 1.25rem);">
                        <i class="fas fa-clipboard-list mr-2"></i> REGISTRO DE COMPRAS ADMINISTRATIVAS
                    </h4>
                    <p class="text-muted mb-0 mt-1 small">Materiales de oficina, limpieza y suministros</p>
                </div>
                <div class="col-12 col-lg-4 mt-2 mt-lg-0 text-left text-lg-right">
                    <a href="{% url 'buys:report_administrative_purchases' %}" class="btn btn-outline-primary btn-sm border-2 btn-sales-rounded w-100 d-lg-inline-block">
                        <i class="fas fa-chart-bar mr-1"></i> Ver Reporte
                    </a>
                </div>
            </div>
        </div>
    </div>

    <form id="admin-purchase-form" method="POST">
        {% csrf_token %}
        <!-- Sección DATOS DE LA COMPRA -->
        <div class="card border-0 shadow-sm mb-3 overflow-hidden" style="border-radius: 15px;">
            <div class="card-header font-weight-bold border-0 py-2" style="background: linear-gradient(180deg, #bbe0f5 0%, #90caf9 100%); border-radius: 15px 15px 0 0;">
                <i class="fas fa-bars mr-2" style="color: #0d47a1;"></i>
                <span style="color: #0d47a1;">DATOS DE LA COMPRA</span>
            </div>
            <div class="card-body p-2 p-sm-3" style="background-color: #fff;">
                <div class="row">
                    <div class="col-12 col-sm-6 col-lg-4 mb-2 mb-sm-3">
                        <label class="small font-weight-bold text-uppercase text-muted mb-1">Proveedor</label>
                        <div class="d-flex align-items-stretch">
                            <select id="supplier-id" name="supplier-id" class="form-control form-control-sm flex-grow-1" style="border-color: #bbdefb; border-radius: 12px;" required>
                                <option value="">- Seleccione -</option>
                                {% for s in admin_suppliers %}
                                    <option value="{{ s.id }}">{{ s.name|upper }}</option>
                                {% endfor %}
                            </select>
                            <button type="button" id="btn-open-supplier-modal" class="btn btn-primary btn-sm ml-2 btn-sales-rounded flex-shrink-0" title="Nuevo proveedor">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-12 col-sm-6 col-lg-4 mb-2 mb-sm-3">
                        <label class="small font-weight-bold text-uppercase text-muted mb-1">Fecha</label>
                        <input type="date" id="purchase-date" name="purchase-date" class="form-control form-control-sm" style="border-color: #bbdefb; border-radius: 12px;"
                               value="{{ formatdate }}" required>
                    </div>
                    <div class="col-12 col-sm-6 col-lg-4 mb-2 mb-sm-3">
                        <label class="small font-weight-bold text-uppercase text-muted mb-1">N° Documento</label>
                        <input type="text" id="document-number" name="document-number" class="form-control form-control-sm" style="border-color: #bbdefb; border-radius: 12px;"
                               placeholder="F001-001" autocomplete="off">
                    </div>
                </div>
                <div class="row">
                    <div class="col-12 col-sm-6 col-lg-4 mb-2 mb-sm-3">
                        <label class="small font-weight-bold text-uppercase text-muted mb-1">Moneda</label>
                        <select id="currency" name="currency" class="form-control form-control-sm" style="border-color: #bbdefb; border-radius: 12px;">
                            {% for c in currency_options %}
                                <option value="{{ c.0 }}" {% if c.0 == 'S' %}selected{% endif %}>{{ c.1 }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-12 col-sm-6 col-lg-4 mb-2 mb-sm-3">
                        <label class="small font-weight-bold text-uppercase text-muted mb-1">Tipo de Pago</label>
                        <select id="payment-method" name="payment-method" class="form-control form-control-sm" style="border-color: #bbdefb; border-radius: 12px;">
                            {% for p in payment_options %}
                                <option value="{{ p.0 }}">{{ p.1 }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-12 col-sm-6 col-lg-4 mb-2 mb-sm-3">
                        <label class="small font-weight-bold text-uppercase text-muted mb-1 d-block">&nbsp;</label>
                        <div class="d-flex">
                            <button type="submit" id="btn-save" class="btn btn-success btn-sm border-2 btn-sales-rounded flex-fill mr-1">
                                <i class="fas fa-save mr-1"></i> Guardar
                            </button>
                            <button type="button" id="btn-new" class="btn btn-outline-secondary btn-sm border-2 btn-sales-rounded flex-fill">
                                <i class="fas fa-plus mr-1"></i> Nuevo
                            </button>
                        </div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-12 mb-0">
                        <label class="small font-weight-bold text-uppercase text-muted mb-1">Observaciones</label>
                        <textarea id="observation" name="observation" class="form-control form-control-sm" rows="2" style="border-color: #bbdefb; border-radius: 12px;"
                                  placeholder="Opcional"></textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sección DETALLE DE ARTÍCULOS -->
        <div class="card border-0 shadow-sm mb-3 overflow-hidden" style="border-radius: 15px;">
            <div class="card-header font-weight-bold border-0 py-2 d-flex align-items-center flex-wrap" style="background: linear-gradient(180deg, #bbe0f5 0%, #90caf9 100%); border-radius: 15px 15px 0 0;">
                <span style="color: #0d47a1;" class="mr-2 mb-1 mb-sm-0">
                    <i class="fas fa-list-alt mr-2"></i>DETALLE DE ARTÍCULOS
                </span>
                <button type="button" id="btn-add-detail" class="btn btn-primary btn-sm border-2 btn-sales-rounded">
                    <i class="fas fa-plus mr-1"></i> Agregar artículo
                </button>
            </div>
            <div class="card-body p-2 p-sm-3" style="background-color: #fff;">
                <div id="render-detail">
                    {% include "buys/purchase_detail.html" %}
                </div>
            </div>
        </div>
    </form>
</div>

<div class="modal fade" id="modal-admin-supplier" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false" aria-hidden="true"></div>

<style>
    .form-control:focus {
        box-shadow: 0 0 0 0.2rem rgba(30, 58, 95, 0.25);
        border-color: #1e3a5f;
    }
    .btn-outline-primary, .btn-outline-success, .btn-outline-warning, .btn-outline-danger, .btn-outline-secondary {
        border-width: 2px;
    }
    .btn-sales-rounded, #admin-purchase-form .btn {
        border-radius: 12px !important;
    }
    .input-icon { position: relative; }
    .input-icon > i {
        position: absolute; display: block; transform: translate(0, -50%);
        top: 50%; pointer-events: none; width: 28px; text-align: center;
        font-style: normal; color: #6c757d;
    }
    .input-icon > input { padding-left: 28px; padding-right: 8px; }
    .input-icon-right > i { right: 0; }
    .input-icon-right > input { padding-left: 8px; padding-right: 28px; text-align: right; }
    .table-admin thead th { background: #3e6787 !important; color: #fff; border: none; }
    .table-admin thead th:nth-child(5) { background: #518d86 !important; }
    #admin-purchase-form .form-control { border-radius: 12px; }
    @media (max-width: 575.98px) {
        .container-fluid.py-2 { padding-left: 0.5rem; padding-right: 0.5rem; }
        .card-body { padding: 0.75rem !important; }
        .table-admin { font-size: 0.8rem; }
        .table-admin .form-control { font-size: 0.75rem; }
    }
</style>

{% endblock body %}

{% block extrajs %}
<script type="text/javascript">
    $("#btn-new").click(function () {
        setTimeout(() => location.reload(), 500);
    });

    $(document).on('change', '#currency', function () {
        let c = $(this).val();
        $(".change-money").text(c === 'D' ? '$' : 'S/');
    });

    $(document).on('click', '#btn-open-supplier-modal', function () {
        $.ajax({
            url: '{% url "buys:modal_admin_supplier" %}',
            dataType: 'json',
            type: 'GET',
            success: function (r) {
                $('#modal-admin-supplier').html(r.form);
                $('#modal-admin-supplier').modal('show');
            },
            error: function () {
                toastr.error('Error al cargar el modal', 'Error');
            }
        });
    });

    $(document).on('click', '#btn-select-admin-supplier', function () {
        let val = $('#admin-supplier-select').val();
        if (val) {
            $('#supplier-id').val(val);
            $('#modal-admin-supplier').modal('hide');
            toastr.info('Proveedor seleccionado', 'Listo');
        } else {
            toastr.warning('Seleccione un proveedor', 'Atención');
        }
    });

    $(document).on('click', '#btn-save-admin-supplier', function () {
        let name = $('#admin-supplier-name').val().trim();
        if (!name) {
            toastr.warning('Ingrese el nombre del proveedor', 'Error');
            return;
        }
        let $btn = $(this);
        $btn.prop('disabled', true);
        $.ajax({
            url: '{% url "buys:save_admin_supplier" %}',
            type: 'POST',
            data: {
                name: name,
                ruc: $('#admin-supplier-ruc').val(),
                address: $('#admin-supplier-address').val(),
                phone: $('#admin-supplier-phone').val(),
                email: $('#admin-supplier-email').val(),
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function (r) {
                if (r.success) {
                    toastr.success(r.message);
                    $('#supplier-id').append($('<option>').val(r.supplier_id).text(r.supplier_name).prop('selected', true));
                    $('#modal-admin-supplier').modal('hide');
                } else {
                    toastr.error(r.message || 'Error');
                }
            },
            error: function (xhr) {
                toastr.error(xhr.responseJSON && xhr.responseJSON.message ? xhr.responseJSON.message : 'Error');
            },
            complete: function () {
                $btn.prop('disabled', false);
            }
        });
    });

    $(document).on('click', '#btn-add-detail', function () {
        let c = $("#currency").val();
        let sym = c === 'D' ? '$' : 'S/';
        $('#details-table tbody').append(
            '<tr>' +
            '<td class="item-num align-middle text-center">1</td>' +
            '<td class="align-middle"><input type="text" class="form-control form-control-sm desc-input" placeholder="Ej: Resmas de papel A4"></td>' +
            '<td class="align-middle"><input type="number" step="0.01" class="form-control form-control-sm qty-input text-center" placeholder="0" value="0"></td>' +
            '<td class="align-middle"><select class="form-control form-control-sm unit-select"><option value="0">Otro</option>{% for u in units %}<option value="{{ u.id }}">{{ u.name }}</option>{% endfor %}</select><input type="text" class="form-control form-control-sm unit-free-input mt-1 d-none" placeholder="Especificar unidad"></td>' +
            '<td class="align-middle"><div class="input-icon"><input type="number" step="0.01" class="form-control form-control-sm price-input" placeholder="0.00" value="0"><i class="change-money">' + sym + '</i></div></td>' +
            '<td class="align-middle"><div class="input-icon input-icon-right"><input type="text" class="form-control form-control-sm total-input" placeholder="0.00" readonly><i class="change-money">' + sym + '</i></div></td>' +
            '<td class="align-middle text-center"><button type="button" class="btn btn-outline-danger btn-sm border-2 delete-row btn-sales-rounded"><i class="fa fa-trash"></i></button></td>' +
            '</tr>');
        renumber();
    });

    $(document).on('click', '.delete-row', function () {
        $(this).closest('tr').remove();
        renumber();
        sumTotal();
    });

    function renumber() {
        $('#details-table tbody tr').each(function (i) {
            $(this).find('.item-num').text(i + 1);
        });
    }

    $(document).on('change', '.unit-select', function () {
        let $cell = $(this).closest('td');
        let v = $(this).val();
        if (v === '0') {
            $cell.find('.unit-free-input').removeClass('d-none');
        } else {
            $cell.find('.unit-free-input').addClass('d-none').val('');
        }
    });

    $(document).on('input', '.qty-input, .price-input', function () {
        let $tr = $(this).closest('tr');
        let q = parseFloat($tr.find('.qty-input').val()) || 0;
        let p = parseFloat($tr.find('.price-input').val()) || 0;
        $tr.find('.total-input').val((q * p).toFixed(2));
        sumTotal();
    });

    function sumTotal() {
        let t = 0;
        $('#details-table tbody tr').each(function () {
            t += parseFloat($(this).find('.total-input').val()) || 0;
        });
        let val = t.toFixed(2);
        $('#subtotal-foot').val(val);
        $('#total-foot').val(val);
    }

    $('#admin-purchase-form').submit(function (e) {
        e.preventDefault();
        if (!$('#supplier-id').val()) {
            toastr.warning('Seleccione un proveedor', 'Error');
            return;
        }
        let details = [];
        $('#details-table tbody tr').each(function () {
            let desc = $(this).find('.desc-input').val();
            if (!desc) return;
            let unitId = $(this).find('.unit-select').val();
            let unitFree = $(this).find('.unit-free-input').val();
            details.push({
                description: desc,
                quantity: $(this).find('.qty-input').val(),
                unit: unitId,
                unit_free: unitFree,
                price: $(this).find('.price-input').val(),
            });
        });

        let data = new FormData(this);
        data.append('detail', JSON.stringify(details));

        $.ajax({
            url: '{% url "buys:create_administrative_purchase" %}',
            type: 'POST',
            data: data,
            cache: false,
            processData: false,
            contentType: false,
            headers: {"X-CSRFToken": '{{ csrf_token }}'},
            success: function (r) {
                if (r.success) {
                    toastr.success(r.message);
                    setTimeout(() => location.reload(), 800);
                } else {
                    toastr.error(r.message || 'Error al guardar');
                }
            },
            error: function (xhr) {
                let msg = xhr.responseJSON && xhr.responseJSON.message ? xhr.responseJSON.message : 'Error al guardar';
                toastr.error(msg);
            }
        });
    });
</script>
{% endblock extrajs %}
