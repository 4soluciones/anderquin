{% extends 'home.html' %}
{% block title %}
    coronasoft.dev | Compras
{% endblock title %}

{% block body %}
    <div class="row">
        <div class="card col-sm-12">
            <div class="card-body" id="render-form">
                {% include "buys/purchase_create.html" %}
            </div>
        </div>
    </div>
    <div class="row mt-4 ml-4">
        <div class="card col-sm-10">
            <div class="card-body ">
                <div class="table-responsive" id="render-table">
                    {% include "buys/purchase_detail_list.html" %}
                </div>
            </div>
        </div>
    </div>
{% endblock body %}


{% block extrajs %}
    <script type="text/javascript">

        window.onload = function () {
            var date = new Date(); //Fecha actual
            var day = date.getDate(); //obteniendo dia
            var month = date.getMonth() + 1; //obteniendo mes
            var year = date.getFullYear(); //obteniendo año
            if (day < 10)
                day = '0' + day; //agrega cero si el menor de 10
            if (month < 10)
                month = '0' + month //agrega cero si el menor de 10
            document.getElementById('id_fechacompra').value = year + "-" + month + "-" + day;
        }
        {#document.ready = document.getElementById("opciones").value = '0';#}
        $('#id_proveedor').select2({
            theme: 'bootstrap4',
        });
        $('#id_producto').select2({
            theme: 'bootstrap4',
        })
        ;$('#id_delivery').select2({
            theme: 'bootstrap4',
        });

        $('#id-sales-reference').select2({
            theme: 'bootstrap4',
        });
        $('#id_address').select2({
            theme: 'bootstrap4',
        });
        $('#id_name').select2({
            theme: 'bootstrap4',
        });
        $('#id_city_address').select2({
            theme: 'bootstrap4',
        });
        $('#id-sales-reference-entity').select2({
            theme: 'bootstrap4',
        });
        /*
        $('#id-truck').select2({
            theme: 'bootstrap4',
        });
        */
        $("#btn-new").click(function () {
            limper_form();
        });

        function limper_form(request) {
            $('#id_fechacompra').val('');
            $("#id_factura").val('');
            $("#id_entrega").val('');
            $("#id_payment_condition").val('');
            $("#id_observation").val('');
            $('#id_proveedor option').removeAttr('selected');
            $('#id_proveedor option:first').attr('selected', 'selected');
            $('#id_proveedor').trigger('change');
            $('#id_currency option').removeAttr('selected');
            $('#id_currency option:first').attr('selected', 'selected');
            $('#id_currency').trigger('change');
            $('#id_payment_method option').removeAttr('selected');
            $('#id_payment_method option:first').attr('selected', 'selected');
            $('#id_payment_method').trigger('change');
            $('#id-sales-reference option').removeAttr('selected');
            $('#id-sales-reference option:first').attr('selected', 'selected');
            $('#id-sales-reference').trigger('change');
            $('#id-sales-reference-entity option').removeAttr('selected');
            $('#id-sales-reference-entity option:first').attr('selected', 'selected');
            $('#id-sales-reference-entity').trigger('change');
            /*$('#id_delivery option').removeAttr('selected');
            $('#id_delivery option:first').attr('selected', 'selected');
            $('#id_delivery').trigger('change');*/

            document.getElementById("id-tr-reference").hidden = true;
            document.getElementById("id-tr-reference-entity").hidden = true;
            document.getElementById("id_address_add").hidden = true;
        };

        function limper(request) {
            $('#id_cantidad').val('');
            $('#id_preciounitario').val('');
            $('#id_cantidad_unidad').val('');
            $('#id_producto option').removeAttr('selected');
            $('#id_producto option:first').attr('selected', 'selected');
            $('#id_producto').trigger('change');
            $("#id_unidad").empty().append('<option>Seleccione</option>');

            {#$('#id_producto option[value=0]').attr('selected','selected');#}
            {#$('#id_unidad option[value=0]').attr('selected','selected');#}
        };

        function limper_reference(request) {
            $('#id_razon_social').val('');
            $('#id_ruc').val('');
            $('#id_direccion').val('');
            $('#id_is_private option').removeAttr('selected');
            $('#id_is_private option:first').attr('selected', 'selected');
            $('#id_is_private').trigger('change');
        };

        function limper_reference_entity(request) {
            $('#id_name option').removeAttr('selected');
            $('#id_name option:first').attr('selected', 'selected');
            $('#id_name').trigger('change');
            $('#id_city_address option').removeAttr('selected');
            $('#id_city_address option:first').attr('selected', 'selected');
            $('#id_city_address').trigger('change');
            $('#id_direccion_entity').val('');
        };

        $("#id_add").click(function () {

            let id_product = $('#id_producto').val();
            let name_product = $('#id_producto option:selected').text();
            let quantity = parseFloat($('#id_cantidad').val());
            let id_unit = $('#id_unidad').val();
            let name_unit = $('#id_unidad option:selected').text();
            let price_unit = parseFloat($('#id_preciounitario').val());
            let quantity_um = parseInt($('#id_cantidad_unidad').val());
            if (id_product > 0 && quantity > 0 && id_unit > 0 && price_unit > 0 && quantity_um > 0) {
                if ($("#id_detail_data_grid tr[product=" + id_product + "]").length) {
                    toastr.warning('PRODUCTO YA SELECCIONADO, SELECCIONE OTRO.!');
                    return false;
                }
                $('#id_detail_data_grid').append(
                    '<tr product="' + id_product + '">' +
                    '<td class="item-numero">' + '</td>' +
                    '<td class="text-center">' + '</td>' +
                    '<td>' + name_product + '</td>' +
                    '<td class="item-unit text-center" pu="' + id_unit + '">' + name_unit + ' x ' + quantity_um + '</td>' +
                    '<td class="text-center" pu="' + id_unit + '">' + quantity + '</td>' +
                    '<td class="item-quantity  text-right">' + parseInt(quantity * quantity_um) + '</td>' +
                    '<td class="item-price text-right">' + price_unit.toFixed(6) + '</td>' +
                    '<td class="text-right">' + (quantity * price_unit * quantity_um).toFixed(2) + '</td>' +
                    {#'<td class="text-center">' + '<button type="button" onclick="deleteItem(' + id_product + ')" class="btn btn-sm delete-detail"><i class="fa fa-trash"></i></button>' + '</td>' +#}
                    '<td class="align-middle text-center"> ' + '<button type="button" onclick="deleteItem(' + id_product + ')" class="btn btn-success delete-detail"><i class="fa fa-trash"></i></button>' + '</td>' +
                    '</tr>'
                );
                //$index++;
                limper()
                counterStrike()
                toastr.info('PRODUCTO AGREGADO', '¡MENSAJE!');


            } else {
                {#toastr.succes('info messages');#}
                toastr.warning('POR FAVOR, COMPLETE TODO LOS CAMPOS!');
            }

        });
        $("#id_add_reference").click(function () {

            let business_name = $('#id_razon_social').val();
            let ruc = $('#id_ruc').val();
            let is_private = $('#id_is_private').val();

            if (business_name && ruc && is_private) {
                $.ajax({
                    url: '/buys/add_reference/',
                    async: true,
                    dataType: 'json',
                    type: 'GET',
                    // registra nuevo referencia de venta
                    data: {
                        'business_name': business_name,
                        'ruc': ruc,
                        'is_private': is_private
                    },
                    // si va bien retorna la data
                    success: function (response) {
                        toastr.success('REFERENCIA AGREGADA CORRECTAMENTE!');
                        const $select = document.querySelector("#id-sales-reference");
                        const option = document.createElement('option');
                        option.value = response.id;
                        option.text = response.business_name;
                        $select.appendChild(option);

                        const $select2 = document.querySelector("#id-sales-reference-entity");
                        const option2 = document.createElement('option');
                        option2.value = response.id;
                        option2.text = response.business_name
                        $select2.appendChild(option2)

                        limper_reference();
                    },
                });


            } else {
                {#toastr.succes('info messages');#}
                toastr.warning('POR FAVOR, COMPLETE TODO LOS CAMPOS!');
            }
        });


        $("#id_add_address_entity").click(function () {

            let name_id = $('#id_name').val();
            let city_id = $('#id_city_address').val();
            let address = $('#id_direccion_entity').val();

            if (name_id && city_id && address) {
                $.ajax({
                    url: '/buys/add_address_entity/',
                    async: true,
                    dataType: 'json',
                    type: 'GET',
                    // registra nuevo referencia de venta
                    data: {
                        'name_id': name_id,
                        'city_id': city_id,
                        'address': address,
                    },
                    // si va bien retorna la data
                    success: function (response) {

                        toastr.success('DIRECCION AÑADIDA CORRECTAMENTE!');
                        {#const $select = document.querySelector("#id_client_group");#}
                        {#const option = document.createElement('option');#}
                        {#option.value = `c-${response.id}`;#}
                        {#option.text = response.address;#}
                        {#$select.appendChild(option);#}

                        $('#id-sales-reference option').removeAttr('selected');
                        $('#id-sales-reference option:first').attr('selected', 'selected');
                        $('#id-sales-reference').trigger('change');

                        limper_reference_entity();
                    },
                });
            } else {
                {#toastr.succes('info messages');#}
                toastr.warning('POR FAVOR, COMPLETE TODO LOS CAMPOS!');
            }
        });


        $('#purchase-form').submit(function (event) {
            event.preventDefault();

            if ($("#id_detail_data_grid tbody tr").length > 0) {
                let Detail_purchase = {
                    "Details": [],
                    {#"Invoice": $('#id_factura').val(),#}
                    "ProviderId": $('#id_proveedor').val(),
                    "Date": $('#id_fechacompra').val(),
                    //"truck": $('#id-truck').val(),
                    "Type_bill": $('#id_type_bill').val(),
                    "currency": $('#id_currency').val(),
                    "payment_method": $('#id_payment_method').val(),
                    "payment_condition": $('#id_payment_condition').val(),
                    "delivery": $('#id_delivery').val(),
                    "referenceId": $('#id-sales-reference').val(),
                    "reference_entityId": $('#id-sales-reference-entity').val(),
                    "observation": $('#id_observation').val(),
                    "supplier_order": $('#id_supplier_order').val()
                };
                // Recorre cada detalle de producto (son 2 arrays) each -> recorre

                $("#id_detail_data_grid tbody tr").each(function () {
                    var detailObj = {
                        "Product": $(this).attr('product'),
                        "Quantity": $(this).find("td.item-quantity").text(),
                        "Unit": $(this).find("td.item-unit").attr('pu'),
                        "Price": $(this).find("td.item-price").text(),
                    };
                    Detail_purchase.Details.push(detailObj);

                });

                {#console.log(JSON.stringify(Detail_purchase));#}
                {#alert('llego la hora de guardar.');#}

                $.ajax({

                    url: '/buys/save_purchase/',
                    async: true,
                    dataType: 'json', // for response
                    type: 'GET',
                    data: {'purchase': JSON.stringify(Detail_purchase)},
                    contentType: 'application/json;charset=UTF-8',
                    headers: {"X-CSRFToken": '{{ csrf_token }}'},
                    success: function (response, textStatus, xhr) {
                        if (xhr.status === 200) {
                            toastr.success(response.message, '¡COMPRA REGISTRADA CORRECTAMENTE!');
                            id_buys = response.pk

                            let url_print_pdf = "/buys/print_pdf_purchase_order/" + id_buys + "/";
                            window.location.href = url_print_pdf;

                            console.log(url_print_pdf)

                            setTimeout(() => {
                                location.reload();
                            }, 2000);
                        }
                    },
                    error: function (jqXhr, textStatus, xhr) {
                        toastr.error("ERROR. ", '¡INCONCEBIBLE!');
                    }
                });

            } else {
                toastr.warning("PARA REALIZAR LA COMPRA NECESITA AGREGAR PRODUCTOS. ", '¡ADVERTENCIA!');
            }
        });

        $('#id_producto').change(function () {
            //recupera el id_dela opcion seleccionada
            let _search = $(this).val();
            //vacia el combo-borra opciones
            $('#id_unidad').empty();

            $.ajax({
                url: '/buys/get_units_by_product/',
                async: true,
                dataType: 'json',
                type: 'GET',
                //mando  id del producto del combo
                data: {'ip': _search},
                // si va bien retorna la data
                success: function (response) {
                    //le da formato array
                    let units = JSON.parse(response['units']);
                    units.forEach(
                        element =>
                            $('#id_unidad').append(
                                '<option value="' + element['pk'] + '">' + element['fields']['name'] + '</option>')
                    )
                },
            });
        });

        $('#id_unidad').change(function () {
            //recupera el id_dela opcion seleccionada
            let _search = $(this).val();
            let id_product = document.getElementById('id_producto').value

            $.ajax({
                url: '/buys/get_price_by_unit/',
                async: true,
                dataType: 'json',
                type: 'GET',
                //mando  id del producto del combo
                data: {
                    'id_unit': _search,
                    'id_product': id_product,
                },
                // si va bien retorna la data
                success: function (response) {
                    document.getElementById('id_preciounitario').value = response.price;
                    document.getElementById('id_cantidad_unidad').value = parseInt(response.quantity);
                },
            });
        });

        $('#id_proveedor').change(function () {
            //recupera el id_dela opcion seleccionada
            let supplier_id = $(this).val();

            $.ajax({
                url: '/buys/is_supplier_reference/',
                async: true,
                dataType: 'json',
                type: 'GET',
                //mando  id del producto del combo
                data: {'supplier_id': supplier_id},
                // si va bien retorna la data
                success: function (response) {
                    if (response.status) {
                        {#document.getElementById('id-tr-reference').style.visibility = "visible"; // visible#}
                        {#document.getElementById('id-tr-reference-entity').style.visibility = "visible"; // visible#}
                        document.getElementById("id-tr-reference").hidden = false;
                        document.getElementById("id-tr-supplier-order").hidden = false;
                        {#document.getElementById("id-tr-delivery").hidden = true;#}
                        {#document.getElementById("id-tr-reference-entity").hidden = false;#}
                    } else {
                        {#document.getElementById('id-tr-reference').style.visibility = "hidden"; // hide#}
                        {#document.getElementById('id-tr-reference-entity').style.visibility = "hidden"; // hide#}
                        document.getElementById("id-tr-reference").hidden = true;
                        document.getElementById("id-tr-supplier-order").hidden = true;
                        document.getElementById("id-tr-delivery").hidden = false;

                        get_addresses_supplier(supplier_id);

                        {#document.getElementById("id-tr-reference-entity").hidden = true;#}
                    }
                },
            });
        });


        $('#id-sales-reference').change(function () {
            //recupera el id_dela opcion seleccionada
            let entity_id = $(this).val();
            let supplier_id = document.getElementById('id_proveedor').value

            {#console.log(_search)#}

            $.ajax({
                url: '/buys/is_entity_private/',
                async: true,
                dataType: 'json',
                type: 'GET',
                //mando  id del producto del combo
                data: {'entity_id': entity_id, 'supplier_id': supplier_id},
                // si va bien retorna la data
                success: function (response) {
                    if (response.status) {
                        {#document.getElementById('id-tr-reference').style.visibility = "visible"; // visible#}
                        {#document.getElementById('id-tr-reference-entity').style.visibility = "visible"; // visible#}
                        {#document.getElementById("id-tr-reference").hidden = false;#}
                        document.getElementById("id-tr-reference-entity").hidden = false;
                    } else {
                        {#document.getElementById('id-tr-reference').style.visibility = "hidden"; // hide#}
                        {#document.getElementById('id-tr-reference-entity').style.visibility = "hidden"; // hide#}
                        {#document.getElementById("id-tr-reference").hidden = true;#}
                        document.getElementById("id-tr-reference-entity").hidden = true;
                    }

                    document.getElementById("id-tr-delivery").hidden = false;
                    document.getElementById("id_address_add").hidden = false;


                    $('#id_delivery option').removeAttr('selected');
                    $('#id_delivery option:first').attr('selected', 'selected');
                    $('#id_delivery').trigger('change');
                    $('#id-sales-reference-entity option').removeAttr('selected');
                    $('#id-sales-reference-entity option:first').attr('selected', 'selected');
                    $('#id-sales-reference-entity').trigger('change');

                    {#get_addresses_by_client_supplier_id(entity_id, supplier_id);#}
                    get_addresses_client(entity_id);
                    get_addresses_supplier(supplier_id);
                    get_entities();
                },
            });
        });

        function get_addresses_client(entity_id) {

            let padre_1 = document.getElementById("id_client_group"); //obteniendo el elemento padre

            padre_1.innerHTML = ''; //estableciendo el contenido HTML del elemento padre como una cadena vacía para eliminar todas las etiquetas hijas
            if ($("#id_delivery").hasClass('select2-hidden-accessible')) {
                $("#id_delivery").select2("destroy");
                $("#id_delivery").select2();
            }

            $.ajax({
                url: '/buys/get_addresses_client/',
                async: true,
                dataType: 'json',
                type: 'GET',
                //mando  id del producto del combo
                data: {'entity_id': entity_id},
                // si va bien retorna la data
                success: function (response) {

                    let addresses_client = response.addresses_client;

                    for (var id in addresses_client) {
                        const opt = document.createElement("option"); // <option></option>
                        opt.textContent = addresses_client[id]
                        opt.value = `c-${id}`
                        padre_1.appendChild(opt)
                    }
                },
            });

        }

        function get_addresses_supplier(supplier_id) {

            let padre_2 = document.getElementById("id_supplier_group"); //obteniendo el elemento padre

            padre_2.innerHTML = '';
            if ($("#id_delivery").hasClass('select2-hidden-accessible')) {
                $("#id_delivery").select2("destroy");
                $("#id_delivery").select2();
            }

            $.ajax({
                url: '/buys/get_addresses_supplier/',
                async: true,
                dataType: 'json',
                type: 'GET',
                //mando  id del producto del combo
                data: {'supplier_id': supplier_id},
                // si va bien retorna la data
                success: function (response) {

                    let addresses_supplier = response.addresses_supplier;

                    for (var id in addresses_supplier) {
                        const opt = document.createElement("option"); // <option></option>
                        opt.textContent = addresses_supplier[id]
                        opt.value = `p-${id}`
                        padre_2.appendChild(opt)
                    }
                },
            });

        }

        function get_entities() {
            let padre_1 = document.getElementById("id_name"); //obteniendo el elemento padre

            padre_1.innerHTML = '';
            if ($("#id_name").hasClass('select2-hidden-accessible')) {
                $("#id_name").select2("destroy");
                $("#id_name").select2();
            }
            $.ajax({
                url: '/buys/get_entities/',
                async: true,
                dataType: 'json',
                type: 'GET',
                //mando  id del producto del combo
                data: {},
                // si va bien retorna la data
                success: function (response) {
                    let entities = response.entities;

                    for (var id in entities) {
                        const opt = document.createElement("option"); // <option></option>
                        opt.textContent = entities[id]
                        opt.value = id
                        padre_1.appendChild(opt)
                    }
                },
            });
        }

        //Bonton eliminar fila
        function deleteItem($id) {
            $('#details').find("tr[product=" + $id + "]").remove();
            counterStrike();
        }

        // reasigna numero de fila a los detalles
        function counterStrike() {
            let l = 1;
            $('#details tr').each(function () {
                $(this).attr('i', l);
                $(this).children('td:nth-child(2)').text(l);
                l++;
            });

        }


    </script>
{% endblock extrajs %}