{% extends 'home.html' %}
{% load app_filters %}
{% block title %}
    Editar Orden de Compra
{% endblock title %}

{% block body %}
    {% if purchase %}
        <!-- Card principal del título -->
        <div class="card m-2 shadow-sm roboto-condensed-regular"{% if contract_obj %} style="background: #62a239" {% else %} style="background: #1a77c8"{% endif %}>
            <div class="card-body py-3 pr-2">
                <div class="row align-items-center">
                    <div class="col-12 col-md-6 col-lg-8">
                        <input type="hidden" id="contract_detail_id" name="contract-detail" value="{{ contract_detail_ids_str }}">
                        <input type="hidden" id="purchase_id" value="{{ purchase.id }}">
                        {% if contract_obj %}
                            <div class="d-flex align-items-center">
                                <i class="fa fa-file-contract text-primary mr-3 ml-2" style="font-size: 2rem;"></i>
                                <div>
                                    <h4 class="mb-0 text-primary font-weight-bold">
                                        EDITAR CONTRATO: {{ contract_obj.contract_number }}
                                    </h4>
                                    <p class="mb-0 text-muted" style="font-size: 13px">Orden de Compra: {{ purchase.bill_number }}</p>
                                    <div class="delivery-dates-container">
                                        <ul class="text-muted mb-0" style="list-style: none; padding-left: 0;">
                                            {% for c in contract_detail_purchase_set %}
                                                <li><i class="fa fa-clock-o mr-1"></i>Entrega {{ c.contract_detail.nro_quota }}: {{ c.contract_detail.date|date:'d-m-Y' }}</li>
                                            {% endfor %}
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        {% else %}
                            <div class="d-flex align-items-center">
                                <i class="fa fa-shopping-cart text-primary mr-3 ml-2" style="font-size: 2rem;"></i>
                                <div>
                                    <h4 class="mb-0 text-primary font-weight-bold roboto-condensed-regular">
                                        EDITAR ORDEN DE COMPRA: {{ purchase.bill_number }}
                                    </h4>
                                </div>
                            </div>
                        {% endif %}
                    </div>
                    
                    <!-- Controles de la derecha -->
                    <div class="col-12 col-md-6 col-lg-4 mt-3 mt-md-0">
                        <div class="row align-items-center">
                            <!-- Botón Nuevo Proveedor -->
                            <div class="col-12 col-md-4 mb-2 mb-md-0">
{#                                <button type="button" #}
{#                                        onclick="showModalView('modal_supplier_create')"#}
{#                                        class="btn btn-outline-primary btn-block btn-sm">#}
{#                                    <i class="fa fa-plus mr-1"></i>#}
{#                                    Nuevo Proveedor#}
{#                                </button>#}
                            </div>
                            
                            <!-- Checkbox Dólares -->
                            <div class="col-12 col-md-4 mb-2 mb-md-0">
{#                                <div class="form-check mb-0">#}
{#                                    <input class="form-check-input check-dollar" type="checkbox" value="" id="check_dollar" {% if purchase.check_dollar %}checked{% endif %}>#}
{#                                    <label class="form-check-label" for="check_dollar">#}
{#                                        <strong>En Dolares</strong>#}
{#                                    </label>#}
{#                                </div>#}
                            </div>
                            
                            <!-- Correlativo y Año -->
                            <div class="col-12 col-md-4">
                                <div class="form-group mb-0">
                                    <div class="input-group input-group-sm">
                                        <div class="input-group-prepend">
                                            <span class="input-group-text bg-secondary border-right-0">
                                                <i class="fa fa-hashtag text-muted fa-xs"></i>
                                            </span>
                                        </div>
                                        <select id="year" class="form-control border-left-0" style="border-radius: 0;">
                                            <option value="2023" {% if purchase.purchase_date|date:'Y' == '2023' %}selected{% endif %}>2023</option>
                                            <option value="2024" {% if purchase.purchase_date|date:'Y' == '2024' %}selected{% endif %}>2024</option>
                                            <option value="2025" {% if purchase.purchase_date|date:'Y' == '2025' %}selected{% endif %}>2025</option>
                                        </select>
                                        <input type="text" 
                                               class="form-control text-center font-weight-bold"
                                               id="correlative" 
                                               value="{{ purchase.correlative|zfill:4 }}" 
                                               autocomplete="off"
                                               placeholder="000">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Card principal del contenido -->
        <div class="card m-2 roboto-condensed-regular">
            <div class="card-body p-0">
                <!-- Sección de datos de la orden y referencia -->
                <div class="row g-0">
                    <!-- Datos de la orden -->
                    <div class="col-12 col-lg-5 pr-0">
                        <div class="h-100 border-end">
                            <div class="card-header bg-light py-0 px-0">
                                <div class="row align-items-center">
                                    <div class="col-8">
                                        <h6 class="mb-0 font-weight-bold text-dark roboto-condensed-regular">
                                            <i class="fa fa-file-text-o mr-2"></i>
                                            DATOS DE LA ORDEN
                                        </h6>
                                    </div>
                                    <div class="col-4">
                                        <div class="form-check mb-0">
                                            <input class="form-check-input check-dollar" type="checkbox" value="" id="check_dollar_header" {% if purchase.check_dollar %}checked{% endif %}>
                                            <label class="form-check-label text-dark form-control-sm font-weight-bold mb-0" for="check_dollar_header">
                                                En Dolares
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body p-3">
                                <form id="purchase-form" action="{% url 'buys:save_update_purchase' %}" method="POST">
                                    {% csrf_token %}
                                    <div class="row p-1">
                                        <div class="col-sm-8 col-md-8 col-lg-8">
                                            <label for="supplier_id">Proveedor:</label>
                                            <select id="supplier_id" name="supplier-id" class="form-control" required>
                                                <option value="0">Seleccione</option>
                                                {% for s in supplier_set %}
                                                    {% if s.id == purchase.supplier.id %}
                                                        <option selected value="{{ s.id }}">{{ s.name|upper }}</option>
                                                    {% else %}
                                                        <option value="{{ s.id }}">{{ s.name|upper }}</option>
                                                    {% endif %}
                                                {% endfor %}
                                            </select>
                                        </div>

                                        <div class="col-sm-4 col-md-4 col-lg-4 {% if contract_obj is None %}d-none{% endif %} delivery">
                                            <label for="delivery_date">Fecha de entrega:</label>
                                            <input type="date" class="form-control" id="delivery_date"
                                                   name="delivery-date"
                                                   value="{{ purchase.delivery_date|date:'Y-m-d' }}">
                                        </div>

                                        <div class="col-sm-4 col-md-4 col-lg-4 {% if contract_obj %}d-none{% endif %} purchase-date">
                                            <label for="id_fechacompra">Fecha:</label>
                                            <input type="date" class="form-control" id="id_fechacompra"
                                                   name="fechacompra"
                                                   value="{{ purchase.purchase_date|date:"Y-m-d" }}" required>
                                        </div>
                                    </div>

                                    <div class="row p-1">
                                        <div class="col-sm-4 col-md-4 col-lg-4">
                                            <label for="reference">Referencia:</label>
                                            <input type="text" class="form-control text-uppercase" id="reference"
                                                   name="reference" autocomplete="off"
                                                   placeholder="O/C"
                                                   value="{{ purchase.reference|default_if_none:'' }}" required>
                                        </div>

                                        <div class="col-sm-4 col-md-4 col-lg-4">
                                            <label for="payment_type">Tipo de pago:</label>
                                            <select id="payment_type" class="form-control text-uppercase">
                                                <option value="0">Seleccione</option>
                                                {% for item in choices_payments_purchase %}
                                                    {% if item.0 == purchase.payment_method %}
                                                        <option selected value="{{ item.0 }}">{{ item.1 }}</option>
                                                    {% else %}
                                                        <option value="{{ item.0 }}">{{ item.1 }}</option>
                                                    {% endif %}
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="col-sm-4 col-md-4 col-lg-4">
                                            <label for="pay_condition">Condicion de pago:</label>
                                            <input type="text" class="form-control" id="pay_condition"
                                                   name="pay_condition" autocomplete="off"
                                                   placeholder=""
                                                   value="{{ purchase.payment_condition }}" required>
                                        </div>

                                        <div class="col-sm-2 col-md-2 col-lg-2 pr-1 pl-1 dues d-none">
                                            <label>Monto:</label>
                                            <div class="input-group">
                                                <input type="number" class="form-control text-right" placeholder="INGRESE MONTO"
                                                       aria-label="Recipient's username" aria-describedby="add-dues" id="amount-due">
                                                <button class="btn btn-outline-success" type="button" id="add-dues">+</button>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="row pt-4 pb-4 pr-0 pl-0">
                                        <div class="col-sm-4 col-md-4 col-lg-4">
                                            <button type="button" id="btn-new" class="btn btn-sm btn-secondary btn-block">NUEVO</button>
                                        </div>

                                        <div class="col-sm-4 col-md-4 col-lg-4">
                                            <button type="submit" id="btn-save" class="btn btn-sm btn-primary btn-block">ACTUALIZAR</button>
                                        </div>

                                        <div class="col-sm-4 col-md-4 col-lg-4">
                                            <button type="button" id="btn-add-new-detail" class="btn btn-sm btn-success btn-block">AGREGAR +</button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Referencia de venta -->
                    <div class="col-12 col-lg-7 pl-0">
                        <div class="h-100">
                            <div class="card-header bg-light py-2 px-3">
                                <h6 class="mb-0 font-weight-bold text-dark roboto-condensed-regular">
                                    <i class="fa fa-shopping-cart mr-2"></i>
                                    DATOS CLIENTE
                                </h6>
                            </div>
                            <div class="card-body p-3">
                                <div class="row">
                                    <div class="col-sm-12 col-md-12 col-lg-12 text-left">
                                        <label for="person-names" class="">Referencia de Venta: (Cliente)</label>
                                        <div id="autocomplete-client" class="autocomplete">
                                            <input class="form-control autocomplete-input"
                                                   type="text"
                                                   id="person-names"
                                                   name="person-names"
                                                   maxlength="200"
                                                   autocomplete="off"
                                                   value="{{ purchase.client_reference.names }}"
                                                   placeholder="Buscar Cliente..."/>
                                            <ul class="autocomplete-result-list"></ul>
                                        </div>
                                        <input type="hidden" id="client_reference_id"
                                               name="client_reference"
                                               value="{{ purchase.client_reference.id }}">
                                        <input type="hidden" id="type_client_reference" name="type_client_reference" value="{{ purchase.client_reference.type_client|default:'' }}">
                                    </div>
                                </div>
                                <div class="row p-1">
                                    <div class="col-sm-4 col-md-4 col-lg-4">
                                        <div class="custom-control custom-checkbox">
                                            <input class="custom-control-input" type="checkbox"
                                                   id="check-subsidiary"
                                                   {% if purchase.delivery_choice == 'S' %}checked{% endif %}>
                                            <label for="check-subsidiary" class="custom-control-label">En Anderquin:</label>
                                        </div>
                                        <select id="address_subsidiary" name="address_subsidiary"
                                                class="form-control">
                                            <option value="0">Seleccione</option>
                                            {% for s in subsidiary_set %}
                                                {% if s.id == purchase.delivery_subsidiary.id %}
                                                    <option selected value="{{ s.id }}">{{ s.address }}</option>
                                                {% else %}
                                                    <option value="{{ s.id }}">{{ s.name|upper }}</option>
                                                {% endif %}
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-sm-4 col-md-4 col-lg-4">
                                        <div class="custom-control custom-checkbox">
                                            <input class="custom-control-input" type="checkbox"
                                                   id="check-provider"
                                                   {% if purchase.delivery_choice == 'P' %}checked{% endif %}>
                                            <label for="check-provider" class="custom-control-label">En Proveedor:</label>
                                        </div>
                                        <select id="address_provider" name="address_provider"
                                                class="form-control">
                                            <option value="0">Seleccione</option>
                                            {% for s in supplier_address_set %}
                                                {% if s.id == purchase.delivery_supplier.id %}
                                                    <option selected value="{{ s.id }}">{{ s.address }}</option>
                                                {% else %}
                                                    <option value="{{ s.id }}">{{ s.address }}</option>
                                                {% endif %}
                                            {% endfor %}
                                        </select>
                                    </div>
                                    <div class="col-sm-4 col-md-4 col-lg-4 delivery-client">
                                        <div class="custom-control custom-checkbox">
                                            <input class="custom-control-input" type="checkbox"
                                                   id="check-client"
                                                   {% if purchase.delivery_choice == 'CR' %}checked{% endif %}>
                                            <label for="check-client" class="custom-control-label">En Cliente: (Referencia)</label>
                                        </div>
                                        <select id="client_address_reference" name="client_address_reference"
                                                class="form-control">
                                            <option value="0">Seleccione</option>
                                            {% for c in client_reference_address_set %}
                                                {% if c.id == purchase.delivery_client.id %}
                                                    <option selected value="{{ c.id }}">{{ c.address }}</option>
                                                {% else %}
                                                    <option value="{{ c.id }}">{{ c.address }}</option>
                                                {% endif %}
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-sm-12 col-md-12 col-lg-12">
                                        <label for="observations" class="">Observaciones:</label>
                                        <input type="text" class="form-control" id="observations"
                                               name="observations"
                                               placeholder="OBSERVACIONES"
                                               value="{{ purchase.observation|upper }}">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Sección de detalles de la tabla -->
                <div class="border-top">
                    <div class="card-header bg-light py-2 px-3">
                        <h6 class="mb-0 font-weight-bold text-dark roboto-condensed-regular">
                            <i class="fa fa-list-alt mr-2"></i>
                            DETALLES DE LA ORDEN
                        </h6>
                    </div>
                    <div class="p-3">
                        <div class="table-responsive" id="render-table">
                            <div class="table-responsive dataTables_wrapper roboto-condensed-regular">
                                <table id="id_detail_data_grid"
                                       class="table table-hover table-sm align-content-center table-bordered mb-0"
                                       cellspacing="0" style="width: 100%;">
                                <thead>
                                <tr class="text-center text-white" style="background: #1a77c8">
                                    <th scope="col" class="align-middle font-weight-normal" style="width: 5%;">Nº</th>
                                    <th scope="col" class="align-middle font-weight-normal" style="width: 30%;">
                                        Descripción de Artículo
                                    </th>
                                    <th scope="col" class="align-middle font-weight-normal client-detail-column {% if not show_client_detail_column %}d-none{% endif %}" style="width: 15%;">
                                        Cliente Detalle
                                    </th>
                                    <th scope="col" class="align-middle font-weight-normal" style="width: 8%;">
                                        Cantidad
                                    </th>
                                    <th scope="col" class="align-middle font-weight-normal" style="width: 8%;">Unidad
                                        Medida
                                    </th>
                                    <th scope="col" class="align-middle font-weight-normal"
                                        style="width: 8%; background-color: #518d86">Cant. / U. M.
                                    </th>
                                    <th scope="col" class="align-middle font-weight-normal" style="width: 8%;">Valor
                                        Unitario
                                    </th>
                                    <th scope="col" class="align-middle font-weight-normal" style="width: 8%;">
                                        Importe
                                    </th>
                                    <th scope="col" class="align-middle font-weight-normal" style="width: 5%;">
                                        Eliminar
                                    </th>
                                </tr>
                                </thead>
                                <tbody id="details-table">
                                {% for pd in purchase_detail_dict %}
                                    <tr class="" product="{{ pd.product_id }}" pd_id="{{ pd.id }}">
                                        <td class="item-numero align-middle text-center">{{ forloop.counter }}</td>
                                        <td class="align-middle text-left product-item-table">
                                            <input type="text"
                                                   class="form-control text-uppercase product-table dropdown-toggle"
                                                   data-toggle="dropdown" aria-expanded="false"
                                                   placeholder="Ingrese producto..."
                                                   value="{{ pd.product_name }} - {{ pd.product_brand }}"
                                                   {% if contract_obj %}disabled{% endif %}>
                                            <div class="dropdown-menu"></div>
                                        </td>
                                        <td class="align-middle text-center client-detail-column {% if not show_client_detail_column %}d-none{% endif %}">
                                            <select class="form-control select2-client-detail" style="width: 100%;">
                                                <option value="">Buscar Cliente...</option>
                                                {% if pd.client_entity_id %}
                                                    <option value="{{ pd.client_entity_id }}" selected>{{ pd.client_entity_name }}</option>
                                                {% endif %}
                                            </select>
                                            <input type="hidden" class="client-detail-id" 
                                                   value="{% if pd.client_entity_id %}{{ pd.client_entity_id }}{% endif %}">
                                        </td>
                                        <td class="align-middle item-quantity">
                                            <input type="text"
                                                   class="form-control text-center quantity-product text-uppercase"
                                                   placeholder="0"
                                                   value="{{ pd.quantity_x_und|safe|floatformat:0 }}">
                                        </td>
                                        <td class="align-middle unit">
                                            <select class="form-control unit-product text-center" id="id_unit_product"
                                                    name="unit_product" required>
                                                <option value="0">Seleccione</option>
                                                {% for u in pd.units %}
                                                    {% if u.id == pd.unit_id %}
                                                        <option selected value="{{ u.id }}"
                                                                qm="{{ u.quantity_minimum }}">{{ u.name }}
                                                            ({{ u.quantity_minimum }}UND)
                                                        </option>
                                                    {% else %}
                                                        <option value="{{ u.id }}"
                                                                qm="{{ u.quantity_minimum }}">{{ u.name }}
                                                            ({{ u.quantity_minimum }}UND)
                                                        </option>
                                                    {% endif %}
                                                {% endfor %}
                                            </select>
                                        </td>
                                        <td class="align-middle quantity-minimum">
                                            <input type="text" class="form-control text-center quantity-minimum-val"
                                                   value="{{ pd.quantity|safe }}">
                                        </td>
                                        <td class="item-price text-right align-middle">
                                            <div class="input-icon">
                                                <input type="text"
                                                       class="form-control text-right text-uppercase price-unit-product"
                                                       value="{{ pd.price_unit|safe }}"
                                                       placeholder="0.00">
                                                <i class="change-money">S/</i>
                                            </div>
                                        </td>
                                        <td class="item-total text-right align-middle total-row">
                                            <div class="input-icon">
                                                <input type="text"
                                                       class="form-control text-right text-uppercase total-detail"
                                                       value="{{ pd.total_detail|safe }}"
                                                       placeholder="0.00">
                                                <i class="change-money">S/</i>
                                            </div>
                                        </td>
                                        <td class="align-middle text-center">
                                            <button type="button" onclick="deleteItem(this)"
                                                    class="btn btn-danger delete-detail">
                                                <i class="fa fa-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                {% endfor %}

                                </tbody>

                                <tfoot id="details-table-foot">
                                <tr>
                                    <td class="border-0" colspan="2"></td>

                                    <td class="border td-table-foot" colspan="11">
                                        <div class="form-check mt-5">
                                            <input class="form-check-input check-igv"
                                                   {% if purchase.check_igv %}checked{% endif %} type="checkbox"
                                                   id="check_igv">
                                            <label class="form-check-label" for="check_igv">
                                                INCLUYE IGV
                                            </label>
                                        </div>
                                        <table class="table table-hover table-sm align-content-center table-bordered mt-3 "
                                               cellspacing="0" style="width: 100%;" id="id_detail_data_foot">

                                            <thead>
                                            <tr class="text-center text-white" style="background: #1a77c8">
                                                <th scope="col" class="align-middle font-weight-normal"
                                                    style="width: 35%;">
                                                    Base Imponible
                                                </th>
                                                <th scope="col" class="align-middle font-weight-normal"
                                                    style="width: 30%;">
                                                    IGV (18%)
                                                </th>
                                                <th scope="col" class="align-middle font-weight-normal"
                                                    style="width: 35%;">
                                                    Importe Total
                                                </th>
                                            <tbody id="table-detail-foot">
                                            <tr class="text-center">
                                                <td class="foot-base">
                                                    <div class="input-icon">
                                                        <input type="text"
                                                               class="form-control text-right text-uppercase total-foot-base"
                                                               placeholder="0.00"
                                                               value="{{ purchase.base_total_purchase|safe }}">
                                                        <i class="change-money">S/</i>
                                                    </div>
                                                </td>
                                                <td class="foot-igv">
                                                    <div class="input-icon">
                                                        <input type="text"
                                                               class="form-control text-right text-uppercase total-foot-igv"
                                                               placeholder="0.00"
                                                               value="{{ purchase.igv_total_purchase|safe }}">
                                                        <i class="change-money">S/</i>
                                                    </div>
                                                </td>
                                                <td class="foot-total">
                                                    <div class="input-icon">
                                                        <input type="text"
                                                               class="form-control text-right text-uppercase total-foot-total"
                                                               placeholder="0.00"
                                                               value="{{ purchase.total|safe }}">
                                                        <i class="change-money">S/</i>
                                                    </div>
                                                </td>

                                            </tr>
                                            </tbody>
                                        </table>
                                    </td>
                                </tr>
                                </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="mr-3 ml-0" style="
                display: none;
                position: absolute;
                top: 83px;
                left: 0px;
                background: #e9ecef;
                opacity: 0.5;
                width: 100%;
                bottom: 560px;
                padding-right: 65em;
                padding-top: 2em;" id="loading-666">
        </div>

        <div class="modal fade bd-example-modal-lg" id="add-modal" tabindex="-1" role="dialog"
             aria-labelledby="exampleModalLabel" aria-hidden="true"></div>
    {% else %}
        <div class="alert alert-info alert-dismissible fade show mt-3" role="alert">
            <strong>Atencion!</strong> No existe la compra, favor de regresar y revisar de nuevo
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>

    {% endif %}

    <style>
        .input-icon {
            position: relative;
        }

        .input-icon > i {
            position: absolute;
            display: block;
            transform: translate(0, -50%);
            top: 50%;
            pointer-events: none;
            width: 25px;
            text-align: center;
            font-style: normal;
        }

        .input-icon > input {
            padding-left: 25px;
            padding-right: 8px;
        }

        .input-icon-right > i {
            right: 0;
        }

        .input-icon-right > input {
            padding-left: 0;
            padding-right: 25px;
            text-align: right;
        }

        /* Estilos para el checkbox de O/C sin referencia */
        .form-check-label {
            font-size: 0.875rem;
            color: #333;
            cursor: pointer;
        }

        .form-check-input {
            margin-top: 0.25rem;
        }

        /* Estilos para cards con fondo de color */
        .card.shadow-sm[style*="background: #62a239"] .form-check-label {
            color: #ffffff !important;
        }

        .card.shadow-sm[style*="background: #1a77c8"] .form-check-label {
            color: #ffffff !important;
        }
        
        .card.shadow-sm[style*="background: #3e6787"] .form-check-label {
            color: #ffffff !important;
        }

        /* Estilos para la funcionalidad de cliente en detalles */
        .client-detail-active .client-detail-column {
            display: table-cell !important;
        }

        /* Centrar texto en elementos Select2 */
        .select2-container--default .select2-selection--single .select2-selection__rendered {
            text-align: center !important;
        }

        .select2-container--default .select2-selection--single {
            text-align: center !important;
        }

        /* Centrar texto en inputs de autocomplete */
        .autocomplete-input {
            text-align: center !important;
        }

        .select2-container--default .select2-selection--single {
            border: 1px solid #ced4da;
            border-radius: 0.25rem;
            height: 31px;
            line-height: 1.5;
        }

        .select2-container--default .select2-selection--single .select2-selection__rendered {
            line-height: 28px;
            padding-left: 8px;
            color: #495057;
            font-size: 12px;
        }

        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 29px;
        }

        .select2-dropdown {
            border: 1px solid #ced4da;
            border-radius: 0.25rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .select2-results__option {
            padding: 6px 12px;
            font-size: 12px;
        }

        .select2-results__option--highlighted[aria-selected] {
            background-color: #007bff;
            color: white;
        }

        .select2-search__field {
            font-size: 12px;
            padding: 4px 8px;
        }

        /* Estilos para el card principal del contenido */
        .card.m-2.roboto-condensed-regular {
            border: 1px solid #dee2e6;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }

        .card.m-2.roboto-condensed-regular .card-body {
            padding: 0;
        }

        .card.m-2.roboto-condensed-regular .card-header {
            background-color: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
            font-size: 0.875rem;
        }

        .card.m-2.roboto-condensed-regular .card-header h6 {
            font-size: 0.875rem;
            font-weight: 600;
        }

        .card.m-2.roboto-condensed-regular .card-header i {
            color: #6c757d;
        }

        .border-end {
            border-right: 1px solid #dee2e6 !important;
        }

        /* Responsive para el layout principal */
        @media (max-width: 991.98px) {
            .border-end {
                border-right: none !important;
                border-bottom: 1px solid #dee2e6 !important;
            }

            .col-12.col-lg-5,
            .col-12.col-lg-7 {
                margin-bottom: 1rem;
            }
        }

        @media (max-width: 768px) {
            .card.m-2.roboto-condensed-regular .card-header {
                padding: 0.5rem 0.75rem;
            }

            .card.m-2.roboto-condensed-regular .card-body {
                padding: 0.75rem;
            }

            .card.m-2.roboto-condensed-regular .card-header h6 {
                font-size: 0.8rem;
            }

            .form-check-label {
                font-size: 0.8rem;
            }
        }

        @media (max-width: 576px) {
            .card.m-2.roboto-condensed-regular .card-header {
                padding: 0.375rem 0.5rem;
            }

            .card.m-2.roboto-condensed-regular .card-body {
                padding: 0.5rem;
            }

            .card.m-2.roboto-condensed-regular .card-header h6 {
                font-size: 0.75rem;
            }

            .form-check-label {
                font-size: 0.75rem;
            }
        }
    </style>


{% endblock body %}

{% block extrajs %}
    <script type="text/javascript">
        // Variable global para almacenar las unidades de productos
        let _unit_dict = [];

        // Loader para mostrar durante las operaciones
        loader = '<div class="container">' +
            '<div class="row">' +
            '<div class="col-md-12">' +
            '<div class="loader">' +
            '<p><strong>Cargando...</strong></p>' +
            '<div class="loader-inner"></div>' +
            '<div class="loader-inner"></div>' +
            '<div class="loader-inner"></div>' +
            '</div>' +
            '</div>' +
            '</div>' +
            '</div>';

        $(document).ready(function () {
            // Inicializar el tipo de moneda
            let _check = $("#check_dollar")
            if (_check.is(':checked')) {
                $(".change-money").text('$')
            } else {
                $(".change-money").text('S/')
            }
            
            // Sincronizar checkboxes de dólares
            $('#check_dollar, #check_dollar_header').on('change', function() {
                let isChecked = $(this).is(':checked');
                $('#check_dollar, #check_dollar_header').prop('checked', isChecked);
                if (isChecked) {
                    $(".change-money").text('$')
                } else {
                    $(".change-money").text('S/')
                }
            });
            
        });

        // Cambio de año - actualizar correlativo
        $(document).on('change', '#year', function (e) {
            let year = $(this).val()
            let _correlative = $('#correlative')
            $.ajax({
                url: '/buys/get_correlative_by_year/',
                async: true,
                dataType: 'json',
                type: 'GET',
                data: {'year': year},
                success: function (response) {
                    _correlative.val(response.correlative)
                },
            });
        });

        // Botón nuevo - redirigir a la página de nueva compra
        $("#btn-new").click(function () {
            setTimeout(() => {
                window.open("/buys/buy_list/", '_self');
            }, 1000);
        });

        // Verificar que todas las unidades estén seleccionadas
        function checkUnit() {
            let flag = false
            $('tbody#details-table tr').each(function () {
                let _unit = $(this).find('td.unit select.unit-product').val()
                if (_unit === '0') {
                    flag = true
                }
            });
            return flag
        }

        // Enfoque en campo de producto
        $(document).on('focusin', '.product-table', function (e) {
            $(this).parent('td').find('div.dropdown-menu').css({
                'background-color': 'transparent',
                'border': 'transparent',
            })
            $(this).val(' ');
            //$('#id_unit_product').val('0')
        });

        // Búsqueda de productos
        $(document).on('keypress', '.product-table', function (e) {
            $(this).parent('td').find('div.dropdown-menu').empty()

            if (e.keyCode === 13) {
                e.preventDefault()
                $(this).trigger("enterKey");
                let _product_name = $(this).val();
                let _td = $(this).parent('td')
                let _menu = _td.find('.dropdown-menu')

                if (_product_name.length > 3) {
                    $.ajax({
                        url: '/buys/get_product_by_criteria_table/',
                        async: true,
                        dataType: 'json',
                        type: 'GET',
                        data: {
                            'value': _product_name,
                        },
                        contentType: 'application/json;charset=UTF-8',
                        headers: {"X-CSRFToken": '{{ csrf_token }}'},
                        success: function (response, textStatus, xhr) {
                            if (xhr.status === 200) {
                                let list = response.productList;
                                console.log("list", list)
                                _menu.css({'background-color': '#fff', 'border': '1px solid rgba(0,0,0,.15)'})
                                for (let i = 0; i < list.length; i++) {
                                    let unit_dict = JSON.stringify(list[i].unit_dict)
                                    _menu.append(`<a class="dropdown-item product-item" unit='${unit_dict}'  brand="${list[i].brand}" href="#" data-id="${list[i].id}">${list[i].name} - ${list[i].brand}</a>`)
                                }
                            }
                        },
                        error: function (jqXhr, textStatus, xhr) {
                            if (jqXhr.status === 500) {
                                toastr.error(jqXhr.responseJSON.error, 'Mensaje');
                            } else {
                                if (textStatus === 'timeout') {
                                    toastr.error('Failed from timeout', 'Mensaje');
                                } else {
                                    console.log(" STATUS: " + xhr + " " + textStatus);
                                }
                            }
                        }
                    });
                } else {
                    toastr.warning('Para la busqueda ingrese minimo 3 caracteres', 'Error de llenado');
                    return false;
                }
            }
        });

        // Selección de producto
        $(document).on('click', '.product-item', function (e) {
            let _product_id = $(this).attr('data-id');
            let _unit_dict = $(this).attr('unit');
            let _product_name = $(this).text();
            let _tr = $(this).parent('div.dropdown-menu').parent('td').parent('tr')
            let _td = $(this).parent('div.dropdown-menu').parent('td')
            let _select_unit = _tr.find('td.unit select.unit-product');

            _tr.attr('product', _product_id);
            _tr.attr('pd_id', NaN)
            _td.find('input.product-table').val(_product_name);
            _select_unit.append($('<option>').val(0).text('Seleccione'));
            
            let units = JSON.parse(_unit_dict);
            for (let i = 0; i < units.length; i++) {
                let _quantity_minimum = Number(units[i].quantity_minimum).toFixed(0);
                let option = $('<option>')
                    .val(units[i].unit_id)
                    .text(units[i].unit_name + ' ' + '(' + _quantity_minimum + 'UND' + ')')
                    .attr('qm', _quantity_minimum);
                _select_unit.append(option);
            }

            $(this).parent('div.dropdown-menu').empty()
            $(this).parent('div.dropdown-menu').addClass('hide')
        });

        // Cambio de unidad
        $(document).on('change', '.unit-product', function (e) {
            let unit_id = $(this).val();
            let product_id = $(this).parent('td').parent('tr').attr('product')
            let _quantity = Number($(this).parent('td').parent('tr').find('td.item-quantity input.quantity-product').val())
            let _tr = $(this).parent('td').parent('tr')
            
            if (unit_id !== '0') {
                getQuantityMinimumByProduct(product_id, unit_id, _tr, _quantity)
            } else {
                toastr.warning('Seleccione una unidad valida', 'Error de llenado');
                $(this).val(1).change();
                return false;
            }
        });

        // Cambio en cantidad mínima
        $(document).on('keyup', '.quantity-minimum-val', async function (e) {
            let _tr = $(this).parent('td').parent('tr');
            let _quantity_minimum = _tr.find('td.unit select.unit-product option:selected').attr('qm');
            let _val = $(this).val();
            let _quantity = _tr.find('td.item-quantity input.quantity-product');
            let _new_quantity = _val * _quantity_minimum
            _quantity.val(_new_quantity);
            $('.quantity-product').trigger('keyup');
        });

        // Obtener cantidad mínima por producto
        function getQuantityMinimumByProduct(product_id, _unit, _tr, _quantity) {
            let _input_quantity_minimum = _tr.find('td.quantity-minimum input.quantity-minimum-val');
            let _price_unit_product = _tr.find('td.item-price input.price-unit-product');
            _input_quantity_minimum.val('')
            
            if (product_id !== '0') {
                $.ajax({
                    url: '/buys/get_quantity_minimum/',
                    async: true,
                    dataType: 'json',
                    type: 'GET',
                    data: {
                        'product_id': product_id,
                        'unit_id': _unit
                    },
                    success: function (response) {
                        let _quantity_minimum = Number(response.quantity_minimum).toFixed(2)
                        if (_quantity_minimum && _quantity) {
                            let _q_x_u = _quantity / _quantity_minimum
                            _input_quantity_minimum.val(_q_x_u)
                        }
                        _price_unit_product.val(response.price_purchase);
                        $('.price-unit-product').trigger('keyup');
                    },
                });
            }
        }

        // Cambio en cantidad
        $(document).on('keyup', '.quantity-product', function () {
            let _tr = $(this).parent('td').parent('tr')
            let _quantity = Number(_tr.find('td.item-quantity input.quantity-product').val())
            let _quantity_minimum = Number((_tr.find('td.quantity-minimum input.quantity-minimum-val').val()))

            if (_quantity_minimum !== 0 && _quantity_minimum !== '') {
                quantityMinimumXQuantity(_quantity, _quantity_minimum, _tr)
            }
            calculate_total(_tr)
            sum_table()
        });

        // Cambio en precio unitario
        $(document).on('keyup', '.price-unit-product', function () {
            let _tr = $(this).parent('div').parent('td').parent('tr')
            let _quantity = Number(_tr.find('td.item-quantity input.quantity-product').val())
            let _quantity_minimum = Number(_tr.find('td.quantity-minimum input.quantity-minimum-val').val())
            let _price_unit = Number(_tr.find('td.item-price input.price-unit-product').val())

            if (_quantity !== 0 && _price_unit !== 0) {
                let _total = _quantity_minimum * _price_unit
                _tr.find('td.total-row input.total-detail').val(Number(_total).toFixed(2));
            }
            calculate_total(_tr)
            sum_table()
        });

        // Calcular total
        function calculate_total(_tr) {
            let $quantity_minimum = Number(_tr.find('td.quantity-minimum input.quantity-minimum-val').val())
            let $price_unit = Number(_tr.find('td.item-price input.price-unit-product').val());
            let amount = $quantity_minimum * $price_unit
            _tr.find('td.total-row input.total-detail').val(amount.toFixed(4))
        }

        // Sumar tabla
        function sum_table() {
            let igv = 0;
            let base = 0;
            let sum_total = 0;
            let _total;

            $("#id_detail_data_grid tbody#details-table tr").each(function () {
                let td_total = Number($(this).find("td.total-row input.total-detail").val());
                sum_total = sum_total + td_total
            });

            let _check_igv = $("#id_detail_data_grid tfoot tr input.check-igv")

            if (_check_igv.is(':checked')) {
                base = sum_total / 1.18
                igv = sum_total - base
                _total = base + igv
            } else {
                base = sum_total
                igv = sum_total * 0.18
                _total = base + igv
            }

            $("#id_detail_data_grid tfoot tr input.total-foot-base").val(base.toFixed(4));
            $("#id_detail_data_grid tfoot tr input.total-foot-igv").val(igv.toFixed(4));
            $("#id_detail_data_grid tfoot tr input.total-foot-total").val(_total.toFixed(4));
        }

        // Cambio en checkbox IGV
        $(document).on('change', '#id_detail_data_grid tfoot tr input.check-igv', function (e) {
            sum_table()
        });

        // Agregar nuevo detalle
        $(document).on('click', '#btn-add-new-detail', function () {
            let _check = $("#check_dollar");
            let _val_money = 'S/'
            let _show_client_column = {{ show_client_detail_column|yesno:"true,false" }};

            if (_check.is(':checked')) {
                _val_money = '$'
            }

            let clientColumn = '';
            if (_show_client_column) {
                clientColumn = '<td class="align-middle text-center client-detail-column">' +
                    '<select class="form-control select2-client-detail" style="width: 100%;">' +
                    '<option value="">Buscar Cliente...</option>' +
                    '</select>' +
                    '<input type="hidden" class="client-detail-id" value="">' +
                    '</td>';
            }

            $('#id_detail_data_grid > tbody').append(
                '<tr class="text-center">' +
                '<td class="item-numero align-middle">' + '</td>' +
                '<td class="align-middle text-left product-item-table">' +
                '<input type="text" class="form-control text-uppercase product-table dropdown-toggle" ' +
                '               data-toggle="dropdown" aria-expanded="false" placeholder="Ingrese producto...">' + '<div class="dropdown-menu"></div>' + '</td>' +
                clientColumn +
                '<td class="align-middle item-quantity">' + '<input type="text" class="form-control text-center quantity-product text-uppercase" placeholder="0">' + '</td>' +
                '<td class="align-middle unit text-center">' +
                '<select class="form-control unit-product text-center" id="id_unit_product" name="unit_product" required>' +
                '<option disabled value="0">Seleccione</option>' +
                '</td>' +
                '<td class="align-middle quantity-minimum text-center">' +
                '<input type="text" class="form-control text-center quantity-minimum-val" readonly>' +
                '</td>' +

                '<td class="item-price text-right align-middle" price-unit-with-discount="">' + '<div class="input-icon">' +
                '<input type="text" class="form-control text-right text-uppercase price-unit-product" placeholder="0.00">' + '<i class="change-money">' + _val_money + '</i>' + '</div>' + '</td>' +

                '<td class="item-total text-right align-middle total-row">' + '<div class="input-icon">' +
                '<input type="text" class="form-control text-right text-uppercase total-detail" placeholder="0.00">' + '<i class="change-money">' + _val_money + '</i>' + '</div>' + '</td>' +

                '<td class="align-middle"> ' + '<button type="button" onclick="deleteItem(this)" class="btn btn-danger delete-detail"><i class="fa fa-trash"></i></button>' + '</td>' +
                '</tr>');
            
            // Inicializar Select2 en la nueva fila si es necesario
            if (_show_client_column) {
                setTimeout(() => {
                    let newRow = $('#details-table tr:last');
                    let selectElement = newRow.find('.select2-client-detail');
                    if (selectElement.length > 0) {
                        initializeSelect2ClientDetail(selectElement);
                    }
                }, 100);
            }
            
            counterStrike2()
        });

        // Eliminar item
        function deleteItem(btn) {
            let row = $(btn).closest('tr');
            let detail_id = parseInt(row.attr('pd_id'));

            if (!isNaN(detail_id)) {
                let r = confirm("¿Está seguro que desea eliminar el detalle?, al hacerlo no podra recuperarlo")
                if (r === true) {
                    deleteProduct(detail_id);
                    row.remove();
                    counterStrike2();
                }
            } else {
                row.remove();
                counterStrike2();
            }
        }

        // Contador de filas
        function counterStrike2() {
            let l = 1;
            $('#details-table tr').each(function () {
                $(this).attr('i', l);
                let firstTd = $(this).children('td').first();
                if (firstTd.hasClass('item-numero')) {
                    firstTd.text(l);
                }
                l++;
            });
            // Recalcular totales después de reordenar
            sum_table();
        }

        // Eliminar producto de la base de datos
        function deleteProduct(detail_id) {
            $.ajax({
                url: '/buys/delete_item_buys/',
                async: true,
                dataType: 'json',
                type: 'GET',
                data: {'detail_id': detail_id},
                contentType: 'application/json;charset=UTF-8',
                headers: {"X-CSRFToken": '{{ csrf_token }}'},
                success: function (response, textStatus, xhr) {
                    if (xhr.status === 200) {
                        toastr.success(response.message, '¡Mensaje!');
                    }
                },
                error: function (jqXhr, textStatus, xhr) {
                    toastr.error(jqXhr.responseJSON.error, '¡ERROR!');
                }
            });
        }

        // Cambio en tipo de pago
        $(document).on('change', '#payment_type', function (e) {
            let type_pay = $(this).val();
            if (type_pay === 'L') {
                $('.dues').removeClass('d-none');
                $('.table-dues').removeClass('d-none');
            } else {
                $('.dues').addClass('d-none');
                $('.table-dues').addClass('d-none');
            }
        });

        // Inicializar tipo de pago
        $("#payment_type").trigger('change');

        // Envío del formulario
        $('#purchase-form').submit(function (event) {
            event.preventDefault();
            let reference = $('#reference').val()
            let _contract = $("#contract_detail_id")
            let delivery_date = $('#delivery_date').val()
            
            if (_contract.val() !== '') {
                if (delivery_date === '') {
                    toastr.warning('¡Seleccione la fecha de entrega!', 'Mensaje');
                    return false;
                }
            } else {
                delivery_date = ''
            }

            if ($('#payment_type').val() === '0') {
                toastr.warning('¡Selecione el tipo de pago!', 'Mensaje');
                return false;
            }
            if ($('#supplier_id').val() === '0') {
                toastr.warning('¡Selecione el proveedor!', 'Mensaje');
                return false;
            }
            if (checkUnit() === true) {
                toastr.warning('¡Selecione el tipo de unidad en los productos!', 'Mensaje');
                return false;
            }

            if ($("#id_detail_data_grid tbody#details-table tr").length > 0 && $('.product-table').val() !== '') {
                let table_foot = $("#id_detail_data_grid tfoot#details-table-foot tr td.td-table-foot").find("#id_detail_data_foot tbody#table-detail-foot tr")
                let Detail_purchase = {
                    "PurchaseId": $('#purchase_id').val(),
                    "SupplierId": $('#supplier_id').val(),
                    "Date": $('#id_fechacompra').val(),
                    "Reference": reference,
                    "Delivery_date": delivery_date,
                    "Type_Pay": $('#payment_type').val(),
                    "Pay_condition": $('#pay_condition').val(),
                    "Base_Total": Number(table_foot.find("td.foot-base input.total-foot-base").val().replace(',', '.')),
                    "Igv_Total": Number(table_foot.find("td.foot-igv input.total-foot-igv").val().replace(',', '.')),
                    "Import_Total": Number(table_foot.find("td.foot-total input.total-foot-total").val().replace(',', '.')),
                    "Check_Igv": ($("#id_detail_data_grid tfoot#details-table-foot tr td.td-table-foot").find("div.form-check input.check-igv").is(':checked')) ? 1 : 0,
                    "Check_Dollar": ($("#check_dollar").is(':checked')) ? 1 : 0,
                    "Details": [],
                    "client_reference_id": $('#client_reference_id').val(),
                    "client_final": $('#client_final').val(),
                    "check-subsidiary": ($("#check-subsidiary").is(':checked')) ? 1 : 0,
                    "check-provider": ($("#check-provider").is(':checked')) ? 1 : 0,
                    "check-client-final": ($("#check-client-final").is(':checked')) ? 1 : 0,
                    "check-client": ($("#check-client").is(':checked')) ? 1 : 0,
                    "address_subsidiary": $("#address_subsidiary").val(),
                    "address_provider": $("#address_provider").val(),
                    "client_address_reference": $("#client_address_reference").val(),
                    "client_final_address": $("#client_final_address").val(),
                    "observations": $("#observations").val(),
                    "contract_detail_id": _contract.val(),
                    "correlative": $('#correlative').val()
                };
                
                $("#id_detail_data_grid tbody#details-table tr").each(function () {
                    let detailObj = {
                        "ProductDetail": $(this).attr('pd_id'),
                        "Product": $(this).attr('product'),
                        "Unit": $(this).find("td.unit select.unit-product").val(),
                        "Quantity": $(this).find("td.item-quantity input.quantity-product").val(),
                        "QuantityUnits": $(this).find("td.quantity-minimum input.quantity-minimum-val").val(),
                        "Price": Number($(this).find("td.item-price input.price-unit-product").val()),
                        "Total": Number($(this).find("td.item-total input.total-detail").val()),
                        "ClientDetail": $(this).find("td input.client-detail-id").val() || null,
                    };
                    Detail_purchase.Details.push(detailObj);
                });
                
                console.log(Detail_purchase)
                $.ajax({
                    url: '/buys/save_update_purchase/',
                    async: true,
                    dataType: 'json',
                    type: 'GET',
                    data: {
                        'purchase': JSON.stringify(Detail_purchase),
                        'purchase_id': $('#purchase_id').val(),
                    },
                    contentType: 'application/json;charset=UTF-8',
                    headers: {"X-CSRFToken": '{{ csrf_token }}'},
                    success: function (response, textStatus, xhr) {
                        if (xhr.status === 200) {
                            toastr.success(response.message, '¡COMPRA ACTUALIZADA CORRECTAMENTE!');
                            let purchase_id = response.pk
                            window.location.href = "/buys/print_pdf_purchase_order/" + purchase_id + "/";
                            if (response.contract) {
                                setTimeout(() => {
                                    window.open("/buys/contracts/", '_self');
                                }, 2000);
                            } else {
                                setTimeout(() => {
                                    window.open("/buys/buy_list/", '_self');
                                }, 1000);
                            }
                        }
                    },
                    error: function (jqXhr, textStatus, xhr) {
                        toastr.error("ERROR. ", '¡INCONCEBIBLE!');
                    }
                });

            } else {
                toastr.warning("PARA REALIZAR LA COMPRA AGREGUE AL MENOS UN PRODUCTO. ", '¡ADVERTENCIA!');
                return false;
            }
        });

        // Obtener direcciones por cliente
        function getAddress(client_id, _select) {
            $.ajax({
                url: '/buys/get_address_by_client_id/',
                async: true,
                dataType: 'json',
                type: 'GET',
                data: {'client_id': client_id},
                success: function (response) {
                    _select.empty();
                    let _client_address = JSON.parse(response['client_address_set']);
                    _select.append($('<option>').val("0").text('Seleccione'));
                    if (response['client_address_set'] !== '[]') {
                        for (let i = 0; i < _client_address.length; i++) {
                            let option = $('<option>').val(_client_address[i]['pk']).text(_client_address[i]['fields']['address'].toUpperCase());
                            _select.append(option);
                        }
                    }
                },
            });
        }

        // Cambio en cliente de referencia
        $(document).on('change', '#client_reference_id', function (e) {
            let client_id = $(this).val();
            let _select = $('#client_address_reference')

            if (client_id !== '0') {
                let type_client = $('#client_reference_id option:selected').attr("type");
                if (type_client === 'PR') {
                    $('#client_final').val("0");
                    $('#client_final_address').val("0");
                    $('.client-final').removeClass('d-none');
                    $('.delivery-client-final').removeClass('d-none');
                    $('.delivery-client').addClass('d-none');
                } else {
                    $('.client-final').addClass('d-none');
                    $('#client_final_address').val("0");
                    $('.delivery-client-final').addClass('d-none');
                    $('.delivery-client').removeClass('d-none');
                    getAddress(client_id, _select)
                }
            } else {
                toastr.warning('Seleccione un cliente valido', 'Error de llenado');
                return false;
            }
        });

        // Cambio en checkboxes de entrega
        $(document).on('change', '#check-subsidiary', function (e) {
            if ($(this).is(":checked")) {
                $(this).attr("checked");
                $('#check-provider').prop('checked', false);
                $('#check-client').prop('checked', false);
                $('#check-client-final').prop('checked', false);
            }
        });
        
        $(document).on('change', '#check-provider', function (e) {
            if ($(this).is(":checked")) {
                $(this).attr("checked");
                $('#check-subsidiary').prop('checked', false);
                $('#check-client').prop('checked', false);
                $('#check-client-final').prop('checked', false);
            }
        });
        
        $(document).on('change', '#check-client', function (e) {
            if ($(this).is(":checked")) {
                $(this).attr("checked");
                $('#check-subsidiary').prop('checked', false);
                $('#check-provider').prop('checked', false);
                $('#check-client-final').prop('checked', false);
            }
        });
        
        $(document).on('change', '#check-client-final', function (e) {
            if ($(this).is(":checked")) {
                $(this).attr("checked");
                $('#check-subsidiary').prop('checked', false);
                $('#check-provider').prop('checked', false);
                $('#check-client').prop('checked', false);
            }
        });

        // Cambio en proveedor
        $(document).on('change', '#supplier_id', function (e) {
            let supplier_id = $(this).val();
            let _select = $('#address_provider');
            if (supplier_id !== '0') {
                $.ajax({
                    url: '/buys/get_address_by_supplier_id/',
                    async: true,
                    dataType: 'json',
                    type: 'GET',
                    data: {'supplier_id': supplier_id},
                    success: function (response) {
                        _select.empty();
                        let _supplier_address = JSON.parse(response['supplier_address_set']);
                        _select.append($('<option>').val("0").text('Seleccione'));
                        if (response['supplier_address_set'] !== '[]') {
                            for (let i = 0; i < _supplier_address.length; i++) {
                                let option = $('<option>').val(_supplier_address[i]['pk']).text(_supplier_address[i]['fields']['address'].toUpperCase());
                                _select.append(option);
                            }
                        }
                    },
                });
            }
        });

        // Autocompletado de clientes (solo si el elemento existe)
        const autocompleteClient = document.querySelector('#autocomplete-client');
        if (autocompleteClient) {
            new Autocomplete('#autocomplete-client', {
                search: input => {
                    const url = `/buys/get_client/?search=${encodeURI(input.toUpperCase())}`
                    return new Promise(resolve => {
                        if (input.length < 3) {
                            return resolve([])
                        }
                        fetch(url)
                            .then(response => response.json())
                            .then(data => {
                                resolve(data.results)
                            })
                    })
                },
                renderResult: (result, props) => {
                    let group = ''
                    if (result.index % 3 === 0) {
                        group = '<li class="group">Group</li>'
                    }
                    return `
                    ${group}
                    <li ${props}>
                     <div class="h6" style="font-family: roboto_condensed_regular">
                        ${result.names}
                     </div>
                     <div class="wiki-snippet text-black">
                        Tipo: ${result.type_client_display}
                      </div>
                    </li>
                    `
                },
                getResultValue: result => result.names,
                onSubmit: handleClientSubmit
            })
        }

        // Manejo de selección de cliente
        async function handleClientSubmit(result) {
            if (result) {
                let client_id = result.id;
                let _select = $('#client_address_reference');
                let type_client = result.type_client;
                $('#client_reference_id').val(client_id);
                if (type_client === 'PR') {
                    $('#client_final').val("0");
                    $('#client_final_address').val("0");
                    $('.client-final').removeClass('d-none');
                    $('.delivery-client-final').removeClass('d-none');
                    $('.delivery-client').addClass('d-none');
                } else {
                    $('.client-final').addClass('d-none');
                    $('#client_final_address').val("0");
                    $('.delivery-client-final').addClass('d-none');
                    $('.delivery-client').removeClass('d-none');
                    _select.empty();
                    let _client_address = result.address;
                    _select.append($('<option>').val("0").text('Seleccione'));
                    if (_client_address !== '[]') {
                        for (let i = 0; i < _client_address.length; i++) {
                            let option = $('<option>').val(_client_address[i]['id']).text(_client_address[i]['address'].toUpperCase());
                            _select.append(option);
                        }
                    }
                }
            } else {
                toastr.warning('Seleccione un cliente valido', 'Error de llenado');
                return false;
            }
        }

        // Autocompletado de cliente final (solo si el elemento existe)
        const autocompleteClientFinal = document.querySelector('#autocomplete-client-final');
        if (autocompleteClientFinal) {
            new Autocomplete('#autocomplete-client-final', {
                search: input => {
                    const url = `/buys/get_client/?search=${encodeURI(input.toUpperCase())}`
                    return new Promise(resolve => {
                        if (input.length < 3) {
                            return resolve([])
                        }
                        fetch(url)
                            .then(response => response.json())
                            .then(data => {
                                resolve(data.results)
                            })
                    })
                },
                renderResult: (result, props) => {
                    let group = ''
                    if (result.index % 3 === 0) {
                        group = '<li class="group">Group</li>'
                    }
                    return `
                    ${group}
                    <li ${props}>
                     <div class="h6" style="font-family: roboto_condensed_regular">
                        ${result.names}
                     </div>
                     <div class="wiki-snippet text-black">
                        Tipo: ${result.type_client_display}
                      </div>
                    </li>
                    `
                },
                getResultValue: result => result.names,
                onSubmit: result => {
                    if (result) {
                        let client_id = result.id;
                        let _client_address = result.address;
                        let _select = $('#client_final_address');
                        $('#client_final').val(client_id);
                        _select.empty();
                        _select.append($('<option>').val("0").text('Seleccione'));
                        if (_client_address !== '[]') {
                            for (let i = 0; i < _client_address.length; i++) {
                                let option = $('<option>').val(_client_address[i]['id']).text(_client_address[i]['address'].toUpperCase());
                                _select.append(option);
                            }
                        }
                    }
                }
            })
        }

        // Inicializar Select2 para clientes en detalles
        function initializeSelect2ClientDetail(selectElement) {
            $(selectElement).select2({
                placeholder: 'Buscar Cliente...',
                allowClear: true,
                minimumInputLength: 2,
                ajax: {
                    url: '/buys/get_client/',
                    dataType: 'json',
                    delay: 250,
                    data: function(params) {
                        return {
                            search: params.term || '',
                            page: params.page || 1
                        };
                    },
                    processResults: function(data, params) {
                        params.page = params.page || 1;
                        
                        return {
                            results: data.results || [],
                            pagination: {
                                more: false
                            }
                        };
                    },
                    cache: true
                },
                templateResult: function(client) {
                    if (client.loading) return client.text;
                    if (!client.id) return client.text;
                    
                    return $(`
                        <div class="select2-result-client">
                            <div class="select2-result-client__title">${client.names}</div>
                            <div class="select2-result-client__subtitle">${client.type_client_display || ''}</div>
                        </div>
                    `);
                },
                templateSelection: function(client) {
                    if (!client.id) return client.text;
                    return client.names || client.text;
                }
            }).on('select2:select', function(e) {
                let data = e.params.data;
                let row = $(this).closest('tr');
                let hiddenInput = row.find('.client-detail-id');
                hiddenInput.val(data.id);
            }).on('select2:clear', function(e) {
                let row = $(this).closest('tr');
                let hiddenInput = row.find('.client-detail-id');
                hiddenInput.val('');
            });
        }

        // Inicializar Select2 en elementos existentes
        $(document).ready(function() {
            // Verificar si Select2 está disponible
            if (typeof $.fn.select2 !== 'undefined') {
                $('.select2-client-detail').each(function() {
                    initializeSelect2ClientDetail(this);
                });
            } else {
                console.warn('Select2 no está cargado. Asegúrate de incluir la librería Select2.');
            }
        });

        // Inicializar Select2 en elementos dinámicos
        $(document).on('select2:open', '.select2-client-detail', function() {
            if (!$(this).data('select2')) {
                initializeSelect2ClientDetail(this);
            }
        });

    </script>

    <style>
        /* Estilos para el card del título */
        .card.shadow-sm {
            border: none;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075) !important;
        }
        
        .card.shadow-sm .card-body {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }
        
        /* Estilos para cuando hay contrato (fondo verde) */
        .card.shadow-sm[style*="background: #62a239"] .card-body {
            background: linear-gradient(135deg, #62a239 0%, #4a7c2a 100%);
        }
        
        .card.shadow-sm[style*="background: #62a239"] .text-primary {
            color: #ffffff !important;
        }
        
        .card.shadow-sm[style*="background: #62a239"] .text-muted {
            color: #e8f5e8 !important;
        }
        
        .card.shadow-sm[style*="background: #62a239"] .fa {
            color: #ffffff !important;
        }
        
        /* Estilos para cuando no hay contrato (fondo azul) - Edición */
        .card.shadow-sm[style*="background: #1a77c8"] .card-body {
            background: linear-gradient(135deg, #1a77c8 0%, #155a96 100%);
        }
        
        .card.shadow-sm[style*="background: #1a77c8"] .text-primary {
            color: #ffffff !important;
        }
        
        .card.shadow-sm[style*="background: #1a77c8"] .text-muted {
            color: #cce5f4 !important;
        }
        
        .card.shadow-sm[style*="background: #1a77c8"] .fa {
            color: #ffffff !important;
        }
        
        /* Estilos para cuando no hay contrato (fondo azul) - Nueva orden */
        .card.shadow-sm[style*="background: #3e6787"] .card-body {
            background: linear-gradient(135deg, #3e6787 0%, #2d4d63 100%);
        }
        
        .card.shadow-sm[style*="background: #3e6787"] .text-primary {
            color: #ffffff !important;
        }
        
        .card.shadow-sm[style*="background: #3e6787"] .text-muted {
            color: #b8d4e6 !important;
        }
        
        .card.shadow-sm[style*="background: #3e6787"] .fa {
            color: #ffffff !important;
        }
        
        .text-primary {
            color: #007bff !important;
        }
        
        .btn-outline-primary {
            border-color: #007bff;
            color: #007bff;
        }
        
        .btn-outline-primary:hover {
            background-color: #007bff;
            border-color: #007bff;
            color: white;
        }
        
        /* Estilos para botones en cards con fondo de color */
        .card.shadow-sm[style*="background: #62a239"] .btn-outline-primary {
            border-color: #ffffff;
            color: #ffffff;
        }
        
        .card.shadow-sm[style*="background: #62a239"] .btn-outline-primary:hover {
            background-color: #ffffff;
            border-color: #ffffff;
            color: #62a239;
        }
        
        .card.shadow-sm[style*="background: #1a77c8"] .btn-outline-primary {
            border-color: #ffffff;
            color: #ffffff;
        }
        
        .card.shadow-sm[style*="background: #1a77c8"] .btn-outline-primary:hover {
            background-color: #ffffff;
            border-color: #ffffff;
            color: #1a77c8;
        }
        
        .card.shadow-sm[style*="background: #3e6787"] .btn-outline-primary {
            border-color: #ffffff;
            color: #ffffff;
        }
        
        .card.shadow-sm[style*="background: #3e6787"] .btn-outline-primary:hover {
            background-color: #ffffff;
            border-color: #ffffff;
            color: #3e6787;
        }
        
        .input-group-text {
            background-color: #f8f9fa;
            border-color: #ced4da;
        }
        
        /* Estilos para controles en cards con fondo de color */
        .card.shadow-sm[style*="background: #62a239"] .input-group-text {
            background-color: #ffffff;
            border-color: #ffffff;
            color: #62a239;
        }
        
        .card.shadow-sm[style*="background: #1a77c8"] .input-group-text {
            background-color: #ffffff;
            border-color: #ffffff;
            color: #1a77c8;
        }
        
        .card.shadow-sm[style*="background: #3e6787"] .input-group-text {
            background-color: #ffffff;
            border-color: #ffffff;
            color: #3e6787;
        }
        
        .card.shadow-sm[style*="background: #62a239"] .form-control {
            background-color: #ffffff;
            border-color: #ffffff;
            color: #333333;
        }
        
        .card.shadow-sm[style*="background: #1a77c8"] .form-control {
            background-color: #ffffff;
            border-color: #ffffff;
            color: #333333;
        }
        
        .card.shadow-sm[style*="background: #3e6787"] .form-control {
            background-color: #ffffff;
            border-color: #ffffff;
            color: #333333;
        }
        
        .card.shadow-sm[style*="background: #62a239"] .form-text {
            color: #e8f5e8 !important;
        }
        
        .card.shadow-sm[style*="background: #1a77c8"] .form-text {
            color: #cce5f4 !important;
        }
        
        .card.shadow-sm[style*="background: #3e6787"] .form-text {
            color: #b8d4e6 !important;
        }
        
        /* Estilos para la columna de cliente en detalles */
        /*.client-detail-column {
            background-color: #f8f9fa;
        }*/

        /* Estilos para Select2 en detalles */
        .select2-client-detail {
            font-size: 12px;
        }

        .select2-container--default .select2-selection--single {
            border: 1px solid #ced4da;
            border-radius: 0.25rem;
            height: 31px;
            line-height: 1.5;
        }

        .select2-container--default .select2-selection--single .select2-selection__rendered {
            line-height: 28px;
            padding-left: 8px;
            color: #495057;
        }

        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 29px;
        }

        .select2-dropdown {
            border: 1px solid #ced4da;
            border-radius: 0.25rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .select2-results__option {
            padding: 6px 12px;
            font-size: 12px;
        }

        .select2-results__option--highlighted[aria-selected] {
            background-color: #007bff;
            color: white;
        }

        .select2-search__field {
            font-size: 12px;
            padding: 4px 8px;
        }

        /* Estilos para resultados de Select2 */
        .select2-result-client {
            padding: 2px 0;
        }

        .select2-result-client__title {
            font-weight: bold;
            color: #333;
            font-size: 12px;
        }

        .select2-result-client__subtitle {
            color: #666;
            font-size: 11px;
            font-style: italic;
        }

        /* Estilos para Select2 en detalles */
        .select2-client-detail {
            font-size: 12px;
        }

        .select2-container--default .select2-selection--single {
            border: 1px solid #ced4da;
            border-radius: 0.25rem;
            height: 31px;
            line-height: 1.5;
        }

        .select2-container--default .select2-selection--single .select2-selection__rendered {
            line-height: 28px;
            padding-left: 8px;
            color: #495057;
        }

        .select2-container--default .select2-selection--single .select2-selection__arrow {
            height: 29px;
        }

        .select2-dropdown {
            border: 1px solid #ced4da;
            border-radius: 0.25rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .select2-results__option {
            padding: 6px 12px;
            font-size: 12px;
        }

        .select2-results__option--highlighted[aria-selected] {
            background-color: #007bff;
            color: white;
        }

        .select2-search__field {
            font-size: 12px;
            padding: 4px 8px;
        }

        /* Mejoras responsive para Select2 */
        @media (max-width: 768px) {
            .select2-container--default .select2-selection--single {
                height: 28px;
            }
            
            .select2-container--default .select2-selection--single .select2-selection__rendered {
                line-height: 26px;
                font-size: 11px;
            }
            
            .select2-container--default .select2-selection--single .select2-selection__arrow {
                height: 26px;
            }
            
            .select2-results__option {
                padding: 4px 8px;
                font-size: 11px;
            }
        }

        /* Estilos responsive para el formulario principal */
        @media (max-width: 768px) {
            /* Ocultar columna de cliente en detalles en móviles si no es necesaria */
            .client-detail-column.d-none {
                display: none !important;
            }
            
            /* Mejoras responsive para Select2 */
            .select2-container--default .select2-selection--single {
                height: 28px;
            }
            
            .select2-container--default .select2-selection--single .select2-selection__rendered {
                line-height: 26px;
                font-size: 11px;
            }
            
            .select2-container--default .select2-selection--single .select2-selection__arrow {
                height: 26px;
            }
            
            .select2-results__option {
                padding: 4px 8px;
                font-size: 11px;
            }
            
            .card-body {
                padding: 0.5rem;
            }
            
            .row {
                margin-left: -0.25rem;
                margin-right: -0.25rem;
            }
            
            .col-sm-12, .col-md-12, .col-lg-12 {
                padding-left: 0.25rem;
                padding-right: 0.25rem;
            }
            
            .form-control {
                font-size: 14px;
                padding: 0.375rem 0.5rem;
            }
            
            .btn {
                font-size: 14px;
                padding: 0.375rem 0.5rem;
            }
            
            .card-header {
                padding: 0.5rem;
            }
            
            .card-header h6 {
                font-size: 14px;
            }
            
            /* Ajustar layout en móviles */
            .col-sm-5, .col-md-5, .col-lg-5,
            .col-sm-7, .col-md-7, .col-lg-7 {
                flex: 0 0 100%;
                max-width: 100%;
                margin-bottom: 1rem;
            }
            
            /* Ajustes para el card del título en móviles */
            .card.shadow-sm .card-body {
                padding: 1rem;
            }
            
            .card.shadow-sm h4 {
                font-size: 1.25rem;
            }
            
            .card.shadow-sm .fa {
                font-size: 1.5rem !important;
            }
            
            .btn-outline-primary {
                font-size: 0.875rem;
                padding: 0.5rem 0.75rem;
            }
            
            .input-group-sm .form-control {
                font-size: 0.875rem;
            }
        }

        @media (max-width: 576px) {
            /* Ajustes específicos para la columna de cliente en pantallas pequeñas */
            .client-detail-column {
                min-width: 120px;
            }
            
            .client-detail-column .form-control {
                font-size: 11px;
                padding: 0.2rem 0.4rem;
            }
            
            /* Ajustes específicos para Select2 en pantallas pequeñas */
            .select2-container--default .select2-selection--single {
                height: 26px;
            }
            
            .select2-container--default .select2-selection--single .select2-selection__rendered {
                line-height: 24px;
                font-size: 10px;
            }
            
            .select2-container--default .select2-selection--single .select2-selection__arrow {
                height: 24px;
            }
            
            .select2-results__option {
                padding: 3px 6px;
                font-size: 10px;
            }
            
            .card-body {
                padding: 0.25rem;
            }
            
            .form-control {
                font-size: 13px;
                padding: 0.25rem 0.375rem;
            }
            
            .btn {
                font-size: 13px;
                padding: 0.25rem 0.375rem;
            }
            
            .card-header h6 {
                font-size: 13px;
            }
        }
    </style>
{% endblock extrajs %}