{% extends 'home.html' %}
{% block title %}
    Facturas
{% endblock title %}

{% block body %}
    <div class="row m-0">
        <div class="col-sm-12 col-sm-12 col-lg-12 pt-3 roboto-condensed-regular">
            <div class="card">
                <div class="card-header pt-0" style="background: #19800f">
                    <div class="col-sm-2 col-md-2 col-lg-2">
                        <h5 class="montserrat text-white font-weight-bold mt-4 mb-0">
                            <label>EMISIÓN DE FACTURA:</label>
                        </h5>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row m-1">
        <div class="col-sm-12 col-md-12 col-lg-12 pr-0">
            <div class="card">
                <div class="card-header pb-1 pt-1">
                    <div class="row">
                        <div class="col-sm-9 col-md-9 col-lg-9 font-weight-bold">
                            DATOS DE LA FACTURA:
                        </div>
                    </div>
                </div>
                <div class="card-body pt-1 pb-0">
                    <div class="row p-1">
                        <div class="col-sm-7 col-md-7 col-lg-7 pl-0">
                            <div class="card-body pt-1 border pb-0 bg-light ">
                                <div class="card header mb-1 border-0 text-left font-weight-bold">
                                    Busqueda de Cliente:
                                </div>
                                <div class="row m-0 mb-2">
                                    <div class="col-2 pr-0 pl-0">
                                        <label class="form-check-label mt-2" for="radio1">
                                            Nombres/Razón Social:
                                        </label>
                                    </div>
                                    <div class="col-10 pr-0 pl-0">
                                        <input type="text"
                                               class="form-control text-uppercase client-search dropdown-toggle"
                                               data-toggle="dropdown" aria-expanded="false" aria-label="..."
                                               placeholder="Ingrese cliente y presione enter...">
                                        <div class="dropdown-menu"></div>
                                        <input type="hidden"
                                               id="client_id"
                                               name="client_id">
                                    </div>
                                    {#                                    <div class="col-3">#}
                                    {#                                        <button type="button"#}
                                    {#                                                onclick="showModalView('modal_client_create')"#}
                                    {#                                                class="btn btn-sm btn-block btn-outline-info"><i#}
                                    {#                                                class="nav-icon fas fa-user-plus"></i>#}
                                    {#                                            NUEVO CLIENTE#}
                                    {#                                        </button>#}
                                    {#                                    </div>#}
                                </div>
                                <div class="row pl-1 pr-3 pt-1 pb-3 mb-2">
                                    <div class="col-md-1 text-uppercase small pr-0">
                                        <label for="client_siaf" class="font-weight-bold">SIAF</label>
                                        <input type="text"
                                               class="form-control form-control-sm text-center"
                                               id="client_siaf"
                                               name="client_siaf" readonly>
                                    </div>
                                    <div class="col-md-5 text-uppercase small pl-1 pr-1">
                                        <label for="client_name" class="font-weight-bold">Cliente
                                            - Nombres/Razón social:</label>
                                        <input type="text"
                                               class="form-control form-control-sm text-uppercase"
                                               id="client_name"
                                               name="client_name" readonly>
                                    </div>
                                    <div class="col-md-6 text-uppercase small pl-1 pr-0">
                                        <label for="client_address" class="font-weight-bold">Dirección:</label>
                                        <input type="text"
                                               class="form-control form-control-sm text-uppercase"
                                               id="client_address"
                                               name="client_address">
                                    </div>
                                </div>

                            </div>
                            <div class="card-body pt-1 border pb-0 bg-light">
                                <div class="row p-1">
                                    <div class="col-sm-3 col-md-3 col-lg-3">
                                        <label for="order_date" class="font-weight-bold">Fecha de pedido:</label>
                                        <input type="date" class="form-control"
                                               id="order_date"
                                               name="order_date"
                                               value="{{ formatdate }}" required>
                                    </div>
                                    <div class="col-sm-3 col-md-3 col-lg-3">
                                        <label for="number_date" class="font-weight-bold">Nro de pedido:</label>
                                        <input type="text" class="form-control" id="number_order"
                                               name="number_order">
                                    </div>
                                    <div class="col-sm-6 col-md-6 col-lg-6">
                                        <div class="form-group">
                                            <label for="purchase" class="font-weight-bold">Ordenes de Compra
                                                (Cliente):</label>
                                            <select class="select2 purchase" multiple="multiple" id="purchase"
                                                    data-placeholder="Seleccionar una O/C"
                                                    style="width: 100%">
                                                {#                                                {% for p in purchase_set %}#}
                                                {#                                                    <option pk="{{ p.id }}">{{ p.bill_number }}</option>#}
                                                {#                                                {% endfor %}#}
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-5 col-md-5 col-lg-5 pl-0">
                            <div class="card-body pt-3 border pb-3  bg-light ">
                                <div class="card header mb-2 border-0 text-left font-weight-bold">
                                    Datos:
                                </div>
                                <div class="row p-3">
                                    <div class="col-sm-3 col-md-3 col-lg-3">
                                        <label for="id_date_issue" class="font-weight-bold">Fecha de emisión:</label>
                                        <input type="date" class="form-control" id="id_date_issue"
                                               name="date_issue"
                                               value="{{ formatdate }}" required>
                                    </div>
                                    <div class="col-sm-3 col-md-3 col-lg-3">
                                        <label for="pay_condition" class="font-weight-bold">Condición de pago:</label>
                                        <input type="number" class="form-control" id="pay_condition"
                                               placeholder="Nro de días"
                                               name="pay_condition-date">
                                    </div>
                                    <div class="col-sm-3 col-md-3 col-lg-3">
                                        <label for="due_date" class="font-weight-bold">Fecha de
                                            vencimiento:</label>
                                        <input type="date" class="form-control" id="due_date"
                                               name="due_date"
                                               value="{{ formatdate }}" required>
                                    </div>
                                    <div class="col-sm-3 col-md-3 col-lg-3 text-left align-middle ">
                                        <label for="user_id" class="font-weight-bold">Vendedor:</label>
                                        <select id="user_id" name="user"
                                                class="form-control"
                                                aria-selected="Text input with radio button">
                                            <option selected value="0">Seleccione...</option>
                                            {% for u in users %}
                                                <option value="{{ u.id }}">{{ u|upper }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="card-body pt-2 border pb-4 bg-light ">
                                <div class="row p-3">
                                    <div class="col-sm-4 col-md-4 col-lg-4">
                                        <button type="button" id="btn-save-bill" onclick="saveBill()"
                                                class="btn btn-success btn-sm text-uppercase text-center col-sm-12 col-md-12 col-lg-12">
                                            <i class="fas fa-save"></i> Guardar
                                        </button>
                                    </div>
                                    <div class="col-sm-4 col-md-4 col-lg-4">
                                        <button type="button" id="btn-new"
                                                class="btn btn-sm btn-secondary btn-block p-1">Nuevo
                                        </button>
                                    </div>
                                    <div class="col-sm-4 col-md-4 col-lg-4">
                                        <button type="button" id="btn-add-new-detail"
                                                class="btn btn-sm btn-success btn-block">Agregar Detalle +
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="card">
                <div class="card-body pt-1">
                    <div class="row p-1">
                        <div class="table-responsive" id="render-table">
                            <table id="id_table_details"
                                   class="table table-sm table-bordered mb-0">
                                <thead>
                                <tr class="text-center text-white" style="background: #19800f">
                                    <th class="align-middle font-weight-normal" style="width: 10%;">Código</th>
                                    <th class="align-middle font-weight-normal" style="width: 10%;">Cantidad</th>
                                    <th class="align-middle font-weight-normal" style="width: 5%;">Unidad Venta</th>
                                    <th class="align-middle font-weight-normal" style="width: 35%;">Descripción</th>
                                    <th class="align-middle font-weight-normal" style="width: 10%;">P. Unitario</th>
                                    <th class="align-middle font-weight-normal" style="width: 10%;">V. Lista</th>
                                    <th class="align-middle font-weight-normal" style="width: 5%;">Descs (%)</th>
                                    <th class="align-middle font-weight-normal" style="width: 10%;">V. Venta Total</th>
                                    <th class="align-middle font-weight-normal" style="width: 5%;"><i
                                            class="fa fa-trash"></i></th>
                                </tr>
                                </thead>
                                <tbody id="details-purchase-table">
                                {#                                <tr detail_id="">#}
                                {#                                    <td class="align-middle text-center">#}
                                {#                                        <input type="text"#}
                                {#                                               class="form-control text-center text-uppercase"#}
                                {#                                               placeholder="0" aria-label="Username"#}
                                {#                                               value="1001169">#}
                                {#                                    </td>#}
                                {#                                    <td class="align-middle text-left">#}
                                {#                                        <input type="text"#}
                                {#                                               class="form-control text-center text-uppercase"#}
                                {#                                               placeholder="0" aria-label="Username"#}
                                {#                                               value="918.00">#}
                                {#                                    </td>#}
                                {#                                    <td class="align-middle text-left">#}
                                {#                                        <input type="text"#}
                                {#                                               class="form-control text-center text-uppercase"#}
                                {#                                               placeholder="0" aria-label="Username"#}
                                {#                                               value="CS-CJA">#}
                                {#                                    </td>#}
                                {#                                    <td class="align-middle text-left">#}
                                {#                                        <input type="text"#}
                                {#                                               class="form-control text-left text-uppercase"#}
                                {#                                               placeholder="0" aria-label="Username"#}
                                {#                                               value="GLORIA EVP ENT PRG. VASO LECHE">#}
                                {#                                    </td>#}
                                {#                                    <td class="align-middle text-left">#}
                                {#                                        <input type="text"#}
                                {#                                               class="form-control text-right text-uppercase"#}
                                {#                                               placeholder="0" aria-label="Username"#}
                                {#                                               value="166.31">#}
                                {#                                    </td>#}
                                {#                                    <td class="align-middle text-left">#}
                                {#                                        <input type="text"#}
                                {#                                               class="form-control text-right text-uppercase"#}
                                {#                                               placeholder="0" aria-label="Username"#}
                                {#                                               value="140.940675">#}
                                {#                                    </td>#}
                                {#                                    <td class="align-middle text-left">#}
                                {#                                        <input type="text"#}
                                {#                                               class="form-control text-right text-uppercase"#}
                                {#                                               placeholder="0" aria-label="Username"#}
                                {#                                               value="0.00">#}
                                {#                                    </td>#}
                                {#                                    <td class="align-middle text-left">#}
                                {#                                        <input type="text"#}
                                {#                                               class="form-control text-right text-uppercase"#}
                                {#                                               placeholder="0" aria-label="Username"#}
                                {#                                               value="152,672.58">#}
                                {#                                    </td>#}
                                {#                                </tr>#}
                                </tbody>
                                <tfoot id="details-table-foot">
                                <tr>
                                    <td class="border-0" colspan="4"></td>
                                    <td class="border td-table-foot" colspan="11">
                                        <div class="form-check mt-5">
                                            <input class="form-check-input check-igv" type="checkbox" checked
                                                   id="check_igv">
                                            <label class="form-check-label" for="check_igv">
                                                INCLUYE IGV
                                            </label>
                                        </div>
                                        <table class="table table-hover table-sm align-content-center table-bordered mt-3 table-foot"
                                               style="width: 100%;" id="id_detail_data_foot">

                                            <thead>
                                            <tr class="text-center text-white" style="background: #19800f">
                                                <th scope="col" class="align-middle font-weight-normal"
                                                    style="width: 35%;">Base Imponible
                                                </th>
                                                <th scope="col" class="align-middle font-weight-normal"
                                                    style="width: 30%;">IGV (18%)
                                                </th>
                                                <th scope="col" class="align-middle font-weight-normal"
                                                    style="width: 35%;">Importe Total
                                                </th>
                                            <tbody id="table-detail-foot">
                                            <tr class="text-center">
                                                <td class="foot-base">
                                                    <div class="input-icon">
                                                        <input type="text"
                                                               class="form-control text-right text-uppercase total-foot-base"
                                                               placeholder="0.00"><i class="change-money">S/</i>
                                                    </div>
                                                </td>
                                                <td class="foot-igv">
                                                    <div class="input-icon">
                                                        <input type="text"
                                                               class="form-control text-right text-uppercase total-foot-igv"
                                                               placeholder="0.00"><i class="change-money">S/</i>
                                                    </div>
                                                </td>
                                                <td class="foot-total">
                                                    <div class="input-icon">
                                                        <input type="text"
                                                               class="form-control text-right text-uppercase total-foot-total"
                                                               placeholder="0.00"><i class="change-money">S/</i>
                                                    </div>
                                                </td>
                                            </tr>
                                            </tbody>
                                        </table>
                                    </td>
                                </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <style>

        .input-icon {
            position: relative;
        }

        .input-icon > i {
        {#content: "$";#} position: absolute;
            display: block;
            transform: translate(0, -50%);
            top: 50%;
            pointer-events: none;
            width: 25px;
            text-align: center;
            font-style: normal;
        }

        .input-icon > input {
            padding-left: 25px;
            padding-right: 8px;
        }

        .input-icon-right > i {
            right: 0;
        }

        .input-icon-right > input {
            padding-left: 0;
            padding-right: 25px;
            text-align: right;
        }

    </style>


{% endblock body %}


{% block extrajs %}
    <script type="text/javascript">

        $(document).on('focusin', '.client-search', function (e) {
            $(this).val(' ');
            $(this).parent('div').find('div.dropdown-menu').css({
                'background-color': 'transparent',
                'border': 'transparent',
            })
            $('#client_id').val('');
            $('#client_name').val('');
            $('#client_address').val('');
            $('#client_siaf').val('');
            $('#purchase').empty();

        });

        $(document).on('keypress', '.client-search', function (e) {

            $(this).parent('div').find('div.dropdown-menu').empty()

            if (e.keyCode === 13) {

                e.preventDefault()

                $(this).trigger("enterKey");
                let _client_name = $(this).val();
                let _menu = $(this).parent('div').find('div.dropdown-menu')

                if (_client_name.length > 3) {

                    $.ajax({
                        url: '/sales/get_clients_by_criteria/',
                        async: true,
                        dataType: 'json', // for response
                        type: 'GET',
                        data: {
                            'value': _client_name,
                        },
                        contentType: 'application/json;charset=UTF-8',
                        headers: {"X-CSRFToken": '{{ csrf_token }}'},
                        success: function (response, textStatus, xhr) {
                            if (xhr.status === 200) {
                                let list = response.client_list;
                                _menu.css({'background-color': '#fff', 'border': '1px solid rgba(0,0,0,.15)'})
                                for (let i = 0; i < list.length; i++) {
                                    _menu.append(`<a class="dropdown-item client-item" client_name="${list[i].client_names}" client_siaf="${list[i].client_siaf}" client_document_number="${list[i].client_document_number}" client_address="${list[i].client_address}" client_type_document="${list[i].client_type_document}" href="#" data-id="${list[i].client_id}">cliente: ${list[i].client_names} - RUC: ${list[i].client_document_number}</a>`)
                                }
                            }
                        },
                        error: function (jqXhr, textStatus, xhr) {
                            if (jqXhr.status === 500) {
                                toastr.error(jqXhr.responseJSON.error, 'Mensaje');
                            } else {
                                if (textStatus === 'timeout') {
                                    toastr.error('Failed from timeout', 'Mensaje');
                                } else {
                                    console.log(" STATUS: " + xhr + " " + textStatus);
                                }
                            }
                        }
                    });
                } else {

                    toastr.warning('Para la busqueda ingrese minimo 3 caracteres', 'Error de llenado');
                    return false;
                }
            }
        });

        $(document).on('click', '.client-item', function (e) {

            let _client_id = $(this).attr('data-id');
            let _client_address = $(this).attr('client_address');
            let _client_name = $(this).attr('client_name');
            let _client_siaf = $(this).attr('client_siaf');
            let _tr = $(this).parent('div.dropdown-menu').parent('td').parent('tr')
            let _td = $(this).parent('div.dropdown-menu').parent('td')
            let _client_type_document = $(this).attr('client_type_document')
            let _client_document_number = $(this).attr('client_document_number')

            $('#document_type_sender').val(_client_type_document);
            $('#document_type_sender').trigger('change');

            $('#client_name').val(_client_name);
            $('#client_address').val(_client_address);
            $('#client_siaf').val(_client_siaf);
            $("#client_id").val(_client_id);
            $(".client-search").val(_client_name);

            $(this).parent('div.dropdown-menu').empty()
            $(this).parent('div.dropdown-menu').addClass('hide')
            get_purchases_by_client(_client_id)
        });

        function get_purchases_by_client(client_id) {
            let _select = $('#purchase')
            $.ajax({
                url: '/buys/get_purchases_by_client/',
                async: true,
                dataType: 'json',
                type: 'GET',
                data: {'client_id': client_id},
                success: function (response) {
                    _select.empty();
                    let _purchase_set = JSON.parse(response['purchase_set']);
                    //console.log(_purchase_set)
                    if (response['purchase_set'] !== '[]') {
                        for (let i = 0; i < _purchase_set.length; i++) {
                            let option = $('<option>').val(_purchase_set[i]['pk']).text(_purchase_set[i]['fields']['bill_number'].toUpperCase());
                            _select.append(option);
                        }
                    }
                },
            });

        }

        $(document).ready(function () {
            $('.select2').select2()
        });

        $(document).on('select2:select', '.select2.purchase', function (e) {

            //var selectedValue = e.params.data.id;
            //let purchase_id = e.params.data.element.attributes.pk.nodeValue
            let purchase_id = e.params.data.id
            let tbody = $('tbody#details-purchase-table');
            $.ajax({
                url: '/buys/get_purchase_detail/',
                dataType: 'json',
                type: 'GET',
                data: {'id': purchase_id},
                success: function (response) {
                    let d = response.detail_purchase_dict
                    for (let i = 0; i < d.length; i++) {
                        let product_id = d[i].product_id;
                        if (tbody.find('tr').length > 0) {
                            let _tr = ''
                            tbody.find('tr').each(function () {
                                if (Number(product_id) === Number($(this).attr("product"))) {
                                    _tr = $(this);
                                }
                            });
                            if (_tr !== '') {
                                let _quantity = _tr.find('td.item-quantity input.quantity');
                                let _detail_total = _tr.find('td.item-detail-total input.detail-total');
                                let _new_quantity = (Number(d[i].quantity) + Number(_quantity.val())).toFixed(2);
                                let _new_detail_total = (Number(d[i].detail_total.replace(',', '')) + Number(_detail_total.val().replace(',', ''))).toFixed(2)
                                _quantity.val(_new_quantity);
                                _detail_total.val(parseFloat(_new_detail_total))
                                /*.toLocaleString('es-US', {
                                minimumFractionDigits: 2,
                                maximumFractionDigits: 2
                            }));*/
                            } else {
                                addDetail(d[i].id, d[i].product_id, d[i].product_code, d[i].quantity, d[i].unit_id, d[i].unit_name, d[i].product_name, d[i].price_unit, d[i].detail_total)
                            }

                        } else {
                            addDetail(d[i].id, d[i].product_id, d[i].product_code, d[i].quantity, d[i].unit_id, d[i].unit_name, d[i].product_name, d[i].price_unit, d[i].detail_total)
                        }
                    }
                    sumTable()
                },
                fail: function (response) {
                    toastr.error('Error en la peticion', '¡Mensaje!');
                }
            });
        });

        function addDetail(detail_id, product_id, product_code, quantity, unit_id, unit_name, product_name, price_unit, detail_total) {
            let tbody = $('tbody#details-purchase-table');
            tbody.append(
                '<tr detail="' + detail_id + '" product="' + product_id + '" unit="' + unit_id + '">' +
                '<td class="align-middle text-center item-code">' +
                '<input type="text" class="form-control text-center text-uppercase code" value="' + product_code + '">' + '</td>' +
                '<td class="align-middle text-center item-quantity">' +
                '<input type="text" class="form-control text-center text-uppercase quantity" value="' + quantity + '">' + '</td>' +
                '<td class="align-middle text-center item-unit">' +
                '<input type="text" class="form-control text-center text-uppercase unit" value="' + unit_name + '">' + '</td>' +
                '<td class="align-middle text-center item-name">' +
                '<input type="text" class="form-control text-center text-uppercase name" value="' + product_name + '">' + '</td>' +
                '<td class="align-middle text-center item-price-unit">' +
                '<input type="text" class="form-control text-center text-uppercase price-unit" value="' + price_unit + '">' + '</td>' +
                '<td class="align-middle text-center item-price-list">' +
                '<input type="text" class="form-control text-center text-uppercase price-list" value="0.00">' + '</td>' +
                '<td class="align-middle text-center item-discount">' +
                '<input type="text" class="form-control text-center text-uppercase discount" value="0.00">' + '</td>' +
                '<td class="align-middle text-center item-detail-total">' +
                '<input type="text" class="form-control text-center text-uppercase detail-total" value="' + detail_total + '">' + '</td>' +
                '<td class="align-middle text-center"> ' +
                '<button type="button" onclick="deleteItem2(this)" class="btn btn-danger delete-detail"><i class="fa fa-trash"></i></button>' + '</td>' +
                '</tr>'
            )
        }

        $(document).on('change', '#pay_condition', function () {

            let _days = $(this).val();
            let _due_date = $('#due_date');
            let _current_date = new Date()
            if (_days > 0) {
                let str_date_due_date = stringToDate(_due_date.val());
                let $new_date = addDays(str_date_due_date, _days);
                _due_date.val(formatDate($new_date));
            } else {
                _due_date.val(formatDate(_current_date));
            }
        });

        function stringToDate(dateString) {
            const [year, month, day] = dateString.split('-').map(num => parseInt(num));
            return new Date(year, month - 1, day);
        }

        function formatDate(date) {
            let day = String(date.getDate()).padStart(2, '0');
            let month = String(date.getMonth() + 1).padStart(2, '0');
            let year = date.getFullYear();
            return `${year}-${month}-${day}`;
        }

        function addDays(date, days) {
            let newDate = new Date(date);
            newDate.setDate(newDate.getDate() + parseInt(days));
            return newDate;
        }

        function sumTable() {
            let igv = 0;
            let base = 0;
            let sum_total = 0;
            let total;
            $('tbody#details-purchase-table tr').each(function () {
                let td_total = Number($(this).find("td.item-detail-total input.detail-total").val());
                sum_total += td_total
            });
            base = sum_total
            igv = sum_total * 0.18
            total = base + igv

            $("#id_table_details tfoot tr input.total-foot-base").val(base.toFixed(4));
            $("#id_table_details tfoot tr input.total-foot-igv").val(igv.toFixed(4));
            $("#id_table_details tfoot tr input.total-foot-total").val(total.toFixed(4));
            $("#id_table_details tfoot tr input.total-foot-document").val(total.toFixed(4));

        }

        function saveBill() {

            let client_id = $('#client_id');
            let client_name = $('.client_search');
            let order_date = $('#order_date');
            let number_order = $('#number_order');
            let purchase = $('#purchase');
            let date_issue = $('#id_date_issue');
            let pay_condition = $('#pay_condition');
            let due_date = $('#due_date');
            let user_id = $('#user_id');

            if (client_id.val() === '') {
                toastr.warning('Error al seleccionar cliente, Intentar de nuevo', 'Error de llenado');
                return false;
            }
            if (client_name.val() === '') {
                toastr.warning('El cliente no puede estar vacio', 'Error de llenado');
                client_name.focus();
                return false;
            }
            if (number_order.val() === '') {
                toastr.warning('Especifique el Numero de pedido', 'Error de llenado');
                number_order.focus();
                return false;
            }
            if (pay_condition.val() === '') {
                toastr.warning('Ingrese la condicion de pago', 'Error de llenado');
                pay_condition.focus();
                return false;
            }
            if (user_id.val() === '0') {
                toastr.warning('Seleccione un Vendedor', 'Error de llenado');
                user_id.focus();
                return false;
            }
            if ($("#id_table_details tbody#details-purchase-table tr").length > 0) {
                let table_foot = $("#id_table_details tfoot#details-table-foot tr td.td-table-foot").find("#id_detail_data_foot tbody#table-detail-foot tr")
                let OrderBill = {
                    "ClientID": client_id.val(),
                    "OrderDate": order_date.val(),
                    "NumberOrder": number_order.val(),
                    "Purchases": purchase.val(),
                    "IssueDate": date_issue.val(),
                    "PayCondition": pay_condition.val(),
                    "DueDate": due_date.val(),
                    "User": user_id.val(),
                    "TotalBase": Number(table_foot.find("td.foot-base input.total-foot-base").val()),
                    "TotalIgv": Number(table_foot.find("td.foot-igv input.total-foot-igv").val()),
                    "TotalImport": Number(table_foot.find("td.foot-total input.total-foot-total").val()),
                    "Details": []
                }
                $('tbody#details-purchase-table tr').each(function () {
                    let detailObj = {
                        "Product": $(this).attr('product'),
                        "Quantity": $(this).find("td.item-quantity input.quantity").val(),
                        "UnitID": $(this).attr('unit'),
                        "PriceUnit": $(this).find("td.item-price-unit input.price-unit").val(),
                        "Total": $(this).find("td.item-detail-total input.detail-total").val()
                    }
                    OrderBill.Details.push(detailObj)
                });
                console.log(OrderBill)
                $.ajax({
                    url: '/buys/save_bill/',
                    async: true,
                    dataType: 'json', // for response
                    type: 'GET',
                    data: {'bill': JSON.stringify(OrderBill)},
                    contentType: 'application/json;charset=UTF-8',
                    headers: {"X-CSRFToken": '{{ csrf_token }}'},
                    success: function (response, textStatus, xhr) {
                        if (xhr.status === 200) {
                            toastr.success(response.message, '¡Factura Registrada Correctamente!');
                            let bill_id = response.pk
                            window.location.href = "/buys/print_pdf_bill/" + bill_id + "/";
                            /*setTimeout(() => {
                            }, 2000);*/
                        }
                    },
                    error: function (jqXhr, textStatus, xhr) {
                        toastr.error("ERROR. ", '¡INCONCEBIBLE!');
                    }
                });

            } else {
                toastr.warning("PARA REALIZAR LA FACTURA AGREGUE AL MENOS UN PRODUCTO. ", '¡ADVERTENCIA!');
                return false;
            }

        }


    </script>

{% endblock extrajs %}