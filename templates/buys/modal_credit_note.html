{% load operations %}
<div class="modal-dialog modal-dialog-centered modal-xl" role="document">
    <div class="modal-content border-0 shadow-lg" style="border-radius: 12px;">
        <form id="credit-form" method="POST">
            {% csrf_token %}
            <div class="modal-header py-3" style="background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);">
                <h6 class="modal-title text-white font-weight-bold roboto-condensed-regular">
                    <i class="fas fa-file-invoice mr-2"></i>REGISTRAR NOTA DE CRÉDITO
                </h6>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close" style="opacity: 1;">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body roboto-condensed-regular">
                <div class="alert alert-light border mb-3" style="border-left: 4px solid #1565c0;">
                    <strong>Producto a devolver:</strong> {{ product_name }} |
                    <strong>Cantidad comprada:</strong> {{ product_quantity|replace_round }} {{ unit_name }} |
                    <strong>Equivalencia en unidades:</strong> {{ quantity_in_units|replace_round }} {{ unit_und_name|default:"UND" }}
                </div>
                <div class="card-body bg-light p-0">
                    <input type="hidden" name="bill" id="bill_id" value="{% if bill_obj %}{{ bill_obj.id }}{% endif %}">
                    <input type="hidden" name="subsidiary_store" id="subsidiary_store_id" value="{% if bill_obj.store_destiny %}{{ bill_obj.store_destiny.id }}{% endif %}">
{#                    {% if purchase_detail_obj %}#}
{#                    <input type="hidden" name="purchase_detail" id="purchase_detail_id" value="{{ purchase_detail_obj.id }}">#}
{#                    <input type="hidden" name="purchase" id="purchase_id" value="{{ purchase_obj.id }}">#}
{#                    {% endif %}#}
                    {% if bill_detail_obj %}
                    <input type="hidden" name="bill_detail" id="bill_detail_id" value="{{ bill_detail_obj.id }}">
                    {% endif %}
                    <div class="row m-1 mt-2">
                        <div class="col-md-2 p-1 border">
                            <label for="credit-serial" class="text-primary">Nº Nota de Crédito:</label>
                            <div class="input-group input-group-sm">
                                <input type="text" class="form-control text-uppercase" id="credit-serial" name="credit-serial" placeholder="FN01" required style="max-width: 60px;">
                                <div class="input-group-append">
                                    <span class="input-group-text">-</span>
                                </div>
                                <input type="text" class="form-control text-uppercase" id="credit-number" name="credit-number" placeholder="00000001" required>
                            </div>
                        </div>
                        <div class="col-md-2 p-1 border">
                            <label for="id-date-issue" class="text-primary">Fecha de emisión:</label>
                            <input type="date"
                                   class="form-control" name="credit-date-issue" id="id-date-issue"
                                   placeholder="" required
                                   value="{{ date }}">
                        </div>
                        <div class="col-md-5 p-1 border">
                            <label for="id_bill-applied" class="text-danger">Documento de Referencia:</label>
                            <select class="form-control" id="id_bill-applied" name="credit-bill-applied">
                                <option selected value="0">Sin documento de referencia</option>
                                {% for b in bill_set %}
                                    {% if b.bill_number %}
                                        {# Caso cuando bill_set es una lista de diccionarios (sales) #}
                                        <option value="{{ b.id }}" {% if bill_obj and b.id == bill_obj.id %}selected{% endif %}>
                                            {{ b.bill_number.serial }}-{{ b.bill_number.correlative }} | {{ b.supplier }} | S/ {{ b.total }}
                                        </option>
                                    {% else %}
                                        {# Caso cuando bill_set es una lista de objetos Bill (buys) #}
                                        <option value="{{ b.id }}" {% if bill_obj and b.id == bill_obj.id %}selected{% endif %}>
                                            {{ b.serial }}-{{ b.correlative }} | {{ b.supplier }} | S/ {{ b.bill_total_total|replace_round_separator }}
                                        </option>
                                    {% endif %}
                                {% endfor %}
                            </select>
                        </div>
                        <div class="col-md-3 p-1 border">
                            <label for="credit_note_motive" class="text-primary">Motivo:</label>
                            <input type="text"
                                   class="form-control" name="credit-note-motive" id="credit_note_motive"
                                   placeholder="" required>
                        </div>
                    </div>
                    <div class="row m-1 mt-2">
                        <div class="col-sm-12 p-1 border">
                            <div class="card col-sm-12 p-0">
                                <table class="table-hover table-sm table-bordered" id="id-table-detail-note"
                                       style="width: 100%;">
                                    <thead class="text-uppercase small text-center">
                                    <tr class="text-white" style="background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);">
                                        <th scope="col" class="font-weight-normal" style="width: 10%;">Código</th>
                                        <th scope="col" class="font-weight-normal" style="width: 10%;">Cantidad</th>
                                        <th scope="col" class="font-weight-normal" style="width: 10%;">Unidad</th>
                                        <th scope="col" class="font-weight-normal" style="width: 50%;">Descripción</th>
                                        <th scope="col" class="font-weight-normal" style="width: 10%;">P. Unitario</th>
                                        <th scope="col" class="font-weight-normal" style="width: 10%;">V. Venta Total
                                        </th>
                                    </tr>
                                    </thead>
                                    <tbody id="new-note-credit">
                                    <tr>
                                        <td class="text-center align-middle">
                                            <input type="text" autocomplete="off" aria-label="Código"
                                                   class="form-control text-uppercase text-center" name="credit-code"
                                                   id="credit-code" maxlength="200" value="{{ product_code }}" placeholder="Código producto" readonly>
                                        </td>
                                        <td class="text-center align-middle">
                                            <input type="text" autocomplete="off" aria-label="Cantidad"
                                                   class="form-control text-uppercase text-center"
                                                   name="credit-quantity"
                                                   id="credit-quantity" maxlength="200" value="{{ product_quantity|replace_round }}" placeholder="Cantidad">
                                        </td>
                                        <td class="text-center align-middle">
                                            <input type="text" autocomplete="off" aria-label="Unidad"
                                                   class="form-control text-uppercase text-center" name="credit-unit"
                                                   value="{{ unit_display }}{% if bill_detail_obj.unit.description %}-{{ bill_detail_obj.unit.description }}{% elif purchase_detail_obj.unit.description %}-{{ purchase_detail_obj.unit.description }}{% endif %}"
                                                   id="credit-unit" maxlength="200" readonly>
                                        </td>
                                        <td class="text-center align-middle">
                                            <input type="text" autocomplete="off" aria-label="Descripción"
                                                   class="form-control text-uppercase" name="credit-description"
                                                   id="credit-description" maxlength="200" value="{{ product_name }}" placeholder="Descripción producto" readonly>
                                        </td>
                                        <td class="text-center align-middle">
                                            <input type="text" autocomplete="off" aria-label="Precio unitario"
                                                   class="form-control text-uppercase text-right"
                                                   name="credit-price-unit"
                                                   value="{% if bill_detail_obj %}{{ bill_detail_obj.price_unit|replace_round }}{% else %}{{ purchase_detail_obj.price_unit|replace_round }}{% endif %}"
                                                   id="credit-price-unit" maxlength="200">
                                        </td>
                                        <td class="text-center align-middle">
                                            <input type="text" autocomplete="off" aria-label="Total"
                                                   class="form-control text-uppercase text-right" name="credit-total"
                                                   value="{% if bill_detail_obj %}{{ bill_detail_obj.amount|replace_round }}{% else %}{{ purchase_detail_obj.multiplicate|replace_round }}{% endif %}"
                                                   id="credit-total" maxlength="200" readonly>
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer py-3 bg-white border-top">
                    <button type="button" class="btn btn-outline-secondary font-weight-bold" data-dismiss="modal" id="btn-close">
                        <i class="fas fa-times mr-1"></i>Cerrar
                    </button>
                    <button id="save-credit-note" type="submit" class="btn btn-primary font-weight-bold px-4">
                        <i class="fas fa-save mr-1"></i>Registrar Nota de Crédito
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>
<script type="text/javascript">
    // Función para calcular el total automáticamente
    function calculateTotal() {
        let quantity = parseFloat($('#credit-quantity').val()) || 0;
        let priceUnit = parseFloat($('#credit-price-unit').val()) || 0;
        let total = quantity * priceUnit;
        $('#credit-total').val(total.toFixed(2));
    }

    // Calcular total cuando cambie la cantidad o el precio unitario
    $(document).ready(function() {
        $('#credit-quantity, #credit-price-unit').on('input', function() {
            calculateTotal();
        });
        
        // Calcular total inicial
        calculateTotal();
    });

    $('#credit-form').submit(function (e) {
        e.preventDefault();
        let data = new FormData($('#credit-form').get(0));
        //data.append('detail', JSON.stringify(detailCredit));
        $.ajax({
            url: '/buys/save_credit_note/',
            async: true,
            dataType: 'json',
            type: 'POST',
            cache: false,
            processData: false,
            data: data,
            contentType: false,
            headers: {"X-CSRFToken": '{{ csrf_token }}'},
            success: function (response, textStatus, xhr) {
                if (xhr.status === 200) {

                    toastr.success(response.message, '¡Mensaje!');
                    setTimeout(() => {
                        location.reload();
                    }, 500);
                    $('#modal-credit-note').modal('hide');
                }
            },
            error: function (jqXhr, textStatus, xhr) {
                toastr.error(jqXhr.responseJSON.error, '¡ERROR!');
            }
        });
    });

</script>