{% load operations %}
<div class="modal-dialog modal-dialog-centered modal-xl" role="document">
    <div class="modal-content border-0 shadow-lg" style="border-radius: 12px;">
        <form id="credit-form" method="POST">
            {% csrf_token %}
            <div class="modal-header py-3" style="background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);">
                <h6 class="modal-title text-white font-weight-bold roboto-condensed-regular">
                    <i class="fas fa-file-invoice mr-2"></i>REGISTRAR NOTA DE CRÉDITO
                </h6>
                <button type="button" class="close text-white" data-dismiss="modal" aria-label="Close" style="opacity: 1;">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body roboto-condensed-regular">
                <div class="alert alert-light border mb-3" style="border-left: 4px solid #1565c0;">
                    <strong>Producto a devolver:</strong> {{ product_name|default:bill_detail_obj.product.name }} |
                    <strong>Cantidad:</strong> {{ product_quantity|replace_round }} {{ unit_name|default:"UND" }}
                </div>
                <div class="card-body bg-light p-0">
                    <input type="hidden" name="bill" id="bill_id" value="{{ bill_obj.id }}">
                    <input type="hidden" name="subsidiary_store" id="subsidiary_store_id" value="{% if bill_obj.store_destiny %}{{ bill_obj.store_destiny.id }}{% endif %}">
                    <input type="hidden" name="bill_detail" id="bill_detail_id" value="{{ bill_detail_obj.id }}">
                    <div class="row m-1 mt-2">
                        <div class="col-md-2 p-1 border">
                            <label for="credit-serial" class="text-primary">Doc. NC (Serie y Número):</label>
                            <div class="input-group input-group-sm">
                                <input type="text" class="form-control text-uppercase" id="credit-serial" name="credit-serial" placeholder="F001" required style="max-width: 60px;">
                                <div class="input-group-append">
                                    <span class="input-group-text">-</span>
                                </div>
                                <input type="text" class="form-control text-uppercase" id="credit-number" name="credit-number" placeholder="00000001" required>
                            </div>
                        </div>
                        <div class="col-md-2 p-1 border">
                            <label for="id-date-issue" class="text-primary">Fecha de emisión:</label>
                            <input type="date"
                                   class="form-control" name="credit-date-issue" id="id-date-issue"
                                   placeholder="" required
                                   value="{{ date }}">
                        </div>
                        <div class="col-md-5 p-1 border">
                            <label for="id_bill-applied" class="text-danger">Documento de Referencia:</label>
                            <select class="form-control" id="id_bill-applied" name="credit-bill-applied">
                                <option selected value="0">Sin documento de referencia</option>
                                {% for b in bill_set %}
                                    <option value="{{ b.id }}">{{ b.bill_number }} | {{ b.supplier }} | S/ {{ b.total|replace_round_separator }}</option>
                                {% endfor %}
                            </select>
{#                            <div class="input-group">#}
{#                                <div class="input-group-prepend col-6 pr-0 pl-0">#}
{#                                    <input type="text" class="form-control text-uppercase text-center font-weight-bold"#}
{#                                           placeholder="F001" aria-label="" name="bill-serial"#}
{#                                           id="bill_serial" autocomplete="off" value="{{ bill_serial }}">#}
{#                                    <span class="input-group-text bg-light border-0">-</span>#}
{#                                </div>#}
{#                                <input type="text" class="form-control col-6 font-weight-bold text-center" placeholder="001"#}
{#                                       aria-label="" name="bill-correlative"#}
{#                                       id="bill_correlative" autocomplete="off" value="{{ bill_correlative }}">#}
{#                            </div>#}
                            {#                        <input type="text"#}
                            {#                               class="form-control" name="bill-applied" id="id_bill-applied" required#}
                            {#                               value="{{ bill_number }}">#}
                        </div>
                        <div class="col-md-3 p-1 border">
                            <label for="credit_note_motive" class="text-primary">Motivo:</label>
                            <input type="text"
                                   class="form-control" name="credit-note-motive" id="credit_note_motive"
                                   placeholder="" required>
                        </div>
                    </div>
                    <div class="row m-1 mt-2">
                        <div class="col-sm-12 p-1 border">
                            <div class="card col-sm-12 p-0">
                                <table class="table-hover table-sm table-bordered" id="id-table-detail-note"
                                       style="width: 100%;">
                                    <thead class="text-uppercase small text-center">
                                    <tr class="text-white" style="background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);">
                                        <th scope="col" class="font-weight-normal" style="width: 10%;">Código</th>
                                        <th scope="col" class="font-weight-normal" style="width: 10%;">Cantidad</th>
                                        <th scope="col" class="font-weight-normal" style="width: 10%;">Unidad</th>
                                        <th scope="col" class="font-weight-normal" style="width: 50%;">Descripción</th>
                                        <th scope="col" class="font-weight-normal" style="width: 10%;">P. Unitario</th>
                                        <th scope="col" class="font-weight-normal" style="width: 10%;">V. Venta Total
                                        </th>
                                    </tr>
                                    </thead>
                                    <tbody id="new-note-credit">
                                    <tr>
                                        <td class="text-center align-middle">
                                            <input type="text" autocomplete="off" aria-label="Código"
                                                   class="form-control text-uppercase text-center" name="credit-code"
                                                   id="credit-code" maxlength="200" value="{{ product_code|default:'' }}" placeholder="Código producto">
                                        </td>
                                        <td class="text-center align-middle">
                                            <input type="text" autocomplete="off" aria-label="Cantidad"
                                                   class="form-control text-uppercase text-center"
                                                   name="credit-quantity"
                                                   id="credit-quantity" maxlength="200" value="{{ product_quantity|replace_round }}" placeholder="Cantidad">
                                        </td>
                                        <td class="text-center align-middle">
                                            <input type="text" autocomplete="off" aria-label="Unidad"
                                                   class="form-control text-uppercase text-center" name="credit-unit"
                                                   value="{{ unit_display|default:'NIU-UND' }}"
                                                   id="credit-unit" maxlength="200">
                                        </td>
                                        <td class="text-center align-middle">
                                            <input type="text" autocomplete="off" aria-label="Descripción"
                                                   class="form-control text-uppercase" name="credit-description"
                                                   id="credit-description" maxlength="200" value="{{ product_name|default:'' }}" placeholder="Descripción producto">
                                        </td>
                                        <td class="text-center align-middle">
                                            <input type="text" autocomplete="off" aria-label="..."
                                                   class="form-control text-uppercase text-right"
                                                   name="credit-price-unit"
                                                   value="{{ bill_detail_obj.price_unit|replace_round }}"
                                                   id="credit-price-unit" maxlength="200">
                                        </td>
                                        <td class="text-center align-middle">
                                            <input type="text" autocomplete="off" aria-label="..."
                                                   class="form-control text-uppercase text-right" name="credit-total"
                                                   value="{{ bill_detail_obj.amount|replace_round }}"
                                                   id="credit-total" maxlength="200">
                                        </td>
                                    </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer py-3 bg-white border-top">
                    <button type="button" class="btn btn-outline-secondary font-weight-bold" data-dismiss="modal" id="btn-close">
                        <i class="fas fa-times mr-1"></i>Cerrar
                    </button>
                    <button id="save-credit-note" type="submit" class="btn btn-primary font-weight-bold px-4">
                        <i class="fas fa-save mr-1"></i>Registrar Nota de Crédito
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>
<script type="text/javascript">
    $('#credit-form').submit(function (e) {
        e.preventDefault();
        /*let detailCredit = []
        $("#new-note-credit tr").each(function () {
            let detailObj = {billDetail: $(this).attr('bill_detail')};
            detailCredit.push(detailObj);
        });*/
        let data = new FormData($('#credit-form').get(0));
        //data.append('detail', JSON.stringify(detailCredit));
        $.ajax({
            url: '/sales/bill_create_credit_note/',
            async: true,
            dataType: 'json',
            type: 'POST',
            cache: false,
            processData: false,
            data: data,
            contentType: false,
            headers: {"X-CSRFToken": '{{ csrf_token }}'},
            success: function (response, textStatus, xhr) {
                if (xhr.status === 200) {

                    toastr.success(response.message, '¡Mensaje!');
                    setTimeout(() => {
                        location.reload();
                    }, 500);
                    /*let parent = response.parent
                    let _tr = $('#purchase-data-grid tbody').find('tr[pk_parent="' + parent + '"]');
                    let _td = _tr.find('table.table-details tbody tr[detail="'+ response.purchase_detail_id +'"] td.credit-note');
                    _td.empty();
                    _td.append('<span class="text-warning">' + response.nro_document + '</span><br>');
                    _td.append('Factura: <span class="text-warning">' + response.bill + '</span>');*/
                    $('#modal-credit-note').modal('hide');
                }
            },
            error: function (jqXhr, textStatus, xhr) {
                toastr.error(jqXhr.responseJSON.error, '¡ERROR!');
            }
        });
    });

</script>